<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Download Class Marks (Excel/PDF) - St. Patrick's School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,600,700&display=swap">
  <style>
    body { background: #f4f8fc; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; min-height: 100vh; }
    .container { max-width: 520px; margin: 50px auto 30px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 18px #0f3d6b22; padding: 36px 24px 32px 24px; text-align: center; }
    .title { color: #0f3d6b; font-size: 1.3em; font-weight: bold; margin-bottom: 6px; letter-spacing: .2px; }
    .desc { font-size: 1.06em; color: #2d4870; margin-bottom: 20px; margin-top: 0; }
    .row { display: flex; justify-content: center; align-items: center; gap: 18px; margin-bottom: 24px; }
    .custom-dropdown { border: 1.4px solid #1467b7; border-radius: 7px; background: #f7fafd; min-width: 110px; width: 200px; position: relative; font-size: 1.09em; cursor:pointer;}
    .dropdown-selected { padding: 11px 14px; user-select: none; border-radius: 7px; }
    .dropdown-list { position: absolute; left: 0; right: 0; top: 100%; background: #fff; border: 1.2px solid #1467b7; border-top: none; border-radius: 0 0 7px 7px; box-shadow: 0 8px 24px #1467b720; z-index: 9; max-height: 200px; overflow-y: auto; display: none;}
    .dropdown-option { padding: 11px 14px; cursor: pointer;}
    .dropdown-option:hover { background: #e3f2fd; }
    .download-btn { background: #0f3d6b; color: #fff; font-size: 1.13em; font-weight: bold; border: none; border-radius: 10px; padding: 13px 32px; cursor: pointer; margin-top: 5px; transition: background .17s; }
    .download-btn:disabled { background: #b8c7da; cursor: not-allowed; }
    .download-btn:hover:not(:disabled) { background: #164b7d; }
    .pdf-btn { background: #db504c; }
    .pdf-btn:hover:not(:disabled) { background: #a4312b; }
    .status { color: #e26c17; margin-top: 18px; font-size: 1.08em; min-height: 25px; }
    .back-link { display: inline-block; margin-top: 22px; color: #0f3d6b; text-decoration: underline; cursor: pointer; font-size: 1em; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="title">Download Class Marks (Excel / PDF)</div>
    <div class="desc">
      Select the exam and export all students' marks, totals, grades, and ranks.<br>
      <b>PDF:</b> Subject marks, total, grade, rank. Marks below 40% circled in red.
    </div>
    <div class="row">
      <div class="custom-dropdown" id="examDropdown">
        <div class="dropdown-selected" id="examSelected">-- Select Exam --</div>
        <div class="dropdown-list" id="examList"></div>
      </div>
      <button class="download-btn" id="downloadExcelBtn" disabled>Download Excel</button>
      <button class="download-btn pdf-btn" id="downloadPdfBtn" disabled>Download PDF</button>
    </div>
    <div class="status" id="status"></div>
  </div>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
      authDomain: "stpatricks-questionbank.firebaseapp.com",
      projectId: "stpatricks-questionbank",
      storageBucket: "stpatricks-questionbank.appspot.com",
      messagingSenderId: "917615322861",
      appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Utils
    const CLASS_GROUP_MAP = {
      'Nursery': 'nursery-lkg-ukg', 'LKG': 'nursery-lkg-ukg', 'UKG': 'nursery-lkg-ukg',
      '1st Class': 'class-1-2', '2nd Class': 'class-1-2',
      '3rd Class': 'class-3-5', '4th Class': 'class-3-5', '5th Class': 'class-3-5',
      '6th Class': 'class-6-9', '7th Class': 'class-6-9', '8th Class': 'class-6-9', '9th Class': 'class-6-9',
      '10th Class': 'class-10'
    };
    function getClassGroupName(className) {
      return CLASS_GROUP_MAP[className] || 'default';
    }
    function getGrade(percent) {
      if (percent >= 95) return 'A+';
      if (percent >= 90) return 'A';
      if (percent >= 85) return 'B+';
      if (percent >= 80) return 'B';
      if (percent >= 70) return 'C+';
      if (percent >= 60) return 'C';
      if (percent >= 50) return 'D';
      if (percent >= 40) return 'E';
      return 'F';
    }

    // Auth and initial exam load
    const statusDiv = document.getElementById('status');
    const excelBtn = document.getElementById('downloadExcelBtn');
    const pdfBtn = document.getElementById('downloadPdfBtn');
    let allExams = [];
    let selectedExam = null;

    auth.onAuthStateChanged(async function(user) {
      if (!user) {
        statusDiv.textContent = "You must be logged in to download marks.";
        excelBtn.disabled = true; pdfBtn.disabled = true;
      } else {
        statusDiv.textContent = "Loading exams...";
        excelBtn.disabled = true; pdfBtn.disabled = true;
        await loadExamDropdown();
      }
    });

    // Load exam dropdown
    async function loadExamDropdown() {
      // Get academic year, class, section from localStorage
      let academicYear = localStorage.getItem('sp_selectedYear') || '';
      let classId = localStorage.getItem('sp_selectedClassId') || '';
      let className = localStorage.getItem('sp_selectedClassName') || '';
      let sectionId = localStorage.getItem('sp_selectedSectionId') || '';
      let sectionName = localStorage.getItem('sp_selectedSectionName') || '';
      if (!academicYear || !classId || !sectionId) {
        statusDiv.textContent = "Error: Class or section not selected.";
        return;
      }
      const classGroup = getClassGroupName(className);
      let examsSnap = await db.collection('years').doc(academicYear)
        .collection('exams').doc('classGroups')
        .collection(classGroup).orderBy('name').get();
      allExams = [];
      examsSnap.forEach(doc => allExams.push({ id: doc.id, ...doc.data() }));
      let examList = document.getElementById('examList');
      examList.innerHTML = allExams.map(e => `<div class="dropdown-option" data-id="${e.id}">${e.name}</div>`).join('');
      document.getElementById('examSelected').textContent = "-- Select Exam --";
      selectedExam = null;
      excelBtn.disabled = true;
      pdfBtn.disabled = true;
      statusDiv.textContent = allExams.length ? "" : "No exams found for this class group.";
    }

    // Dropdown logic
    document.getElementById('examSelected').onclick = function() {
      let examList = document.getElementById('examList');
      examList.style.display = (examList.style.display === 'block' ? 'none' : 'block');
    };
    document.getElementById('examList').onclick = function(e) {
      if (e.target.classList.contains('dropdown-option')) {
        let examId = e.target.dataset.id;
        selectedExam = allExams.find(e => e.id === examId);
        document.getElementById('examSelected').textContent = selectedExam.name;
        this.style.display = 'none';
        excelBtn.disabled = false;
        pdfBtn.disabled = false;
        statusDiv.textContent = "";
      }
    };
    document.addEventListener('click', function handler(e) {
      if (!document.getElementById('examDropdown').contains(e.target)) {
        document.getElementById('examList').style.display = 'none';
      }
    });

    // ---- Download Excel for selected exam ----
    excelBtn.onclick = async function () {
      if (!selectedExam) return;
      statusDiv.textContent = "Preparing Excel...";
      let { students, studentMarks } = await getStudentMarks(selectedExam);
      if (!students.length) {
        statusDiv.textContent = "No students found.";
        return;
      }
      // Prepare headers
      let subjectHeaders = selectedExam.subjects.map(s => s.name);
      let headers = ['Roll', 'Student Name', ...subjectHeaders, 'Total', 'Grade', 'Rank'];
      let rows = [];
      for (let s of studentMarks) {
        let row = [s.roll, s.name, ...s.subjects.map(m => m.value), s.total, s.grade, s.rank];
        rows.push(row);
      }
      let ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Marks");
      let className = localStorage.getItem('sp_selectedClassName') || '';
      let sectionName = localStorage.getItem('sp_selectedSectionName') || '';
      XLSX.writeFile(wb, `Marks_${selectedExam.name}_${className}_${sectionName}.xlsx`);
      statusDiv.textContent = "Excel downloaded!";
    };

    // ---- Download PDF for selected exam ----
    pdfBtn.onclick = async function () {
      if (!selectedExam) return;
      statusDiv.textContent = "Preparing PDF...";
      let { students, studentMarks } = await getStudentMarks(selectedExam);
      if (!students.length) {
        statusDiv.textContent = "No students found.";
        return;
      }
      // Prepare headers
      let subjectHeaders = selectedExam.subjects.map(s => s.name);
      let headers = ['Roll', 'Student Name', ...subjectHeaders, 'Total', 'Grade', 'Rank'];
      // Prepare rows
      let body = studentMarks.map((s, idx) => [
        s.roll, s.name,
        ...s.subjects.map((m, i) =>
          (typeof m.value === "number" && m.max && m.value < (m.max * 0.4))
            ? { content: String(m.value), styles: { textColor: [220,32,32], cellWidth: 32, lineWidth: 1.2, lineColor: [220,32,32], cellPadding: 2, halign: 'center', valign: 'middle', cellBorder: 'circle' } }
            : (m.value !== undefined && m.value !== null ? String(m.value) : '')
        ),
        s.total, s.grade, s.rank
      ]);
      // Generate PDF
      const { jsPDF } = window.jspdf;
      let doc = new jsPDF({
        orientation: 'landscape',
        unit: 'pt',
        format: 'A4'
      });
      doc.setFontSize(18);
      let className = localStorage.getItem('sp_selectedClassName') || '';
      let sectionName = localStorage.getItem('sp_selectedSectionName') || '';
      doc.text(`St. Patrick's School`, 40, 44);
      doc.setFontSize(13);
      doc.text(`${className} - ${sectionName} | ${selectedExam.name} Results`, 40, 66);
      window.jspdf.autoTable(doc, {
        startY: 90,
        head: [headers],
        body,
        styles: { fontSize: 11, cellPadding: 5 },
        alternateRowStyles: { fillColor: [247, 252, 255] },
        rowStyles: (rowIndex) => rowIndex % 2 ? { fillColor: [235, 245, 251] } : {},
        didParseCell: function (data) {
          if (data.cell.raw && typeof data.cell.raw === 'object' && data.cell.raw.styles && data.cell.raw.styles.cellBorder === 'circle') {
            let { cell } = data;
            let { x, y, width, height } = cell;
            data.doc.setDrawColor(220, 32, 32);
            data.doc.setLineWidth(2);
            data.doc.ellipse(x + width / 2, y + height / 2, width / 2 - 3, height / 2 - 3);
          }
        }
      });
      doc.save(`Marks_${selectedExam.name}_${className}_${sectionName}.pdf`);
      statusDiv.textContent = "PDF downloaded!";
    };

    // --- Helper: Fetch students and marks for selected exam, compute total/rank ---
    async function getStudentMarks(exam) {
      let academicYear = localStorage.getItem('sp_selectedYear') || '';
      let classId = localStorage.getItem('sp_selectedClassId') || '';
      let sectionId = localStorage.getItem('sp_selectedSectionId') || '';
      // 1. Fetch students
      let studentsSnap = await db.collection('years').doc(academicYear)
        .collection('classes').doc(classId)
        .collection('sections').doc(sectionId)
        .collection('students').orderBy('roll').get();
      let students = [];
      studentsSnap.forEach(doc => {
        const s = doc.data();
        if (!s.isDeleted) students.push({ id: doc.id, ...s });
      });
      // 2. For each student, fetch marks for the selected exam
      let studentMarks = [];
      for (let stu of students) {
        let markDoc = await db.collection('years').doc(academicYear)
          .collection('classes').doc(classId)
          .collection('sections').doc(sectionId)
          .collection('students').doc(stu.id)
          .collection('marks').doc(exam.id).get();
        let marksData = (markDoc.exists ? markDoc.data() : {});
        let total = 0, totalMax = 0;
        let subjectsArr = [];
        for (let subj of exam.subjects) {
          let value = marksData[subj.name];
          let max = Number(subj.max || 100);
          if (typeof value === "number" && !isNaN(value)) {
            total += value;
            totalMax += max;
            subjectsArr.push({ value, max });
          } else {
            totalMax += max;
            subjectsArr.push({ value: '', max });
          }
        }
        let percent = totalMax > 0 ? (total / totalMax) * 100 : 0;
        studentMarks.push({
          roll: stu.roll,
          name: stu.name,
          subjects: subjectsArr,
          total,
          grade: getGrade(percent),
          percent,
        });
      }
      // Sort by total desc, assign rank
      studentMarks.sort((a, b) => b.total - a.total);
      studentMarks.forEach((s, i) => { s.rank = i + 1; });
      return { students, studentMarks };
    }
  </script>
</body>
</html>
