<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Question Bank | St. Patrick's School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
      window.MathJax = { tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script src="https://unpkg.com/docx@8.4.0/build/index.umd.js"></script>

    <style>
        :root { --header-height: 90px; }
        html { height: -webkit-fill-available; }
        body {
            margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f8fc;
            height: 100vh;
            height: -webkit-fill-available;
        }
        body::after {
            content: "St. Patrick's\A IIT & NEET FOUNDATION";
            white-space: pre; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 5vw; font-weight: bold;
            color: rgba(15, 61, 107, 0.04); z-index: -1; text-align: center;
            pointer-events: none; line-height: 1.2;
        }
        .page-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #main-header {
            background: linear-gradient(90deg, #1762a7, #0f3d6b);
            color: #fff; border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
            min-height: var(--header-height); display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 15px 10px 18px 10px;
            box-sizing: border-box; flex-shrink: 0;
            position: sticky; top: 0; z-index: 10;
        }
        #main-header .school-title { font-size: 1.8em; font-weight: bold; margin: 0;}
        #main-header .subtitle { font-size: 1.05em; color: #e0eaff; margin-top: 5px; }

        main {
            flex: 1 1 0%;
            min-height: 0;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .setup-form-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px auto; 
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 18px rgba(0, 27, 68, 0.1);
            padding: 25px 16px;
            flex-shrink: 0;
            overflow-x: hidden;
            box-sizing: border-box;  
        }
        .setup-form-container h2 {
            text-align: center;
            color: #0f3d6b;
            margin-top: 0;
            margin-bottom: 20px;
        }
        #filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        @media (max-width: 560px) {
            #filter-form { grid-template-columns: 1fr; gap: 15px; }
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #185496;
            display: block;
        }
        .custom-dropdown { position: relative; }
        .selected-option { padding: 10px 12px; color: #12416c; background: #f7fafd; border-radius: 6px; border: 1.3px solid #bcd6ef; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dropdown-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1.3px solid #bcd6ef; border-top: none; border-radius: 0 0 6px 6px; box-shadow: 0 6px 15px rgba(0, 27, 68, 0.1); z-index: 1000; max-height: 200px; overflow-y: auto; }
        .custom-dropdown.open .dropdown-options { display: block; }
        .dropdown-options div[data-value] { padding: 10px 15px; cursor: pointer; }
        .dropdown-options div[data-value]:hover { background: #e0eaff; }
        .question-item {
            background: #fff;
            border: 1.5px solid #e0eaff;
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(0, 27, 68, 0.06);
            padding: 12px 18px 12px 18px;
            margin-bottom: 12px;
            transition: box-shadow 0.15s;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
            page-break-inside: avoid;
        }
        .question-item:hover {
            box-shadow: 0 4px 24px rgba(23, 98, 167, 0.12);
        }
        .question-meta {
            color: #c82333;
            font-size: 1.12em;
            font-weight: 700;
            margin-bottom: 2px;
            letter-spacing: 0.01em;
        }
        .question-meta {
          margin-bottom: 0px !important;
        }
        .question-text {
            color: #185496;
            font-size: 1.14em;
            font-weight: 500;
            line-height: 1.58;
            margin-top: 0;
            margin-bottom: 0;
            text-align: left;
            white-space: normal;
            word-break: break-word;
        }
        .question-item img {
            max-width: 170px;
            max-height: 110px;
            border-radius: 9px;
            margin-top: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px #0f3d6b19;
            display: block;
        }
        .question-img-btn, .delete-img-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border: 1px solid #bcd6ef;
            background: #f7fafd;
            border-radius: 5px;
            font-size: 1em;
            color: #185496;
            margin-top: 1px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .question-img-btn:hover, .delete-img-btn:hover { background: #e0eaff; }
        #export-btns {
            width: 100%;
            max-width: 650px;   /* Matches your card/question width for visual alignment */
            margin: 14px auto 0 auto; /* Centered with gap above, no side margin */
            padding: 0 12px;     /* Adds a little space left/right (adjust as needed) */
            box-sizing: border-box;
                }
        #download-pdf-btn, #download-word-btn {
            padding: 12px 22px;
            border-radius: 6px;
            border: none;
            font-size: 1.09em;
            background: #1762a7;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 10px #0f3d6b19;
            cursor: pointer;
            margin-top: 10px;
        }
       #download-pdf-btn {
            width: 100%;
            box-sizing: border-box;
            padding: 13px 0;
            border-radius: 6px;
            border: none;
            font-size: 1.09em;
            background: #1762a7;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 10px #0f3d6b19;
            cursor: pointer;
            margin: 0;
        }
        .main-btn {
            width: 100%;
            box-sizing: border-box;
            padding: 13px 0;
            border-radius: 6px;
            border: none;
            font-size: 1.09em;
            background: #1762a7;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 10px #0f3d6b19;
            cursor: pointer;
            margin: 0;
            margin-top: 16px;
            transition: background 0.14s;
        }
        .main-btn:hover {
            background: #144e83;
        }
        .question-actions {
    position: absolute;
    top: 12px;
    right: 10px;
    z-index: 10;
}
.q-action-btn {
    background: none;
    border: none;
    color: #54656f;
    font-size: 1.18em;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    line-height: 22px;
}
.q-action-btn:hover {
    background-color: #e0e0e0;
}
.actions-menu {
    position: absolute;
    background: #333;
    color: white;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    padding: 5px;
    z-index: 1010;
    display: flex;
    flex-direction: column;
    gap: 0;
    right: 10px;
    top: 40px;
    min-width: 120px;
}
.actions-menu button {
    background: none;
    border: none;
    color: white;
    padding: 10px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.98em;
    text-align: left;
}
.actions-menu button:hover {
    background-color: #555;
}
.temp-answer {
    background-color: #fff8e1;
    border-top: 2px solid #ffecb3;
    padding: 10px 14px;
    margin-top: 10px;
    border-radius: 0 0 12px 12px;
    font-style: italic;
    color: #5d4037;
    white-space: pre-wrap;
}
    </style>
</head>
<body>
        <div class="page-wrapper">
        <header id="main-header">
            <h1 class="school-title">St. Patrick's School</h1>
            <div class="subtitle">IIT & NEET FOUNDATION</div>
        </header>
        <main>
            <div class="setup-form-container">
                <h2>Question Bank</h2>
                <form id="filter-form">
                    <div class="form-group">
                        <label>Class:</label>
                        <div id="class-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>Subject:</label>
                        <div id="subject-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>Question Type:</label>
                        <div id="qtype-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>Chapter:</label>
                        <div id="chapter-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div class="form-group">
                    <label>Level:</label>
                    <div id="level-dropdown" class="custom-dropdown"></div>
                </div>
                    <div class="form-group">
                        <label>Marks:</label>
                        <div id="marks-dropdown" class="custom-dropdown"></div>
                    </div>
                </form>
                <div id="export-btns">
              <button id="download-pdf-btn"><i class="fa-solid fa-file-pdf"></i> Download Worksheet</button>
             <button id="create-quiz-btn" class="main-btn" style="margin-top:16px;"><i class="fa-solid fa-pen-to-square"></i> Create Practice Quiz</button>
            </div>
            </div>
            <div id="questions-display-area">
                <p class="no-questions-message">Select filters to view questions.</p>
            </div>
        </main>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
            authDomain: "stpatricks-questionbank.firebaseapp.com",
            projectId: "stpatricks-questionbank",
            storageBucket: "stpatricks-questionbank.appspot.com",
            messagingSenderId: "917615322861",
            appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;

        const filterConfig = {
            classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
            subjectMappings: {
                "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
                "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
                "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
                "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
                "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
                "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
                "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
                "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
            },
            questionTypes: ["MCQ (Single)", "MCQ (Multiple)", "Descriptive"],
            marks: Array.from({
                length: 10
            }, (_, i) => i + 1),
            levels: ["Level 1", "Level 2", "Level 3", "Mixed"]
            };

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    initializeApp();
                } else {
                    window.location.href = 'login.html';
                }
            });

            document.addEventListener('click', () => {
                document.querySelectorAll('.custom-dropdown.open').forEach(d => d.classList.remove('open'));
            });
        });

        function initializeApp() {
            setupDropdowns();
            fetchAndDisplayQuestions();
            document.getElementById('download-pdf-btn').addEventListener('click', exportPDF);
        }

        // PDF EXPORT USING html2pdf.js
        async function exportPDF(e) {
            e.preventDefault();
            const pdfBtn = document.getElementById('download-pdf-btn');
            pdfBtn.disabled = true;
            pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';

            const classVal = document.getElementById('class-value').value || '';
            const subjectVal = document.getElementById('subject-value').value || '';
            const chapterVal = document.getElementById('chapter-value').value || '';

            // Wrapper for PDF content
            const printable = document.createElement('div');
            printable.id = 'printable-export';
            printable.style.background = "#fff";
            printable.style.color = "#000";
            printable.style.fontFamily = "'Times New Roman', Times, serif";
            printable.style.fontSize = "11pt";
            printable.style.maxWidth = "820px";
            printable.style.margin = "0 auto";
            printable.style.padding = "0";
            printable.style.lineHeight = "1.6";

            // Header
            printable.innerHTML = `
  <div style="display:flex;align-items:center;justify-content:center;margin-bottom:10px;gap:30px;">
    <img src="schoollogo1.png" style="height:72px;width:auto;margin-right:8px;" onerror="this.style.display='none';">
    <div style="flex:1;text-align:center;">
      <div style="font-size:2.35em;font-weight:bold;letter-spacing:0.01em;font-family:'Times New Roman', Times, serif;line-height:1;margin-bottom:2px;">
        St. Patrick's School
      </div>
      <div style="font-size:1.32em;font-weight:700;color:#224a74;letter-spacing:0.02em;margin-bottom:2px;">
        IIT & NEET FOUNDATION
      </div>
      <div style="font-size:1.18em;font-weight:bold;margin-top:7px;letter-spacing:0.01em;">
        ${(classVal ? classVal.replace("Class", "").trim() : "")} ${(subjectVal || "").toUpperCase()}
      </div>
    </div>
    <img src="schoollogo2.png" style="height:72px;width:auto;margin-left:8px;" onerror="this.style.display='none';">
  </div>
  <div style="margin:22px auto 18px auto; border:2.5px solid #bdd7f6; border-radius:16px; padding:20px 40px 14px 40px; background:#fafdff; box-sizing:border-box; max-width:510px;">
    <div style="font-size:1.24em;font-weight:bold;letter-spacing:0.01em;text-align:center;margin-bottom:5px;">
      ${(chapterVal || '').toUpperCase()}
    </div>
    <div style="font-size:1.14em;font-weight:700;text-align:center;">
      WORKSHEET
    </div>
  </div>
`;

            const displayArea = document.getElementById('questions-display-area');
            const nodes = displayArea.querySelectorAll('.question-item');
            if (!nodes.length) {
                alert("No questions to export!");
                pdfBtn.innerHTML = '<i class="fa-solid fa-file-pdf"></i> Download Worksheet';
                pdfBtn.disabled = false;
                return;
            }

            // Helper for hanging indent
            function createHangingDiv(qNum, text, isMCQ = false) {
                if (isMCQ) {
                    return `<div style="margin-bottom:2px;">
      <div style="text-indent:-20px;padding-left:20px;font-size:11pt;display:flex;justify-content:space-between;align-items:center;max-width:98%;">
        <span style="flex:1;">${qNum}. ${text}</span>
        <span style="
    display:inline-block;
    text-align:right;
    font-weight:normal;
    font-size:1.15em;
    letter-spacing:2px;
    min-width:38px;
    font-family:'Times New Roman', Times, serif;
    ">
  ( &nbsp;&nbsp; )
</span>
      </div>
    </div>`;
                } else {
                    return `<div style="margin-bottom:2px;">
      <div style="text-indent:-20px;padding-left:20px;font-size:11pt;">
        ${qNum}. ${text}
      </div>
    </div>`;
                }
            }

            // MCQ Option Formatter
            function formatOptions(options) {
                options = options.map(x => x.trim()).filter(Boolean);
                if (options.length === 0) return "";

                const SHORT_LIMIT = 14;
                const MEDIUM_LIMIT = 28;

                const allShort = options.every(opt => opt.length <= SHORT_LIMIT);
                if (allShort) {
                    // All short: one line (spaced out)
                    return `<div style="margin-left:22px;margin-top:1px;display:flex;gap:28px;">
            ${options.map(opt => `<div>${opt}</div>`).join("")}
        </div>`;
                }
                const allMedium = options.every(opt => opt.length <= MEDIUM_LIMIT);
                if (allMedium) {
                    // 2+2 grid
                    return `
        <div style="display:flex;gap:20px;margin-left:22px;">
            <div style="flex:1;">${options[0] || ''}</div>
            <div style="flex:1;">${options[1] || ''}</div>
        </div>
        <div style="display:flex;gap:20px;margin-left:22px;">
            <div style="flex:1;">${options[2] || ''}</div>
            <div style="flex:1;">${options[3] || ''}</div>
        </div>
        `;
                }
                return `<div style="margin-left:22px;margin-top:1px;">
        ${options.map(opt => `<div>${opt}</div>`).join("")}
    </div>`;
            }
            // For MathJax rendering
            let mathElements = [];

            // Build questions
            nodes.forEach((item, idx) => {
                const qNum = idx + 1;

                // Remove buttons from clone
                const clone = item.cloneNode(true);
                clone.querySelectorAll('.question-img-btn, .delete-img-btn, .question-image-input').forEach(btn => btn.remove());

                // --- IMAGE HANDLING ---
                let imgHtml = '';
                const imgTag = clone.querySelector('img');
                if (imgTag && imgTag.src) {
                    imgHtml = `<div class="question-img-block" style="margin:10px 0 4px 0;">
            <img class="question-img" src="${imgTag.src}" style="max-width:170px;max-height:110px;border:1px solid #eee;border-radius:5px;display:block;"/>
        </div>`;
                }

                // --- UNIVERSAL QUESTION TEXT + OPTIONS EXTRACTION ---
                const textDiv = clone.querySelector('.question-text');
                let questionLine = '';
                let options = [];
                if (textDiv) {
                    // Remove images
                    let html = textDiv.innerHTML.replace(/<img[^>]*>/gi, '');
                    // Split into lines by <br> or <div>
                    let parts = html.split(/<br\s*\/?>|<\/div>|<div[^>]*>/gi)
                        .map(s => s.replace(/&nbsp;/g, ' ').trim())
                        .filter(Boolean);

                    // Remove empty lines
                    parts = parts.filter(line => line && !/^<br\s*\/?>$/i.test(line));

                    if (parts.length > 0) {
                        questionLine = parts[0];
                        // Gather all lines after question as possible options
                        let optionLines = [];
                        for (let i = 1; i < parts.length; i++) {
                            let line = parts[i];
                            // If a line contains all options in one, split them!
                            let inlineOpts = line.match(/([A-D][).][^A-D]*)/g);
                            if (inlineOpts && inlineOpts.length >= 2) {
                                optionLines.push(...inlineOpts.map(opt => opt.trim()));
                            } else if (line) {
                                optionLines.push(line);
                            }
                        }
                        // Add option labels if missing
                        if (optionLines.length === 4) {
                            options = optionLines.map((opt, i) =>
                                /^[A-D][).]/.test(opt) ? opt : String.fromCharCode(65 + i) + ") " + opt
                            );
                        } else {
                            options = optionLines;
                        }
                    }
                }
                let isMCQ = options.length === 4;
                // console.log("DEBUG MCQ extraction", { questionLine, options, isMCQ });
                // --- END REPLACEMENT BLOCK ---

                let questionHtml =
                    `<div class="question-container" style="display:flex;align-items:flex-start;margin-bottom:10px;page-break-inside:avoid;break-inside:avoid;">
                            <div class="question-body" style="flex:1;">
                              ${createHangingDiv(qNum, questionLine, isMCQ)}
                              ${imgHtml ? imgHtml : ''}
                              <div class="options-block" style="margin-top:2px;">
                                    ${ 
                                  isMCQ
                                    ? (() => {
                                        // MCQ options (fit logic): one line, two lines, or four lines
                                         let optionLines = options.slice(0, 4).map((opt, i) => {
                                          // Remove any existing leading A), A. etc (with or without space)
                                          let cleaned = opt.replace(/^[A-D][\)\.\-]\s*/, '');
                                          // Always add label just once
                                          return String.fromCharCode(65 + i) + ") " + cleaned;
                                        });
                                    
                                            // Helper: check if two options fit in one line
                                        function fitsInLine(a, b) {
                                            let d = document.createElement('span');
                                            d.style.cssText = 'visibility:hidden;position:absolute;white-space:nowrap;padding:0;margin:0;border:none;font-family:Times New Roman,Times,serif;font-size:1.11em;';
                                            d.innerText = a + "    " + b;
                                            document.body.appendChild(d);
                                            let fits = d.offsetWidth < 450;
                                            document.body.removeChild(d);
                                            return fits;
                                        }
                                        // Measure using HTML with MathJax
                                            let dummyDiv = document.createElement('div');
                                            dummyDiv.style.cssText = 'visibility:hidden;position:absolute;white-space:nowrap;padding:0;margin:0;border:none;z-index:-1;font-family:Times New Roman,Times,serif;font-size:1.11em;';
                                            dummyDiv.innerHTML = optionLines.map(opt => `<span style="display:inline-block;vertical-align:middle;margin-right:32px;">${opt.trim()}</span>`).join('');
                                            document.body.appendChild(dummyDiv);
                                            
                                            let fitsFour = dummyDiv.offsetWidth < 700; // 700px is safe for A4, adjust if needed
                                            document.body.removeChild(dummyDiv);

                                       let abFits = fitsInLine(optionLines[0], optionLines[1]);
                                        let cdFits = fitsInLine(optionLines[2], optionLines[3]);
                                
                                       if (fitsFour) {
                                        // All four options in one row (left aligned)
                                        return `<div style="display:flex;gap:32px;flex-wrap:wrap;margin-bottom:3px;margin-left:2px;">
                                            ${optionLines.map(opt => `<span style="min-width:70px;display:inline-block;vertical-align:top;">${opt.trim()}</span>`).join('')}
                                        </div>`;
                                       } else if (abFits && cdFits) {
                                            // Two rows: (A+B), (C+D)
                                            return `
                                          <div style="
                                          display: grid;
                                          grid-template-columns: auto auto;
                                          column-gap: 24px;
                                          row-gap: 0;
                                          margin-bottom: 2px;
                                          margin-left: 2px;
                                          width: max-content;
                                          ">
                                              <span style="min-width:70px;display:inline-block;vertical-align:top;">${optionLines[0]}</span>
                                                <span style="min-width:70px;display:inline-block;vertical-align:top;">${optionLines[1]}</span>
                                                <span style="min-width:70px;display:inline-block;vertical-align:top;">${optionLines[2]}</span>
                                                <span style="min-width:70px;display:inline-block;vertical-align:top;">${optionLines[3]}</span>
                                          </div>
                                        `;
                                        } else {
                                            // Four lines, each option on its own
                                            return optionLines.map(opt =>
                                                `<div style="margin-bottom:2px;margin-left:2px;">${opt.trim().replace(/\n/g, '<br>')}</div>`
                                            ).join('');
                                        }
                                    })()
                                    : (options.length > 0
                                        ? options.map(opt =>
                                            `<div style="margin-bottom:2px;margin-left:2px;">${opt.trim().replace(/\n/g, '<br>')}</div>`
                                          ).join('')
                                        : '')
                                }
        </div>
      </div>
    </div>
`;
                // MathJax tracking (keep if you use MathJax)
                if (/\$|\\\(|\\\)/.test(questionLine)) mathElements.push(idx);
                let wrap = document.createElement('div');
                wrap.innerHTML = questionHtml;
                printable.appendChild(wrap);
            });

          // Final export using html2pdf
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                await window.MathJax.typesetPromise([printable]);
                await new Promise(res => setTimeout(res, 100)); // Let browser paint SVG
            }
                html2pdf().set({
                margin: [1.5, 1.5, 1.5, 1.5], // [top, right, bottom, left] in cm
                filename: `Question_Bank_${classVal || ''}_${subjectVal || ''}_${chapterVal || ''}.pdf`.replace(/ /g, "_"),
                html2canvas: {
                    scale: 2,
                    useCORS: true
                },
                jsPDF: {
                    unit: 'cm',
                    format: 'a4',
                    orientation: 'portrait'
                }
            }).from(printable)
                .toPdf()
                .get('pdf')
                .then(function (pdf) {
                    const pageCount = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(11);
                        pdf.text(`Page : ${i}`, pdf.internal.pageSize.getWidth() - 2.5, pdf.internal.pageSize.getHeight() - 1, { align: 'right' });
                    }
                })
                .save()
                .then(() => {
                    pdfBtn.innerHTML = '<i class="fa-solid fa-file-pdf"></i> Download Worksheet';
                    pdfBtn.disabled = false;
                }).catch((err) => {
                    alert("Failed to export PDF: " + err);
                    pdfBtn.innerHTML = '<i class="fa-solid fa-file-pdf"></i> Download Worksheet';
                    pdfBtn.disabled = false;
                });
        }
   
       async function exportWord() {
    const { Document, Packer, Paragraph, TextRun } = window.docx;
    const area = document.getElementById('questions-display-area');
    const questions = area.querySelectorAll('.question-item');
    const docChildren = [];

    // Helper to decode HTML entities (&nbsp;) and strip HTML tags
    function decodeAndClean(html) {
        html = html.replace(/<br\s*\/?>/gi, '\n');
        html = html.replace(/<\/?[^>]+(>|$)/g, '');
        const txt = document.createElement('textarea');
        txt.innerHTML = html;
        return txt.value.replace(/\u00a0/g, ' ');
    }

    let qNo = 1;
    for (const q of questions) {
        let qText = decodeAndClean(q.querySelector('.question-text').innerHTML);
        let lines = qText.split('\n').map(l => l.trim()).filter(Boolean);

        // Determine question type (MCQ detection)
        let isMCQ = false;
        for (let i = 1; i < lines.length; i++) {
            if (/^[A-Da-d]\)/.test(lines[i]) || /^[A-Da-d][\.\-]/.test(lines[i])) {
                isMCQ = true;
                break;
            }
            if (/^(A|a)[\)\.\-]/.test(lines[i].trim())) {
                isMCQ = true;
                break;
            }
        }
        if (!isMCQ && lines.length > 1 && /(A\).+B\).+C\).+D\))/.test(lines[1])) isMCQ = true;

        // Hanging indent for Word: 700 twips (0.5 inch)
        const hangingTwips = 700;

        if (isMCQ) {
            let questionLine = lines[0];
            let optionsText = lines.slice(1).join(' ');
            let options = [];

            if (optionsText) {
                let found = optionsText.match(/([A-Da-d]\)[^A-Da-d]*)/g);
                if (found && found.length === 4) {
                    options = found.map(o => o.trim());
                } else {
                    options = lines.slice(1).filter(x => x).map(x => x.trim());
                }
            } else {
                options = lines.slice(1).filter(x => x).map(x => x.trim());
            }

            // Q:  question (number and text)
            docChildren.push(new Paragraph({
                children: [
                    new TextRun({ text: qNo + '. ', bold: true, size: 26 }),
                    new TextRun({ text: questionLine, size: 26 }),
                ],
                indent: { hanging: hangingTwips, left: 0 },
                spacing: { after: 80 }
            }));

            // Options, aligned using hanging indent
            if (options.length === 4 && options.every(opt => opt.length <= 24)) {
                let runs = [];
                options.forEach((opt, idx) => {
                    runs.push(new TextRun({ text: opt, size: 26 }));
                    if (idx < options.length - 1) runs.push(new TextRun({ text: "     ", size: 26 }));
                });
                docChildren.push(new Paragraph({
                    children: runs,
                    indent: { left: hangingTwips, hanging: 0 }, // key line
                    spacing: { after: 120 }
                }));
            } else if (options.length === 4 && options.every(opt => opt.length <= 40)) {
                docChildren.push(new Paragraph({
                    children: [
                        new TextRun({ text: options[0], size: 26 }),
                        new TextRun({ text: "           ", size: 26 }),
                        new TextRun({ text: options[1], size: 26 }),
                    ],
                    indent: { left: hangingTwips, hanging: hangingTwips },
                }));
                docChildren.push(new Paragraph({
                    children: [
                        new TextRun({ text: options[2], size: 26 }),
                        new TextRun({ text: "           ", size: 26 }),
                        new TextRun({ text: options[3], size: 26 }),
                    ],
                    indent: { left: hangingTwips, hanging: hangingTwips },
                    spacing: { after: 120 }
                }));
            } else {
                options.forEach(opt => {
                    docChildren.push(new Paragraph({
                        children: [new TextRun({ text: opt, size: 26 })],
                        indent: { left: hangingTwips, hanging: hangingTwips },
                    }));
                });
                docChildren.push(new Paragraph({
                    children: [new TextRun({ text: "", size: 26 })],
                    spacing: { after: 120 }
                }));
            }
        } else {
            docChildren.push(new Paragraph({
                children: [
                    new TextRun({ text: qNo + '. ', bold: true, size: 26 }),
                    new TextRun({ text: lines.join(' '), size: 26 }),
                ],
                indent: { hanging: hangingTwips, left: 0 },
                spacing: { after: 140 }
            }));
        }
        qNo++;
    }

    const doc = new Document({ sections: [{ properties: {}, children: docChildren }] });
    window.docx.Packer.toBlob(doc).then(blob => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "QuestionPaper.docx";
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
            document.body.removeChild(link);
            window.URL.revokeObjectURL(link.href);
        }, 50);
    });
}

// Utility, keep as is:
function dataURLtoArrayBuffer(dataURL) {
    const base64 = dataURL.split(',')[1];
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
    return bytes.buffer;
}

function saveAs(blob, fileName) {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    setTimeout(() => {
        document.body.removeChild(link);
        window.URL.revokeObjectURL(link.href);
    }, 50);
}

// IMPORTANT: This was a bug in your code (must use backticks)
function createDropdownHTML(id, options, defaultValueText = 'All') {
    const optionsHTML = options.map(opt => `<div data-value="${opt}">${opt}</div>`).join('');
    return `
        <input type="hidden" id="${id}-value" value="All">
        <div class="selected-option">${defaultValueText}</div>
        <div class="dropdown-options">
            <div data-value="All">${defaultValueText}</div>
            ${optionsHTML}
        </div>
    `;
}

        function setupDropdowns() {
    const classDropdown = document.getElementById('class-dropdown');
    classDropdown.innerHTML = createDropdownHTML('class', filterConfig.classes, 'Select Class');
    document.getElementById('class-value').value = '';

    const subjectDropdown = document.getElementById('subject-dropdown');
    subjectDropdown.innerHTML = createDropdownHTML('subject', [], 'Select Subject');
    document.getElementById('subject-value').value = '';

    const qtypeDropdown = document.getElementById('qtype-dropdown');
    qtypeDropdown.innerHTML = createDropdownHTML('qtype', filterConfig.questionTypes);

    const chapterDropdown = document.getElementById('chapter-dropdown');
    chapterDropdown.innerHTML = createDropdownHTML('chapter', [], 'Select Chapter');
    document.getElementById('chapter-value').value = '';

    const marksDropdown = document.getElementById('marks-dropdown');
    const marksOptions = filterConfig.marks.map(m => `${m} Mark(s)`);
    marksDropdown.innerHTML = createDropdownHTML('marks', marksOptions);
    const levelDropdown = document.getElementById('level-dropdown');
    levelDropdown.innerHTML = createDropdownHTML('level', filterConfig.levels, 'Select Level');
    addDropdownListener('level-dropdown', fetchAndDisplayQuestions);

    addDropdownListener('class-dropdown', onClassChange);
    addDropdownListener('subject-dropdown', onSubjectChange);
    addDropdownListener('qtype-dropdown', fetchAndDisplayQuestions);
    addDropdownListener('chapter-dropdown', fetchAndDisplayQuestions);
    addDropdownListener('marks-dropdown', fetchAndDisplayQuestions);
}

function addDropdownListener(dropdownId, callback) {
    const dropdown = document.getElementById(dropdownId);
    const input = document.getElementById(`${dropdownId.split('-')[0]}-value`);
    const selectedDisplay = dropdown.querySelector('.selected-option');

    dropdown.querySelector('.selected-option').addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('open');
    });

    dropdown.querySelector('.dropdown-options').addEventListener('click', (e) => {
        if (e.target && e.target.dataset.value) {
            const value = e.target.dataset.value;
            input.value = value;
            selectedDisplay.textContent = value;
            dropdown.classList.remove('open');
            if (callback) callback();
        }
    });
}

function onClassChange() {
    const className = document.getElementById('class-value').value;
    const subjects = className && className !== 'All' ? filterConfig.subjectMappings[className] || [] : [];

    const subjectDropdown = document.getElementById('subject-dropdown');
    subjectDropdown.innerHTML = createDropdownHTML('subject', subjects, 'Select Subject');
    addDropdownListener('subject-dropdown', onSubjectChange);

    const subjectInput = document.getElementById('subject-value');
    const subjectSelected = subjectDropdown.querySelector('.selected-option');
    if (subjects.length > 0) {
        subjectInput.value = subjects[0];
        subjectSelected.textContent = subjects[0];
    } else {
        subjectInput.value = '';
        subjectSelected.textContent = 'Select Subject';
    }
    onSubjectChange();
}

function onSubjectChange() {
    updateChapterDropdown();
    fetchAndDisplayQuestions();
}

async function updateChapterDropdown() {
    const classVal = document.getElementById('class-value').value;
    const subjectVal = document.getElementById('subject-value').value;
    const chapterDropdown = document.getElementById('chapter-dropdown');

    if (!classVal || classVal === 'All' || !subjectVal || subjectVal === 'All') {
        chapterDropdown.innerHTML = createDropdownHTML('chapter', [], 'Select Chapter');
        addDropdownListener('chapter-dropdown', fetchAndDisplayQuestions);
        return;
    }

    try {
        const query = db.collection('questions')
            .where('class', '==', classVal)
            .where('subject', '==', subjectVal);

        const snapshot = await query.get();
        const chapters = new Set();
        snapshot.forEach(doc => {
            if (doc.data().chapter) {
                chapters.add(doc.data().chapter);
            }
        });

        chapterDropdown.innerHTML = createDropdownHTML('chapter', Array.from(chapters));
        addDropdownListener('chapter-dropdown', fetchAndDisplayQuestions);

    } catch (error) {
        console.error("Error fetching chapters: ", error);
    }
}

async function fetchAndDisplayQuestions() {
    if (!currentUser) return;

    const displayArea = document.getElementById('questions-display-area');
    displayArea.innerHTML = '<p class="no-questions-message">Loading questions...</p>';

    try {
        const classVal = document.getElementById('class-value').value;
        const subjectVal = document.getElementById('subject-value').value;
        const qtypeVal = document.getElementById('qtype-value').value;
        const chapterVal = document.getElementById('chapter-value').value;
        const marksVal = document.getElementById('marks-value').value;
        const levelVal = document.getElementById('level-value').value;
        const numericMarks = parseInt(marksVal, 10);

        let query = db.collection('questions');
        if (classVal && classVal !== 'Select Class' && classVal !== 'All') {
            query = query.where('class', '==', classVal);
        }
        if (subjectVal && subjectVal !== 'Select Subject' && subjectVal !== 'All') {
            query = query.where('subject', '==', subjectVal);
        }
        if (chapterVal && chapterVal !== 'Select Chapter' && chapterVal !== 'All') {
            query = query.where('chapter', '==', chapterVal);
        }
        if (levelVal && levelVal !== 'Select Level' && levelVal !== 'All' && levelVal !== 'Mixed') {
            query = query.where('level', '==', levelVal);
        }

        query = query.orderBy("questionNumber");

        const snapshot = await query.get();

        if (snapshot.empty) {
            displayArea.innerHTML = '<p class="no-questions-message">No questions found matching your criteria.</p>';
            return;
        }

        let questionsHTML = '';
        let questionCount = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
         if (Array.isArray(data.options)) {
                console.log("Options for", doc.id, data.options);
            }
            if (marksVal !== 'All') {
                const questionMarks = Number(data.marks);
                if (questionMarks !== numericMarks) {
                    return;
                }
            }
            if (qtypeVal && qtypeVal !== 'All') {
                if (qtypeVal === 'MCQ (Single)') {
                    // Show if marked as MCQ (Single), OR (for old data) exactly 4 options and not marked Multiple
                    if (
                        (data.mcqType && data.mcqType !== 'MCQ (Single)') ||
                        (!data.mcqType && (!Array.isArray(data.options) || data.options.length !== 4))
                    ) return;
                } else if (qtypeVal === 'MCQ (Multiple)') {
                    // Show if marked as MCQ (Multiple)
                    if (data.mcqType !== 'MCQ (Multiple)') return;
                } else if (qtypeVal === 'Descriptive') {
                    // Show if not MCQ (Single) or MCQ (Multiple), OR old data (not 4 options)
                    if (
                        (data.mcqType === 'MCQ (Single)' || data.mcqType === 'MCQ (Multiple)') ||
                        (Array.isArray(data.options) && data.options.length === 4 && (!data.mcqType || data.mcqType === ''))
                    ) return;
                }
            }
            questionCount++;
            questionsHTML += `
            <div class="question-item" data-id="${doc.id}" style="position:relative;">
                <div class="question-meta">
                    ${data.metaLine || `Q${questionCount}: ${data.difficulty || 'N/A'}, ${data.marks || 'N/A'} Mark(s)`}
                    ${(data.mcqType && (data.mcqType === 'MCQ (Single)' || data.mcqType === 'MCQ (Multiple)'))
                      ? `<span style="color:#126c30;font-weight:600;margin-left:10px;">[${data.mcqType}]</span>` : ''}
                </div>
                <div class="question-text">
                   ${
                      Array.isArray(data.options) && data.options.length === 4
                      ? `
                        <div style="font-weight:bold;margin-bottom:0;padding-bottom:0;">${autoLatexAll(data.question)}</div>
                        <div style="margin-left:18px;">
                          <div>${autoLatexAll(data.options[0].replace(/^[A-D][).]\s*/, ''))}</div>
                          <div>${autoLatexAll(data.options[1].replace(/^[A-D][).]\s*/, ''))}</div>
                          <div>${autoLatexAll(data.options[2].replace(/^[A-D][).]\s*/, ''))}</div>
                          <div>${autoLatexAll(data.options[3].replace(/^[A-D][).]\s*/, ''))}</div>
                        </div>
                      `
                      : autoLatexAll(data.body || data.text)
                    }
                   ${data.image
                        ? `<img src="${data.image}">
                           <button type="button" class="delete-img-btn" style="margin-left:12px; color:#c82333; background:none; border:none; cursor:pointer;">‚ùå Delete Image</button>`
                        : ''
                    }
                </div>
                <div class="question-actions">
                    <button class="q-action-btn" title="Options"><i class="fas fa-ellipsis-v"></i></button>
                </div>
                <input type="file" accept="image/*" style="display:none;" class="question-image-input">
                <button type="button" class="question-img-btn">üì∑ Add/Edit Image</button>
            </div>
        `;
        });

        if (questionCount > 0) {
            displayArea.innerHTML = questionsHTML;
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise([displayArea]).catch(function (err) {
                    console.error('MathJax rendering error:', err);
                });
            }
            if (typeof setupQuestionActionMenus === "function") setupQuestionActionMenus();
            document.querySelectorAll('.question-img-btn').forEach(btn => {
                btn.onclick = function() {
                    const container = btn.closest('.question-item');
                    const input = container.querySelector('.question-image-input');
                    input.click();
                };
            });
            document.querySelectorAll('.question-image-input').forEach(input => {
                input.onchange = async function() {
                    const file = input.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        let img = input.closest('.question-item').querySelector('img');
                        if (!img) {
                            img = document.createElement('img');
                            img.style.maxWidth = '100%';
                            img.style.marginTop = '8px';
                            input.closest('.question-item').appendChild(img);
                        }
                        img.src = e.target.result;
                        const docId = input.closest('.question-item').getAttribute('data-id');
                        await db.collection('questions').doc(docId).update({
                            image: e.target.result
                        });
                        alert('Image saved!');
                    };
                    reader.readAsDataURL(file);
                };
            });

            document.querySelectorAll('.delete-img-btn').forEach(btn => {
                btn.onclick = async function() {
                    const container = btn.closest('.question-item');
                    const docId = container.getAttribute('data-id');
                    if (!docId) return;
                    if (!confirm("Delete the image from this question?")) return;
                    try {
                        await db.collection('questions').doc(docId).update({
                            image: firebase.firestore.FieldValue.delete()
                        });
                        fetchAndDisplayQuestions();
                    } catch (err) {
                        alert("Could not delete image: " + err.message);
                    }
                };
            });

             } else {
            displayArea.innerHTML = '<p class="no-questions-message">No questions found matching all filter criteria.</p>';
        }
    } catch (error) {
        console.error("Error fetching questions: ", error);
        displayArea.innerHTML = '<p class="no-questions-message">An error occurred while fetching questions.</p>';
    }
}
        function autoLatexAll(str) {
    if (!str) return '';
    // 1. Find many $...$ in a line and combine
    // Example: $x^2$ + $y^2$ + $z^2$ = 1  --> $x^2 + y^2 + z^2 = 1$
    // Only if there are 2 or more $...$ pairs in a line
    let match = str.match(/(\$[^\$]+\$)/g);
    if (match && match.length >= 2) {
        // Remove all single $ and keep the content
        let joined = str.replace(/\$([^\$]+)\$/g, '$1');
        str = '$' + joined.replace(/\s*\+\s*/g, ' + ') + '$';
    }
    return str;
}
        // --- 3-dot menu actions for each question in Question Bank ---
        
        function setupQuestionActionMenus() {
            document.querySelectorAll('.q-action-btn').forEach((btn, idx) => {
                btn.onclick = function(e) {
                    e.stopPropagation();
        
                    // Remove any other open menu
                    document.querySelectorAll('.actions-menu').forEach(m => m.remove());
        
                    const questionItem = btn.closest('.question-item');
                    const docId = questionItem.getAttribute('data-id');
                    const menu = document.createElement('div');
                    menu.className = 'actions-menu';
        
                    // Build menu
                    menu.innerHTML = `
                        <button class="menu-show-answer-btn">Show Answer</button>
                        <button class="menu-edit-btn">Edit</button>
                        <button class="menu-delete-btn">Delete</button>
                    `;
        
                    // Insert menu
                    questionItem.appendChild(menu);
        
                    // Show Answer
                    menu.querySelector('.menu-show-answer-btn').onclick = async (event) => {
                        event.stopPropagation();
                        // Remove any previous .temp-answer
                        let tempAns = questionItem.querySelector('.temp-answer');
                        if (tempAns) {
                            tempAns.remove();
                            menu.querySelector('.menu-show-answer-btn').textContent = 'Show Answer';
                            menu.remove();
                            return;
                        }
                        // Fetch answer from DB if needed (here using parsedAnswer/answer fields)
                        let answer = '';
                        try {
                            const docSnap = await db.collection('questions').doc(docId).get();
                            const data = docSnap.data();
                            answer = data.parsedAnswer || data.answer || data.parsedAns || 'No answer available.';
                        } catch (e) {
                            answer = 'No answer found.';
                        }
                        const ansDiv = document.createElement('div');
                        ansDiv.className = 'temp-answer';
                        ansDiv.textContent = answer;
                        questionItem.appendChild(ansDiv);
                        menu.querySelector('.menu-show-answer-btn').textContent = 'Hide Answer';
                        if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                            window.MathJax.typesetPromise([ansDiv]);
                        }
                        menu.remove();
                    };
        
                    // Edit
                    menu.querySelector('.menu-edit-btn').onclick = async () => {
                        menu.remove();
                        // Fetch current data
                        const docSnap = await db.collection('questions').doc(docId).get();
                        const data = docSnap.data();
                        showEditPopupForBank(docId, data);
                    };
        
                    // Delete
                    menu.querySelector('.menu-delete-btn').onclick = async () => {
                        menu.remove();
                        if (!confirm("Are you sure you want to delete this question?")) return;
                        await db.collection('questions').doc(docId).delete();
                        fetchAndDisplayQuestions();
                    };
                };
            });
        
            // Hide menu when clicking outside
            document.addEventListener('click', function(event) {
                document.querySelectorAll('.actions-menu').forEach(menu => {
                    if (!menu.contains(event.target) && !event.target.closest('.q-action-btn')) {
                        menu.remove();
                    }
                });
            });
        }
        
        // After displaying questions, always call:
        if (typeof setupQuestionActionMenus === "function") setupQuestionActionMenus();
        
       
        function showEditPopupForBank(docId, data) {
    // Remove any existing edit popups
    document.querySelectorAll('.edit-popup').forEach(p => p.remove());

    const options = Array.isArray(data.options) && data.options.length === 4 ? data.options : ["", "", "", ""];
    const answerVal = data.parsedAnswer || data.answer || "";

    // Modern, mobile-friendly popup
    const popup = document.createElement('div');
    popup.className = 'edit-popup';
    popup.innerHTML = `
        <div style="
            background:#fff;
            border-radius:18px;
            box-shadow:0 6px 24px rgba(23,98,167,0.20);
            padding:28px 18px 18px 18px;
            max-width:95vw;
            width:410px;
            margin:0 auto;
            position:relative;
            font-family:'Segoe UI',Arial,sans-serif;">
            <div style="font-weight:bold;font-size:1.34em;margin-bottom:16px;letter-spacing:0.01em;text-align:center;">Edit Question</div>
            <label style="display:block;margin-bottom:4px;margin-top:2px;font-weight:500;color:#1d5b96;">Question:</label>
            <textarea id="edit-q-text" rows="2" style="width:100%;margin-bottom:13px;padding:7px 8px;border-radius:7px;border:1.2px solid #bdd7f6;font-size:1em;">${data.question || ''}</textarea>
            <div>
                <div style="margin-bottom:9px;">
                    <label style="font-weight:500;color:#1d5b96;">Option A:</label>
                    <input type="text" id="edit-q-optA" value="${options[0] || ''}" style="width:100%;margin-bottom:4px;padding:6px 7px;border-radius:7px;border:1.2px solid #bdd7f6;">
                </div>
                <div style="margin-bottom:9px;">
                    <label style="font-weight:500;color:#1d5b96;">Option B:</label>
                    <input type="text" id="edit-q-optB" value="${options[1] || ''}" style="width:100%;margin-bottom:4px;padding:6px 7px;border-radius:7px;border:1.2px solid #bdd7f6;">
                </div>
                <div style="margin-bottom:9px;">
                    <label style="font-weight:500;color:#1d5b96;">Option C:</label>
                    <input type="text" id="edit-q-optC" value="${options[2] || ''}" style="width:100%;margin-bottom:4px;padding:6px 7px;border-radius:7px;border:1.2px solid #bdd7f6;">
                </div>
                <div>
                    <label style="font-weight:500;color:#1d5b96;">Option D:</label>
                    <input type="text" id="edit-q-optD" value="${options[3] || ''}" style="width:100%;margin-bottom:4px;padding:6px 7px;border-radius:7px;border:1.2px solid #bdd7f6;">
                </div>
            </div>
            <label style="display:block;margin-top:12px;font-weight:500;color:#1d5b96;">Answer (e.g., "A" or "A, C" for multiple correct):</label>
            <input type="text" id="edit-q-answer" value="${answerVal}" style="width:100%;margin-bottom:6px;padding:6px 7px;border-radius:7px;border:1.2px solid #bdd7f6;">
            <div style="display:flex;justify-content:flex-end;gap:16px;margin-top:20px;">
                <button id="edit-cancel" style="background:#eee;border:none;border-radius:6px;padding:8px 17px;font-weight:600;font-size:1em;color:#346799;cursor:pointer;">Cancel</button>
                <button id="edit-save" style="background:#1762a7;border:none;border-radius:6px;padding:8px 17px;font-weight:600;font-size:1em;color:#fff;cursor:pointer;">Save</button>
            </div>
        </div>
    `;
    // Full screen, blur bg
    Object.assign(popup.style, {
        position: 'fixed',
        top: '0', left: '0', width: '100vw', height: '100vh', background: 'rgba(12,29,68,0.12)',
        zIndex: 5000, display: 'flex', alignItems: 'center', justifyContent: 'center'
    });
    document.body.appendChild(popup);

    document.getElementById('edit-cancel').onclick = () => popup.remove();

    document.getElementById('edit-save').onclick = async () => {
        const qText = document.getElementById('edit-q-text').value.trim();
        const optA = document.getElementById('edit-q-optA').value.trim();
        const optB = document.getElementById('edit-q-optB').value.trim();
        const optC = document.getElementById('edit-q-optC').value.trim();
        const optD = document.getElementById('edit-q-optD').value.trim();
        const answer = document.getElementById('edit-q-answer').value.trim();

        if (!qText || !optA || !optB || !optC || !optD || !answer) {
            alert("All fields are required.");
            return;
        }

        await db.collection('questions').doc(docId).update({
            question: qText,
            options: [optA, optB, optC, optD],
            parsedAnswer: answer
        });
        popup.remove();
        fetchAndDisplayQuestions();
    };
}
        // --- Create Practice Quiz Button Handler ---
    document.getElementById('create-quiz-btn').addEventListener('click', async function() {
        // Show spinner overlay
        document.getElementById('quiz-spinner').style.display = 'flex';
    
        try {
            const displayArea = document.getElementById('questions-display-area');
            const nodes = displayArea.querySelectorAll('.question-item');
            if (nodes.length < 1) {
                alert("No questions found for this quiz!");
                document.getElementById('quiz-spinner').style.display = 'none';
                return;
            }
    
            // Build quiz questions array
            const questions = [];
            for (let item of nodes) {
                const docId = item.getAttribute('data-id');
                const snap = await db.collection('questions').doc(docId).get();
                const data = snap.data();
                questions.push({
                    question: data.question,
                    options: data.options,
                    answer: data.parsedAnswer || data.answer || "",
                    level: data.level || ""
                });
            }
    
            // Create quiz doc in Firestore
            const quizDoc = await db.collection('quizzes').add({
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                level: document.getElementById('level-value').value || "Mixed",
                questions: questions
            });
            const quizId = quizDoc.id;
            const quizLink = `${window.location.origin.replace(/\/$/, "")}/quiz.html?quiz=${quizId}`;
            // Build the message
        const classVal = document.getElementById('class-value').value;
        const chapterVal = document.getElementById('chapter-value').value;
        const levelVal = document.getElementById('level-value').value;
        const message = 
        `St. Patrick‚Äôs School Online Quiz Invitation
        
        Dear Student,
        
        You have a new online practice quiz!
        
        - Class: ${classVal}
        - Subject: ${subjectVal}
        - Chapter: ${chapterVal}
        - Level: ${levelVal}
        
        Please click the link below to start your quiz:
        ${quizLink}
        
        Best wishes,
        St. Patrick‚Äôs School
        IIT & NEET Foundation`;
        
        // Remove any old modal
        document.querySelectorAll('.quiz-share-modal').forEach(el => el.remove());
        
        // Create modal HTML
        const modal = document.createElement('div');
        modal.className = 'quiz-share-modal';
        modal.innerHTML = `
          <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(12,29,68,0.12);display:flex;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:28px 22px 18px 22px;border-radius:14px;max-width:94vw;width:410px;box-shadow:0 6px 22px rgba(23,98,167,0.14);display:flex;flex-direction:column;align-items:center;">
              <div style="font-weight:bold;font-size:1.19em;color:#175799;text-align:center;margin-bottom:16px;">Share this message with students</div>
              <textarea id="quiz-share-textarea" style="width:100%;height:210px;font-size:1em;padding:10px 8px;border-radius:8px;border:1.1px solid #bcd6ef;background:#f9fcff;resize:none;margin-bottom:18px;" readonly>${message}</textarea>
              <button id="copy-quiz-message-btn" style="padding:10px 24px;font-size:1em;border:none;border-radius:7px;background:#1762a7;color:#fff;font-weight:600;cursor:pointer;margin-bottom:8px;">Copy</button>
              <button id="close-quiz-message-btn" style="background:#eee;border:none;border-radius:7px;padding:7px 20px;font-weight:500;color:#134579;cursor:pointer;">Close</button>
            </div>
          </div>
        `;
        
        // Add modal to body
        document.body.appendChild(modal);
        
        // Copy functionality
        document.getElementById('copy-quiz-message-btn').onclick = function() {
          const textarea = document.getElementById('quiz-share-textarea');
          textarea.select();
          textarea.setSelectionRange(0, 99999);
          document.execCommand('copy');
          this.textContent = "Copied!";
          setTimeout(() => { this.textContent = "Copy"; }, 1300);
        };
        
        // Close functionality
        document.getElementById('close-quiz-message-btn').onclick = function() {
          modal.remove();
        };

            } catch (err) {
            alert("Quiz creation failed: " + err.message);
        }
    
        // Hide spinner overlay
        document.getElementById('quiz-spinner').style.display = 'none';
    });   
      </script>
    <!-- Quiz Creation Spinner -->
<div id="quiz-spinner" style="
  display:none;
  position:fixed;
  top:0; left:0; width:100vw; height:100vh;
  background:rgba(0, 0, 0, 0.15);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    padding:32px 28px;
    border-radius:18px;
    box-shadow:0 4px 24px #0f3d6b25;
    display:flex;
    flex-direction:column;
    align-items:center;
  ">
    <i class="fa fa-spinner fa-spin" style="font-size:2.6em;color:#1762a7;margin-bottom:12px;"></i>
    <span style="color:#1762a7;font-weight:bold;font-size:1.13em;">Creating Quiz... Please wait</span>
  </div>
</div>
</body>
</html>
