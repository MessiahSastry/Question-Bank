<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Question Generator - Review & Save</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css" />
  <!-- MathJax for math -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script>
    window.MathJax = {
      tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]], },
      svg: { fontCache: "global" },
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    /* --- Additional card and review page styles --- */
    .review-container {
      max-width: 540px;
      margin: 36px auto 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 18px #0f3d6b1b;
      padding: 32px 22px;
    }
    .review-container h2 {
      color: #0f3d6b;
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.5em;
      font-weight: bold;
    }
    label {
      display: block;
      margin-top: 14px;
      margin-bottom: 6px;
      font-weight: 600;
      color: #185496;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1.2px solid #bcd6ef;
      font-size: 1em;
      margin-bottom: 10px;
      box-sizing: border-box;
      background: #f7fafd;
    }
    button, .btn {
      background: #1762a7;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      padding: 12px 0;
      margin-top: 8px;
      margin-bottom: 4px;
      width: 100%;
      transition: background 0.17s;
      letter-spacing: .5px;
    }
    button:disabled, .btn.disabled {
      background: #9bb9db;
      cursor: not-allowed;
    }
    .question-card {
      background: #eaf1fa;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 16px;
      position: relative;
      box-shadow: 0 2px 7px #0f3d6b10;
      animation: fadein .2s;
    }
    @keyframes fadein { from { opacity: 0;} to {opacity: 1;} }
    .question-text {
      white-space: pre-wrap;
      margin-bottom: 7px;
      font-size: 1.08em;
      color: #185496;
    }
    .question-text[contenteditable="true"] {
      outline: 2px solid #1762a7;
      background: #fff;
      cursor: text;
      border-radius: 6px;
      padding: 6px;
    }
    .btn-group {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
    }
    .btn-small {
      background: #0f3d6b;
      font-weight: normal;
      padding: 6px 10px;
      font-size: 0.97em;
      border-radius: 6px;
      border: none;
    }
    .btn-small.copy-btn { background: #2a9d8f; }
    .btn-small.delete-btn { background: #e76f51; }
    .btn-small.edit-btn { background: #f4a261; }
    #output { margin-top: 28px; }
    @media (max-width: 700px) {
      .review-container { padding: 14px 3vw; }
      .review-container h2 { font-size: 1.1em;}
      .question-card { font-size: .97em;}
    }
  </style>
</head>
<body>
  <div class="review-container">
    <h2>AI Question Generator - Review & Save</h2>
    <form id="genForm">
      <label>Class:</label>
      <input name="class" type="text" required />
      <label>Subject:</label>
      <input name="subject" type="text" required />
      <label>Chapter:</label>
      <input name="chapter" type="text" required />
      <label>Prompt (Instructions for questions):</label>
      <textarea name="prompt" rows="4" placeholder="E.g. Prepare 4 easy 4-mark questions, 2 difficult 4-mark questions, 3 one-mark easy questions" required></textarea>
      <button type="submit">Generate</button>
    </form>
    <div id="output"></div>
    <button id="saveAllBtn" class="btn" style="display:none;">Save All Questions</button>
  <div id="context-menu" class="context-menu" style="display:none; position:absolute; z-index:9999;"></div>
  </div>

  <script>
    // --- Firebase Init ---
    if (!firebase.apps.length) {
      const firebaseConfig = {
        apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
        authDomain: "stpatricks-questionbank.firebaseapp.com",
        projectId: "stpatricks-questionbank",
        storageBucket: "stpatricks-questionbank.appspot.com",
        messagingSenderId: "917615322861",
        appId: "1:917615322861:web:c6c890aa2184dd395b8ee4",
      };
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    const outputDiv = document.getElementById("output");
    const saveAllBtn = document.getElementById("saveAllBtn");
    let questions = [];

    function renderQuestions() {
      outputDiv.innerHTML = "";
      questions.forEach((q, idx) => {
        const card = document.createElement("div");
        card.className = "question-card";
        card.dataset.idx = idx;

        const qText = document.createElement("div");
        qText.className = "question-text";
        qText.contentEditable = false;
        qText.innerHTML = `<b>Q${idx + 1}.</b> ${q.text}`;
        card.appendChild(qText);

        const btnGroup = document.createElement("div");
        btnGroup.className = "btn-group";

        // Edit button
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "btn-small edit-btn";
        editBtn.onclick = () => {
          if (qText.contentEditable === "true") {
            qText.contentEditable = false;
            q.text = qText.innerText.replace(/^Q\d+\.\s*/, "").trim();
            editBtn.textContent = "Edit";
            if (window.MathJax) window.MathJax.typesetPromise();
          } else {
            qText.contentEditable = true;
            qText.focus();
            editBtn.textContent = "Save";
          }
        };
        btnGroup.appendChild(editBtn);

        // Copy button
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Copy";
        copyBtn.className = "btn-small copy-btn";
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(q.text).then(() => {
            alert("Question copied to clipboard");
          });
        };
        btnGroup.appendChild(copyBtn);

        // Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "btn-small delete-btn";
        deleteBtn.onclick = () => {
          if (confirm("Are you sure you want to delete this question?")) {
            questions.splice(idx, 1);
            renderQuestions();
            if (questions.length === 0) saveAllBtn.style.display = "none";
          }
        };
        btnGroup.appendChild(deleteBtn);

        card.appendChild(btnGroup);
        outputDiv.appendChild(card);
      });
      if (questions.length > 0) {
        saveAllBtn.style.display = "block";
      } else {
        saveAllBtn.style.display = "none";
      }
      if (window.MathJax) window.MathJax.typesetPromise();
    }

    document.getElementById("genForm").onsubmit = async function(e) {
      e.preventDefault();
      outputDiv.innerHTML = "Generating questions, please wait...";
      saveAllBtn.style.display = "none";
      questions = [];

      const form = e.target;
      const data = {
  class: form.class.value,
  subject: form.subject.value,
  chapter: form.chapter.value,
  prompt: form.prompt.value,
};
const fullPrompt = 
  `Generate questions for class ${data.class}, subject ${data.subject}, chapter "${data.chapter}".\n` +
  `Format each question EXACTLY like this:\n` +
  `Question 1: (Easy, 2 Marks)\nThe question starts from here and can run into a second line if needed.\n\n` +
  `Question 2: (Difficult, 4 Marks)\nThe question starts from here.\n\n` +
  `- Use this format for all questions: 'Question X: (Difficulty, Marks)' on the first line (no extra symbols or Markdown), followed by the question itself starting on the next line.\n` +
  `- Do not use Markdown or extra hashes (###), just plain text as shown.\n` +
  `- The difficulty should match the requested difficulty.\n` +
  (data.prompt && data.prompt.trim() !== "" ? `Instructions/keywords: ${data.prompt}\n` : "") +
  "Only give questions (NO solutions/answers).";
body: JSON.stringify({ prompt: fullPrompt }),
      try {
        const response = await fetch("https://22f773db-8a2d-4142-9ba1-88c12864daa0-00-1civ713u5lhhg.pike.repl.co/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: fullPrompt }),
        });

        const result = await response.json();

        if (result.error) {
          outputDiv.innerHTML = "Error: " + result.error;
          return;
        }

        // Split questions by pattern (e.g., numbered list)
        const items = result.result.split(/\n?\d+\.\s/).filter(Boolean);
        questions = items.map(q => ({ text: q.trim() }));

        renderQuestions();
      } catch (err) {
        outputDiv.innerHTML = "Request failed. " + err;
      }
    };

    saveAllBtn.onclick = async () => {
      if (!auth.currentUser) {
        alert("Please login to save questions.");
        return;
      }
      saveAllBtn.disabled = true;
      saveAllBtn.textContent = "Saving...";
      const userId = auth.currentUser.uid;
      const batch = db.batch();
      questions.forEach((q) => {
        const docRef = db.collection("questions").doc();
        batch.set(docRef, {
          text: q.text,
          createdBy: userId,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });
      });
      try {
        await batch.commit();
        alert("All questions saved successfully!");
        saveAllBtn.textContent = "Save All Questions";
        saveAllBtn.disabled = false;
      } catch (err) {
        alert("Failed to save questions: " + err.message);
        saveAllBtn.textContent = "Save All Questions";
        saveAllBtn.disabled = false;
      }
    };
// ===== CONTEXT MENU FOR QUESTIONS =====

// Utility to detect long press
function longPress(element, callback) {
  let timer = null;
  element.addEventListener("touchstart", start, false);
  element.addEventListener("mousedown", start, false);
  element.addEventListener("touchend", cancel, false);
  element.addEventListener("mouseup", cancel, false);
  element.addEventListener("mouseleave", cancel, false);

  function start(e) {
    e.stopPropagation();
    timer = setTimeout(() => callback(e), 500); // 500ms = long press
  }
  function cancel(e) {
    clearTimeout(timer);
  }
}

// Context menu element
const contextMenu = document.getElementById("context-menu");
let lastQuestionIdx = null;

// Build menu
function showMenu(x, y, idx) {
  lastQuestionIdx = idx;
  contextMenu.innerHTML = `
    <div class="menu-item" data-action="select">Select</div>
    <div class="menu-item" data-action="selectall">Select All</div>
    <div class="menu-item" data-action="copy">Copy</div>
    <div class="menu-item" data-action="edit">Edit</div>
    <div class="menu-item" data-action="delete">Delete</div>
  `;
  contextMenu.style.display = "block";
  contextMenu.style.left = x + "px";
  contextMenu.style.top = y + "px";
}
function hideMenu() {
  contextMenu.style.display = "none";
}

// Attach to each question card after rendering
function attachLongPressToCards() {
  const cards = document.querySelectorAll(".question-card");
  cards.forEach((card, idx) => {
    card.oncontextmenu = e => { e.preventDefault(); }; // Prevent default right-click
    longPress(card, function (e) {
      e.preventDefault();
      let touch = e.touches ? e.touches[0] : e;
      showMenu(touch.clientX || 100, touch.clientY || 100, idx);
    });
  });
}
attachLongPressToCards(); // Initial

// Whenever questions are rendered, re-attach
const oldRenderQuestions = window.renderQuestions;
window.renderQuestions = function() {
  oldRenderQuestions();
  attachLongPressToCards();
};

// Handle menu actions
contextMenu.onclick = function(e) {
  if (!e.target.classList.contains("menu-item")) return;
  const action = e.target.getAttribute("data-action");
  if (lastQuestionIdx == null) return;
  const card = document.querySelectorAll(".question-card")[lastQuestionIdx];
  const q = questions[lastQuestionIdx];
  switch(action) {
    case "select":
      window.getSelection().selectAllChildren(card.querySelector(".question-text"));
      break;
    case "selectall":
      let txt = questions.map(q => q.text).join("\n\n");
      navigator.clipboard.writeText(txt);
      alert("All questions copied!");
      break;
    case "copy":
      navigator.clipboard.writeText(q.text);
      alert("Question copied!");
      break;
    case "edit":
      let qText = card.querySelector(".question-text");
      qText.contentEditable = true;
      qText.focus();
      qText.onblur = () => {
        qText.contentEditable = false;
        questions[lastQuestionIdx].text = qText.innerText.trim();
      };
      break;
    case "delete":
      if (confirm("Delete this question?")) {
        questions.splice(lastQuestionIdx, 1);
        renderQuestions();
      }
      break;
  }
  hideMenu();
};
window.addEventListener("click", hideMenu);
window.addEventListener("scroll", hideMenu);
window.addEventListener("resize", hideMenu);
</script>
</body>
</html>
