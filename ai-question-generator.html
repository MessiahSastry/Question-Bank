<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Question Generator - Prompt Version</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7fafd;
        padding: 40px;
      }
      .container {
        max-width: 420px;<!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8" />
          <title>AI Question Generator - Review & Save</title>
          <style>
            /* --- Basic styles for body and container --- */
            body {
              font-family: Arial, sans-serif;
              background: #f7fafd;
              padding: 40px;
              max-width: 600px;
              margin: auto;
            }
            h2 {
              color: #0f3d6b;
              text-align: center;
              margin-bottom: 20px;
            }
            label {
              display: block;
              margin-top: 14px;
              margin-bottom: 6px;
              font-weight: bold;
            }
            input, textarea {
              width: 100%;
              padding: 8px;
              border-radius: 6px;
              border: 1.2px solid #bcd6ef;
              font-size: 1em;
              margin-bottom: 10px;
              box-sizing: border-box;
            }
            button, .btn {
              background: #1762a7;
              color: #fff;
              border: none;
              border-radius: 8px;
              font-size: 1em;
              font-weight: bold;
              cursor: pointer;
              padding: 10px 14px;
              margin-top: 10px;
              user-select: none;
            }
            button:disabled, .btn.disabled {
              background: #9bb9db;
              cursor: not-allowed;
            }
            #output {
              margin-top: 28px;
            }
            /* --- Question card styles --- */
            .question-card {
              background: #eaf1fa;
              border-radius: 12px;
              padding: 12px 16px;
              margin-bottom: 12px;
              position: relative;
            }
            .question-text {
              white-space: pre-wrap;
              margin-bottom: 6px;
              font-size: 1.05em;
            }
            /* Editable question text styling */
            .question-text[contenteditable="true"] {
              outline: 2px solid #1762a7;
              padding: 6px;
              border-radius: 6px;
              background: #fff;
              cursor: text;
            }
            /* Button group styles on each card */
            .btn-group {
              position: absolute;
              top: 10px;
              right: 10px;
              display: flex;
              gap: 8px;
            }
            /* Small buttons for Edit, Copy, Delete */
            .btn-small {
              background: #0f3d6b;
              font-weight: normal;
              padding: 6px 8px;
              font-size: 0.85em;
              border-radius: 6px;
            }
            .btn-small.copy-btn { background: #2a9d8f; }
            .btn-small.delete-btn { background: #e76f51; }
            .btn-small.edit-btn { background: #f4a261; }
          </style>
          <!-- MathJax for rendering math in questions -->
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
          <script>
            window.MathJax = {
              tex: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]],
              },
              svg: { fontCache: "global" },
            };
          </script>
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
          <!-- Firebase SDKs -->
          <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
          <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
          <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
        </head>
        <body>
          <!-- Page Title -->
          <h2>AI Question Generator - Review & Save</h2>

          <!-- Form inputs for class, subject, chapter and prompt -->
          <form id="genForm">
            <label>Class:</label>
            <input name="class" type="text" required />
            <label>Subject:</label>
            <input name="subject" type="text" required />
            <label>Chapter:</label>
            <input name="chapter" type="text" required />
            <label>Prompt (Instructions for questions):</label>
            <textarea name="prompt" rows="4" placeholder="E.g. Prepare 4 easy 4-mark questions, 2 difficult 4-mark questions, 3 one-mark easy questions" required></textarea>
            <button type="submit">Generate</button>
          </form>

          <!-- Div where generated questions will appear -->
          <div id="output"></div>

          <!-- Save all questions button, initially hidden -->
          <button id="saveAllBtn" class="btn" style="display:none;">Save All Questions</button>

          <script>
            // Initialize Firebase if not already initialized
            if (!firebase.apps.length) {
              const firebaseConfig = {
                apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
                authDomain: "stpatricks-questionbank.firebaseapp.com",
                projectId: "stpatricks-questionbank",
                storageBucket: "stpatricks-questionbank.appspot.com",
                messagingSenderId: "917615322861",
                appId: "1:917615322861:web:c6c890aa2184dd395b8ee4",
              };
              firebase.initializeApp(firebaseConfig);
            }

            const db = firebase.firestore();
            const auth = firebase.auth();

            const outputDiv = document.getElementById("output");
            const saveAllBtn = document.getElementById("saveAllBtn");
            let questions = [];

            // Render questions in UI with Edit, Copy, Delete buttons
            function renderQuestions() {
              outputDiv.innerHTML = "";
              questions.forEach((q, idx) => {
                const card = document.createElement("div");
                card.className = "question-card";
                card.dataset.idx = idx;

                // Question text div
                const qText = document.createElement("div");
                qText.className = "question-text";
                qText.contentEditable = false;
                qText.innerHTML = `<b>Q${idx + 1}.</b> ${q.text}`;
                card.appendChild(qText);

                // Button group div
                const btnGroup = document.createElement("div");
                btnGroup.className = "btn-group";

                // Edit button toggles inline editing
                const editBtn = document.createElement("button");
                editBtn.textContent = "Edit";
                editBtn.className = "btn-small edit-btn";
                editBtn.onclick = () => {
                  if (qText.contentEditable === "true") {
                    qText.contentEditable = false;
                    // Remove the question number prefix before saving
                    q.text = qText.innerText.replace(/^Q\d+\.\s*/, "").trim();
                    editBtn.textContent = "Edit";
                    if (window.MathJax) window.MathJax.typesetPromise();
                  } else {
                    qText.contentEditable = true;
                    qText.focus();
                    editBtn.textContent = "Save";
                  }
                };
                btnGroup.appendChild(editBtn);

                // Copy button copies question text to clipboard
                const copyBtn = document.createElement("button");
                copyBtn.textContent = "Copy";
                copyBtn.className = "btn-small copy-btn";
                copyBtn.onclick = () => {
                  navigator.clipboard.writeText(q.text).then(() => {
                    alert("Question copied to clipboard");
                  });
                };
                btnGroup.appendChild(copyBtn);

                // Delete button deletes question after confirmation
                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "Delete";
                deleteBtn.className = "btn-small delete-btn";
                deleteBtn.onclick = () => {
                  if (confirm("Are you sure you want to delete this question?")) {
                    questions.splice(idx, 1);
                    renderQuestions();
                    if (questions.length === 0) saveAllBtn.style.display = "none";
                  }
                };
                btnGroup.appendChild(deleteBtn);

                card.appendChild(btnGroup);
                outputDiv.appendChild(card);
              });
              if (questions.length > 0) {
                saveAllBtn.style.display = "block";
              } else {
                saveAllBtn.style.display = "none";
              }
              if (window.MathJax) window.MathJax.typesetPromise();
            }

            // On form submit: generate questions via backend
            document.getElementById("genForm").onsubmit = async function(e) {
              e.preventDefault();
              outputDiv.innerHTML = "Generating questions, please wait...";
              saveAllBtn.style.display = "none";
              questions = [];

              const form = e.target;
              const data = {
                class: form.class.value,
                subject: form.subject.value,
                chapter: form.chapter.value,
                prompt: form.prompt.value,
              };
              const fullPrompt = `Generate questions for Class ${data.class}, Subject ${data.subject}, Chapter ${data.chapter}. Instructions: ${data.prompt}. Tag each question with difficulty level and marks.`;

              try {
                const response = await fetch("https://22f773db-8a2d-4142-9ba1-88c12864daa0-00-1civ713u5lhhg.pike.repl.co/generate", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ prompt: fullPrompt }),
                });

                const result = await response.json();

                if (result.error) {
                  outputDiv.innerHTML = "Error: " + result.error;
                  return;
                }

                // Split AI response into questions by numbering pattern
                const items = result.result.split(/\n?\d+\.\s/).filter(Boolean);
                questions = items.map(q => ({ text: q.trim() }));

                renderQuestions();
              } catch (err) {
                outputDiv.innerHTML = "Request failed. " + err;
              }
            };

            // Save all questions to Firestore linked to logged-in user
            saveAllBtn.onclick = async () => {
              if (!auth.currentUser) {
                alert("Please login to save questions.");
                return;
              }
              saveAllBtn.disabled = true;
              saveAllBtn.textContent = "Saving...";
              const userId = auth.currentUser.uid;
              const batch = db.batch();
              questions.forEach((q) => {
                const docRef = db.collection("questions").doc();
                batch.set(docRef, {
                  text: q.text,
                  createdBy: userId,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                });
              });
              try {
                await batch.commit();
                alert("All questions saved successfully!");
                saveAllBtn.textContent = "Save All Questions";
                saveAllBtn.disabled = false;
              } catch (err) {
                alert("Failed to save questions: " + err.message);
                saveAllBtn.textContent = "Save All Questions";
                saveAllBtn.disabled = false;
              }
            };

          </script>
        </body>
        </html>

        margin: auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 16px #0f3d6b20;
        padding: 28px;
      }
      h2 {
        color: #0f3d6b;
        text-align: center;
      }
      label {
        display: block;
        margin-top: 14px;
        margin-bottom: 6px;
      }
      input,
      textarea {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1.2px solid #bcd6ef;
        margin-bottom: 10px;
        font-size: 1em;
      }
      button {
        width: 100%;
        padding: 10px;
        background: #1762a7;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: bold;
        margin-top: 12px;
        cursor: pointer;
      }
      #output {
        margin-top: 28px;
      }
      .question {
        background: #eaf1fa;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
      }
    </style>
    <!-- MathJax for pretty math -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
        },
        svg: { fontCache: "global" },
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  </head>
  <body>
    <div class="container">
      <h2>AI Question Generator</h2>
      <form id="genForm">
        <label>Class:</label>
        <input name="class" type="text" required />
        <label>Subject:</label>
        <input name="subject" type="text" required />
        <label>Chapter:</label>
        <input name="chapter" type="text" required />
        <label>Prompt (Instructions for questions):</label>
        <textarea
          name="prompt"
          rows="5"
          placeholder="E.g. Prepare 4 easy 4-mark questions, 2 difficult 4-mark questions, 3 one-mark easy questions"
          required
        ></textarea>
        <button type="submit">Generate</button>
      </form>
      <div id="output"></div>
    </div>
    <script>
      document.getElementById("genForm").onsubmit = async function (e) {
        e.preventDefault();
        const form = e.target;
        const data = {
          class: form.class.value,
          subject: form.subject.value,
          chapter: form.chapter.value,
          prompt: form.prompt.value,
        };
        const output = document.getElementById("output");
        output.innerHTML = "Generating questions, please wait...";

        // Compose full prompt for backend
        const fullPrompt = `Generate questions for Class ${data.class}, Subject ${data.subject}, Chapter ${data.chapter}. Instructions: ${data.prompt}. Tag each question with difficulty level and marks.`;

        try {
          const response = await fetch("/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: fullPrompt }),
          });
          const result = await response.json();

          if (result.error) {
            output.innerHTML = "Error: " + result.error;
            return;
          }

          let items = result.result.split(/\n?\d+\.\s/).filter(Boolean);
          let html =
            items.length > 1
              ? items
                  .map(
                    (q, i) =>
                      `<div class="question"><b>Q${i + 1}.</b> ${q.trim()}</div>`,
                  )
                  .join("")
              : `<div class="question">${result.result}</div>`;

          output.innerHTML = html;
          if (window.MathJax) window.MathJax.typesetPromise();
        } catch (err) {
          output.innerHTML = "Request failed. " + err;
        }
      };
    </script>
  </body>
</html>
