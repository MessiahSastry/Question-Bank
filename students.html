<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Students - St. Patrick's Progress Card App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    html, body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f8fc; min-height: 100vh; min-width: 100vw; overflow-x: hidden; }
    .fixed-header {
  background: #0f3d6b; 
  color: #fff; 
  text-align: center; 
  padding: 18px 0 8px 0; 
  border-bottom-left-radius: 14px; 
  border-bottom-right-radius: 14px; 
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  width: 100%;
}
    .fixed-header .school-title { color: #fff; font-size: 1.5em; margin: 0; }
    .fixed-header .subtitle { color: #c9e4ff; font-size: .99em; font-weight: 400; margin: 0; }
    .fixed-header #header-exam { font-size: 1.13em; font-weight: bold; color: #fdc600; margin: 6px 0 0 0; }
    .main-content { 
      padding: 18px 10px 80px 10px; 
      max-width: 510px; 
      margin: 0 auto; 
      min-height: 60vh; 
      margin-top: 88px;  /* <-- adjust to your header height (try 70px, 80px, 90px as needed) */
    }
    .screen-title { font-size: 1.4em; font-weight: bold; text-align: left; color: #0f3d6b; margin-bottom: 12px; margin-top: 18px; letter-spacing: 0.5px; }
    .student-list { display: flex; flex-direction: column; gap: 7px; margin-top: 14px; }
    .student-row { background: #fff; border-radius: 12px; padding: 10px 16px; margin-bottom: 0px; box-shadow: 0 1px 5px #0f3d6b15; font-size: 1.09em; font-weight: 500; display: flex; align-items: center; justify-content: flex-start; cursor: pointer; transition: box-shadow .13s; }
    .student-row:hover { box-shadow: 0 2px 10px #0f3d6b25; background: #f7fafd; }
    .roll-no { display: inline-block; min-width: 30px; font-weight: bold; color: #1467b7; }
    .student-faded { color: #999; font-size: 0.96em; margin-left: 10px; }
    .deleted-student { text-decoration: line-through; opacity: 0.5; }
    .fab, .settings-btn { position: fixed; right: 22px; width: 44px; height: 44px; border-radius: 50%; background: #0f3d6b; box-shadow: 0 4px 18px #0f3d6b30; display: flex; align-items: center; justify-content: center; z-index: 104; border: none; cursor: pointer; transition: background 0.18s, box-shadow 0.18s; color: #fff; font-size: 1.75em; }
    .fab { bottom: 30px; }
    .fab:active, .settings-btn:active { background: #195084; box-shadow: 0 2px 8px #0f3d6b44; }
    .fab::before { content: "+"; display: block; font-size: 1.1em; font-weight: bold; color: #fff; line-height: 1; text-align: center; }
    .settings-btn { bottom: 86px; }
    .settings-btn i { color: #fff !important; font-size: 0.95em; pointer-events: none; margin: 0; padding: 0; }
    #popup-bg { position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: #0007; z-index: 2001; display: none; align-items: center; justify-content: center; }
    #popup-bg.show { display: flex !important; }
    #popup-content { background: #fff; border-radius: 15px; box-shadow: 0 8px 30px #0f3d6b22; padding: 22px 18px 18px 18px; min-width: 270px; max-width: 94vw; width: 350px; display: flex; flex-direction: column; gap: 12px; align-items: stretch; }
    .popup-title { font-size: 1.13em; color: #0f3d6b; font-weight: 700; margin-bottom: 9px; }
    #popup-content label { font-weight: 600; color: #195084; margin-bottom: 4px; }
    #popup-content input, #popup-content select { padding: 9px 11px; font-size: 1.07em; border-radius: 7px; border: 1.3px solid #c7d7ea; background: #f7fafd; margin-bottom: 13px; transition: border-color .2s; }
    #popup-content input:focus, #popup-content select:focus { outline: none; border-color: #0f3d6b; }
    .popup-btn-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
    .popup-cancel-btn { background: #e0e0e0; color: #444; font-weight: 500; border: none; border-radius: 8px; padding: 10px 18px; cursor: pointer; transition: background .14s; }
    .popup-action-btn { background: #0f3d6b; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-weight: bold; cursor: pointer; transition: background .14s; }
    .popup-action-btn:hover { background: #195084; }
    .wa-btn { background: #25D366; color: #fff; border: none; border-radius: 6px; font-size: 1em; font-weight: bold; padding: 7px 10px; margin-left: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
    .wa-btn i { font-size: 1.1em; }
    .wa-btn:active { background: #189d44; }
    #popup-content label,
    #popup-content input,
    #popup-content .popup-btn-row {
      display: block !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }
    #popup-content input {
      margin-bottom: 13px !important;
    }
   .custom-dropdown {
  border: 1.4px solid #1467b7;
  border-radius: 7px;
  background: #f7fafd;
  margin-bottom: 15px;
  width: 100%;
  position: relative;
  font-size: 1.09em;
}

.dropdown-selected {
  padding: 13px 14px;
  cursor: pointer;
  user-select: none;
  border-radius: 7px;
}

.dropdown-list {
  position: absolute;
  top: 100%; left: 0; right: 0;
  background: #fff;
  border: 1.2px solid #1467b7;
  border-top: none;
  border-radius: 0 0 7px 7px;
  box-shadow: 0 8px 24px #1467b720;
  z-index: 9;
  max-height: 200px;
  overflow-y: auto;
}

.dropdown-option {
  padding: 13px 14px;
  cursor: pointer;
}

.dropdown-option:hover {
  background: #e3f2fd;
}

.dropdown-selected.disabled {
  color: #b6b6b6 !important;
  background: #f0f0f0 !important;
  pointer-events: none;
}
    .att-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  border-bottom: 1px solid #f2f2f2;
  padding: 10px 0 4px 0;
}
.att-main {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}
.att-name {
  font-weight: 600;
  color: #222;
  font-size: 1em;
  min-width: 110px;
  max-width: 170px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.att-badges {
  display: flex;
  gap: 10px;
  margin-top: 2px;
}
.att-badge {
  padding: 2px 13px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1em;
  display: inline-block;
  border: 1.3px solid #e0e0e0;
}
.att-m-present, .att-a-present { background: #eaf8ea; color: #208c2c; border: 1px solid #70d085;}
.att-m-absent,  .att-a-absent  { background: #fae9e9; color: #d43f3a; border: 1px solid #e48a8a;}
.att-total-box {
  border: 1.5px solid #1762a7;
  border-radius: 8px;
  padding: 5px 18px;
  min-width: 60px;
  font-size: 1.09em;
  background: #f8fcfe;
  text-align: center;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.marks-row {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #f3f3f3;
  padding: 10px 0;
  width: 100%;
}
.roll-name {
  flex: 1;
  min-width: 0;
  color: #1762a7;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 1.08em;
}
.marks-input {
  width: 48px;
  max-width: 55px;
  font-size: 1.13em;
  padding: 4px 5px;
  border-radius: 7px;
  border: 1px solid #bbb;
  background: #f7fafd;
  text-align: right;
  margin-left: 10px;
}
    .call-icon:hover {
  color: #218c53 !important;
  text-decoration: none !important;
}
   
  </style>
</head>
<body>
  <div class="fixed-header" id="header">
    <div class="school-title">St. Patrick's School</div>
    <div class="subtitle">IIT & NEET FOUNDATION</div>
    <div class="subtitle" id="header-exam" style="font-weight:600;"></div>
  </div>
  <div class="main-content" id="main-area"></div>
  <button class="fab" id="fab"></button>
  <button class="settings-btn" id="settings-btn" title="Settings"><i class="fa fa-cog"></i></button>
  <div id="popup-bg"><div id="popup-content"></div></div>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
    function normalizeExamName(name) {
   return name.replace(/[\s\.\-]/g, '').toUpperCase();
}
    // ======================= CONFIG ==============================
    const firebaseConfig = {
      apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
      authDomain: "stpatricks-questionbank.firebaseapp.com",
      projectId: "stpatricks-questionbank",
      storageBucket: "stpatricks-questionbank.appspot.com",
      messagingSenderId: "917615322861",
      appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
    };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();
      const CLASS_GROUP_MAP = {
  'Nursery': 'nursery-lkg-ukg',
  'LKG': 'nursery-lkg-ukg',
  'UKG': 'nursery-lkg-ukg',
  '1st Class': 'class-1-2',
  '2nd Class': 'class-1-2',
  '3rd Class': 'class-3-5',
  '4th Class': 'class-3-5',
  '5th Class': 'class-3-5',
  '6th Class': 'class-6-9',
  '7th Class': 'class-6-9',
  '8th Class': 'class-6-9',
  '9th Class': 'class-6-9',
  '10th Class': 'class-10'
};

function getClassGroupName(className) {
  return CLASS_GROUP_MAP[className] || 'default';
}
      function formatDate(dateStr) {
        // Converts "YYYY-MM-DD" to "DD-MM-YYYY"
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${day}-${month}-${year}`;
      }
            // ======================= GLOBALS =============================
      let academicYear = localStorage.getItem('sp_selectedYear') || '';
      console.log('academicYear raw:', academicYear, 'length:', academicYear.length);
      document.getElementById('header-exam').textContent = academicYear;
      const mainArea = document.getElementById("main-area");
      const popupBg = document.getElementById('popup-bg');
      const popupContent = document.getElementById('popup-content');
      const fab = document.getElementById('fab');
      const settingsBtn = document.getElementById('settings-btn');
      let currentClassId = localStorage.getItem('sp_selectedClassId') || '';
      let currentClassName = localStorage.getItem('sp_selectedClassName') || '';
      let currentSectionId = localStorage.getItem('sp_selectedSectionId') || '';
      let currentSectionName = localStorage.getItem('sp_selectedSectionName') || '';
      
      // --- Only render UI after authentication ---
      let isAdmin = false;
    auth.onAuthStateChanged(function(user) {
      if (user) {
        isAdmin = (user.email === "messiah.sastry@stpatricksschool.com");
        fab.onclick = showAddStudentPopup;
        fab.style.display = "flex";
        settingsBtn.onclick = showSettingsPopup;
        settingsBtn.style.display = "flex";
        renderStudentList();
      } else {
        window.location.replace("index.html"); // redirect to login if not authenticated
      }
    });

    // ======================= MAIN LIST ===========================
    function renderStudentList() {
  if (!currentClassId || !currentSectionId) {
    mainArea.innerHTML = `<div style="color:#e74c3c; margin-top:40px;">Error: Class or Section not selected.</div>`;
    fab.style.display = "none";
    settingsBtn.style.display = "none";
    return;
  }
  const classGroup = getClassGroupName(currentClassName);
  db.collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('students')
    .orderBy('roll')
    .get()
    .then(snap => {
      let students = [];
      snap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
      let html = `<div class="screen-title">${currentClassName} – ${currentSectionName}</div>
        <div class="student-list">`;
      if (students.length === 0) html += `<div style="color:#888;font-style:italic;">No students found.</div>`;
      students.filter(stu => !stu.isDeleted).forEach(stu => {
  html += `<div class="student-row"
    data-student-id="${stu.id}">
    <span class="roll-no">${stu.roll ? stu.roll + '.' : ''}</span>
    <span style="color:#1467b7; font-weight:600;">${stu.name}</span>
    <span style="flex:1"></span>
    ${
      stu.parentPhone
        ? `<a href="tel:${stu.parentPhone.replace(/\D/g, '')}" class="call-icon" title="Call Parent" style="margin-left:14px;color:#27ae60; font-size:1.17em;display:flex;align-items:center;justify-content:center;">
              <i class="fa fa-phone"></i>
          </a>`
        : `<i class="fa fa-phone" style="margin-left:14px;color:#bcbcbc;opacity:0.6; font-size:1.13em;" title="No phone number"></i>`
    }
  </div>`;
});
      html += "</div>";
      mainArea.innerHTML = html;

      document.querySelectorAll('.student-row').forEach(row => {
        let pressTimer = null;
        row.addEventListener('mousedown', startPress);
        row.addEventListener('touchstart', startPress);
        row.addEventListener('mouseup', clearPress);
        row.addEventListener('mouseleave', clearPress);
        row.addEventListener('touchend', clearPress);

        function startPress(e) {
          pressTimer = setTimeout(() => {
            showStudentActionPopup(row.dataset.studentId);
          }, 600);
        }
        function clearPress(e) {
          clearTimeout(pressTimer);
        }
      });
    });
}
    // ===================== POPUP BASE ===========================
    function showPopup(htmlContent, formId = null, formSubmitHandler = null) {
      popupContent.innerHTML = htmlContent;
      popupBg.classList.add('show');
      popupBg.onclick = function(e) {
        if (e.target === popupBg) closePopup();
      };
      if (formId && formSubmitHandler) {
        const form = document.getElementById(formId);
        if (form) form.addEventListener('submit', formSubmitHandler);
      }
      popupContent.querySelectorAll('.popup-cancel-btn').forEach(btn => {
        btn.onclick = function(e) { e.preventDefault(); closePopup(); };
      });
    }
    function closePopup() {
      popupBg.classList.remove("show");
      popupContent.innerHTML = '';
      popupBg.onclick = null;
    }

    // =========== ADD/EDIT STUDENT POPUP =========================
    function showAddStudentPopup() {
      showPopup(`
        <form id="addStudentForm">
        <div class="popup-title">Add Student</div>
        <label>Student Name</label>
        <input name="studentName" maxlength="40" required>
        <label>Father's Name</label>
        <input name="fatherName" maxlength="40" required>
        <label>Roll Number</label>
        <input name="rollNo" type="number" min="1" max="999" required>
        <label>Parent Phone Number</label>
        <input name="parentPhone" type="tel" maxlength="12" required placeholder="e.g., 9876543210" pattern="[0-9]{10,12}">
        <div class="popup-btn-row">
          <button type="button" class="popup-cancel-btn">Cancel</button>
          <button type="submit" class="popup-action-btn">Add</button>
        </div>
      </form>
      `, 'addStudentForm', function (e) {
        e.preventDefault();
        const name = e.target.studentName.value.trim();
        const father = e.target.fatherName.value.trim();
        const roll = parseInt(e.target.rollNo.value.trim(), 10);
        const parentPhone = e.target.parentPhone.value.trim();
        if (!name || !father || isNaN(roll) || !parentPhone) return;
        db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
          .collection('sections').doc(currentSectionId)
          .collection('students')
          .add({ name, father, roll, parentPhone })
          .then(() => { closePopup(); renderStudentList(); });
      });
    }
    function showStudentActionPopup(studentId) {
      db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
        .collection('sections').doc(currentSectionId)
        .collection('students').doc(studentId)
        .get().then(doc => {
          if (!doc.exists) return;
          const stu = doc.data();
          showPopup(`
            <div class="popup-title">Student Actions (${stu.name})</div>
            <div style="display:flex;flex-direction:column;gap:13px;">
              <button class="popup-action-btn" id="editStudentBtn">Edit Student</button>
              ${!stu.isDeleted
                ? `<button class="popup-action-btn" id="deleteStudentBtn">Delete Student</button>`
                : `<button class="popup-action-btn" id="restoreStudentBtn">Restore Student</button>`
              }
              <button class="popup-cancel-btn">Close</button>
            </div>
          `);
          if (document.getElementById('editStudentBtn')) {
            document.getElementById('editStudentBtn').onclick = function () {
              showEditStudentPopup(studentId, stu);
            }
          }
          if (!stu.isDeleted && document.getElementById('deleteStudentBtn')) {
            document.getElementById('deleteStudentBtn').onclick = function () {
              db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
                .collection('sections').doc(currentSectionId)
                .collection('students').doc(studentId)
                .update({ isDeleted: true }).then(() => {
                  closePopup();
                  renderStudentList();
                });
            }
          }
          if (stu.isDeleted && document.getElementById('restoreStudentBtn')) {
            document.getElementById('restoreStudentBtn').onclick = function () {
              db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
                .collection('sections').doc(currentSectionId)
                .collection('students').doc(studentId)
                .update({ isDeleted: firebase.firestore.FieldValue.delete() }).then(() => {
                  closePopup();
                  renderStudentList();
                });
            }
          }
        });
    }
    function showEditStudentPopup(studentId, stu) {
      showPopup(`
        <form id="editStudentForm">
          <div class="popup-title">Edit Student</div>
          <label>Student Name</label>
          <input name="studentName" maxlength="40" required value="${stu.name}">
          <label>Father's Name</label>
          <input name="fatherName" maxlength="40" required value="${stu.father}">
          <label>Roll Number</label>
          <input name="rollNo" type="number" min="1" max="999" required value="${stu.roll}">
          <label>Parent Phone Number</label>
          <input name="parentPhone" maxlength="12" required value="${stu.parentPhone || ''}">
          <div class="popup-btn-row">
            <button type="button" class="popup-cancel-btn">Cancel</button>
            <button type="submit" class="popup-action-btn">Update</button>
          </div>
        </form>
      `, 'editStudentForm', function (e) {
        e.preventDefault();
        const name = e.target.studentName.value.trim();
        const father = e.target.fatherName.value.trim();
        const roll = parseInt(e.target.rollNo.value.trim(), 10);
        const parentPhone = e.target.parentPhone.value.trim();
        db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
          .collection('sections').doc(currentSectionId)
          .collection('students').doc(studentId)
          .update({ name, father, roll, parentPhone })
          .then(() => { closePopup(); renderStudentList(); });
      });
    }
    // ======================= SETTINGS POPUP =====================
    function showSettingsPopup() {
  showPopup(`
    <div class="popup-title">Section Tools</div>
    <div style="display:flex;flex-direction:column;gap:13px;">
      <button class="popup-action-btn" id="uploadStudentsBtn">Upload Students (Excel)</button>
      <button class="popup-action-btn" id="yearPlanBtn">Year Plan</button>
      <button class="popup-action-btn" id="examSettingsBtn">Exam Settings</button>
      <button class="popup-action-btn" id="enterMarksBtn">Enter Marks</button>
      <button class="popup-action-btn" id="attendanceBtn">Take Attendance (WhatsApp)</button>
      <button class="popup-action-btn" id="viewAttendanceBtn">View Attendance</button>
      <button class="popup-action-btn" id="absenteesPDFBtn">Absentees Report (PDF)</button>
      <button class="popup-action-btn" id="downloadMemosBtn">Download Class Marks Memos (PDF)</button>
      <button class="popup-action-btn" id="downloadHallTicketsBtn">Download Hall Tickets</button>
      <button class="popup-action-btn" id="downloadExcelBtn">Download Class Marks (Excel/Pdf)</button>
      <button class="popup-action-btn" id="performanceGraphBtn">Performance Graph</button>
      <button class="popup-action-btn" id="showDeletedBtn">Show Deleted Students</button>
      <button class="popup-cancel-btn">Close</button>
    </div>
  `);
  document.getElementById('uploadStudentsBtn').onclick = showBulkStudentUploadPopup;
  document.getElementById('examSettingsBtn').onclick = showExamSettingsPopup;
  document.getElementById('enterMarksBtn').onclick = showEnterMarksPopup;
  document.getElementById('attendanceBtn').onclick = showAttendancePopup;
  document.getElementById('viewAttendanceBtn').onclick = showAttendanceHistoryPopup;
  document.getElementById('downloadMemosBtn').onclick = function() {
    window.location.href = "memos.html";
  };
  document.getElementById('downloadHallTicketsBtn').onclick = function() {
    window.location.href = "hallticket.html";
  };
  document.getElementById('downloadExcelBtn').onclick = function() {
  window.location.href = "excel.html";
};
  document.getElementById('performanceGraphBtn').onclick = function() {
  window.location.href = "performance.html";
};
  document.getElementById('showDeletedBtn').onclick = showDeletedStudentsPopup;
    document.getElementById('yearPlanBtn').onclick = function() {
    window.location.href = "year-plan.html";
};
  document.getElementById('absenteesPDFBtn').onclick = function() {
  openAbsenteesModal();
};
}
// ========== EXAM SETTINGS ===========
function showExamSettingsPopup() {
  const classGroup = getClassGroupName(currentClassName);
  // Fetch all exams for this group
  db.collection('years').doc(academicYear)
    .collection('exams').doc('classGroups')
    .collection(classGroup)
    .get()
    .then(snap => {
      let exams = [];
      snap.forEach(doc => exams.push({ id: doc.id, ...doc.data() }));
      let html = `
        <div class="popup-title">Exam Settings</div>
        <div id="examListArea" style="max-height:240px;overflow-y:auto;margin-bottom:12px;">
          ${exams.length === 0 
            ? '<div style="color:#888;font-style:italic;">No exams found.</div>' 
            : exams.map((exam, idx) => `
                <div style="border-bottom:1px solid #f1f1f1;margin-bottom:7px;padding-bottom:7px;">
                  <strong>${exam.name}</strong>
                  ${isAdmin ? `<button type="button" class="popup-action-btn" data-edit="${exam.id}" style="margin-left:10px;padding:2px 8px;font-size:0.9em;">Edit</button>` : ''}
                  <div style="margin-top:6px;margin-left:8px;font-size:0.99em;">
                    ${Array.isArray(exam.subjects) && exam.subjects.length > 0
                      ? exam.subjects.map(subj => `${subj.name} <span style="color:#888;">(Max: ${subj.max})</span>`).join(', ')
                      : '<span style="color:#aaa;">No subjects</span>'
                    }
                  </div>
                </div>
              `).join('')}
        </div>
        ${isAdmin ? `
      <form id="addExamForm" style="display:flex; flex-direction:column; max-height:58vh;">
        <div style="flex:1; overflow-y:auto; padding-right:4px;">
          <label>Exam Name</label>
          <input name="examName" maxlength="30" required placeholder="e.g., FA1">
          <label>Subjects</label>
          <div id="subjectsContainer"></div>
          <button type="button" id="addSubjectBtn"
            style="margin:6px 0 14px 0; background:#1762a7;color:#fff;
                   padding:7px 13px;border:none;border-radius:7px;font-weight:600;">
            + Add Subject
          </button>
        </div>
        <div class="popup-btn-row" style="margin-top:10px;">
          <button type="button" class="popup-cancel-btn">Close</button>
          <button type="submit" class="popup-action-btn">Add Exam</button>
        </div>
      </form>
      ` : `
      <div class="popup-btn-row" style="margin-top:10px;">
        <button type="button" class="popup-cancel-btn">Close</button>
      </div>
      `}
      `;
      showPopup(html, 'addExamForm', function (e) {
        e.preventDefault();
        const name = e.target.examName.value.trim();
        const nameKey = normalizeExamName(name); // Normalize for comparison
        let subjects = [];
        const container = popupContent.querySelector('#subjectsContainer');
        if (container) {
          const subjectDivs = container.querySelectorAll('div[data-subject-row]');
          subjectDivs.forEach(div => {
            const subjInput = div.querySelector('input[type="text"]');
            const marksInput = div.querySelector('input[type="number"]');
            const subjName = subjInput ? subjInput.value.trim() : '';
            const maxMarks = marksInput ? parseInt(marksInput.value.trim()) : 0;
            if (subjName && maxMarks) {
              subjects.push({ name: subjName, max: maxMarks });
            }
          });
        }
        if (!name || !subjects.length) {
          alert("Please enter exam name and at least one subject!");
          return;
        }
        // Check for duplicates before adding
        db.collection('years').doc(academicYear)
          .collection('exams').doc('classGroups')
          .collection(classGroup)
          .where('nameKey', '==', nameKey)
          .get()
          .then(dupSnap => {
            if (!dupSnap.empty) {
              alert("Exam with this (or very similar) name already exists!");
              return;
            }
            // If not duplicate, add
            db.collection('years').doc(academicYear)
              .collection('exams').doc('classGroups')
              .collection(classGroup)
              .add({ name, nameKey, subjects })
              .then(() => { closePopup(); showExamSettingsPopup(); });
          });
      });

      // --- Subject Fields Logic ---
      const subjectsContainer = popupContent.querySelector('#subjectsContainer');
      const addSubjectBtn = popupContent.querySelector('#addSubjectBtn');
      function addSubjectField(name = '', max = '') {
        const idx = subjectsContainer.children.length;
        const div = document.createElement('div');
        div.setAttribute("data-subject-row", "");
        div.style = "display:flex;align-items:center;gap:8px;margin-bottom:7px;";
        div.innerHTML = `
         <input type="text" name="subjectName_${idx}" placeholder="Subject Name" value="${name}" required style="width:80%; padding: 8px; border-radius: 6px; border: 1px solid #c7d7ea; background: #f7fafd; margin-right:7px;" />
         <input type="number" name="maxMarks_${idx}" placeholder="Max Marks" min="1" max="200" value="${max}" required style="width:25%; padding: 8px; border-radius: 6px; border: 1px solid #c7d7ea; background: #f7fafd;" />
         ${isAdmin ? `<button type="button" class="option-btn" style="width: 70px; padding: 5px;" onclick="this.parentNode.remove()">Remove</button>` : ''}
        `;
        subjectsContainer.appendChild(div);
      }
      addSubjectBtn.onclick = () => addSubjectField();
      addSubjectField();

      // Attach Edit button handlers
      setTimeout(() => {
        popupContent.querySelectorAll('[data-edit]').forEach(btn => {
          btn.onclick = function() {
            const examId = btn.getAttribute('data-edit');
            closePopup();
            showEditExamPopup(examId);
          };
        });
      }, 200);
    });
}

// ----------- EDIT EXAM -------------
function showEditExamPopup(examId) {
  const classGroup = getClassGroupName(currentClassName);
  db.collection('years').doc(academicYear)
    .collection('exams').doc('classGroups')
    .collection(classGroup).doc(examId)
    .get()
    .then(doc => {
      if (!doc.exists) return alert("Exam not found!");
      const exam = doc.data();
      showPopup(`
        <form id="editExamForm" style="display:flex; flex-direction:column; max-height:75vh;">
      <div style="flex:1; overflow-y:auto; padding-right:4px;">
          <div class="popup-title">Edit Exam</div>
          <label>Exam Name</label>
          <input name="examName" maxlength="30" required value="${exam.name}">
          <label>Subjects</label>
          <div id="editSubjectsContainer"></div>
          <button type="button" id="editAddSubjectBtn"
            style="margin:6px 0 14px 0; background:#1762a7;color:#fff;
                   padding:7px 13px;border:none;border-radius:7px;font-weight:600;">
            + Add Subject
          </button>
          <div class="popup-btn-row" style="margin-top:10px;">
            <button type="button" class="popup-cancel-btn">Cancel</button>
            <button type="submit" class="popup-action-btn">Save Changes</button>
          </div>
        </form>
      `, 'editExamForm', function (e) {
        e.preventDefault();
        const name = e.target.examName.value.trim();
        const nameKey = normalizeExamName(name);
        let subjects = [];
        const container = popupContent.querySelector('#editSubjectsContainer');
        if (container) {
          const subjectDivs = container.querySelectorAll('div[data-subject-row]');
          subjectDivs.forEach(div => {
            const subjInput = div.querySelector('input[type="text"]');
            const marksInput = div.querySelector('input[type="number"]');
            const subjName = subjInput ? subjInput.value.trim() : '';
            const maxMarks = marksInput ? parseInt(marksInput.value.trim()) : 0;
            if (subjName && maxMarks) {
              subjects.push({ name: subjName, max: maxMarks });
            }
          });
        }
        if (!name || !subjects.length) {
          alert("Please enter exam name and at least one subject!");
          return;
        }
        // Check for duplicates (but exclude this examId itself)
        db.collection('years').doc(academicYear)
          .collection('exams').doc('classGroups')
          .collection(classGroup)
          .where('nameKey', '==', nameKey)
          .get()
          .then(dupSnap => {
            let isDuplicate = false;
            if (!dupSnap.empty) {
              dupSnap.forEach(doc => {
                if (doc.id !== examId) isDuplicate = true;
              });
              if (isDuplicate) {
                alert("Another exam with this (or very similar) name already exists!");
                return;
              }
            }
            // If not duplicate, update
            db.collection('years').doc(academicYear)
              .collection('exams').doc('classGroups')
              .collection(classGroup).doc(examId)
              .update({ name, nameKey, subjects })
              .then(() => { 
                closePopup(); 
                showExamSettingsPopup(); 
              });
          });
      });

      // --- Subject Fields Logic for Edit ---
      const subjectsContainer = popupContent.querySelector('#editSubjectsContainer');
      const addSubjectBtn = popupContent.querySelector('#editAddSubjectBtn');
      function addSubjectField(name = '', max = '') {
        const idx = subjectsContainer.children.length;
        const div = document.createElement('div');
        div.setAttribute("data-subject-row", "");
        div.style = "display:flex;align-items:center;gap:8px;margin-bottom:7px;";
        div.innerHTML = `
         <input type="text" name="subjectName_${idx}" placeholder="Subject Name" value="${name}" required style="width:80%; padding: 8px; border-radius: 6px; border: 1px solid #c7d7ea; background: #f7fafd; margin-right:7px;" />
         <input type="number" name="maxMarks_${idx}" placeholder="Max Marks" min="1" max="200" value="${max}" required style="width:25%; padding: 8px; border-radius: 6px; border: 1px solid #c7d7ea; background: #f7fafd;" />
         ${isAdmin ? `<button type="button" class="option-btn" style="width: 70px; padding: 5px;" onclick="this.parentNode.remove()">Remove</button>` : ''}
        `;
        subjectsContainer.appendChild(div);
      }
      if (exam.subjects && Array.isArray(exam.subjects)) {
        exam.subjects.forEach(subj => addSubjectField(subj.name, subj.max));
      }
      addSubjectBtn.onclick = () => addSubjectField();
    });
}

   // ============= ENTER MARKS ===============
function showEnterMarksPopup() {
  console.log('showEnterMarksPopup called');
  console.log('academicYear:', academicYear);
  const classGroup = getClassGroupName(currentClassName);
db.collection('years').doc(academicYear)
  .collection('exams').doc('classGroups')
  .collection(classGroup).orderBy('name').get()
    .then(examSnap => {
      let exams = [];
      examSnap.forEach(doc => exams.push({ id: doc.id, ...doc.data() }));
      if (exams.length === 0) {
        showPopup(`<div class="popup-title">Enter Marks</div>
          <div style="margin:16px 0;">No exams found! Please add exams first.</div>
          <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
        `);
        return;
      }
      let html = `
        <form id="selectExamForm">
          <div class="popup-title">Enter Marks</div>
          <label>Select Exam</label>
          <div class="custom-dropdown" id="examDropdown" tabindex="0">
            <div class="dropdown-selected" id="examSelected" data-value="">--Select--</div>
            <div class="dropdown-list" id="examList" style="display:none;"></div>
          </div>
          <label>Select Subject</label>
          <div class="custom-dropdown" id="subjectDropdown" tabindex="0">
            <div class="dropdown-selected" id="subjectSelected" data-value="">--Select Exam First--</div>
            <div class="dropdown-list" id="subjectList" style="display:none;"></div>
          </div>
          <div class="popup-btn-row">
            <button type="button" class="popup-cancel-btn">Cancel</button>
            <button type="submit" class="popup-action-btn">Next</button>
          </div>
        </form>
      `;
      showPopup(html, 'selectExamForm', function(e) {
        e.preventDefault();
        // Get selected values
        const examId = document.getElementById('examSelected').dataset.value;
        const subjectName = document.getElementById('subjectSelected').dataset.value;
        if (!examId || !subjectName) return;
        db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
          .collection('sections').doc(currentSectionId)
          .collection('students').orderBy('roll').get().then(stuSnap => {
            let students = [];
            stuSnap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
            const exam = exams.find(ex => ex.id === examId);
            const subj = (exam && exam.subjects) ? exam.subjects.find(s => s.name === subjectName) : null;
            const max = subj ? subj.max : 100;
            // --- Begin: Marks Entry Popup Block ---
            let marksData = {};
            let marksPromises = students.map(stu =>
              db.collection('years').doc(academicYear)
                .collection('classes').doc(currentClassId)
                .collection('sections').doc(currentSectionId)
                .collection('students').doc(stu.id)
                .collection('marks').doc(examId)
                .get().then(doc => {
                  if (doc.exists && doc.data()[subjectName] !== undefined) {
                    marksData[stu.id] = doc.data()[subjectName];
                  }
                })
            );
            Promise.all(marksPromises).then(() => {
              let html2 = `
                <form id="marksEntryForm" style="max-height:77vh;overflow-y:auto;">
                  <div class="popup-title">Marks: ${exam.name} – ${subjectName} (Max: ${max})</div>
                  <div style="display:flex;flex-direction:column;gap:8px;">
                    ${
                      students.length === 0
                        ? '<div style="color:#888;font-style:italic;">No students found.</div>'
                        : students.map(stu => `
                      <div class="marks-row">
                      <span class="roll-name">${stu.roll ? stu.roll + '. ' : ''}${stu.name}</span>
                      <input
                        type="number"
                        name="marks_${stu.id}"
                        value="${marksData[stu.id] !== undefined ? marksData[stu.id] : ''}"
                        min="0" max="${max}" step="1"
                        class="marks-input"
                      />
                    </div>
                    `).join('')
                    }
                  </div>
                  <div class="popup-btn-row" style="margin-top:12px;">
                    <button type="button" class="popup-cancel-btn">Cancel</button>
                    <button type="submit" class="popup-action-btn">Save</button>
                  </div>
                </form>
              `;
              showPopup(html2, 'marksEntryForm', function(ev) {
                ev.preventDefault();
                let formData = new FormData(ev.target);
                let batch = db.batch();
                students.forEach(stu => {
                  let marksStr = formData.get('marks_' + stu.id);
                  let marks = (marksStr === "" || marksStr == null) ? null : parseFloat(marksStr);
                  if (marks != null) {
                    let markRef = db.collection('years').doc(academicYear)
                      .collection('classes').doc(currentClassId)
                      .collection('sections').doc(currentSectionId)
                      .collection('students').doc(stu.id).collection('marks').doc(examId);
                    batch.set(markRef, { [subjectName]: marks }, { merge: true });
                  }
                });
                batch.commit().then(() => {
                  alert("Marks saved successfully!");
                  closePopup();
                }).catch(error => alert("Error saving marks: " + error.message));
              });
            });
          });
      });

      // ======= Custom Dropdown Logic for Exam =======
      const examDropdown = document.getElementById('examDropdown');
      const examSelected = document.getElementById('examSelected');
      const examList = document.getElementById('examList');
      const subjectDropdown = document.getElementById('subjectDropdown');
      const subjectSelected = document.getElementById('subjectSelected');
      const subjectList = document.getElementById('subjectList');
      let selectedExam = null;

      // Populate exam dropdown
      examList.innerHTML = exams.map(e => `
        <div class="dropdown-option" data-id="${e.id}" style="padding:10px 12px;cursor:pointer;">
          ${e.name}
        </div>
      `).join('');

      // Exam show/hide
      examSelected.onclick = function () {
        examList.style.display = (examList.style.display === 'none' || examList.style.display === '') ? 'block' : 'none';
      };
      document.addEventListener('click', function handler(e) {
        if (!examDropdown.contains(e.target)) {
          examList.style.display = 'none';
          document.removeEventListener('click', handler);
        }
      });

      // Exam select logic
      examList.querySelectorAll('.dropdown-option').forEach(opt => {
        opt.onclick = function () {
          examSelected.textContent = this.textContent;
          examSelected.dataset.value = this.dataset.id;
          examList.style.display = 'none';
          // Fill subject dropdown
          const ex = exams.find(e => e.id === this.dataset.id);
          selectedExam = ex;
          if (ex && Array.isArray(ex.subjects) && ex.subjects.length > 0) {
            subjectList.innerHTML = ex.subjects.map(s => `<div class="dropdown-option" data-name="${s.name}">${s.name} (Max: ${s.max})</div>`).join('');
            subjectSelected.textContent = '--Select--';
            subjectSelected.dataset.value = '';
            subjectSelected.classList.remove('disabled');
            subjectList.style.display = 'none';
            subjectSelected.style.pointerEvents = '';
          } else {
            subjectList.innerHTML = `<div class="dropdown-option" data-name="">No subjects</div>`;
            subjectSelected.textContent = 'No subjects';
            subjectSelected.dataset.value = '';
            subjectSelected.classList.add('disabled');
            subjectList.style.display = 'none';
            subjectSelected.style.pointerEvents = 'none';
          }
        };
      });

      // Subject show/hide
      subjectSelected.onclick = function () {
        if (!selectedExam || !selectedExam.subjects || !selectedExam.subjects.length) return;
        subjectList.style.display = (subjectList.style.display === 'none' || subjectList.style.display === '') ? 'block' : 'none';
      };
      document.addEventListener('click', function handler(e) {
        if (!subjectDropdown.contains(e.target)) {
          subjectList.style.display = 'none';
          document.removeEventListener('click', handler);
        }
      });

      // Subject select logic
      subjectList.addEventListener('click', function (e) {
        if (e.target.classList.contains('dropdown-option')) {
          subjectSelected.textContent = e.target.textContent;
          subjectSelected.dataset.value = e.target.dataset.name;
          subjectList.style.display = 'none';
        }
      });
    });
}
    // ========== ATTENDANCE + WHATSAPP ===========
    function showAttendancePopup() {
        db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
          .collection('sections').doc(currentSectionId)
          .collection('students').orderBy('roll').get()
          .then(snap => {
            let students = [];
            snap.forEach(doc => { if (!doc.data().isDeleted) students.push({ id: doc.id, ...doc.data() }); });
            // Add: Date selection field, default today
            let today = new Date().toISOString().slice(0, 10);
            let html = `
              <form id="attendanceDateForm">
                <div class="popup-title">Select Date for Attendance</div>
                <label for="attendanceDate">Attendance Date</label>
                <input type="date" id="attendanceDate" name="attendanceDate" value="${today}" max="${today}" required style="font-size:1.13em;margin-bottom:10px;">
                <div class="popup-btn-row" style="margin-top:6px;">
                  <button type="button" class="popup-cancel-btn">Cancel</button>
                  <button type="submit" class="popup-action-btn">Next</button>
                </div>
              </form>
            `;
            showPopup(html, 'attendanceDateForm', function(e){
              e.preventDefault();
              let date = e.target.attendanceDate.value;
              if (!date) return;
              // Now show actual attendance form for that date
              showAttendanceEntryForDate(date, students);
            });
          });
      }
      
      // Helper: actual attendance entry UI for a given date
      function showAttendanceEntryForDate(date, students) {
        db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
          .collection('sections').doc(currentSectionId)
          .collection('attendance').doc(date)
          .get()
          .then(attSnap => {
          let attData = attSnap.exists ? attSnap.data() : {};
          let html = `
          <form id="attendanceForm">
            <div class="popup-title">Take Attendance - ${date}</div>
            <div style="max-height:270px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;">
             ${students.map(stu => {
              let mChecked = attData[stu.id]?.M === 'absent' ? 'checked' : '';
              let aChecked = attData[stu.id]?.A === 'absent' ? 'checked' : '';
              return `
              <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid #f3f3f3;">
                <div style="display: flex; align-items: center; gap: 6px; min-width: 0;">
                  <span style="width:32px; font-weight:600; color:#1762a7; text-align:right;">
                  ${stu.roll ? stu.roll + '.' : ''}
                </span>
                <span style="color:#1762a7; font-weight:600; font-size:1.07em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${stu.name}
                </span>
                </div>
                <div style="display:flex;align-items:center;gap:14px;">
                  <div style="display:flex;flex-direction:column;align-items:center;gap:5px;">
                    <div style="display:flex;gap:14px;">
                      <span style="font-size:0.96em;font-weight:600;">M</span>
                      <span style="font-size:0.96em;font-weight:600;">A</span>
                    </div>
                    <div style="display:flex;gap:14px;">
                     <input type="checkbox" name="absentM_${stu.id}" style="width:22px;height:22px;accent-color:#0f3d6b;" ${mChecked}>
                      <input type="checkbox" name="absentA_${stu.id}" style="width:22px;height:22px;accent-color:#0f3d6b;" ${aChecked}>
                  </div>
                  ${
                    stu.parentPhone
                     ? `<button type="button" class="wa-btn" data-ph="${stu.parentPhone}" data-name="${stu.name}" data-stuid="${stu.id}" style="background:#25D366; width:34px; height:34px; display:none; align-items:center; justify-content:center; border-radius:50%; border:none; padding:0;">
                            <svg viewBox="0 0 32 32" width="21" height="21">
                              <circle cx="16" cy="16" r="16" fill="#25D366"/>
                              <path fill="#fff" d="M21.6,17.9c-0.3-0.2-1.9-0.9-2.2-1c-0.3-0.1-0.5-0.2-0.7,0.2c-0.2,0.3-0.7,1-0.8,1.2
                                c-0.1,0.2-0.3,0.3-0.6,0.1c-0.3-0.2-1.3-0.5-2.4-1.6c-0.9-0.9-1.5-1.9-1.7-2.2c-0.2-0.3,0-0.5,0.2-0.7c0.2-0.2,0.3-0.4,0.5-0.6
                                c0.2-0.2,0.2-0.3,0.3-0.5c0.1-0.2,0-0.4,0-0.6c0-0.2-0.7-1.8-1-2.5c-0.2-0.6-0.4-0.5-0.6-0.5c-0.2,0-0.4,0-0.7,0
                                c-0.2,0-0.5,0.1-0.8,0.4c-0.2,0.3-1,1-1,2.4c0,1.3,1,2.6,1.2,2.8c0.2,0.3,2,3.2,4.9,4.4c0.7,0.3,1.2,0.4,1.7,0.6
                                c0.7,0.2,1.3,0.2,1.8,0.1c0.5-0.1,1.6-0.7,1.8-1.3c0.2-0.6,0.2-1.2,0.1-1.3C22,18.1,21.9,18.1,21.6,17.9z"/>
                              <path fill="#fff" d="M16,6C10,6,5,11,5,17c0,2.1,0.6,4.1,1.7,5.8L5,27l4.3-1.4C11.9,26.4,13.9,27,16,27c6,0,11-5,11-11S22,6,16,6z
                                M16,25c-1.8,0-3.5-0.4-5.1-1.2l-0.4-0.2l-2.6,0.9l0.9-2.6l-0.2-0.4C7.4,19.5,7,18.3,7,17c0-5,4-9,9-9s9,4,9,9S21,25,16,25z"/>
                            </svg>
                      </button>`
                      : ''
                  }
                </div>
              </div>
              `;
            }).join('')}
            </div>
            <div class="popup-btn-row" style="margin-top:16px;">
              <button type="button" class="popup-cancel-btn">Cancel</button>
              <button type="submit" class="popup-action-btn">Save Attendance</button>
            </div>
          </form>
          <div style="font-size:0.95em;color:#387c23;margin-top:8px;">
            Tick M for Morning Absentees, A for Afternoon. WhatsApp will message parent.
          </div>
          `;
          showPopup(html, 'attendanceForm', function(e){
          e.preventDefault();
          let form = e.target;
          // Build attendance object per student: { [stu.id]: {M: 'present'|'absent', A: 'present'|'absent'} }
          let attObj = {};
          students.forEach(stu => {
            let m = form[`absentM_${stu.id}`] && form[`absentM_${stu.id}`].checked ? 'absent' : 'present';
            let a = form[`absentA_${stu.id}`] && form[`absentA_${stu.id}`].checked ? 'absent' : 'present';
            attObj[stu.id] = { M: m, A: a };
          });
          let attDoc = db.collection('years').doc(academicYear)
            .collection('classes').doc(currentClassId)
            .collection('sections').doc(currentSectionId)
            .collection('attendance').doc(date);
          attDoc.set(attObj).then(() => {
            alert("Attendance saved!");
            closePopup();
          });
        });
           // --- Show/Hide WhatsApp icon based on absent checkbox ---
setTimeout(() => {
  students.forEach(stu => {
    const mBox = popupContent.querySelector(`input[name="absentM_${stu.id}"]`);
    const aBox = popupContent.querySelector(`input[name="absentA_${stu.id}"]`);
    const waBtn = popupContent.querySelector(`.wa-btn[data-stuid="${stu.id}"]`);
    function updateWA() {
      if (waBtn) {
        if ((mBox && mBox.checked) || (aBox && aBox.checked)) {
          waBtn.style.display = "flex";
        } else {
          waBtn.style.display = "none";
        }
      }
    }
    if (mBox) mBox.addEventListener("change", updateWA);
    if (aBox) aBox.addEventListener("change", updateWA);
    updateWA();
  });
}, 200);
 // WhatsApp button event (unchanged)
          setTimeout(() => {
            popupContent.querySelectorAll('.wa-btn').forEach(btn => {
              btn.onclick = async function() {
  let ph = btn.dataset.ph.replace(/^0+/, '');
  let name = btn.dataset.name;
  let stuid = btn.dataset.stuid;

  // Fetch all attendance records for this section to count absents
  let attSnap = await db.collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('attendance').get();

  let daysAbsent = 0;
  attSnap.forEach(doc => {
    let data = doc.data()[stuid];
    if (data) {
      let absentM = data.M === 'absent';
      let absentA = data.A === 'absent';
      if (absentM && absentA) {
        daysAbsent += 1;      // full day
      } else if (absentM || absentA) {
        daysAbsent += 0.5;    // half day
      }
    }
  });

  let daysAbsentStr = (Math.round(daysAbsent * 10) / 10).toString();

  let msg = encodeURIComponent(
  `*Dear Parent,*\n\n` +
  `Your child *${name}* is absent today at school. Kindly send reason for absence. *${name}* has been absent for ${daysAbsentStr} day(s) so far this academic year.\n\n` + 
  `*${name}* ఈ రోజు స్కూల్‌కు హాజరు కాలేదు. హాజరు కాకపోవడానికి గల కారణం తెలియజేయగలరు. ఇప్పటి వరకు మొత్తం ${daysAbsentStr} రోజులు అబ్సెంట్ అయ్యారు.\n\n` +
  `Thank you\n` +
  `*St. Patrick's School*`
);
  window.open(`https://wa.me/91${ph}?text=${msg}`,'_blank');
}

            });
          }, 400);
    });
}
    function showAttendanceHistoryPopup() {
  // Get attendance docs for this section
  db.collection('years').doc(academicYear)
    .collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('attendance').orderBy(firebase.firestore.FieldPath.documentId()).get()
    .then(snap => {
      if (snap.empty) {
        showPopup(`<div class="popup-title">Attendance History</div>
          <div style="color:#888;">No attendance records found.</div>
          <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
        `);
        return;
      }
     let dates = [];
        snap.forEach(doc => dates.push(doc.id));
        
        // Extract unique years and months
        let monthsSet = new Set(), yearsSet = new Set();
        dates.forEach(d => {
          let [y, m] = d.split('-');
          yearsSet.add(y);
          monthsSet.add(m);
        });
        let months = Array.from(monthsSet).sort();
        let years = Array.from(yearsSet).sort();
        let today = new Date();
        let defaultYear = today.getFullYear().toString();
        let defaultMonth = (today.getMonth() + 1).toString().padStart(2, '0');
        
        // Initial selected month/year
        let selectedYear = defaultYear;
        let selectedMonth = defaultMonth;
        
        // Build selects
        function buildMonthYearDropdown(selectedMonth, selectedYear) {
  return `
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px;">
      <!-- Month Dropdown -->
      <div class="custom-dropdown" id="monthDropdown">
        <div class="dropdown-selected" id="monthSelected">${monthName(selectedMonth)}</div>
        <div class="dropdown-list" id="monthList" style="display:none;">
          ${months.map(m => `<div class="dropdown-option" data-value="${m}">${monthName(m)}</div>`).join('')}
        </div>
      </div>
      <!-- Year Dropdown -->
      <div class="custom-dropdown" id="yearDropdown">
        <div class="dropdown-selected" id="yearSelected">${selectedYear}</div>
        <div class="dropdown-list" id="yearList" style="display:none;">
          ${years.map(y => `<div class="dropdown-option" data-value="${y}">${y}</div>`).join('')}
        </div>
      </div>
    </div>
  `;
}

        function monthName(m) {
          return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1];
        }
        
        // Function to filter and show dates
        function showFilteredDates(selectedMonth, selectedYear) {
          let filteredDates = dates.filter(d => d.startsWith(selectedYear + '-' + selectedMonth));
          filteredDates.sort((a, b) => b.localeCompare(a));
          let listHtml = filteredDates.length === 0
            ? `<div style="color:#888;padding:14px 0;text-align:center;">No attendance found for this month.</div>`
            : filteredDates.map(date => `<button class="popup-action-btn" data-date="${date}" style="padding:8px 12px;font-size:1em;">${formatDate(date)}</button>`).join('');
          popupContent.querySelector('#datesList').innerHTML = listHtml;
        
          // --- ADD THIS: attach click event for new date buttons ---
          popupContent.querySelectorAll('.popup-action-btn[data-date]').forEach(btn => {
            btn.onclick = () => showAttendanceForDate(btn.dataset.date);
          });
        }
         // Initial HTML
        let html = `
          <div class="popup-title">Attendance Dates</div>
          ${buildMonthYearDropdown(selectedMonth, selectedYear)}
          <button id="downloadExcelBtn" style="margin-bottom:10px;padding:6px 16px;background:#2b8e32;color:#fff;border:none;border-radius:6px;float:right;">Download Excel</button>
          <div id="datesList" style="clear:both;max-height:269px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;margin-bottom:10px;"></div>
          <div class="popup-btn-row"><button class="popup-cancel-btn">close</button></div>
        `;
          showPopup(html);
          setTimeout(() => {
            const excelBtn = document.getElementById('downloadExcelBtn');
          if (!excelBtn) return;
          excelBtn.onclick = async function () {
            // Get month & year from selectors
            const month = (() => {
            const m = popupContent.querySelector('#monthSelected');
            return m && m.textContent ? months.find(mm => monthName(mm) === m.textContent) : '';
          })();
          const year = (() => {
            const y = popupContent.querySelector('#yearSelected');
            return y && y.textContent ? y.textContent : '';
          })();
            // Get all students
            let stuSnap = await db.collection('years').doc(academicYear)
              .collection('classes').doc(currentClassId)
              .collection('sections').doc(currentSectionId)
              .collection('students').orderBy('roll').get();
            let students = [];
            stuSnap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
          
            // Get all attendance docs
            let attSnap = await db.collection('years').doc(academicYear)
              .collection('classes').doc(currentClassId)
              .collection('sections').doc(currentSectionId)
              .collection('attendance').get();
          
            // Filter attendance by selected month, get unique dates sorted
            let days = [];
            attSnap.forEach(doc => {
              let d = doc.id; // "YYYY-MM-DD"
              if (d.startsWith(`${year}-${month}`)) days.push(d);
            });
            days.sort();
          
            // Build headers for date/M/A
            let titleRow = [`${currentClassName} ${currentSectionName} (Jun ${year})`];
            // Merge this cell across columns in Excel
            let headerRow = ['Roll', 'Name'];
            let subHeaderRow = ['', ''];
            days.forEach(d => {
              let dayNum = d.split('-')[2];
              headerRow.push(dayNum, '');
              subHeaderRow.push('M', 'A');
            });
          
            // Prepare data rows
            let data = [titleRow, headerRow, subHeaderRow];
            students.forEach(stu => {
              let row = [stu.roll, stu.name];
              days.forEach(d => {
                // Default to present if attendance not found
                let attData = attSnap.docs.find(doc => doc.id === d)?.data() || {};
                let statusM = attData[stu.id]?.M === 'absent' ? 'Ab' : 'X';
                let statusA = attData[stu.id]?.A === 'absent' ? 'Ab' : 'X';
                row.push(statusM, statusA);
              });
              data.push(row);
            });
          
            // Export to Excel (SheetJS community)
            let ws = XLSX.utils.aoa_to_sheet(data);
            // Merge the top row
            ws['!merges'] = [{s:{r:0,c:0}, e:{r:0,c:headerRow.length-1}}];
            // Set compact column width
            ws['!cols'] = [{ wch: 5 }, { wch: 18 }, ...Array(days.length * 2).fill({ wch: 3 })];
          
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance");
            XLSX.writeFile(wb, `Attendance_${year}-${month}_${currentSectionName}.xlsx`);
          };
          }, 500);
                  
        // Initial render
        showFilteredDates(selectedMonth, selectedYear);
        
        // Add change listeners for custom dropdowns
setTimeout(() => {
  // MONTH DROPDOWN
  const monthDropdown = popupContent.querySelector('#monthDropdown');
  const monthSelected = popupContent.querySelector('#monthSelected');
  const monthList = popupContent.querySelector('#monthList');
  if (monthDropdown && monthSelected && monthList) {
    monthSelected.onclick = function () {
      monthList.style.display = monthList.style.display === 'block' ? 'none' : 'block';
    };
    monthList.querySelectorAll('.dropdown-option').forEach(opt => {
      opt.onclick = function () {
        monthSelected.textContent = this.textContent;
        selectedMonth = this.dataset.value;
        monthList.style.display = 'none';
        showFilteredDates(selectedMonth, selectedYear);
      }
    });
    document.addEventListener('click', function handler(e){
      if (!monthDropdown.contains(e.target)) monthList.style.display = 'none';
    });
  }

  // YEAR DROPDOWN
  const yearDropdown = popupContent.querySelector('#yearDropdown');
  const yearSelected = popupContent.querySelector('#yearSelected');
  const yearList = popupContent.querySelector('#yearList');
  if (yearDropdown && yearSelected && yearList) {
    yearSelected.onclick = function () {
      yearList.style.display = yearList.style.display === 'block' ? 'none' : 'block';
    };
    yearList.querySelectorAll('.dropdown-option').forEach(opt => {
      opt.onclick = function () {
        yearSelected.textContent = this.textContent;
        selectedYear = this.dataset.value;
        yearList.style.display = 'none';
        showFilteredDates(selectedMonth, selectedYear);
      }
    });
    document.addEventListener('click', function handler(e){
      if (!yearDropdown.contains(e.target)) yearList.style.display = 'none';
    });
  }

  // Button click to show that day's attendance
  popupContent.querySelectorAll('.popup-action-btn[data-date]').forEach(btn => {
    btn.onclick = () => showAttendanceForDate(btn.dataset.date);
  });
}, 200);
        
        // Utility
        function formatDate(dateStr) {
          if (!dateStr) return '';
          const [y, m, d] = dateStr.split('-');
          return `${d}-${m}-${y}`;
        }
         // Add event handlers for each date button
      setTimeout(() => {
        popupContent.querySelectorAll('button[data-date]').forEach(btn => {
          btn.onclick = function() {
            showAttendanceForDate(this.getAttribute('data-date'));
          }
        });
      }, 100);
    });
}
function showDeletedStudentsPopup() {
  db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId)
    .collection('students').orderBy('roll').get()
    .then(snap => {
      let students = [];
snap.forEach(doc => {
  let data = doc.data();
  // Accepts true, "true", or 1 as deleted (for safety)
  if (data.isDeleted === true || data.isDeleted === "true" || data.isDeleted === 1) {
    students.push({ id: doc.id, ...data });
  }
});
let html = `
  <div class="popup-title">Deleted Students</div>
        <div style="max-height:350px;overflow-y:auto;">
          ${
            students.length === 0
              ? `<div style="color:#888;text-align:center;">No deleted students.</div>`
              : students.map(stu => `
                <div style="padding: 14px 0; border-bottom: 1px solid #f3f3f3;">
                  <div style="font-weight:bold; font-size:1.12em; margin-bottom: 6px; text-align:left;">
                    <span style="color:#d43f3a;">${stu.roll ? stu.roll + '. ' : ''}${stu.name}</span>
                  </div>
                  <div style="display:flex; gap:16px; justify-content:center;">
                    <button class="popup-action-btn" style="background:#26bb5a; min-width:115px;" data-restore="${stu.id}">Restore</button>
                    <button class="popup-action-btn" style="background:#d43f3a; min-width:160px;" data-delete="${stu.id}">Delete Permanently</button>
                  </div>
                </div>
              `).join('')
          }
        </div>
        <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
      `;
      showPopup(html);

      // Attach restore handlers
      popupContent.querySelectorAll('button[data-restore]').forEach(btn => {
        btn.onclick = function() {
          const id = btn.getAttribute('data-restore');
          db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
            .collection('sections').doc(currentSectionId)
            .collection('students').doc(id)
            .update({ isDeleted: firebase.firestore.FieldValue.delete() })
            .then(() => {
              showDeletedStudentsPopup(); // Refresh the list
              renderStudentList(); // Refresh main list if open
            });
        }
      });
      // Attach permanent delete handlers
      popupContent.querySelectorAll('button[data-delete]').forEach(btn => {
        btn.onclick = function() {
          const id = btn.getAttribute('data-delete');
          if (!confirm("Are you sure you want to permanently delete this student? This cannot be undone!")) return;
          db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
            .collection('sections').doc(currentSectionId)
            .collection('students').doc(id)
            .delete()
            .then(() => {
              showDeletedStudentsPopup(); // Refresh the list
              renderStudentList(); // Refresh main list if open
            });
        }
      });
    });
}
// View attendance for one date
function showAttendanceForDate(date) {
  // Load student list
  db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
    .collection('sections').doc(currentSectionId).collection('students').orderBy('roll').get()
    .then(stuSnap => {
      let students = [];
      stuSnap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));

      // Load all attendance docs for absence counts
      db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
        .collection('sections').doc(currentSectionId).collection('attendance').get()
        .then(allAttSnap => {
          let attDataByDate = {};
          let totalDays = 0;
          allAttSnap.forEach(d => {
            attDataByDate[d.id] = d.data();
            totalDays++;
          });

          // Load this date’s attendance
          db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
            .collection('sections').doc(currentSectionId).collection('attendance').doc(date).get()
            .then(attSnap => {
              let att = attSnap.data() || {};

              let html = `<div class="popup-title">Attendance: ${formatDate(date)}</div>
                <div style="max-height:290px;overflow-y:auto;">`;

              students.forEach(stu => {
  let daysAbsent = 0;
  let totalDays = Object.keys(attDataByDate).length;
  for (let d in attDataByDate) {
    let st = attDataByDate[d][stu.id] || {};
    const absentM = st.M === 'absent';
    const absentA = st.A === 'absent';
    if (absentM && absentA) {
      daysAbsent += 1;           // Full day absent
    } else if (absentM || absentA) {
      daysAbsent += 0.5;         // Half day absent
    }
  }
  // Format daysAbsent to show .5 if needed, else as integer
  let daysAbsentStr = daysAbsent % 1 === 0 ? daysAbsent.toString() : daysAbsent.toFixed(1);

  let stat = att[stu.id] || {};
  let statM = (stat.M || 'present').toLowerCase();
  let statA = (stat.A || 'present').toLowerCase();
  let badgeM = `<span class="att-badge att-m-${statM}">M: ${statM === 'absent' ? 'Ab' : 'Pr'}</span>`;
  let badgeA = `<span class="att-badge att-a-${statA}">A: ${statA === 'absent' ? 'Ab' : 'Pr'}</span>`;
  let totalBox = `<span class="att-total-box">${daysAbsentStr} / ${totalDays}</span>`;
  html += `
    <div class="att-row">
      <div class="att-main">
        <span class="att-name">${stu.roll ? stu.roll + '. ' : ''}${stu.name}</span>
        <div class="att-badges">
          ${badgeM}
          ${badgeA}
        </div>
      </div>
      ${totalBox}
    </div>
  `;
});
              html += `</div>
                <div class="popup-btn-row"><button class="popup-cancel-btn">Close</button></div>
              `;
              showPopup(html);
              // --- Modern Dropdown JS for Month & Year (Attendance History) ---
              setTimeout(() => {
                // MONTH DROPDOWN
                const monthDropdown = popupContent.querySelector('#monthDropdown');
                const monthSelected = popupContent.querySelector('#monthSelected');
                const monthList = popupContent.querySelector('#monthList');
                if(monthDropdown) {
                  monthSelected.onclick = function () {
                    monthList.style.display = monthList.style.display === 'block' ? 'none' : 'block';
                  };
                  monthList.querySelectorAll('.dropdown-option').forEach(opt => {
                    opt.onclick = function () {
                      monthSelected.textContent = this.textContent;
                      selectedMonth = this.dataset.value;
                      monthList.style.display = 'none';
                      showFilteredDates(selectedMonth, selectedYear);
                    }
                  });
                  document.addEventListener('click', function handler(e){
                    if (!monthDropdown.contains(e.target)) monthList.style.display = 'none';
                  });
                }
                // YEAR DROPDOWN
                const yearDropdown = popupContent.querySelector('#yearDropdown');
                const yearSelected = popupContent.querySelector('#yearSelected');
                const yearList = popupContent.querySelector('#yearList');
                if(yearDropdown) {
                  yearSelected.onclick = function () {
                    yearList.style.display = yearList.style.display === 'block' ? 'none' : 'block';
                  };
                  yearList.querySelectorAll('.dropdown-option').forEach(opt => {
                    opt.onclick = function () {
                      yearSelected.textContent = this.textContent;
                      selectedYear = this.dataset.value;
                      yearList.style.display = 'none';
                      showFilteredDates(selectedMonth, selectedYear);
                    }
                  });
                  document.addEventListener('click', function handler(e){
                    if (!yearDropdown.contains(e.target)) yearList.style.display = 'none';
                  });
                }
              }, 300);
            });
        });
    });
}
// Helper to show date as DD-MM-YYYY
function formatDate(dateStr) {
  if (!dateStr) return '';
  const [y, m, d] = dateStr.split('-');
  return `${d}-${m}-${y}`;
}
    function showBulkStudentUploadPopup() {
  showPopup(`
    <div class="popup-title">Upload Students (Excel)</div>
    <input type="file" id="studentFileInput" accept=".xlsx,.csv" style="margin-bottom:15px;" />
    <div style="font-size:0.97em; color:#555; margin-bottom:10px;">
      Please upload an Excel (.xlsx) or CSV file with columns: <b>Roll, Name, Father, ParentPhone</b>.
    </div>
    <div class="popup-btn-row">
      <button type="button" class="popup-cancel-btn">Cancel</button>
      <button type="button" class="popup-action-btn" id="doBulkUploadBtn">Upload</button>
    </div>
  `);

  document.getElementById('doBulkUploadBtn').onclick = function() {
    const fileInput = document.getElementById('studentFileInput');
    if (!fileInput.files.length) {
      alert('Please select a file!');
      return;
    }
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      let data = new Uint8Array(e.target.result);
      let workbook = XLSX.read(data, {type: 'array'});
      let sheet = workbook.Sheets[workbook.SheetNames[0]];
      let rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval: ''});
      let headers = rows[0].map(x => x.toString().toLowerCase().trim());
      let nameIdx = headers.findIndex(h => h === 'name');
      let rollIdx = headers.findIndex(h => h === 'roll');
      let fatherIdx = headers.findIndex(h => h === 'father');
      let phoneIdx = headers.findIndex(h => h.includes('phone'));
      if (nameIdx < 0 || rollIdx < 0 || fatherIdx < 0) {
        alert('Excel must have headers: Roll, Name, Father, ParentPhone');
        return;
      }
      let students = [];
      for (let i=1; i<rows.length; i++) {
        let row = rows[i];
        if (!row[nameIdx]) continue;
        students.push({
          name: row[nameIdx].toString().trim(),
          father: row[fatherIdx].toString().trim(),
          roll: parseInt(row[rollIdx]),
          parentPhone: phoneIdx >= 0 ? row[phoneIdx].toString().trim() : ""
        });
      }
      if (students.length === 0) {
        alert('No valid students found!');
        return;
      }
      // Upload students in batch
      let batch = db.batch();
      let sectionRef = db.collection('years').doc(academicYear).collection('classes').doc(currentClassId)
        .collection('sections').doc(currentSectionId).collection('students');
      students.forEach(stu => {
        let ref = sectionRef.doc();
        batch.set(ref, stu);
      });
      batch.commit().then(() => {
        alert("All students uploaded!");
        closePopup();
        renderStudentList();
      }).catch(e => {
        alert("Error uploading students: " + e.message);
      });
    };
    reader.readAsArrayBuffer(file);
  }
}
    // ---- Absentees Modal Open/Close ----
function openAbsenteesModal() {
  document.getElementById('absenteesModalBg').style.display = 'flex';
  document.getElementById('absenteesIframe').src = 'absentees-report.html';
}

function closeAbsenteesModal() {
  document.getElementById('absenteesModalBg').style.display = 'none';
  document.getElementById('absenteesIframe').src = '';
}

  </script>
  <!-- Absentees Report Modal -->
<div id="absenteesModalBg" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:#0007;z-index:2003;align-items:center;justify-content:center;">
  <div id="absenteesModalContent" style="background:#fff;border-radius:16px;box-shadow:0 8px 30px #0f3d6b22;padding:0;min-width:320px;max-width:97vw;width:780px;display:flex;flex-direction:column;gap:0;align-items:stretch;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 24px 10px 18px;">
      <span style="font-size:1.23em;font-weight:700;color:#0f3d6b;">Absentees Report</span>
      <button id="closeAbsenteesModal" style="background:none;border:none;font-size:1.55em;color:#0f3d6b;cursor:pointer;padding:0 8px;">&times;</button>
    </div>
    <iframe id="absenteesIframe" src="" style="border:none;width:100%;height:75vh;border-radius:0 0 16px 16px;"></iframe>
  </div>
</div>
  <script>
  document.getElementById('closeAbsenteesModal').onclick = closeAbsenteesModal;
  document.getElementById('absenteesModalBg').onclick = function(e) {
    if (e.target === this) closeAbsenteesModal();
  };
</script>
</body>
</html>
