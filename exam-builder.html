<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <meta charset="UTF-8" />
    <title>Exam Builder - Multi Subject | St. Patrick's School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        :root {
            --primary-blue: #0f3d6b;
            --secondary-blue: #1762a7;
            --light-blue-bg: #f4f8fc;
            --border-color: #bcd6ef;
            --text-dark: #12416c;
            --text-light: #54656f;
        }
        html { height: -webkit-fill-available; }
        body {
            margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f8fc;
            height: 100vh; height: -webkit-fill-available;
        }
        body::after {
            content: "St. Patrick's\A IIT & NEET FOUNDATION";
            white-space: pre; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 5vw; font-weight: bold;
            color: rgba(15, 61, 107, 0.04); z-index: -1; text-align: center;
            pointer-events: none; line-height: 1.2;
        }
        .page-wrapper { display: flex; flex-direction: column; height: 100vh; }
        #main-header {
            background: linear-gradient(90deg, #1762a7, #0f3d6b);
            color: #fff; border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
            min-height: 60px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 15px 10px 18px 10px;
            box-sizing: border-box; flex-shrink: 0; position: sticky; top: 0; z-index: 10;
        }
        #main-header .school-title { font-size: 1.8em; font-weight: bold; margin: 0;}
        #main-header .subtitle { font-size: 1.05em; color: #e0eaff; margin-top: 5px; }
        main {
            flex: 1 1 0%;
            min-height: 0;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .setup-form-container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto 20px auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 18px rgba(0, 27, 68, 0.1);
            padding: 25px 16px;
            flex-shrink: 0;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        .setup-form-container h2 { text-align: center; color: var(--primary-blue); margin-top: 0; margin-bottom: 25px; }
        #exam-setup-form h3 {
            margin-top: 25px; margin-bottom: 15px;
            color: var(--secondary-blue); border-bottom: 2px solid #e0eaff; padding-bottom: 10px;
            font-size: 1.2em; display: flex; align-items: center; gap: 10px;
        }
        #exam-setup-form h3:first-of-type { margin-top: 0; }
        .form-grid-1-col, .form-grid-2-col { display: grid; gap: 15px; }
        .form-grid-1-col { grid-template-columns: 1fr; }
        .form-grid-2-col { grid-template-columns: 1fr 1fr; }
        @media (max-width: 600px) {
            main { padding-top: 20px; }
            .form-grid-2-col { grid-template-columns: 1fr; }
        }
        .form-group { margin-bottom: 0; }
        .form-group label {
            font-weight: 600; margin-bottom: 5px;
            color: #185496; display: block;
        }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="date"],
        .form-group textarea, .custom-dropdown .selected-option {
            width: 100%; padding: 10px 12px; border-radius: 6px;
            border: 1.3px solid #bcd6ef; font-size: 1em; background: #f7fafd;
            box-sizing: border-box; height: 42px;
        }
        .form-group textarea { height: auto; min-height: 80px; }
        .custom-dropdown { position: relative; }
        .custom-dropdown .selected-option { cursor: pointer; }
        .dropdown-options {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1.3px solid #bcd6ef; border-top: none;
            border-radius: 0 0 6px 6px; box-shadow: 0 6px 15px rgba(0, 27, 68, 0.1);
            z-index: 1000; max-height: 200px; overflow-y: auto;
        }
        .custom-dropdown.open .dropdown-options { display: block; }
        .dropdown-options div[data-value] { padding: 10px 15px; cursor: pointer; }
        .dropdown-options div[data-value]:hover { background: #e0eaff; }
        .multi-select-dropdown .dropdown-options div { display: flex; align-items: center; padding: 10px 15px; }
        .multi-select-dropdown .dropdown-options div:hover { background: #e0eaff; }
        .multi-select-dropdown input[type="checkbox"] { margin-right: 10px; }
        .multi-select-dropdown .selected-chapters-display {
            min-height: 42px; height: auto; padding: 10px 12px;
            background: #f7fafd; border-radius: 6px;
            border: 1.3px solid #bcd6ef;
            line-height: 1.5; cursor: pointer;
        }
        .placeholder { font-style: normal; color: #5a7a9b; }
        .subject-block {
            margin: 24px 0 32px 0;
            padding: 20px 18px;
            border-radius: 14px;
            background: #f4f8fc;
            border: 1.3px solid #d2e3f7;
            box-shadow: 0 2px 14px #112a4c0e;
        }
        .subject-block-title {
            font-size: 1.19em;
            color: #0f3d6b;
            font-weight: bold;
            margin-bottom: 16px;
            margin-top: 2px;
        }
        #add-section-btn {
            background: none; border: 1px dashed #1762a7; color: #1762a7;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        .submit-btn {
            background: linear-gradient(90deg, #1762a7, #0f3d6b);
            color: #fff; font-weight: bold; cursor: pointer; padding: 12px 0;
            margin-top: 25px; width: 100%; border-radius: 8px; border: none; font-size: 1.05em;
        }
        .section-item {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 14px 10px;
            border: 1.3px solid #bcd6ef;
            border-radius: 12px;
            background: #fff;
            margin-bottom: 12px;
            min-height: 42px;
            box-shadow: 0 2px 12px rgba(0, 27, 68, 0.07);
        }
        .section-logic-fields {
            flex: 1 1 260px;
            min-width: 220px;
            margin-top: 6px;
            margin-bottom: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .internal-choice-pairs { width: 100%; margin-top: 6px; margin-bottom: 2px; }
        .drag-handle { cursor: grab; color: #5a7a9b; }
        .remove-section-btn { background: none; border: none; color: #c82333; cursor: pointer; font-size: 1.1em; }
        .section-item .remove-section-btn {
            background: #f7dede;
            border: none;
            color: #c82333;
            cursor: pointer;
            font-size: 1.1em;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .section-item .remove-section-btn:hover { background: #fbbcbc; }
        .section-item select,
            .section-item input[type="number"],
            .section-item input[type="text"] {
                width: auto;
                min-width: 90px;
                padding: 9px 12px;
                border-radius: 6px;
                border: 1.3px solid #bcd6ef;
                font-size: 1em;
                background: #f7fafd;
                color: #12416c;
                outline: none;
                transition: border-color 0.2s;
                margin-bottom: 6px;
            }
            .section-item select:focus,
            .section-item input[type="number"]:focus,
            .section-item input[type="text"]:focus {
                border-color: #1762a7;
            }
            .section-item label {
                font-weight: 600;
                color: #185496;
                font-size: 0.97em;
                margin-bottom: 2px;
            }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header id="main-header">
            <h1 class="school-title">St. Patrick's School</h1>
            <div class="subtitle">IIT & NEET FOUNDATION</div>
        </header>
        <main>
            <div class="setup-form-container">
                <h2>Exam Builder (Multi-Subject)</h2>
                <form id="exam-setup-form">
                    <h3><i class="fas fa-file-alt"></i> Basic Information</h3>
                    <div class="form-grid-2-col">
                        <div class="form-group">
                            <label>Class</label>
                            <div id="class-dropdown" class="custom-dropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Subjects (select one or more)</label>
                            <div id="subjects-multiselect" class="multi-select-dropdown custom-dropdown">
                                <div class="selected-chapters-display placeholder">Select class to see subjects</div>
                                <div class="dropdown-options"></div>
                            </div>
                        </div>
                    </div>
                    <h3><i class="fas fa-list-ol"></i> Exam Details</h3>
                    <div class="form-group">
                        <label>Exam Name</label>
                        <div id="exam-name-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>Max Marks</label>
                        <input type="number" id="max-marks-input" placeholder="e.g. 100">
                    </div>
                    <div class="form-group">
                        <label>Time (in minutes)</label>
                        <input type="number" id="time-input" value="90">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="date-input">
                    </div>
                    <div class="form-group">
                        <label>Difficulty Level</label>
                        <div id="difficulty-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div id="subjects-sections-area">
                        <!-- JS will generate subject blocks here, one per selected subject -->
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Instructions (Optional)</label>
                        <textarea id="instructions-input" placeholder="e.g., All questions are compulsory..."></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Build Exam Draft</button>
                </form>
            </div>
        </main>
    </div>
    <div id="toast" style="
        position: fixed;
        bottom: 28px;
        left: 50%;
        transform: translateX(-50%);
        background: #0f3d6b;
        color: #fff;
        padding: 14px 28px;
        border-radius: 8px;
        display: none;
        z-index: 9999;
        font-weight: bold;
        font-size: 1.1em;
        box-shadow: 0 6px 24px rgba(0, 27, 68, 0.18);
    "></div>
    <div id="modal-prompt" style="
        display:none;
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(20,40,80,0.18);
        z-index: 10000;
        align-items: center;
        justify-content: center;">
        <div style="
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 32px #17386855;
            max-width: 340px;
            margin: auto;
            padding: 36px 22px 22px 22px;
            border: 2px solid #c82333;
            display: flex;
            flex-direction: column;
            align-items: center;">
            <div id="modal-prompt-message" style="color: #c82333; font-weight: bold; font-size: 1.13em; text-align: center; margin-bottom: 26px;"></div>
            <button id="modal-prompt-ok" style="
                padding: 8px 26px;
                background: #1762a7;
                color: #fff;
                border-radius: 7px;
                border: none;
                font-weight: 600;
                font-size: 1.06em;
                cursor: pointer;">OK</button>
        </div>
    </div>
<script>
// --- FIREBASE INIT (leave this unchanged if already at top) ---
const firebaseConfig = {
    apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
    authDomain: "stpatricks-questionbank.firebaseapp.com",
    projectId: "stpatricks-questionbank",
    storageBucket: "stpatricks-questionbank.appspot.com",
    messagingSenderId: "917615322861",
    appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
};
firebase.initializeApp(firebaseConfig);

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.background = type === 'error' ? '#c82333' : '#0f3d6b';
    toast.style.display = 'block';
    clearTimeout(window._toastTimeout);
    window._toastTimeout = setTimeout(() => { toast.style.display = 'none'; }, 2300);
}
function showModalPrompt(message) {
    const modal = document.getElementById('modal-prompt');
    const msgBox = document.getElementById('modal-prompt-message');
    const okBtn = document.getElementById('modal-prompt-ok');
    msgBox.innerHTML = message;
    modal.style.display = 'flex';
    okBtn.onclick = () => { modal.style.display = 'none'; };
}

// --- CONFIG ---
const config = {
    classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
    subjectMappings: {
        "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
    },
    examNames: ["Slip Test", "Fortnightly Exam", "Formative Assessment", "Summative Assessment"],
    examTypes: ["MCQs", "Descriptive", "Both"],
    difficultyLevels: ["Level 1", "Level 2", "Level 3", "Mixed"],
    sectionLabels: ["Section A", "Section B", "Section C", "Section D", "Section E", "Section F", "Section G"],
    sectionTypes: ["Answer all", "Answer any", "Internal choice"],
    sectionTypeKeys: ["all", "any", "internal"]
};

// --- Helpers for MCQ logic (keep as-is) ---
function extractMCQOptions(q) {
    if (Array.isArray(q.options) && q.options.length === 4) return q.options;
    let stem = q.question || q.text || '';
    let match = stem.match(/^(.*?)(?:A\))\s*([^B]+)B\)\s*([^C]+)C\)\s*([^D]+)D\)\s*([^A]*)(?:Ans:|$)/);
    if (match) return [match[2].trim(), match[3].trim(), match[4].trim(), match[5].trim()];
    return null;
}
function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}
function shuffleMCQQuestion(questionObj) {
    if (!questionObj.options || !questionObj.options.length) return questionObj;
    let { options, answer } = questionObj;
    let correctIndices = [];
    if (typeof answer === 'string') {
        const ansMatches = answer.match(/[A-D]/g);
        if (ansMatches) correctIndices = ansMatches.map(l => "ABCD".indexOf(l));
    } else if (Array.isArray(answer)) correctIndices = answer;
    const optPairs = options.map((opt, idx) => ({ opt, idx }));
    shuffleArray(optPairs);
    const newOptions = optPairs.map(p => p.opt);
    const newCorrectIndices = optPairs.map((p, newIdx) => (correctIndices.includes(p.idx) ? newIdx : null)).filter(x => x !== null);
    const ansStr = "Ans: " + newCorrectIndices.map(i => "ABCD"[i] + ")").join(", ");
    return { ...questionObj, options: newOptions, answer: ansStr };
}
function splitCounts(total, percents) {
    let result = percents.map(p => Math.floor(total * p / 100));
    let sum = result.reduce((a, b) => a + b, 0);
    let diff = total - sum;
    for (let i = 0; diff > 0; i++, diff--) result[i % result.length]++;
    return result;
}

// --- Firebase/Firestore fetch helpers ---
const db = {
    getChapters: async (selectedClass, selectedSubject) => {
        try {
            const firestore = firebase.firestore();
            const snapshot = await firestore.collection("questions")
                .where("class", "==", selectedClass)
                .where("subject", "==", selectedSubject)
                .get();
            if (snapshot.empty) return [];
            const chapterSet = new Set();
            snapshot.forEach(doc => { const data = doc.data(); if (data.chapter) chapterSet.add(data.chapter); });
            return Array.from(chapterSet);
        } catch (error) { console.error("Error fetching chapters from Firestore:", error); return []; }
    }
};
async function fetchQuestions({ selectedClass, selectedSubject, chapters, marksPerQuestion, mcqType, count, forceDifficulty }) {
    const firestore = firebase.firestore();
    let query = firestore.collection("questions")
        .where("class", "==", selectedClass)
        .where("subject", "==", selectedSubject);
    if (forceDifficulty) query = query.where("difficulty", "==", forceDifficulty);
    else if (window.difficultyFilter && window.difficultyFilter !== "Mixed") query = query.where("difficulty", "==", window.difficultyFilter);
    if (chapters && chapters.length) query = query.where("chapter", "in", chapters.slice(0, 10));
    if (marksPerQuestion) query = query.where("marks", "==", parseInt(marksPerQuestion));
    if (mcqType === "MCQ (Single)") query = query.where("mcqType", "==", "MCQ (Single)");
    else if (mcqType === "MCQ (Multiple)") query = query.where("mcqType", "==", "MCQ (Multiple)");
    const snapshot = await query.get();
    let allQuestions = [];
    snapshot.forEach(doc => { allQuestions.push({ id: doc.id, ...doc.data() }); });
    if (mcqType === "Descriptive") allQuestions = allQuestions.filter(q => !q.mcqType || q.mcqType === "Descriptive");
    shuffleArray(allQuestions);
    return allQuestions.slice(0, count);
}

// --- DROPDOWN HELPERS (multi, single, sections, etc.) ---
function createDropdown(containerId, options, placeholder) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const optionsHTML = options.map(opt => `<div data-value="${opt}">${opt}</div>`).join('');
    container.innerHTML = `<div class="selected-option">${placeholder}</div><div class="dropdown-options">${optionsHTML}</div>`;
    container.dataset.value = '';
    container.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.custom-dropdown.open').forEach(d => { if (d !== container) d.classList.remove('open'); });
        container.classList.toggle('open');
        if (e.target.dataset.value) {
            const selectedValue = e.target.dataset.value;
            container.querySelector('.selected-option').textContent = selectedValue;
            container.dataset.value = selectedValue;
            container.classList.remove('open');
            container.dispatchEvent(new Event('change', { bubbles: true }));
        }
    });
}
function createMultiSelectDropdown(containerId, options, placeholder, onChange) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const optionsHTML = options.map(opt => `<div><label><input type="checkbox" value="${opt}"> ${opt}</label></div>`).join('');
    container.innerHTML = `<div class="selected-chapters-display placeholder">${placeholder}</div><div class="dropdown-options">${optionsHTML}</div>`;
    container.classList.remove('open');
    container.addEventListener('click', function (e) {
        e.stopPropagation();
        if (e.target.closest('.selected-chapters-display')) container.classList.toggle('open');
        if (e.target.type === 'checkbox' && onChange) onChange();
    });
    document.addEventListener('click', () => { container.classList.remove('open'); });
}

// --- SUBJECT & SECTION LOGIC ---
function renderSubjectsSectionsArea(subjects, selectedClass) {
    const area = document.getElementById('subjects-sections-area');
    area.innerHTML = '';
    subjects.forEach((subject, sIdx) => {
        // Subject Block
        const subjectDiv = document.createElement('div');
        subjectDiv.className = "subject-block";
        subjectDiv.style = "margin-bottom:32px;padding:16px;border:1.3px solid #bcd6ef;border-radius:13px;background:#f9fbfd;";

        subjectDiv.innerHTML = `
            <h3 style="color:#185496;margin-bottom:10px;font-size:1.1em;"><i class="fas fa-book"></i> ${subject}</h3>
                 <div class="form-group">
                <label>Chapters (select one or more)</label>
                <div id="chapters-multiselect-${sIdx}" class="multi-select-dropdown custom-dropdown" data-sidx="${sIdx}">
                    <div class="selected-chapters-display placeholder">Select subject to see chapters</div>
                    <div class="dropdown-options"></div>
                </div>
            </div>
            <div class="form-group" style="margin-top:14px;">
                <label>Sections (Add, set type, and drag to reorder)</label>
                <div class="subject-sections-list" id="sections-list-${sIdx}"></div>
                <button type="button" class="add-section-btn" data-sidx="${sIdx}" style="margin-top: 10px;">+ Add Section</button>
            </div>
            subjectDiv.dataset.subject = subject;
        `;
        area.appendChild(subjectDiv);

        // Chapters fetch & display logic
        (async () => {
            const chapterDropdown = subjectDiv.querySelector(`#chapters-multiselect-${sIdx}`);
            const optionsContainer = chapterDropdown.querySelector('.dropdown-options');
            const display = chapterDropdown.querySelector('.selected-chapters-display');
            display.textContent = 'Loading chapters...';
            display.classList.add('placeholder');
            const chapters = await db.getChapters(selectedClass, subject);
            if (chapters.length > 0) {
                optionsContainer.innerHTML = chapters.map(opt => `<div><label><input type="checkbox" value="${opt}"> ${opt}</label></div>`).join('');
                display.textContent = 'Select one or more chapters';
            } else {
                optionsContainer.innerHTML = '<div style="padding: 10px; font-style: italic;">No chapters found.</div>';
                display.textContent = 'No chapters found';
            }
            display.classList.add('placeholder');
            // update display on change
            chapterDropdown.addEventListener('click', function (e) {
                e.stopPropagation();
                if (e.target.closest('.selected-chapters-display')) chapterDropdown.classList.toggle('open');
                if (e.target.type === 'checkbox') updateSelectedChaptersDisplay(chapterDropdown);
            });
        })();

        // Add first section for this subject
        setTimeout(() => addSectionForSubject(sIdx), 100); // delay for element to exist

        // Add Section button logic
        subjectDiv.querySelector('.add-section-btn').onclick = () => addSectionForSubject(sIdx);
    });
}
function addSectionForSubject(sIdx) {
    const list = document.getElementById(`sections-list-${sIdx}`);
    const sectionCount = list.children.length;
    // Create Section Item (re-use same as your logic above, but unique IDs/classes for each subject)
    const newItem = document.createElement('div');
    newItem.className = 'section-item';
    // Section Label Dropdown
    const sectionLabelDropdown = createSectionDropdown(
        config.sectionLabels, "Select Section",
        config.sectionLabels[sectionCount % config.sectionLabels.length], null
    );
    sectionLabelDropdown.classList.add('section-label-dropdown');
    sectionLabelDropdown.style.width = "120px";
    sectionLabelDropdown.style.marginRight = "8px";
    // MCQ Type Dropdown
    const mcqTypeOptions = ["MCQ (Single)", "MCQ (Multiple)", "Descriptive"];
    const mcqTypeDropdown = createSectionDropdown(mcqTypeOptions, "MCQ Type", mcqTypeOptions[0], null);
    mcqTypeDropdown.classList.add('mcq-type-dropdown');
    mcqTypeDropdown.style.width = "150px";
    mcqTypeDropdown.style.marginRight = "10px";
    // Section Type Dropdown
    const sectionTypeDropdown = createSectionDropdown(
        config.sectionTypes, "Select Type", config.sectionTypes[0],
        (val) => updateSectionLogicFields(newItem, config.sectionTypeKeys[config.sectionTypes.indexOf(val)])
    );
    sectionTypeDropdown.classList.add('section-type-dropdown');
    sectionTypeDropdown.style.width = "140px";
    sectionTypeDropdown.style.marginRight = "10px";
    // Logic fields placeholder
    const logicFields = document.createElement('span');
    logicFields.className = "section-logic-fields";
    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.type = "button";
    removeBtn.className = "remove-section-btn";
    removeBtn.style.marginLeft = "8px";
    removeBtn.innerHTML = "&times;";
    removeBtn.onclick = () => newItem.remove();
    // Drag handle
    const dragHandle = document.createElement('span');
    dragHandle.className = "drag-handle";
    dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
    // Build
    newItem.appendChild(dragHandle);
    newItem.appendChild(sectionLabelDropdown);
    newItem.appendChild(mcqTypeDropdown);
    newItem.appendChild(sectionTypeDropdown);
    newItem.appendChild(logicFields);
    newItem.appendChild(removeBtn);
    // Init logic fields
    updateSectionLogicFields(newItem, config.sectionTypeKeys[0]);
    list.appendChild(newItem);
    // Drag support (optional)
    if (window.Sortable) new Sortable(list, { animation: 150, handle: '.drag-handle' });
}
function createSectionDropdown(options, placeholder, defaultValue, onChange) {
    const dropdown = document.createElement('div');
    dropdown.className = 'custom-dropdown';
    const optionsHTML = options.map(opt => `<div data-value="${opt}">${opt}</div>`).join('');
    dropdown.innerHTML = `<div class="selected-option">${defaultValue || placeholder}</div><div class="dropdown-options">${optionsHTML}</div>`;
    dropdown.dataset.value = defaultValue || '';
    dropdown.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.custom-dropdown.open').forEach(d => { if (d !== dropdown) d.classList.remove('open'); });
        dropdown.classList.toggle('open');
        if (e.target.dataset.value) {
            const val = e.target.dataset.value;
            dropdown.querySelector('.selected-option').textContent = val;
            dropdown.dataset.value = val;
            dropdown.classList.remove('open');
            if (onChange) onChange(val);
        }
    });
    return dropdown;
}
function updateSectionLogicFields(sectionItem, typeKey) {
    const logicFields = sectionItem.querySelector('.section-logic-fields');
    logicFields.innerHTML = '';
    if (typeKey === 'all') {
        logicFields.innerHTML = `
            <label style="font-size:0.97em;">
                Number of questions:
                <input type="number" class="num-questions-input" min="1" value="1" style="width:50px; margin-left:6px;">
            </label>
            <label style="font-size:0.97em; margin-left:14px;">
                Marks per question:
                <input type="number" class="marks-per-question-input" min="1" value="1" style="width:50px; margin-left:6px;">
            </label>
        `;
    } else if (typeKey === 'any') {
        logicFields.innerHTML = `
            <label style="font-size:0.97em;">
                Total questions:
                <input type="number" class="num-questions-input" min="1" value="1" style="width:50px; margin:0 6px;">
            </label>
            <label style="font-size:0.97em; margin-left:18px;">
                Attempt any:
                <input type="number" class="attempt-any-input" min="1" value="1" style="width:50px; margin-left:6px;">
            </label>
            <label style="font-size:0.97em; margin-left:14px;">
                Marks per question:
                <input type="number" class="marks-per-question-input" min="1" value="1" style="width:50px; margin-left:6px;">
            </label>
        `;
    } else if (typeKey === 'internal') {
        logicFields.innerHTML = `
            <label style="font-size:0.97em;">
                Number of pairs:
                <input type="number" class="num-pairs-input" min="1" value="1" style="width:50px; margin-left:6px;">
            </label>
            <label style="font-size:0.97em; margin-left:14px;">
                Marks per pair:
                <input type="number" class="marks-per-question-input" min="1" value="1" style="width:50px; margin-left:6px;">
            </label>
            <div class="internal-choice-pairs"></div>
        `;
        generateInternalPairs(sectionItem);
        sectionItem.querySelector('.num-pairs-input').addEventListener('input', () => generateInternalPairs(sectionItem));
    }
}
function generateInternalPairs(sectionItem) {
    const pairCount = parseInt(sectionItem.querySelector('.num-pairs-input').value) || 1;
    const pairsDiv = sectionItem.querySelector('.internal-choice-pairs');
    pairsDiv.innerHTML = '';
    for (let i = 1; i <= pairCount; i++) {
        const pairDiv = document.createElement('div');
        pairDiv.style.margin = '6px 0';
        pairDiv.style.display = 'flex';
        pairDiv.style.alignItems = 'center';
        pairDiv.innerHTML = `<label style="margin-right:10px;">Pair ${i}:</label>
            <input class="pair-chapter-a" placeholder="Chapter (a)" style="width:110px;margin-right:7px;">
            <input class="pair-chapter-b" placeholder="Chapter (b)" style="width:110px;">`;
        pairsDiv.appendChild(pairDiv);
    }
}
function updateSelectedChaptersDisplay(chapterDropdown) {
    const display = chapterDropdown.querySelector('.selected-chapters-display');
    const checkedChapters = Array.from(chapterDropdown.querySelectorAll('input:checked')).map(cb => cb.value);
    if (checkedChapters.length === 0) {
        display.textContent = 'Select one or more chapters';
        display.classList.add('placeholder');
    } else {
        display.textContent = checkedChapters.join(', ');
        display.classList.remove('placeholder');
    }
}

// --- MAIN EVENT HANDLERS ---
document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(function(user) {
        if (!user) { window.location.href = "login.html"; return; }
        // DROPDOWNS
        createDropdown('class-dropdown', config.classes, 'Select Class');
        createDropdown('exam-name-dropdown', config.examNames, 'Select Exam Name');
        createDropdown('difficulty-dropdown', config.difficultyLevels, 'Select Difficulty');
        document.getElementById('date-input').valueAsDate = new Date();

        // Multi-Subject Dropdown Logic
        document.getElementById('class-dropdown').addEventListener('change', function () {
            const selectedClass = this.dataset.value;
            const subjects = config.subjectMappings[selectedClass] || [];
            createMultiSelectDropdown('subjects-multiselect', subjects, 'Select Subject(s)', updateSubjectsSectionsArea);
        });
        // Listen for subject multi-select changes and render sections per subject
        function updateSubjectsSectionsArea() {
            const allSubjectsCbs = Array.from(document.querySelectorAll('#subjects-multiselect input[type="checkbox"]'));
            const selectedSubjects = allSubjectsCbs.filter(cb => cb.checked).map(cb => cb.value);
            const selectedClass = document.getElementById('class-dropdown').dataset.value;
            if (!selectedClass || selectedSubjects.length === 0) {
                document.getElementById('subjects-sections-area').innerHTML = '';
                return;
            }
            renderSubjectsSectionsArea(selectedSubjects, selectedClass);
        }
        // Form submit
        document.getElementById('exam-setup-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const btn = document.querySelector('.submit-btn');
            btn.disabled = true;
            btn.textContent = "Building Paper...";
            try {
                const selectedClass = document.getElementById('class-dropdown').dataset.value;
                const examName = document.getElementById('exam-name-dropdown').dataset.value;
                const maxMarks = document.getElementById('max-marks-input').value;
                const time = document.getElementById('time-input').value;
                const date = document.getElementById('date-input').value;
                const instructions = document.getElementById('instructions-input').value;
                const difficultyValue = document.getElementById('difficulty-dropdown').dataset.value;
                // Collect subjects and sections
                const subjectBlocks = document.querySelectorAll('.subject-block');
                const subjectsData = [];
                const subjectTitle = sb.dataset.subject;
                    const chapterDropdown = sb.querySelector('.multi-select-dropdown');
                    const chapters = Array.from(chapterDropdown.querySelectorAll('input:checked')).map(cb => cb.value);
                    const sectionsList = sb.querySelectorAll('.section-item');
                    const sections = [];
                    for (let section of sectionsList) {
                        const label = section.querySelector('.section-label-dropdown').dataset.value;
                        const mcqType = section.querySelector('.mcq-type-dropdown').dataset.value;
                        const typeLabel = section.querySelector('.section-type-dropdown').dataset.value;
                        const typeIndex = config.sectionTypes.indexOf(typeLabel);
                        const type = config.sectionTypeKeys[typeIndex];
                        let sec = { label, mcqType, type };
                        if (type === "all") {
                            sec.numQuestions = parseInt(section.querySelector('.num-questions-input').value);
                            sec.marksPerQuestion = parseInt(section.querySelector('.marks-per-question-input').value);
                        } else if (type === "any") {
                            sec.numQuestions = parseInt(section.querySelector('.num-questions-input').value);
                            sec.attemptAny = parseInt(section.querySelector('.attempt-any-input').value);
                            sec.marksPerQuestion = parseInt(section.querySelector('.marks-per-question-input').value);
                        } else if (type === "internal") {
                            sec.numPairs = parseInt(section.querySelector('.num-pairs-input').value);
                            sec.marksPerQuestion = parseInt(section.querySelector('.marks-per-question-input').value);
                            sec.pairs = [];
                            const pairDivs = section.querySelectorAll('.internal-choice-pairs > div');
                            pairDivs.forEach(div => {
                                const chapterA = div.querySelector('.pair-chapter-a').value;
                                const chapterB = div.querySelector('.pair-chapter-b').value;
                                sec.pairs.push({ chapterA, chapterB });
                            });
                        }
                        sections.push(sec);
                    }
                    subjectsData.push({ subject: subjectTitle, chapters, sections });
                }

                // Final structure for paper
                const finalPaper = {
                    class: selectedClass,
                    examName,
                    date,
                    time,
                    maxMarks,
                    instructions,
                    subjects: [] // Each with: subject, chapters, sections
                };

                // --- Build all subjects and sections and fetch questions for each
               let allSectionErrors = []; // collect all errors

for (let subjData of subjectsData) {
    let subjectBlock = { subject: subjData.subject, chapters: subjData.chapters, sections: [] };
    for (let secIdx = 0; secIdx < subjData.sections.length; secIdx++) {
        const sec = subjData.sections[secIdx];
        let questions = [];
        let sectionErrors = [];
        if (sec.type === "all" || sec.type === "any") {
            let requestedCount = sec.numQuestions;
            if (difficultyValue === "Mixed") {
                const difficultyLevels = ["Level 1", "Level 2", "Level 3"];
                const percentages = [40, 30, 30];
                const counts = splitCounts(requestedCount, percentages);
                for (let d = 0; d < difficultyLevels.length; d++) {
                    if (counts[d] > 0) {
                        let qs = await fetchQuestions({
                            selectedClass,
                            selectedSubject: subjectTitle,
                            chapters: subjData.chapters,
                            marksPerQuestion: sec.marksPerQuestion,
                            mcqType: sec.mcqType,
                            count: counts[d],
                            forceDifficulty: difficultyLevels[d]
                        });
                        questions = questions.concat(qs);
                    }
                }
                shuffleArray(questions);
                questions = questions.slice(0, requestedCount);
            } else if (difficultyValue && difficultyValue !== "Mixed") {
                questions = await fetchQuestions({
                    selectedClass,
                    selectedSubject: subjData.subject,
                    chapters: subjData.chapters,
                    marksPerQuestion: sec.marksPerQuestion,
                    mcqType: sec.mcqType,
                    count: requestedCount,
                    forceDifficulty: difficultyValue
                });
            } else {
                questions = await fetchQuestions({
                    selectedClass,
                    selectedSubject: subjData.subject,
                    chapters: subjData.chapters,
                    marksPerQuestion: sec.marksPerQuestion,
                    mcqType: sec.mcqType,
                    count: requestedCount
                });
            }
            if (questions.length < requestedCount) {
                sectionErrors.push(
                    `${subjData.subject} - ${sec.label} (${sec.mcqType}): Only ${questions.length} of ${requestedCount} questions found.`
                );
                continue; // skip this section
            }
            questions = questions.map((q, idx) => {
                let optionsArr = extractMCQOptions(q);
                let stem = q.question || q.text || '';
                if ((sec.mcqType === "MCQ (Single)" || sec.mcqType === "MCQ (Multiple)") && Array.isArray(optionsArr) && optionsArr.length === 4) {
                    const cleanOptionsArr = optionsArr.map(opt => opt.replace(/^[A-D][).]?\s*/, '').trim());
                    const shuffled = shuffleMCQQuestion({ ...q, options: cleanOptionsArr, question: stem });
                    return {
                        number: idx + 1,
                        text: shuffled.question || shuffled.text || "",
                        marks: sec.marksPerQuestion,
                        options: shuffled.options || [],
                        answer: shuffled.answer || ""
                    };
                } else {
                    return {
                        number: idx + 1,
                        text: stem,
                        marks: sec.marksPerQuestion,
                        options: optionsArr || [],
                        answer: q.answer || ""
                    };
                }
            });
        } else if (sec.type === "internal") {
            let missingPairs = 0;
            for (let p = 0; p < sec.pairs.length; p++) {
                let qA = await fetchQuestions({
                    selectedClass,
                    selectedSubject: subjData.subject,
                    chapters: [sec.pairs[p].chapterA],
                    marksPerQuestion: sec.marksPerQuestion,
                    count: 1
                });
                let qB = await fetchQuestions({
                    selectedClass,
                    selectedSubject: subjData.subject,
                    chapters: [sec.pairs[p].chapterB],
                    marksPerQuestion: sec.marksPerQuestion,
                    count: 1
                });
                if (!qA.length || !qB.length) {
                    sectionErrors.push(
                        `${subjData.subject} - ${sec.label} (Pair ${p + 1}): Missing question(s) for selected chapters.`
                    );
                    missingPairs++;
                    continue; // skip this pair
                }
                questions.push({
                    number: p + 1,
                    text: `a) ${qA[0].question || qA[0].text}<br>b) ${qB[0].question || qB[0].text}`,
                    marks: sec.marksPerQuestion,
                    image: qA[0].image || qB[0].image || null
                });
            }
            if (missingPairs > 0 || questions.length < sec.numPairs) {
                sectionErrors.push(
                    `${subjData.subject} - ${sec.label}: Only ${questions.length} of ${sec.numPairs} pairs found.`
                );
                continue; // skip this section
            }
        }
        // Only push if NO sectionErrors for this section
        if (sectionErrors.length === 0) {
            subjectBlock.sections.push({ ...sec, questions });
        } else {
            allSectionErrors = allSectionErrors.concat(sectionErrors);
        }
    }
    finalPaper.subjects.push(subjectBlock);
}

// Show errors if any
if (allSectionErrors.length > 0) {
    showModalPrompt(
        `<b>Some sections could not be added:</b><br><ul style="text-align:left">${allSectionErrors.map(e => `<li>${e}</li>`).join('')}</ul>`
    );
    btn.disabled = false; btn.textContent = "Build Exam Draft";
    return; // stop!
}

// Save and continue as before
sessionStorage.setItem('examPaper', JSON.stringify(finalPaper));
window.location.href = 'exam-review.html';
            } catch (err) {
                showToast("Error building exam: " + (err.message || err), "error");
            }
            btn.disabled = false;
            btn.textContent = "Build Exam Draft";
        });
    });
});
</script>
</body>
</html>
