<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Exam Builder - Setup | St. Patrick's School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    
    <style>
{
    box-sizing: border-box;
}
        :root {
            --primary-blue: #0f3d6b;
            --secondary-blue: #1762a7;
            --light-blue-bg: #f4f8fc;
            --border-color: #bcd6ef;
            --text-dark: #12416c;
            --text-light: #54656f;
            }
        html { height: -webkit-fill-available; }
       body {
        margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif;
        background-color: var(--light-blue-bg);
        height: 100vh;
        min-height: 100vh;
        overflow-x: hidden;
        overflow-y: auto;
    }

        .page-wrapper { display: flex; flex-direction: column; height: 100%; }
        
        #main-header {
            background: linear-gradient(90deg, var(--secondary-blue), var(--primary-blue));
            color: #fff; border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
            min-height: 90px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 15px 10px 18px 10px;
            box-sizing: border-box; flex-shrink: 0;
        }
        #main-header .school-title { font-size: 1.8em; font-weight: bold; margin: 0;}
        #main-header .subtitle { font-size: 1.05em; color: #e0eaff; margin-top: 5px; }

        main {
            flex-grow: 1; overflow-y: auto;
            display: flex; flex-direction: column;
        }
        
        .setup-form-container {
            width: 100%; max-width: 800px; margin: auto; background: #fff;
            border-radius: 16px; box-shadow: 0 4px 18px rgba(0, 27, 68, 0.1);
            padding: 25px 40px;
            margin-top: 20px; margin-bottom: 20px;
            overflow: hidden;
        }
        .setup-form-container h2 { text-align: center; color: var(--primary-blue); margin-top: 0; margin-bottom: 25px; }
        
        /* === UNIFIED FORM STYLES (from ai-gen.html) === */

        /* Form Subheadings (e.g., "Basic Information") */
        #exam-setup-form h3 {
            margin-top: 25px; margin-bottom: 15px;
            color: var(--secondary-blue); border-bottom: 2px solid #e0eaff; padding-bottom: 10px;
            font-size: 1.2em; display: flex; align-items: center; gap: 10px;
        }
        #exam-setup-form h3:first-of-type {
            margin-top: 0;
        }

        /* Form Grid Layouts */
        .form-grid-1-col, .form-grid-2-col {
            display: grid;
            gap: 15px; /* Consistent gap */
        }
        .form-grid-1-col {
            grid-template-columns: 1fr;
        }
        @media (min-width: 600px) {
            .form-grid-2-col {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Form Group & Labels */
        .form-group {
            margin-bottom: 0; /* Remove margin as 'gap' handles spacing */
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #185496; /* Consistent Label Color */
            display: block;
        }

        /* All Input, Textarea, and Dropdown Fields */
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group textarea,
        .custom-dropdown .selected-option {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1.3px solid #bcd6ef; /* Consistent Border */
            font-size: 1em;
            background: #f7fafd; /* Consistent Background */
            box-sizing: border-box;
            height: 42px; /* Consistent Height */
        }
        .form-group textarea {
            height: auto;
            min-height: 80px;
        }

        /* Standard Custom Dropdown */
        .custom-dropdown { position: relative; }
        .custom-dropdown .selected-option { cursor: pointer; }
        .dropdown-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1.3px solid #bcd6ef; border-top: none; border-radius: 0 0 6px 6px; box-shadow: 0 6px 15px rgba(0, 27, 68, 0.1); z-index: 1000; max-height: 200px; overflow-y: auto; }
        .custom-dropdown.open .dropdown-options { display: block; }
        .dropdown-options div[data-value] { padding: 10px 15px; cursor: pointer; }
        .dropdown-options div[data-value]:hover { background: #e0eaff; }

        /* Multi-select Dropdown for Chapters */
        .multi-select-dropdown .dropdown-options div { display: flex; align-items: center; padding: 10px 15px; }
        .multi-select-dropdown .dropdown-options div:hover { background: #e0eaff; }
        .multi-select-dropdown input[type="checkbox"] { margin-right: 10px; }
        .multi-select-dropdown .selected-chapters-display {
            min-height: 42px; height: auto;
            padding: 10px 12px;
            background: #f7fafd; border-radius: 6px;
            border: 1.3px solid #bcd6ef;
            line-height: 1.5; cursor: pointer;
        }
        .placeholder { font-style: normal; color: #5a7a9b; }

        /* Sections List */
        #sections-list .section-item {
            display: flex; gap: 10px; align-items: center; padding: 0 10px;
            border: 1px dashed #bcd6ef; border-radius: 6px; margin-bottom: 10px; background: #f7fafd;
            height: 42px;
        }
        .drag-handle { cursor: grab; color: #5a7a9b; }
        .section-item input { flex-grow: 1; border: none; background: transparent; height: 100%; font-size: 1em; outline: none;}
        .remove-section-btn { background: none; border: none; color: #c82333; cursor: pointer; font-size: 1.1em; }
        #add-section-btn {
            background: none; border: 1px dashed #1762a7; color: #1762a7;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        
        /* Submit Button */
        .submit-btn {
            background: linear-gradient(90deg, #1762a7, #0f3d6b);
            color: #fff; font-weight: bold; cursor: pointer; padding: 12px 0;
            margin-top: 25px; width: 100%; border-radius: 8px; border: none; font-size: 1.05em;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header id="main-header">
            <h1 class="school-title">St. Patrick's School</h1>
            <div class="subtitle">IIT & NEET FOUNDATION</div>
        </header>

        <main>
            <div class="setup-form-container">
                <h2>Exam Builder</h2>
                <form id="exam-setup-form">
                    
                    <h3><i class="fas fa-file-alt"></i> Basic Information</h3>
                    <div class="form-grid-2-col">
                        <div class="form-group">
                            <label>Class</label>
                            <div id="class-dropdown" class="custom-dropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Subject</label>
                            <div id="subject-dropdown" class="custom-dropdown"></div>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Chapters (select one or more)</label>
                            <div id="chapters-multiselect" class="multi-select-dropdown custom-dropdown">
                                <div class="selected-chapters-display placeholder">Select subject to see chapters</div>
                                <div class="dropdown-options"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h3><i class="fas fa-list-ol"></i> Exam Details</h3>
                    <div class="form-grid-1-col">
                         <div class="form-group">
                            <label>Exam Name</label>
                            <div id="exam-name-dropdown" class="custom-dropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Exam Type</label>
                            <div id="exam-type-dropdown" class="custom-dropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Max Marks</label>
                            <div id="max-marks-dropdown" class="custom-dropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Time (in minutes)</label>
                            <input type="number" id="time-input" value="90">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="date-input">
                        </div>
                    </div>

                    <h3><i class="fas fa-sitemap"></i> Paper Structure</h3>
                    <div class="form-grid-1-col">
                        <div class="form-group">
                            <label>Difficulty Level</label>
                            <div id="difficulty-dropdown" class="custom-dropdown"></div>
                        </div>
                    </div>
                     <div class="form-group" style="margin-top: 20px;">
                        <label>Sections (Add, name, and drag to reorder)</label>
                        <div id="sections-list"></div>
                        <button type="button" id="add-section-btn" style="margin-top: 10px;">+ Add Section</button>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Instructions (Optional)</label>
                         <textarea id="instructions-input" placeholder="e.g., All questions are compulsory..."></textarea>
                     </div>
                    
                    <button type="submit" class="submit-btn">Build Exam Draft</button>
                </form>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const config = {
            classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
            subjectMappings: {
                "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
                "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
                "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
                "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
                "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
                "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
                "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
                "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
            },
            examNames: ["Slip Test", "Fortnightly Exam", "Formative Assessment", "Summative Assessment"],
            examTypes: ["MCQs", "Descriptive", "Both"],
            maxMarks: [10, 20, 25, 50, 80, 100],
            difficultyLevels: ["Easy/Level 1", "Medium/Level 2", "Difficult/Level 3", "Mixed"],
        };
        
        const mockDb = { getChapters: (cl, sub) => Promise.resolve(['Algebra', 'Geometry', 'Trigonometry', 'Calculus', 'Statistics']) };

        function createDropdown(containerId, options, placeholder) {
            const container = document.getElementById(containerId);
            const optionsHTML = options.map(opt => `<div data-value="${opt}">${opt}</div>`).join('');
            container.innerHTML = `
                <div class="selected-option">${placeholder}</div>
                <div class="dropdown-options">${optionsHTML}</div>
            `;
            container.dataset.value = '';

            container.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.custom-dropdown.open').forEach(d => {
                    if (d.id !== containerId) d.classList.remove('open');
                });
                container.classList.toggle('open');

                if (e.target.dataset.value) {
                    const selectedValue = e.target.dataset.value;
                    container.querySelector('.selected-option').textContent = selectedValue;
                    container.dataset.value = selectedValue;
                    container.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }
        
        function addSection() {
            const list = document.getElementById('sections-list');
            const sectionCount = list.children.length + 1;
            const newItem = document.createElement('div');
            newItem.className = 'section-item';
            newItem.innerHTML = `
                <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
                <input type="text" placeholder="e.g., Section ${String.fromCharCode(64 + sectionCount)}: Answer all questions">
                <button type="button" class="remove-section-btn">&times;</button>
            `;
            list.appendChild(newItem);
        }
        
        async function handleClassChange() {
            const selectedClass = document.getElementById('class-dropdown').dataset.value;
            const subjects = config.subjectMappings[selectedClass] || [];
            createDropdown('subject-dropdown', subjects, 'Select Subject');
            document.getElementById('subject-dropdown').addEventListener('change', handleSubjectChange);
            handleSubjectChange();
        }

        async function handleSubjectChange() {
            const selectedClass = document.getElementById('class-dropdown').dataset.value;
            const selectedSubject = document.getElementById('subject-dropdown').dataset.value;
            const chapterContainer = document.getElementById('chapters-multiselect');
            const optionsContainer = chapterContainer.querySelector('.dropdown-options');
            const display = chapterContainer.querySelector('.selected-chapters-display');
            
            if (!selectedSubject) {
                optionsContainer.innerHTML = '';
                display.textContent = 'Select subject to see chapters';
                display.classList.add('placeholder');
                updateSelectedChaptersDisplay();
                return;
            }

            const chapters = await mockDb.getChapters(selectedClass, selectedSubject);
            
            if (chapters.length > 0) {
                optionsContainer.innerHTML = chapters.map(opt => `<div><label><input type="checkbox" value="${opt}"> ${opt}</label></div>`).join('');
            } else {
                optionsContainer.innerHTML = '<div style="padding: 10px; font-style: italic;">No chapters found.</div>';
            }
            updateSelectedChaptersDisplay();
        }
        
        function updateSelectedChaptersDisplay() {
            const chapterContainer = document.getElementById('chapters-multiselect');
            const display = chapterContainer.querySelector('.selected-chapters-display');
            const checkedChapters = Array.from(chapterContainer.querySelectorAll('input:checked')).map(cb => cb.value);
            
            if (checkedChapters.length === 0) {
                display.textContent = 'Select one or more chapters';
                display.classList.add('placeholder');
            } else {
                display.textContent = checkedChapters.join(', ');
                display.classList.remove('placeholder');
            }
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const examConfig = {
                class: document.getElementById('class-dropdown').dataset.value,
                subject: document.getElementById('subject-dropdown').dataset.value,
                chapters: Array.from(document.querySelectorAll('#chapters-multiselect input:checked')).map(cb => cb.value),
                examName: document.getElementById('exam-name-dropdown').dataset.value,
                examType: document.getElementById('exam-type-dropdown').dataset.value,
                maxMarks: document.getElementById('max-marks-dropdown').dataset.value,
                time: document.getElementById('time-input').value,
                date: document.getElementById('date-input').value,
                difficulty: document.getElementById('difficulty-dropdown').dataset.value,
                sections: Array.from(document.querySelectorAll('#sections-list input')).map(input => input.value),
                instructions: document.getElementById('instructions-input').value,
            };

            // Validation check
            if (!examConfig.class || !examConfig.subject || examConfig.chapters.length === 0) {
                alert("Please select a Class, Subject, and at least one Chapter.");
                return;
            }

            console.log("Exam Configuration:", examConfig);
            alert("This data would now be sent to the next page (exam-review.html). Check the console for the configuration object.");
            // sessionStorage.setItem('examConfig', JSON.stringify(examConfig));
            // window.location.href = 'exam-review.html';
        }
        
        // --- Setup and Initialization ---
        createDropdown('class-dropdown', config.classes, 'Select Class');
        createDropdown('subject-dropdown', [], 'Select Subject');
        createDropdown('exam-name-dropdown', config.examNames, 'Select Exam Name');
        createDropdown('exam-type-dropdown', config.examTypes, 'Select Exam Type');
        createDropdown('max-marks-dropdown', config.maxMarks, 'Select Max Marks');
        createDropdown('difficulty-dropdown', config.difficultyLevels, 'Select Difficulty');

        document.getElementById('class-dropdown').addEventListener('change', handleClassChange);
        document.getElementById('exam-setup-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('add-section-btn').addEventListener('click', addSection);
        document.getElementById('sections-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-section-btn')) {
                e.target.closest('.section-item').remove();
            }
        });
        
        const chapterContainer = document.getElementById('chapters-multiselect');
        chapterContainer.addEventListener('click', (e) => {
            e.stopPropagation();
            if (e.target.closest('.selected-chapters-display')) {
                chapterContainer.classList.toggle('open');
            }
            if (e.target.type === 'checkbox') {
                updateSelectedChaptersDisplay();
            }
        });
        
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-dropdown.open').forEach(d => d.classList.remove('open'));
        });

        addSection();
        document.getElementById('date-input').valueAsDate = new Date();
        new Sortable(document.getElementById('sections-list'), { animation: 150, handle: '.drag-handle' });
    });
    </script>
</body>
</html>
