<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Exam Builder - Setup | St. Patrick's School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    
    <style>
        :root {
            --header-height: 90px;
            --primary-blue: #0f3d6b;
            --secondary-blue: #1762a7;
            --light-blue-bg: #f4f8fc;
            --border-color: #bcd6ef;
            --text-dark: #12416c;
            --text-light: #54656f;
        }
        body {
            margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--light-blue-bg);
        }
        .page-wrapper { display: flex; flex-direction: column; }
        
        #main-header {
            background: linear-gradient(90deg, var(--secondary-blue), var(--primary-blue));
            color: #fff; border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
            min-height: var(--header-height); display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 15px 10px 18px 10px;
            box-sizing: border-box; flex-shrink: 0;
        }
        #main-header .school-title { font-size: 1.8em; font-weight: bold; margin: 0;}
        #main-header .subtitle { font-size: 1.05em; color: #e0eaff; margin-top: 5px; }

        main { padding: 25px; }
        
        .form-container {
            max-width: 1000px; margin: auto; background: #fff;
            border-radius: 16px; box-shadow: 0 4px 18px rgba(0, 27, 68, 0.1);
            padding: 25px 40px;
        }
        .form-container h2 { text-align: center; color: var(--primary-blue); margin-top: 0; margin-bottom: 25px; }

        #exam-setup-form { display: grid; gap: 20px; }
        
        .form-section {
            border: 1px solid #e0eaff;
            padding: 20px;
            border-radius: 12px;
        }
        .form-section h3 {
            margin-top: 0; color: var(--secondary-blue); border-bottom: 2px solid #e0eaff; padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
        }

        .form-group label { font-weight: 600; margin-bottom: 6px; color: var(--text-dark); display: block; }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group textarea,
        .custom-dropdown .selected-option {
            width: 100%; padding: 10px 12px; border-radius: 6px;
            border: 1.3px solid var(--border-color); font-size: 1em;
            background: #f7fafd; box-sizing: border-box;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }

        /* Custom Dropdown Styles */
        .custom-dropdown { position: relative; }
        .dropdown-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1.3px solid var(--border-color); border-top: none; border-radius: 0 0 6px 6px; box-shadow: 0 6px 15px rgba(0, 27, 68, 0.1); z-index: 1000; max-height: 200px; overflow-y: auto; }
        .custom-dropdown.open .dropdown-options { display: block; }
        .dropdown-options div { padding: 10px 15px; cursor: pointer; }
        .dropdown-options div:hover { background: #e0eaff; }
        
        /* Multi-select Dropdown for Chapters */
        .multi-select-dropdown .dropdown-options div { display: flex; align-items: center; }
        .multi-select-dropdown input[type="checkbox"] { margin-right: 10px; }
        .selected-chapters-display { min-height: 44px; background: #f7fafd; padding: 10px; border-radius: 6px; border: 1.3px solid var(--border-color); font-style: italic; color: var(--text-light); }

        /* Conditional sections */
        .hidden { display: none; }
        #difficulty-mix-inputs { display: flex; gap: 10px; align-items: center; }
        #difficulty-mix-inputs input { width: 50px; text-align: center; }

        /* Dynamic Sections */
        #sections-list .section-item {
            display: flex; gap: 10px; align-items: center; padding: 10px;
            border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px; background: #f7fafd;
        }
        .drag-handle { cursor: grab; color: var(--text-light); }
        .section-item input { flex-grow: 1; border: none; background: transparent; }
        .remove-section-btn { background: none; border: none; color: #c82333; cursor: pointer; font-size: 1.1em; }

        /* Submit Button */
        .submit-btn {
            background: linear-gradient(90deg, var(--secondary-blue), var(--primary-blue));
            color: #fff; font-weight: bold; cursor: pointer; padding: 14px 0;
            margin-top: 15px; width: 100%; border-radius: 8px; border: none; font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header id="main-header">
            <h1 class="school-title">St. Patrick's School</h1>
            <div class="subtitle">IIT & NEET FOUNDATION</div>
        </header>

        <main>
            <div class="form-container">
                <h2>Exam Builder</h2>
                <form id="exam-setup-form">
                    <div class="form-section">
                        <h3><i class="fas fa-file-alt"></i> Basic Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Class</label>
                                <div id="class-dropdown" class="custom-dropdown"></div>
                            </div>
                            <div class="form-group">
                                <label>Subject</label>
                                <div id="subject-dropdown" class="custom-dropdown"></div>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Chapters (select one or more)</label>
                                <div id="chapters-multiselect" class="multi-select-dropdown custom-dropdown">
                                    <div class="selected-chapters-display">Select subject to see chapters</div>
                                    <div class="dropdown-options"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-list-ol"></i> Exam Details</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label>Exam Name</label>
                                <div id="exam-name-dropdown" class="custom-dropdown"></div>
                            </div>
                            <div class="form-group">
                                <label>Exam Type</label>
                                <div id="exam-type-dropdown" class="custom-dropdown"></div>
                            </div>
                             <div class="form-group hidden" id="mcq-level-group">
                                <label>MCQ Level</label>
                                <div id="mcq-level-dropdown" class="custom-dropdown"></div>
                            </div>
                            <div class="form-group">
                                <label>Max Marks</label>
                                <div id="max-marks-dropdown" class="custom-dropdown"></div>
                            </div>
                            <div class="form-group">
                                <label>Time (in minutes)</label>
                                <input type="number" id="time-input" value="90">
                            </div>
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="date-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-sitemap"></i> Paper Structure</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Difficulty Level</label>
                                <div id="difficulty-dropdown" class="custom-dropdown"></div>
                            </div>
                            <div class="form-group hidden" id="difficulty-mix-group">
                                <label>Difficulty Mix (%)</label>
                                <div id="difficulty-mix-inputs">
                                    <input type="number" id="easy-perc" value="40">% Easy
                                    <input type="number" id="medium-perc" value="40">% Med
                                    <input type="number" id="difficult-perc" value="20">% Diff
                                </div>
                            </div>
                        </div>
                         <div class="form-group" style="margin-top: 20px;">
                            <label>Sections (Add, name, and drag to reorder)</label>
                            <div id="sections-list">
                                </div>
                            <button type="button" id="add-section-btn" style="margin-top: 10px;">+ Add Section</button>
                        </div>
                    </div>

                    <div class="form-section">
                         <h3><i class="fas fa-info-circle"></i> Instructions (Optional)</h3>
                         <div class="form-group">
                             <textarea id="instructions-input" placeholder="e.g., All questions are compulsory..."></textarea>
                         </div>
                    </div>
                    
                    <button type="submit" class="submit-btn">Build Exam Draft &rarr;</button>
                </form>
            </div>
        </main>
    </div>

    <script>
    // This script will be very large. A separate .js file is recommended in a real project.
    // For this example, it's included here.
    
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const config = {
            classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
            subjectMappings: {
                "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
                "6th Class": ["Telugu", "Hindi", "English 1", "Math 1", "Physics", "Chemistry", "Biology", "Social"], // Simplified for example
                // Add all other mappings here...
            },
            examNames: ["Slip Test", "Fortnightly Exam", "Formative Assessment", "Summative Assessment"],
            examTypes: ["MCQs", "Descriptive", "Both"],
            mcqLevels: ["Level 1", "Level 2", "Level 3", "Mixed"],
            maxMarks: [10, 15, 20, 25, 50, 80, 100],
            difficultyLevels: ["Easy", "Medium", "Difficult", "Mixed"],
        };
        
        // Mock Firestore for this example. Replace with your actual Firebase connection.
        const mockDb = {
            collection: () => ({
                where: () => ({
                    get: () => Promise.resolve({
                        docs: [
                            { data: () => ({ chapter: 'Algebra' }) },
                            { data: () => ({ chapter: 'Geometry' }) },
                            { data: () => ({ chapter: 'Trigonometry' }) },
                        ]
                    })
                })
            })
        };

        // --- DOM ELEMENT REFERENCES ---
        const form = document.getElementById('exam-setup-form');
        // ... get all other form elements here

        // --- INITIALIZATION ---
        function initializeApp() {
            populateDropdowns();
            setupEventListeners();
            addSection(); // Start with one section
            
            // Set default date to today
            document.getElementById('date-input').valueAsDate = new Date();
        }

        function populateDropdowns() {
            // Populate all static dropdowns using the config object
            createDropdown('class-dropdown', config.classes);
            createDropdown('exam-name-dropdown', config.examNames);
            createDropdown('exam-type-dropdown', config.examTypes);
            createDropdown('mcq-level-dropdown', config.mcqLevels);
            createDropdown('max-marks-dropdown', config.maxMarks);
            createDropdown('difficulty-dropdown', config.difficultyLevels);
        }

        function createDropdown(containerId, options, isMultiSelect = false) {
            const container = document.getElementById(containerId);
            let optionsHTML = '';
            if (isMultiSelect) {
                optionsHTML = options.map(opt => `<div><label><input type="checkbox" value="${opt}"> ${opt}</label></div>`).join('');
            } else {
                optionsHTML = options.map(opt => `<div data-value="${opt}">${opt}</div>`).join('');
            }
            container.innerHTML = `
                <div class="selected-option">${options[0]}</div>
                <div class="dropdown-options">${optionsHTML}</div>
            `;
        }
        
        function setupEventListeners() {
            // Main form submission
            form.addEventListener('submit', handleFormSubmit);

            // Conditional Logic Listeners
            listenForDropdownChange('exam-type-dropdown', handleExamTypeChange);
            listenForDropdownChange('difficulty-dropdown', handleDifficultyChange);
            
            // Cascading Dropdown Listeners
            listenForDropdownChange('class-dropdown', handleClassChange);
            
            // Dynamic Sections
            document.getElementById('add-section-btn').addEventListener('click', addSection);
            document.getElementById('sections-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-section-btn')) {
                    e.target.closest('.section-item').remove();
                }
            });
            
            // Multi-select chapter logic
            const chapterDropdown = document.getElementById('chapters-multiselect');
            const chapterDisplay = chapterDropdown.querySelector('.selected-chapters-display');
            chapterDropdown.querySelector('.selected-option, .selected-chapters-display').addEventListener('click', (e) => {
                 e.stopPropagation();
                 chapterDropdown.classList.toggle('open');
            });
             chapterDropdown.querySelector('.dropdown-options').addEventListener('click', (e) => {
                // Prevent dropdown from closing when clicking on a checkbox/label
                e.stopPropagation(); 
                updateSelectedChaptersDisplay();
            });

        }
        
        function listenForDropdownChange(id, handler) {
            const dropdown = document.getElementById(id);
            dropdown.addEventListener('click', (e) => {
                if (e.target.dataset.value) {
                    dropdown.querySelector('.selected-option').textContent = e.target.dataset.value;
                    document.querySelectorAll(`#${id} .dropdown-options div`).forEach(d => d.style.fontWeight = 'normal');
                    e.target.style.fontWeight = 'bold';
                    handler({ target: e.target });
                }
            });
        }
        
        // --- EVENT HANDLER FUNCTIONS ---

        function handleExamTypeChange(e) {
            const mcqGroup = document.getElementById('mcq-level-group');
            if (e.target.dataset.value === 'MCQs' || e.target.dataset.value === 'Both') {
                mcqGroup.classList.remove('hidden');
            } else {
                mcqGroup.classList.add('hidden');
            }
        }
        
        function handleDifficultyChange(e) {
            const mixGroup = document.getElementById('difficulty-mix-group');
            if (e.target.dataset.value === 'Mixed') {
                mixGroup.classList.remove('hidden');
            } else {
                mixGroup.classList.add('hidden');
            }
        }
        
        function handleClassChange(e) {
            const className = e.target.dataset.value;
            const subjects = config.subjectMappings[className] || [];
            createDropdown('subject-dropdown', subjects);
            listenForDropdownChange('subject-dropdown', handleSubjectChange);
            handleSubjectChange(); // Reset chapters
        }

        async function handleSubjectChange() {
            // In a real app, you would fetch chapters for the selected subject here
            const chapterDropdown = document.getElementById('chapters-multiselect');
            const optionsContainer = chapterDropdown.querySelector('.dropdown-options');
            
            // Using mock data for demonstration
            const snapshot = await mockDb.collection('questions').where('subject', '==', 'mock').get();
            const chapters = [...new Set(snapshot.docs.map(doc => doc.data().chapter))];

            if (chapters.length > 0) {
                 createDropdown('chapters-multiselect', chapters, true);
                 updateSelectedChaptersDisplay();
            } else {
                optionsContainer.innerHTML = '<div style="padding: 10px; font-style: italic;">No chapters found.</div>';
            }
        }
        
        function updateSelectedChaptersDisplay() {
            const chapterDropdown = document.getElementById('chapters-multiselect');
            const display = chapterDropdown.querySelector('.selected-chapters-display');
            const checkedChapters = Array.from(chapterDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            
            if (checkedChapters.length === 0) {
                display.textContent = 'Select one or more chapters';
                display.style.fontStyle = 'italic';
            } else {
                display.textContent = checkedChapters.join(', ');
                display.style.fontStyle = 'normal';
            }
        }

        function addSection() {
            const list = document.getElementById('sections-list');
            const sectionCount = list.children.length + 1;
            const newItem = document.createElement('div');
            newItem.className = 'section-item';
            newItem.innerHTML = `
                <span class="drag-handle">&#9776;</span>
                <input type="text" placeholder="e.g., Section ${String.fromCharCode(64 + sectionCount)}: Answer all questions">
                <button type="button" class="remove-section-btn">&times;</button>
            `;
            list.appendChild(newItem);
        }
        
        // Initialize SortableJS for the sections list
        const sectionsList = document.getElementById('sections-list');
        new Sortable(sectionsList, {
            animation: 150,
            handle: '.drag-handle'
        });

        function handleFormSubmit(event) {
            event.preventDefault();
            // 1. Validate form data (e.g., difficulty mix adds up to 100)
            
            // 2. Collect all data into a single object
            const examConfig = {
                class: document.querySelector('#class-dropdown .selected-option').textContent,
                subject: document.querySelector('#subject-dropdown .selected-option').textContent,
                chapters: Array.from(document.querySelectorAll('#chapters-multiselect input:checked')).map(cb => cb.value),
                examName: document.querySelector('#exam-name-dropdown .selected-option').textContent,
                examType: document.querySelector('#exam-type-dropdown .selected-option').textContent,
                mcqLevel: document.querySelector('#mcq-level-dropdown .selected-option').textContent,
                maxMarks: parseInt(document.querySelector('#max-marks-dropdown .selected-option').textContent, 10),
                time: parseInt(document.getElementById('time-input').value, 10),
                date: document.getElementById('date-input').value,
                difficulty: document.querySelector('#difficulty-dropdown .selected-option').textContent,
                difficultyMix: {
                    easy: parseInt(document.getElementById('easy-perc').value, 10),
                    medium: parseInt(document.getElementById('medium-perc').value, 10),
                    difficult: parseInt(document.getElementById('difficult-perc').value, 10),
                },
                sections: Array.from(document.querySelectorAll('#sections-list input')).map(input => input.value),
                instructions: document.getElementById('instructions-input').value,
            };

            // 3. Store config and navigate to the next page
            console.log("Exam Configuration:", examConfig);
            alert("This data would now be sent to the next page (exam-review.html). Check the console for the configuration object.");
            // In a real app:
            // sessionStorage.setItem('examConfig', JSON.stringify(examConfig));
            // window.location.href = 'exam-review.html';
        }

        // --- START THE APP ---
        initializeApp();
    });

    </script>
</body>
</html>