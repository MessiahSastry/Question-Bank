<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Exam Builder | St. Patrick's School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary-blue: #0f3d6b;
            --secondary-blue: #1762a7;
            --light-blue-bg: #f4f8fc;
        }
        html { height: -webkit-fill-available; }
        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f4f8fc;
            min-height: 100vh; height: -webkit-fill-available;
        }
        body::after {
            content: "St. Patrick's\A IIT & NEET FOUNDATION";
            white-space: pre; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 5vw; font-weight: bold;
            color: rgba(15, 61, 107, 0.04); z-index: -1; text-align: center;
            pointer-events: none; line-height: 1.2;
        }
        .page-wrapper {
            display: flex; flex-direction: column; min-height: 100vh;
        }
        #main-header {
            background: linear-gradient(90deg, #1762a7, #0f3d6b);
            color: #fff; border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
            min-height: 90px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 15px 10px 18px 10px;
            box-sizing: border-box; flex-shrink: 0; position: sticky; top: 0; z-index: 10;
        }
        #main-header .school-title { font-size: 1.8em; font-weight: bold; margin: 0;}
        #main-header .subtitle { font-size: 1.05em; color: #e0eaff; margin-top: 5px; }
        main {
            flex: 1 1 0%; min-height: 0; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; overflow-x: hidden; box-sizing: border-box;
        }
        .setup-form-container {
            width: 100%; max-width: 800px; margin: 0 auto 20px auto; background: #fff;
            border-radius: 16px; box-shadow: 0 4px 18px rgba(0, 27, 68, 0.1);
            padding: 25px 16px; flex-shrink: 0; overflow-x: hidden; box-sizing: border-box;
        }
        .setup-form-container h2 {
            text-align: center; color: var(--primary-blue); margin-top: 0; margin-bottom: 25px;
        }
        .form-grid {
            display: grid; gap: 16px;
            grid-template-columns: 1fr 1fr;
        }
        @media (max-width: 700px) {
            .form-grid { grid-template-columns: 1fr; }
        }
        .form-group { margin-bottom: 0; }
        .form-group label {
            font-weight: 600; margin-bottom: 6px; color: #185496; display: block;
        }
        .custom-dropdown, .multi-select-dropdown {
            position: relative;
        }
        .selected-option, .selected-chapters-display {
            padding: 10px 12px; border-radius: 6px; border: 1.3px solid #bcd6ef;
            font-size: 1em; background: #f7fafd; cursor: pointer; min-height: 42px;
        }
        .dropdown-options {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1.3px solid #bcd6ef; border-top: none;
            border-radius: 0 0 6px 6px; box-shadow: 0 6px 15px rgba(0, 27, 68, 0.1);
            z-index: 1000; max-height: 200px; overflow-y: auto;
        }
        .custom-dropdown.open .dropdown-options,
        .multi-select-dropdown.open .dropdown-options {
            display: block;
        }
        .dropdown-options div[data-value] { padding: 10px 15px; cursor: pointer; }
        .dropdown-options div[data-value]:hover { background: #e0eaff; }
        .multi-select-dropdown .dropdown-options div {
            display: flex; align-items: center; padding: 10px 15px;
        }
        .multi-select-dropdown input[type="checkbox"] { margin-right: 10px; }
        .placeholder { font-style: normal; color: #5a7a9b; }
        .form-group textarea {
            width: 100%; padding: 12px 14px; border-radius: 8px; border: 1.3px solid #bcd6ef;
            background: #f7fafd; font-size: 1em; min-height: 85px; resize: vertical; box-sizing: border-box;
        }
        .submit-btn {
            background: linear-gradient(90deg, #1762a7, #0f3d6b);
            color: #fff; font-weight: bold; cursor: pointer; padding: 13px 0;
            margin-top: 22px; width: 100%; border-radius: 8px; border: none; font-size: 1.08em;
        }
        /* Chat display */
        #ai-response-area {
            max-width: 820px;
            margin: 30px auto 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 27, 68, 0.08);
            padding: 26px 20px;
        }
        .ai-message {
            background: #f7fafd;
            color: #003865;
            border-radius: 13px;
            margin-bottom: 18px;
            padding: 13px 18px;
            font-size: 1.04em;
            line-height: 1.65;
            box-shadow: 0 1px 4px rgba(0, 27, 68, 0.04);
            white-space: pre-wrap;
        }
        .ai-message.section-title {
            background: #e0eaff;
            color: #0f3d6b;
            font-weight: bold;
            margin-top: 20px;
            font-size: 1.12em;
        }
        .ai-message.warning {
            background: #fff2e0; color: #a65c00; font-weight: bold; border: 1px solid #ffd699;
        }
    </style>
</head>
<body>
<div class="page-wrapper">
    <header id="main-header">
        <h1 class="school-title">St. Patrick's School</h1>
        <div class="subtitle">IIT & NEET FOUNDATION</div>
    </header>

    <main>
        <div class="setup-form-container">
            <h2>Exam Builder</h2>
            <form id="exam-setup-form" autocomplete="off">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Class</label>
                        <div id="class-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>Subject</label>
                        <div id="subject-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Chapters (select one or more)</label>
                        <div id="chapters-multiselect" class="multi-select-dropdown custom-dropdown">
                            <div class="selected-chapters-display placeholder">Select subject to see chapters</div>
                            <div class="dropdown-options"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Exam Name</label>
                        <div id="exam-name-dropdown" class="custom-dropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="date-input">
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" id="time-input">
                    </div>
                </div>
                <div class="form-group" style="margin-top:18px;">
                    <label>Exam Instructions / AI Prompt</label>
                    <textarea id="prompt-input" required>
Prepare a question paper as per the following structure:
Section A: Answer all questions. [Number of questions] x [Marks each] = [Total marks for section]
Section B: Answer all questions. [Number of questions] x [Marks each] = [Total marks for section]
Section C: Answer any [Number] out of [Total questions]. [Marks each] x [Number] = [Total marks for section]
Include a mix of question types suitable for the class and foundation level. All questions must be taken only from the existing Question Bank. If not enough questions are available for any section, show a clear warning.
                    </textarea>
                </div>
                <button type="submit" class="submit-btn">Generate Question Paper</button>
            </form>
        </div>

        <div id="ai-response-area" style="display:none;"></div>
    </main>
</div>
<script>
const config = {
    classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
    subjectMappings: {
        "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
    },
    examNames: ["Slip Test", "Fortnightly Exam", "Formative Assessment", "Summative Assessment"],
};
function createDropdown(containerId, options, placeholder) {
    const container = document.getElementById(containerId);
    const optionsHTML = options.map(opt => `<div data-value="${opt}">${opt}</div>`).join('');
    container.innerHTML = `
        <div class="selected-option">${placeholder}</div>
        <div class="dropdown-options">${optionsHTML}</div>
    `;
    container.dataset.value = '';
    container.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.custom-dropdown.open').forEach(d => {
            if (d.id !== containerId) d.classList.remove('open');
        });
        container.classList.toggle('open');
        if (e.target.dataset.value) {
            const selectedValue = e.target.dataset.value;
            container.querySelector('.selected-option').textContent = selectedValue;
            container.dataset.value = selectedValue;
            container.dispatchEvent(new Event('change', { bubbles: true }));
        }
    });
}
async function fetchChapters(selectedClass, selectedSubject) {
    // Replace with actual API/Firebase call for chapters (if needed)
    // Here, chapters are just examples.
    // For production, you will fetch from backend.
    return [
        "Chapter 1", "Chapter 2", "Chapter 3", "Chapter 4"
    ];
}
async function handleClassChange() {
    const selectedClass = document.getElementById('class-dropdown').dataset.value;
    const subjects = config.subjectMappings[selectedClass] || [];
    createDropdown('subject-dropdown', subjects, 'Select Subject');
    handleSubjectChange();
}
async function handleSubjectChange() {
    const selectedClass = document.getElementById('class-dropdown').dataset.value;
    const selectedSubject = document.getElementById('subject-dropdown').dataset.value;
    const chapterContainer = document.getElementById('chapters-multiselect');
    const optionsContainer = chapterContainer.querySelector('.dropdown-options');
    const display = chapterContainer.querySelector('.selected-chapters-display');
    if (!selectedSubject) {
        optionsContainer.innerHTML = '';
        display.textContent = 'Select subject to see chapters';
        display.classList.add('placeholder');
        updateSelectedChaptersDisplay();
        return;
    }
    const chapters = await fetchChapters(selectedClass, selectedSubject);
    if (chapters.length > 0) {
        optionsContainer.innerHTML = chapters.map(opt => `<div><label><input type="checkbox" value="${opt}"> ${opt}</label></div>`).join('');
    } else {
        optionsContainer.innerHTML = '<div style="padding: 10px; font-style: italic;">No chapters found.</div>';
    }
    updateSelectedChaptersDisplay();
}
function updateSelectedChaptersDisplay() {
    const chapterContainer = document.getElementById('chapters-multiselect');
    const display = chapterContainer.querySelector('.selected-chapters-display');
    const checkedChapters = Array.from(chapterContainer.querySelectorAll('input:checked')).map(cb => cb.value);
    if (checkedChapters.length === 0) {
        display.textContent = 'Select one or more chapters';
        display.classList.add('placeholder');
    } else {
        display.textContent = checkedChapters.join(', ');
        display.classList.remove('placeholder');
    }
}
// ----- Form Submit -----
document.addEventListener('DOMContentLoaded', () => {
    createDropdown('class-dropdown', config.classes, 'Select Class');
    createDropdown('subject-dropdown', [], 'Select Class first');
    createDropdown('exam-name-dropdown', config.examNames, 'Select Exam Name');
    document.getElementById('class-dropdown').addEventListener('change', handleClassChange);
    document.getElementById('subject-dropdown').addEventListener('change', handleSubjectChange);
    // Multi-select chapter dropdown
    const chapterContainer = document.getElementById('chapters-multiselect');
    chapterContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        if (e.target.closest('.selected-chapters-display')) {
            if (document.getElementById('subject-dropdown').dataset.value) {
                chapterContainer.classList.toggle('open');
            }
        }
        if (e.target.type === 'checkbox') {
            updateSelectedChaptersDisplay();
        }
    });
    // Global click to close dropdowns
    document.addEventListener('click', () => {
        document.querySelectorAll('.custom-dropdown.open').forEach(d => d.classList.remove('open'));
        document.querySelectorAll('.multi-select-dropdown.open').forEach(d => d.classList.remove('open'));
    });
    document.getElementById('date-input').valueAsDate = new Date();
    // --- Submit Handler ---
    document.getElementById('exam-setup-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        // Validation
        const examConfig = {
            class: document.getElementById('class-dropdown').dataset.value,
            subject: document.getElementById('subject-dropdown').dataset.value,
            chapters: Array.from(document.querySelectorAll('#chapters-multiselect input:checked')).map(cb => cb.value),
            examName: document.getElementById('exam-name-dropdown').dataset.value,
            date: document.getElementById('date-input').value,
            time: document.getElementById('time-input').value,
            prompt: document.getElementById('prompt-input').value.trim()
        };
        if (!examConfig.class || !examConfig.subject || examConfig.chapters.length === 0 || !examConfig.examName || !examConfig.date || !examConfig.time || !examConfig.prompt) {
            alert("Please fill all required fields and select at least one chapter.");
            return;
        }
        // --- Show waiting message in chat area ---
        const responseArea = document.getElementById('ai-response-area');
        responseArea.style.display = 'block';
        responseArea.innerHTML = `<div class="ai-message">Generating question paper... <i class="fas fa-spinner fa-spin"></i></div>`;
        // ---- SEND TO API ----
        try {
            // Replace this URL with your backend endpoint
            const API_URL = 'https://your-backend-api.com/api/v1/exam-optimize';
            // Compose the payload for backend (no Firestore call in frontend)
            const payload = {
                ...examConfig
            };
            // Call backend API (example)
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            responseArea.innerHTML = "";
            // Display sections/questions as ChatGPT style
            if (data.sections && data.sections.length > 0) {
                data.sections.forEach(section => {
                    const title = document.createElement('div');
                    title.className = 'ai-message section-title';
                    title.textContent = section.title;
                    responseArea.appendChild(title);
                    section.questions.forEach(q => {
                        const msg = document.createElement('div');
                        msg.className = 'ai-message';
                        msg.textContent = q;
                        responseArea.appendChild(msg);
                    });
                });
            }
            if (data.warning) {
                const warning = document.createElement('div');
                warning.className = 'ai-message warning';
                warning.textContent = data.warning;
                responseArea.appendChild(warning);
            }
            if ((!data.sections || data.sections.length === 0) && !data.warning) {
                responseArea.innerHTML = `<div class="ai-message warning">No sufficient questions available in the question bank for the requested exam structure.</div>`;
            }
        } catch (err) {
            responseArea.innerHTML = `<div class="ai-message warning">Error: ${err.message}</div>`;
        }
    });
});
</script>
</body>
</html>
