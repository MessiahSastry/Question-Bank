<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Exam Builder | St. Patrick's School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        body { margin:0; padding:0; font-family:'Segoe UI', Arial, sans-serif; background:#f4f8fc; }
        .page-wrapper { min-height:100vh; }
        #main-header {
            background: linear-gradient(90deg,#1762a7,#0f3d6b);
            color:#fff; border-bottom-left-radius:28px; border-bottom-right-radius:28px;
            padding:24px 10px 18px 10px; display:flex; flex-direction:column; align-items:center;
            position: sticky; top: 0; z-index: 10;
        }
        #main-header .school-title { font-size:2.2em; font-weight:bold; margin:0;}
        #main-header .subtitle { font-size:1.12em; color:#e0eaff; margin-top:4px;}
        main { display:flex; flex-direction:column; align-items:center; padding:18px 8px 40px 8px;}
        .setup-form-container {
            width:100%; max-width:440px; margin:0 auto; background:#fff; border-radius:22px;
            box-shadow:0 4px 16px rgba(0,27,68,0.13); padding:32px 20px 28px 20px;
        }
        .setup-form-container h2 { text-align:center; color:#11385d; margin:0 0 30px 0; font-size:2em; font-weight:800;}
        .form-group { margin-bottom:22px; }
        .form-group label { font-weight:700; margin-bottom:8px; color:#205c98; font-size:1.1em; letter-spacing:0.02em; display:block; }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group textarea,
        .custom-dropdown .selected-option,
        .form-group select {
            width:100%; padding:7px 14px; border-radius:10px; border:1.2px solid #bcd6ef;
            font-size:1.08em; background:#f7fafd; box-sizing:border-box; height:44px; min-height:44px; font-weight:500;
        }
        .form-group textarea { min-height:44px; height:44px; resize:vertical;}
        .custom-dropdown { position:relative; width:100%;}
        .custom-dropdown .selected-option { cursor:pointer; display:flex; align-items:center; height:44px; background:#f7fafd;}
        .dropdown-options {
            display:none; position:absolute; top:100%; left:0; right:0; background:#fff; border:1.3px solid #bcd6ef; border-top:none;
            border-radius:0 0 10px 10px; box-shadow:0 6px 15px rgba(0,27,68,0.10); z-index:1000; max-height:210px; overflow-y:auto;
        }
        .custom-dropdown.open .dropdown-options { display:block; }
        .dropdown-options div[data-value] { padding:10px 18px; cursor:pointer; font-size:1em;}
        .dropdown-options div[data-value]:hover { background:#e0eaff;}
        .submit-btn {
            background: linear-gradient(90deg,#1762a7,#0f3d6b);
            color:#fff; font-weight:bold; cursor:pointer; padding:12px 0; width:100%; border-radius:12px;
            border:none; font-size:1.15em; margin-top:16px; letter-spacing:0.01em;
            box-shadow:0 2px 7px #bcd6ef1a; transition:background 0.17s;
        }
        .submit-btn:hover { background:linear-gradient(90deg,#155ca2,#12416c);}
        @media (max-width:500px){ .setup-form-container{max-width:98vw; padding:12px 5px 14px 5px;} }
        .modal-spinner { display:inline-block; margin-right:10px; }
    </style>
</head>
<body>
<div class="page-wrapper">
    <header id="main-header">
        <div class="school-title">St. Patrick's School</div>
        <div class="subtitle">IIT & NEET FOUNDATION</div>
    </header>
    <main>
        <div class="setup-form-container">
            <h2>Exam Builder</h2>
            <form id="exam-setup-form" autocomplete="off">
                <div class="form-group">
                    <label>Class:</label>
                    <div id="class-dropdown" class="custom-dropdown"></div>
                </div>
                <div class="form-group">
                    <label>Subject:</label>
                    <div id="subject-dropdown" class="custom-dropdown"></div>
                </div>
                <div class="form-group">
                    <label>Chapters (select one or more):</label>
                    <div id="chapters-multiselect" class="custom-dropdown">
                        <div class="selected-option">Select subject to see chapters</div>
                        <div class="dropdown-options"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Exam Name:</label>
                    <div id="exam-name-dropdown" class="custom-dropdown"></div>
                </div>
                <div class="form-group">
                   <label>Date:</label>
                    <input type="date" id="date-input" name="date">
                </div>
                <div class="form-group">
                    <label>Time (in minutes):</label>
                    <input type="number" id="time-input" name="time" min="10" max="360" step="1" placeholder="e.g. 90">
                </div>
                <div class="form-group" style="margin-bottom: 28px;">
                    <label>Exam Instructions / AI Prompt</label>
                    <textarea id="ai-prompt"
                        placeholder="Type your exam instructions and structure for the AI here..."
                        rows="2"
                        style="
                            font-size: 1.13em;
                            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
                            background: #f8fafc;
                            border: 1.6px solid #bcd6ef;
                            border-radius: 14px;
                            padding: 16px 14px 16px 14px;
                            min-height: 50px;
                            max-height: 260px;
                            resize: none;
                            line-height: 1.7;
                            box-shadow: 0 1px 8px #0f3d6b14;
                            outline: none;
                            transition: border 0.15s, box-shadow 0.15s;
                        "
                        autocomplete="off"
                        spellcheck="true"
                    ></textarea>
                </div>

                <button type="submit" class="submit-btn">Start Generating</button>
            </form>
        </div>
    </main>
</div>
<!-- Confirmation Modal for AI Prompt -->
<div id="prompt-confirm-modal" style="display:none; position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh; background:rgba(30,44,80,0.28);align-items:center;justify-content:center;">
  <div style="background:#fff; border-radius:18px; max-width:94vw; width:360px; padding:32px 18px; box-shadow:0 8px 32px #0002;">
    <div style="color:#0f3d6b; font-size:1.17em; font-weight:700; margin-bottom:18px;">
      Confirm Exam Instructions
    </div>
    <div id="modal-prompt-summary" style="background:#f7fafd; border-radius:8px; color:#185496; padding:15px 10px; margin-bottom:26px; font-size:1.08em; max-height:140px; overflow:auto;">
        <span class="modal-spinner" style="display:none;"><i class="fas fa-spinner fa-spin"></i> Thinking...</span>
    </div>
    <div id="modal-prompt-warning" style="color:#c82333; font-size:1em; margin-bottom:10px; display:none;"></div>
    <div style="display:flex; gap:16px; justify-content:flex-end;">
      <button id="cancel-modal-btn" style="background:#e0eaff; color:#205c98; border:none; border-radius:8px; font-size:1em; padding:7px 18px; cursor:pointer;">Cancel</button>
      <button id="confirm-modal-btn" style="background:#1762a7; color:#fff; border:none; border-radius:8px; font-size:1em; padding:7px 18px; font-weight:600; cursor:pointer;" disabled>Proceed</button>
    </div>
  </div>
</div>
<script>
    // === CONFIG ===
    const API_BASE_URL = 'https://question-bank-lqsu.onrender.com/api/v1';

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
        authDomain: "stpatricks-questionbank.firebaseapp.com",
        projectId: "stpatricks-questionbank",
        storageBucket: "stpatricks-questionbank.appspot.com",
        messagingSenderId: "917615322861",
        appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- CONFIG DATA ---
    const config = {
        classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
        subjectMappings: {
            "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
            "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
            "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
            "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
            "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
            "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
            "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
            "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
        },
        examNames: ["Slip Test", "Fortnightly Exam", "Formative Assessment", "Summative Assessment"]
    };

    // --- SIMPLE DROPDOWN HANDLING ---
    function createDropdown(containerId, options, placeholder) {
        const container = document.getElementById(containerId);
        const optionsHTML = options.map(opt => `<div data-value="${opt}">${opt}</div>`).join('');
        container.innerHTML = `<div class="selected-option">${placeholder}</div><div class="dropdown-options">${optionsHTML}</div>`;
        container.dataset.value = '';

        container.onclick = (e) => {
            e.stopPropagation();
            document.querySelectorAll('.custom-dropdown.open').forEach(d => {
                if (d !== container) d.classList.remove('open');
            });
            container.classList.toggle('open');
            if (e.target.dataset.value) {
                container.querySelector('.selected-option').textContent = e.target.dataset.value;
                container.dataset.value = e.target.dataset.value;
                container.dispatchEvent(new Event('change', { bubbles: true }));
            }
        };
    }

    document.addEventListener('DOMContentLoaded', () => {
        createDropdown('class-dropdown', config.classes, 'Select Class');
        createDropdown('subject-dropdown', [], 'Select Class first');
        createDropdown('exam-name-dropdown', config.examNames, 'Select Exam Name');

        // Class selection
        document.getElementById('class-dropdown').addEventListener('change', () => {
            const selectedClass = document.getElementById('class-dropdown').dataset.value;
            createDropdown('subject-dropdown', config.subjectMappings[selectedClass] || [], 'Select Subject');
            document.getElementById('chapters-multiselect').querySelector('.selected-option').textContent = 'Select subject to see chapters';
            document.getElementById('chapters-multiselect').querySelector('.dropdown-options').innerHTML = '';
        });

        // Subject selection & fetch chapters from Firestore
        document.getElementById('subject-dropdown').addEventListener('change', async () => {
            const selectedClass = document.getElementById('class-dropdown').dataset.value;
            const selectedSubject = document.getElementById('subject-dropdown').dataset.value;
            const chapterContainer = document.getElementById('chapters-multiselect');
            const optionsContainer = chapterContainer.querySelector('.dropdown-options');
            const display = chapterContainer.querySelector('.selected-option');

            if (!selectedClass || !selectedSubject) {
                optionsContainer.innerHTML = '';
                display.textContent = 'Select subject to see chapters';
                return;
            }
            // Fetch chapters from Firestore
            try {
                optionsContainer.innerHTML = `<div style="padding:10px;font-style:italic;">Loading...</div>`;
                const snapshot = await db.collection("questions")
                    .where("class", "==", selectedClass)
                    .where("subject", "==", selectedSubject)
                    .get();
                const chapterSet = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.chapter) chapterSet.add(data.chapter);
                });
                const chapters = Array.from(chapterSet);
                if (chapters.length > 0) {
                    optionsContainer.innerHTML = chapters.map(opt => `<div><label><input type="checkbox" value="${opt}"> ${opt}</label></div>`).join('');
                    display.textContent = 'Select one or more chapters';
                } else {
                    optionsContainer.innerHTML = `<div style="padding:10px;font-style:italic;">No chapters found.</div>`;
                    display.textContent = 'No chapters found';
                }
            } catch (err) {
                optionsContainer.innerHTML = `<div style="padding:10px;font-style:italic;color:red;">Error loading chapters</div>`;
                display.textContent = 'Error loading chapters';
            }
        });

        // Chapters multi-select
        const chapterContainer = document.getElementById('chapters-multiselect');
        chapterContainer.addEventListener('click', (e) => {
            e.stopPropagation();
            if (e.target.closest('.selected-option')) {
                if (document.getElementById('subject-dropdown').dataset.value)
                    chapterContainer.classList.toggle('open');
            }
            if (e.target.type === 'checkbox') {
                const checked = Array.from(chapterContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                chapterContainer.querySelector('.selected-option').textContent = checked.length ? checked.join(', ') : 'Select one or more chapters';
            }
        });
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-dropdown.open').forEach(d => d.classList.remove('open'));
        });

        // Set today's date as default
        document.getElementById('date-input').valueAsDate = new Date();
    });

    // Auto-resize AI prompt textarea
    const aiPrompt = document.getElementById('ai-prompt');
    if (aiPrompt) {
        aiPrompt.addEventListener('input', () => {
            aiPrompt.style.height = 'auto';
            aiPrompt.style.height = (aiPrompt.scrollHeight) + 'px';
        });
    }

    // FORM SUBMIT WITH AI-POWERED MODAL SUMMARY
    document.getElementById('exam-setup-form').onsubmit = async function(e) {
        e.preventDefault();

        // Collect values
        const classValue = document.getElementById('class-dropdown').dataset.value;
        const subjectValue = document.getElementById('subject-dropdown').dataset.value;
        const examNameValue = document.getElementById('exam-name-dropdown').dataset.value;
        const dateValue = document.getElementById('date-input').value;
        const timeValue = document.getElementById('time-input').value;
        const promptValue = document.getElementById('ai-prompt').value.trim();
        const checkedChapters = Array.from(document.querySelectorAll('#chapters-multiselect input[type="checkbox"]:checked')).map(cb => cb.value);

        // Basic validation
        if (!classValue || !subjectValue || checkedChapters.length === 0) {
            alert("Please select class, subject, and at least one chapter.");
            return;
        }

        // Prepare payload
        const payload = {
            class: classValue,
            subject: subjectValue,
            chapters: checkedChapters,
            examName: examNameValue,
            date: dateValue,
            time: timeValue,
            prompt: promptValue
        };

        // Show spinner and clear modal content
        const modal = document.getElementById('prompt-confirm-modal');
        const summaryDiv = document.getElementById('modal-prompt-summary');
        const warningDiv = document.getElementById('modal-prompt-warning');
        summaryDiv.innerHTML = '<span class="modal-spinner"><i class="fas fa-spinner fa-spin"></i> Thinking...</span>';
        warningDiv.style.display = 'none';
        document.getElementById('confirm-modal-btn').disabled = true;
        modal.style.display = 'flex';

        // Call summarize-prompt endpoint
        try {
            const resp = await fetch(API_BASE_URL + '/summarize-prompt', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await resp.json();
            if (data.error) throw new Error(data.error);

            summaryDiv.textContent = data.summary || "Could not understand your instructions. Please try again.";
            document.getElementById('confirm-modal-btn').disabled = false;
        } catch (err) {
            summaryDiv.textContent = "Sorry, could not summarize the instructions. Please check your input.";
            warningDiv.textContent = err.message;
            warningDiv.style.display = 'block';
        }

        // Cancel button
        document.getElementById('cancel-modal-btn').onclick = function() {
            modal.style.display = 'none';
        };

        // Proceed button
        document.getElementById('confirm-modal-btn').onclick = async function() {
    modal.style.display = 'none';

    // Instead of using the original promptValue, use the AI summary!
    const summaryText = document.getElementById('modal-prompt-summary').textContent;

    try {
        const res = await fetch(API_BASE_URL + '/build-exam', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                class: classValue,
                subject: subjectValue,
                chapters: checkedChapters,
                examName: examNameValue,
                date: dateValue,
                time: timeValue,
                prompt: summaryText // <--- Use the AI summary here!
            })
        });
        // ...rest of your logic
    } catch (err) {
        alert("Error: " + err.message);
    }
};
};
</script>
</body>
</html>
