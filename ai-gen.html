<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AI Question Generator | St. Patrick's School</title>
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
      window.MathJax = { tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] }, svg: { fontCache: "global" } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
      :root {
        --header-height: 90px;
        --chat-bar-height: 65px;
      }
      html {
        height: -webkit-fill-available;
      }
      body {
        margin: 0; padding: 0; font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        background-color: #f4f8fc;
        height: 100vh;
        height: -webkit-fill-available;
        overflow: hidden;
      }
      body::after {
        content: "St. Patrick's\A IIT & NEET FOUNDATION";
        white-space: pre; position: fixed; top: 50%; left: 50%;
        transform: translate(-50%, -50%); font-size: 5vw; font-weight: bold;
        color: rgba(15, 61, 107, 0.04); z-index: -1; text-align: center;
        pointer-events: none; line-height: 1.2;
      }
      .page-wrapper {
        display: flex; flex-direction: column; height: 100%;
      }
      
      #main-header {
        background: linear-gradient(90deg, #1762a7, #0f3d6b);
        color: #fff; border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
        min-height: var(--header-height); display: flex; flex-direction: column;
        align-items: center; justify-content: center; padding: 15px 10px 18px 10px;
        box-sizing: border-box; flex-shrink: 0;
      }
      #main-header .school-title { font-size: 1.8em; font-weight: bold; margin:0; }
      #main-header .subtitle { font-size: 1.05em; color: #e0eaff; margin-top: 5px; }

      main {
        flex-grow: 1; overflow-y: auto;
        display: flex; flex-direction: column;
      }
      
      .review-container {
        width: 100%; max-width: 800px; margin: auto; background: #fff;
        border-radius: 16px; box-shadow: 0 4px 18px rgba(0, 27, 68, 0.1);
        display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;
        margin-top: 20px; margin-bottom: 20px;
      }
      .setup-form-container { padding: 25px 30px; }
      .setup-form-container h2 { text-align: center; color: #0f3d6b; margin-top: 0; margin-bottom: 20px; }
      .setup-form-container .form-group { margin-bottom: 15px; }
      .setup-form-container label { font-weight: 600; margin-bottom: 5px; color: #185496; display: block; }
      .setup-form-container input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1.3px solid #bcd6ef; font-size: 1em; background: #f7fafd; box-sizing: border-box; }
      .setup-form-container button[type="submit"] { background: linear-gradient(90deg, #1762a7, #0f3d6b); color: #fff; font-weight: bold; cursor: pointer; padding: 12px 0; margin-top: 15px; width: 100%; border-radius: 8px; border: none; font-size: 1.05em; }

      .custom-dropdown { position: relative; }
      .selected-option { padding: 10px 12px; color: #12416c; background: #f7fafd; border-radius: 6px; border: 1.3px solid #bcd6ef; cursor: pointer; }
      .dropdown-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1.3px solid #bcd6ef; border-top: none; border-radius: 0 0 6px 6px; box-shadow: 0 6px 15px rgba(0, 27, 68, 0.1); z-index: 1000; max-height: 200px; overflow-y: auto; }
      .custom-dropdown.open .dropdown-options { display: block; }
      .dropdown-options div[data-value] { padding: 10px 15px; cursor: pointer; }
      .dropdown-options div[data-value]:hover { background: #e0eaff; }

      .chat-ui-bar {
        background: linear-gradient(90deg, #1762a7, #0f3d6b);
        color: white; flex-shrink: 0; padding: 12px 15px;
        display: flex; align-items: center; box-sizing: border-box;
      }
      .ai-chat-header {
        justify-content: space-between;
        flex-direction: column; align-items: flex-start;
        justify-content: center; gap: 5px;
      }
      .chat-header-line { width: 100%; }
      .chat-header-line.buttons { margin-top: 8px; display: flex; gap: 10px; }
      .ai-chat-header p { margin: 0; font-size: 0.9em; line-height: 1.4; font-weight: 500;}
      .header-actions .btn-small { background-color: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 14px; font-size: 0.9em; border-radius: 5px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
      .header-actions .btn-small:hover { background-color: rgba(255,255,255,0.3); }
      #ai-save-all-btn { background-color: #28a745; }
      
      .chat-input-bar {
        gap: 10px;
        transition: height 0.2s ease;
    }
      
      .ai-chat-container { display: flex; flex-direction: column; height: 100%; }

      .chat-messages-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
      }
      .message {
        margin-bottom: 12px;
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 85%;
        word-wrap: break-word;
        line-height: 1.5;
      }
      .user-message {
        background-color: #dcf8c6;
        margin-left: auto;
        color: #333;
        align-self: flex-end;
      }
      .ai-message {
        background-color: #fff;
        margin-right: auto;
        color: #333;
        box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        align-self: flex-start;
      }
      .system-message { background-color: #e9edef; color: #54656f; text-align: center; font-size: 0.85em; max-width: 100%; border-radius: 5px; margin: 8px auto; }
      
      .ai-question-item {
        background-color: #fff;
        color: #222;
        float: left;
        text-align: left;
        max-width: 85%;
        margin-bottom: 12px;
        padding: 12px 16px;
        border-radius: 14px;
        font-size: 0.95em;
        line-height: 1.5em;
        clear: both;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        align-self: flex-start;
        padding-right: 40px;
      }
      .question-meta-ai {
        color: #c82333;
        font-weight: 600;
        font-size: 0.9em;
        margin-bottom: 6px;
        display: block;
      }
      .question-text-ai {
        color: #004085;
        font-size: 0.98em;
        white-space: pre-wrap;
        display: block;
      }
      .selection-popup {
        position: absolute; background: #333; color: white; border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 5px;
        z-index: 1010; display: flex; gap: 5px;
      }
      .selection-popup button { background: none; border: none; color: white; padding: 8px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
      .selection-popup button:hover { background-color: #555; }
      
      .chat-input-container {
        position: relative;
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 25px;
        padding: 8px 15px;
        flex-grow: 1;
      }
      #chat-prompt-input {
            flex-grow: 1;
            padding: 0;
            border: none;
            outline: none;
            font-size: 16px;
            resize: none;
            line-height: 1.4;
            background: transparent;
            color: #333;
            max-height: 120px;
            min-height: 22px;
            padding-right: 70px;
            transition: height 0.2s ease;
        }
      .input-buttons {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #chat-upload-btn, #chat-send-btn {
        background: none;
        border: none;
        color: #54656f;
        font-size: 1.4em;
        cursor: pointer;
        padding: 5px;
      }
      #chat-send-btn {
        color: #1762a7;
      }
      
      #scroll-to-bottom {
        position: fixed;
        bottom: 85px;
        right: 20px;
        z-index: 100;
        background-color: #0f3d6b;
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        font-size: 1.2em;
        cursor: pointer;
        display: none;
        animation: floatPulse 2.5s ease-in-out infinite;
        box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        transition: transform 0.3s ease;
      }
      #scroll-to-bottom:hover {
        transform: scale(1.1);
      }
      @keyframes floatPulse {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-4px); }
      }

      .edit-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2000;
        background: #ffffff;
        border: 1.5px solid #ccc;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        padding: 20px 25px;
        max-width: 90%;
        width: 600px;
        font-family: 'Segoe UI', sans-serif;
      }
      .edit-popup h3 {
        margin-top: 0;
        font-size: 1.3em;
        color: #0f3d6b;
      }
      .edit-popup label {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
        color: #185496;
      }
      .edit-popup input,
      .edit-popup textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 14px;
        font-size: 1em;
        border: 1.3px solid #bcd6ef;
        border-radius: 6px;
        background-color: #f7fafd;
        box-sizing: border-box;
      }
      .edit-popup .popup-buttons {
        text-align: right;
      }
      .edit-popup .popup-buttons button {
        padding: 8px 14px;
        margin-left: 10px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.95em;
      }
      .edit-popup #edit-cancel {
        background: #ccc;
        color: #333;
      }
      .edit-popup #edit-save {
        background: #0f3d6b;
        color: white;
      }
      
      .chat-bubble {
        max-width: 80%;
        margin-bottom: 12px;
        padding: 10px 14px;
        border-radius: 14px;
        font-size: 0.95em;
        line-height: 1.4em;
        display: inline-block;
        clear: both;
        position: relative;
        word-wrap: break-word;
        align-self: flex-end;
      }
      .user-bubble {
        background-color: #d1eaff;
        color: #003865;
        float: right;
        text-align: right;
      }
      .ai-bubble {
        background-color: #f1f1f1;
        color: #222;
        float: left;
        text-align: left;
        align-self: flex-start;
      }
      .bubble-text {
        white-space: pre-wrap;
      }

      .question-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 10;
      }
      .q-action-btn {
        background: none;
        border: none;
        color: #54656f;
        font-size: 1.1em;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        line-height: 20px;
      }
      .q-action-btn:hover {
        background-color: #e0e0e0;
      }

      .actions-menu {
        position: absolute;
        background: #333;
        color: white;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        padding: 5px;
        z-index: 1010;
        display: flex;
        flex-direction: column;
        gap: 0;
        right: 15px;
        top: 40px;
        min-width: 100px;
      }
      .actions-menu button {
        background: none;
        border: none;
        color: white;
        padding: 10px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.95em;
        text-align: left;
      }
      .actions-menu button:hover {
        background-color: #555;
      }

      .temp-answer {
        background-color: #fff8e1;
        border-top: 2px solid #ffecb3;
        padding: 10px 14px;
        margin-top: 10px;
        border-radius: 0 0 12px 12px;
        font-style: italic;
        color: #5d4037;
        white-space: pre-wrap;
      }
        /* --- Styles for Confirmation Modal --- */
.confirmation-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    padding: 15px;
    box-sizing: border-box;
}

.confirmation-modal {
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 100%;
    max-width: 450px;
    text-align: left;
}

.confirmation-modal h3 {
    margin-top: 0;
    font-size: 1.2em;
    color: #0f3d6b;
}

.confirmation-modal p {
    line-height: 1.6;
    color: #333;
    font-size: 0.95em;
    white-space: pre-wrap; /* This ensures line breaks from AI are respected */
}

.confirmation-modal .modal-buttons {
    margin-top: 20px;
    text-align: right;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.confirmation-modal .modal-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    font-size: 0.95em;
}

#confirm-cancel-btn {
    background: #e9ecef;
    color: #495057;
}

#confirm-proceed-btn {
    background: #0f3d6b;
    color: white;
}
    </style>
</head>
<body>
    <script src="chapters.js"></script>
    <div class="page-wrapper">
        <header id="main-header">
          <h1 class="school-title">St. Patrick's School</h1>
          <div class="subtitle">IIT & NEET FOUNDATION</div>
        </header>
        <main>
          <div id="ai-container" class="review-container">
            <div class="setup-form-container">
                <h2>AI Question Generator</h2>
                <p>Loading...</p>
            </div>
          </div>
        </main>
    </div>

    <input type="file" id="file-upload-input" accept="image/*,application/pdf,.doc,.docx" capture="environment" style="display:none;">

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

   <script>
    // --- FULL JAVASCRIPT ---

    const API_BASE_URL = 'https://question-bank-lqsu.onrender.com';
    const firebaseConfig = {
      apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
      authDomain: "stpatricks-questionbank.firebaseapp.com",
      projectId: "stpatricks-questionbank",
      storageBucket: "stpatricks-questionbank.appspot.com",
      messagingSenderId: "917615322861",
      appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore(); let stagedFile = null;
    let currentUserProfile = null;
    let currentSessionQuestions = [];
    const aiGeneratorConfig = {
      classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
      subjectMappings: {
        "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
      },
      questionTypes: ["MCQ (Single)", "MCQ (Multiple)", "Descriptive"],
      getSubjectsForClass: function(className) { return this.subjectMappings[className] || []; }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUserProfile = { uid: user.uid, email: user.email, displayName: user.displayName };
          const state = history.state || {};
          if (state.page === 'chat') {
            loadAiChatInterface(state.sessionParams);
          } else {
            loadAiQuestionGeneratorForm();
          }
        } else {
          window.location.href = 'login.html';
        }
      });
      window.addEventListener('popstate', (event) => {
        const state = event.state || {};
        if (state.page === 'chat') {
            loadAiChatInterface(state.sessionParams);
        } else {
            loadAiQuestionGeneratorForm();
        }
      });
    });
    
    function loadAiQuestionGeneratorForm() {
      document.getElementById('main-header').style.display = 'flex';
      const container = document.getElementById('ai-container');
      container.innerHTML = '<div class="setup-form-container"></div>';
      const formContainer = container.querySelector('.setup-form-container');
      const classesHTML = aiGeneratorConfig.classes.map(c => `<div data-value="${c}">${c}</div>`).join('');
      const initialSubjects = aiGeneratorConfig.getSubjectsForClass(aiGeneratorConfig.classes[0]);
      const subjectsHTML = initialSubjects.map(s => `<div data-value="${s}">${s}</div>`).join('');
      const qTypesHTML = aiGeneratorConfig.questionTypes.map(qt => `<div data-value="${qt}">${qt}</div>`).join('');
      
      formContainer.innerHTML = `
      <h2>AI Question Generator</h2>
        <form id="ai-setup-form">
            <div class="form-group"><label>Class:</label><div id="class-dropdown-ai" class="custom-dropdown"><input type="hidden" id="class-value-ai" value="${aiGeneratorConfig.classes[0]}"><div class="selected-option">${aiGeneratorConfig.classes[0]}</div><div class="dropdown-options">${classesHTML}</div></div></div>
            <div class="form-group"><label>Subject:</label><div id="subject-dropdown-ai" class="custom-dropdown"><input type="hidden" id="subject-value-ai" value="${initialSubjects[0] || ''}"><div class="selected-option">${initialSubjects[0] || 'Select Subject'}</div><div class="dropdown-options">${subjectsHTML}</div></div></div>
            <div class="form-group"><label>Question Type:</label><div id="qtype-dropdown-ai" class="custom-dropdown"><input type="hidden" id="qtype-value-ai" value="${aiGeneratorConfig.questionTypes[0]}"><div class="selected-option">${aiGeneratorConfig.questionTypes[0]}</div><div class="dropdown-options">${qTypesHTML}</div></div></div>
            <div class="form-group">
              <label>Chapter:</label>
              <div id="chapter-dropdown-ai" class="custom-dropdown">
                <input type="hidden" id="chapter-value-ai" value="">
                <div class="selected-option">Select Chapter</div>
                <div class="dropdown-options"></div>
              </div>
            </div>
            <button type="submit">Start Generating</button>
       </form>`;
        const initialChapters =
          textbooks[aiGeneratorConfig.classes[0]] && textbooks[aiGeneratorConfig.classes[0]][initialSubjects[0]]
            ? textbooks[aiGeneratorConfig.classes[0]][initialSubjects[0]]
            : [];
        const chaptersHTML = initialChapters.map(ch => `<div data-value="${ch}">${ch}</div>`).join('');
        const chapterDropdown = formContainer.querySelector('#chapter-dropdown-ai .dropdown-options');
        const chapterSelected = formContainer.querySelector('#chapter-dropdown-ai .selected-option');
        const chapterInput = formContainer.querySelector('#chapter-value-ai');
        chapterDropdown.innerHTML = chaptersHTML;
        chapterSelected.textContent = initialChapters[0] || 'Select Chapter';
        chapterInput.value = initialChapters[0] || '';
      
      setupCustomDropdownsForForm();
      document.getElementById("ai-setup-form").onsubmit = (e) => {
        e.preventDefault();
        const sessionParams = {
          class: document.getElementById('class-value-ai').value,
          subject: document.getElementById('subject-value-ai').value,
          questionType: document.getElementById('qtype-value-ai').value,
          chapter: document.getElementById('chapter-value-ai').value,
        };
        if (!sessionParams.chapter || !sessionParams.subject) return;
        history.pushState({ page: 'chat', sessionParams: sessionParams }, 'Chat', '#chat');
        loadAiChatInterface(sessionParams);
      };
    }
    
    function loadAiChatInterface(sessionParams) {
        document.getElementById('main-header').style.display = 'none';
        const container = document.getElementById('ai-container');
        currentSessionQuestions = [];
        container.innerHTML = `
        <div class="ai-chat-container">
            <div class="ai-chat-header chat-ui-bar">
                <div class="chat-header-line">
                    <p><b>Class:</b> ${sessionParams.class} / <b>Subject:</b> ${sessionParams.subject}</p>
                </div>
                <div class="chat-header-line">
                    <p><b>Chapter:</b> ${sessionParams.chapter}</p>
                </div>
                <div class="chat-header-line buttons">
                    <div class="header-actions">
                        <button id="ai-change-setup-btn" class="btn-small">Change Setup</button>
                        <button id="ai-save-all-btn" class="btn-small">Save All</button>
                    </div>
                </div>
            </div>
            <div id="chat-messages-area" class="chat-messages-area"></div>
            <div id="file-preview-box" style="display: none; padding: 6px 16px; background: white; color: #333; font-size: 0.9em; font-family: 'Segoe UI', sans-serif; border-bottom: 1px solid #ddd;">
                <span style="color: #1762a7;">📄</span>
                <span id="file-preview-name" style="font-weight: 600; color: #333;"></span>
                <button id="remove-file-btn" style="background: none; border: none; color: #c82333; font-size: 1.1em; cursor: pointer; margin-left: 10px;" title="Remove File">❌</button>
            </div>
            <div id="chat-input-bar" class="chat-ui-bar chat-input-bar">
                <div class="chat-input-container">
                    <textarea id="chat-prompt-input" placeholder="e.g., Generate HOTS questions from Algebra..." rows="1"></textarea>
                    <div class="input-buttons">
                        <button id="chat-upload-btn" title="Attach File"><i class="fas fa-paperclip"></i></button>
                        <button id="chat-send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            <button id="scroll-to-bottom" title="Scroll to Bottom">⬇️</button>
        </div>`;
        document.getElementById('ai-change-setup-btn').onclick = () => history.back();
        document.getElementById('ai-save-all-btn').onclick = () => saveSessionQuestions(sessionParams);
        const chatPromptInput = document.getElementById('chat-prompt-input');
        const fileUploadInput = document.getElementById('file-upload-input');
        const sendBtn = document.getElementById('chat-send-btn');
        document.getElementById('chat-upload-btn').onclick = () => fileUploadInput.click();
        
        const removeFileBtn = document.getElementById('remove-file-btn');
        removeFileBtn.onclick = () => {
            stagedFile = null;
            document.getElementById('file-preview-box').style.display = 'none';
            document.getElementById('file-preview-name').textContent = '';
            document.getElementById('chat-prompt-input').placeholder = "e.g., Generate HOTS questions from Algebra...";
            document.getElementById('chat-upload-btn').style.color = '#54656f';
            updateSendButtonState(chatPromptInput, sendBtn); 
        };

        sendBtn.onclick = () => handleSendPrompt(sessionParams);
               
        chatPromptInput.addEventListener('input', () => {
            chatPromptInput.style.height = 'auto';
            let scrollHeight = chatPromptInput.scrollHeight;
            const maxHeight = 120;
            if (scrollHeight > maxHeight) {
                chatPromptInput.style.height = maxHeight + 'px';
                chatPromptInput.style.overflowY = 'auto';
            } else {
                chatPromptInput.style.height = scrollHeight + 'px';
                chatPromptInput.style.overflowY = 'hidden';
            }
            updateSendButtonState(chatPromptInput, sendBtn);
        });

        fileUploadInput.onchange = (e) => {
            handleFileUpload(e, sessionParams);
            updateSendButtonState(chatPromptInput, sendBtn);
        };
        
        updateSendButtonState(chatPromptInput, sendBtn);
    } 

    function updateSendButtonState(chatPromptInput, sendBtn) {
        if (chatPromptInput.value.trim() !== '' || stagedFile) {
            sendBtn.disabled = false;
        } else {
            sendBtn.disabled = true;
        }
    }
    
    function setupCustomDropdownsForForm() {
        setupCustomDropdown('class-dropdown-ai', 'class-value-ai', (selectedClass) => {
            const subjectDropdown = document.getElementById('subject-dropdown-ai');
            const subjectOptions = subjectDropdown.querySelector('.dropdown-options');
            const subjectSelected = subjectDropdown.querySelector('.selected-option');
            const subjectInput = document.getElementById('subject-value-ai');
            const newSubjects = aiGeneratorConfig.getSubjectsForClass(selectedClass);
            subjectOptions.innerHTML = newSubjects.map(s => `<div data-value="${s}">${s}</div>`).join('');
            subjectSelected.textContent = newSubjects[0] || 'Select Subject';
            subjectInput.value = newSubjects[0] || '';
            updateChapterDropdown(selectedClass, newSubjects[0] || '');
            optionsContainerListener(subjectOptions, subjectSelected, subjectInput, subjectDropdown, (newSubject) => {
                updateChapterDropdown(selectedClass, newSubject);
            });
        });
        setupCustomDropdown('subject-dropdown-ai', 'subject-value-ai', (selectedSubject) => {
            const selectedClass = document.getElementById('class-value-ai').value;
            updateChapterDropdown(selectedClass, selectedSubject);
        });
        setupCustomDropdown('qtype-dropdown-ai', 'qtype-value-ai');
        setupCustomDropdown('chapter-dropdown-ai', 'chapter-value-ai');
    }

    function updateChapterDropdown(selectedClass, selectedSubject) {
        const chapterDropdown = document.getElementById('chapter-dropdown-ai');
        const chapterOptions = chapterDropdown.querySelector('.dropdown-options');
        const chapterSelected = chapterDropdown.querySelector('.selected-option');
        const chapterInput = document.getElementById('chapter-value-ai');
        const chapters = (textbooks[selectedClass] && textbooks[selectedClass][selectedSubject]) ? textbooks[selectedClass][selectedSubject] : [];
        chapterOptions.innerHTML = chapters.map(ch => `<div data-value="${ch}">${ch}</div>`).join('');
        chapterSelected.textContent = chapters[0] || 'Select Chapter';
        chapterInput.value = chapters[0] || '';
        optionsContainerListener(chapterOptions, chapterSelected, chapterInput, chapterDropdown, null);
    }

    function setupCustomDropdown(dropdownId, inputId, callback) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const selected = dropdown.querySelector('.selected-option');
        const options = dropdown.querySelector('.dropdown-options');
        const input = document.getElementById(inputId);
        selected.onclick = (e) => { e.stopPropagation(); toggleDropdown(dropdownId); };
        optionsContainerListener(options, selected, input, dropdown, callback);
    }

    function optionsContainerListener(options, selected, input, dropdown, callback) {
        options.querySelectorAll('div[data-value]').forEach(option => {
            option.onclick = () => {
                selected.textContent = option.textContent;
                input.value = option.dataset.value;
                dropdown.classList.remove('open');
                if (callback) callback(input.value);
            };
        });
    }

    function toggleDropdown(dropdownId) {
        const currentDropdown = document.getElementById(dropdownId);
        if(!currentDropdown) return;
        const currentlyOpen = currentDropdown.classList.contains('open');
        document.querySelectorAll('.custom-dropdown.open').forEach(d => {
            if (d.id !== dropdownId) d.classList.remove('open');
        });
        if(!currentlyOpen) currentDropdown.classList.add('open');
    }
       function showConfirmationModal(summary, originalPrompt, sessionParams) {
    const overlay = document.createElement('div');
    overlay.className = 'confirmation-overlay';

    overlay.innerHTML = `
        <div class="confirmation-modal">
            <h3>Confirm Exam Instructions</h3>
            <p>${summary}</p>
            <div class="modal-buttons">
                <button id="confirm-cancel-btn">Cancel</button>
                <button id="confirm-proceed-btn">Proceed</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    document.getElementById('confirm-cancel-btn').onclick = () => {
        overlay.remove();
        // Re-enable the send button if cancelled
        const chatPromptInput = document.getElementById('chat-prompt-input');
        const sendBtn = document.getElementById('chat-send-btn');
        sendBtn.innerHTML = `<i class="fas fa-paper-plane"></i>`;
        updateSendButtonState(chatPromptInput, sendBtn);
    };

    document.getElementById('confirm-proceed-btn').onclick = () => {
        overlay.remove();
        proceedWithGeneration(originalPrompt, sessionParams);
    };
} 
    async function proceedWithGeneration(originalPrompt, sessionParams) {
    const messagesArea = document.getElementById('chat-messages-area');
    const chatPromptInput = document.getElementById('chat-prompt-input');
    const sendBtn = document.getElementById('chat-send-btn');
    const didSendFile = stagedFile !== null; // We need to check this again

    const loadingMessage = appendChatMessage('Generating questions as per your instructions...', 'system-message', messagesArea);
    try {
        let result;
        if (stagedFile) {
            const formData = new FormData();
            formData.append('imageFile', stagedFile);
            formData.append('prompt', originalPrompt);
            const response = await fetch(`${API_BASE_URL}/api/v1/extract-from-image`, {
                method: 'POST',
                body: formData
            });
            result = await response.json();
            if (!response.ok) throw new Error(result.error || "File processing failed.");
        } else {
            let fullPromptForAI;
            const baseInfo = `Class: ${sessionParams.class}, Subject: ${sessionParams.subject}, Chapter: ${sessionParams.chapter}. User request: "${originalPrompt}".`;

            if (sessionParams.questionType === "MCQ (Single)") {
                    fullPromptForAI = `${baseInfo}
                Strictly follow these level definitions for every question:
                - Level 1: Easy & Medium
                - Level 2: Difficult & Very Difficult
                - Level 3: Challenging & Very Challenging
                    Instructions for Level 3 questions (for any class 6th–10th):
                    - Each question must require multi-step logical reasoning and should combine at least two different concepts. Questions should have non-standard twists or novel approaches, similar to those found in Olympiad, NTSE, or IIT Foundation exams.
                    - Do NOT include questions that are direct, single-step, formula-based, or similar to standard textbook problems for the selected class. Avoid straightforward calculation or memory-based questions.
                    - Whenever possible, take inspiration from previous Olympiad, NTSE, and JEE Foundation exam papers appropriate to the selected class and topic.
                    - Do not copy questions exactly; always change numbers, variables, or context to fit the chosen class level.
                    - If no suitable past questions exist, create original problems of the same high standard—emphasizing higher-order thinking, application, and integration of multiple concepts.
                    
                    - Math equations must be written in LaTeX.
                
                The user wants Multiple Choice Questions (MCQs) with only one correct answer for each question.
                Please generate questions based on the user's request. Each question MUST follow this strict format:
                1. Start with the question number, level, and marks (e.g., "Q1: Level 2, 1 Mark").
                2. On the next line, write the question text.
                3. On the following lines, provide four options, each starting with "A)", "B)", "C)", and "D)".
                4. On the final line for that question, specify the correct answer using the format "Ans: C)" (only ONE letter).
                Provide ONLY the questions in this exact format. Do not add any other text, explanation, or introduction.`;
                } else if (sessionParams.questionType === "MCQ (Multiple)") {
                    fullPromptForAI = `${baseInfo}
                Strictly follow these level definitions for every question:
                - Level 1: Easy & Medium
                - Level 2: Difficult & Very Difficult
                - Level 3: Challenging & Very Challenging
                    
                    Instructions for Level 3 questions (for any class 6th–10th):
                    - Each question must require multi-step logical reasoning and should combine at least two different concepts. Questions should have non-standard twists or novel approaches, similar to those found in Olympiad, NTSE, or IIT Foundation exams.
                    - Do NOT include questions that are direct, single-step, formula-based, or similar to standard textbook problems for the selected class. Avoid straightforward calculation or memory-based questions.
                    - Whenever possible, take inspiration from previous Olympiad, NTSE, and JEE Foundation exam papers appropriate to the selected class and topic.
                    - Do not copy questions exactly; always change numbers, variables, or context to fit the chosen class level.
                    - If no suitable past questions exist, create original problems of the same high standard—emphasizing higher-order thinking, application, and integration of multiple concepts.
                    
                    - Math equations must be written in LaTeX.
                    
                The user wants Multiple Choice Questions (MCQs) with more than one correct answer possible for each question (Multiple correct options).
                ***STRICT RULES FOR ANSWERS:***
                - You MUST create exactly 10 questions per batch, following this distribution:
                  - 4 questions MUST have exactly 2 correct options,
                  - 4 questions MUST have exactly 3 correct options,
                  - 2 questions MUST have only 1 correct option.
                - Do NOT deviate from these rules. Do not include any question with all 4 options correct.
                - The combination of correct options MUST vary across questions. Do not use the same answer pattern more than once.
                - The correct answers (A, B, C, D) MUST be distributed as evenly as possible.
                - Before finishing, DOUBLE CHECK that your output follows the above distribution.
                Each question MUST follow this strict format:
                1. Start with the question number, level, and marks (e.g., "Q1: Level 2, 1 Mark").
                2. On the next line, write the question text.
                3. On the following lines, provide four options, each starting with "A)", "B)", "C)", and "D)".
                4. On the final line for that question, specify ALL correct answers using the format "Ans: A), C), D)" (list all correct answers, separated by comma).
                Provide ONLY the questions in this exact format. Do not add any other text, explanation, or introduction.`;
                } else {
                // Descriptive
                fullPromptForAI = `${baseInfo}
            Strictly follow these level definitions for every question:
            - Level 1: Easy & Medium
            - Level 2: Difficult & Very Difficult
            - Level 3: Challenging & Very Challenging
               
                Instructions for Level 3 questions (for any class 6th–10th):
                    - Each question must require multi-step logical reasoning and should combine at least two different concepts. Questions should have non-standard twists or novel approaches, similar to those found in Olympiad, NTSE, or IIT Foundation exams.
                    - Do NOT include questions that are direct, single-step, formula-based, or similar to standard textbook problems for the selected class. Avoid straightforward calculation or memory-based questions.
                    - Whenever possible, take inspiration from previous Olympiad, NTSE, and JEE Foundation exam papers appropriate to the selected class and topic.
                    - Do not copy questions exactly; always change numbers, variables, or context to fit the chosen class level.
                    - If no suitable past questions exist, create original problems of the same high standard—emphasizing higher-order thinking, application, and integration of multiple concepts.

                   - Math equations must be written in LaTeX.
                   
            User request: "${originalPrompt}"
            
            Format each question strictly as:
            Q<num>: Level <Lvl>, <Marks> Marks
            <Question text>
            Provide ONLY the questions in this exact format. Do not add any other text, explanation, or introduction.`;
            }
            const response = await fetch(`${API_BASE_URL}/api/v1/generate`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: fullPromptForAI })
            });
            result = await response.json();
            if (!response.ok) throw new Error(result.error || "API error");
        }
        parseAndDisplayAiQuestions(result.result, messagesArea, sessionParams);
    } catch (err) {
        appendChatMessage(`Error: ${err.message}`, 'system-message', messagesArea);
    } finally {
        loadingMessage.remove();
        sendBtn.innerHTML = `<i class="fas fa-paper-plane"></i>`;
        if (didSendFile) {
            stagedFile = null;
            document.getElementById('file-preview-box').style.display = 'none';
            document.getElementById('chat-upload-btn').style.color = '#54656f';
        }
        updateSendButtonState(chatPromptInput, sendBtn);
    }
}
    async function handleSendPrompt(sessionParams) {
    const chatPromptInput = document.getElementById('chat-prompt-input');
    const sendBtn = document.getElementById('chat-send-btn');
    const userPrompt = chatPromptInput.value.trim();
    const messagesArea = document.getElementById('chat-messages-area');

    if (!userPrompt && !stagedFile) return;

    // --- Stage 1: Get Confirmation ---

    sendBtn.disabled = true;
    sendBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

    if(userPrompt) appendChatMessage(userPrompt, 'user', messagesArea);
    chatPromptInput.value = '';
    chatPromptInput.style.height = 'auto';

    const loadingMessage = appendChatMessage('Parsing instructions...', 'system-message', messagesArea);

    // This is the "meta-prompt" that asks the AI to summarize the teacher's request.
    const promptForSummary = `A teacher has provided the following instructions for creating. Re-write and structure these instructions clearly and concisely in a paragraph format for a confirmation message. Start with "You need to create a...". Do not add any conversational text, just the structured instructions. Teacher's instructions: "${userPrompt}"`;

    try {
        // We use the same generation endpoint, but with our special summary prompt.
        const response = await fetch(`${API_BASE_URL}/api/v1/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: promptForSummary })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "API error");

        // On success, remove "Parsing..." and show the confirmation modal
        loadingMessage.remove();
        showConfirmationModal(result.result, userPrompt, sessionParams);

    } catch (err) {
        // If summary fails, show an error and re-enable the button
        loadingMessage.remove();
        appendChatMessage(`Error parsing instructions: ${err.message}. Please try again.`, 'system-message', messagesArea);
        sendBtn.innerHTML = `<i class="fas fa-paper-plane"></i>`;
        updateSendButtonState(chatPromptInput, sendBtn);
    }
}

    function handleFileUpload(event, sessionParams) {
        const file = event.target.files[0];
        if (!file) return;

        stagedFile = file;
        document.getElementById('file-preview-box').style.display = 'block';
        document.getElementById('file-preview-name').textContent = file.name;
        document.getElementById('chat-prompt-input').placeholder = "Describe the file or ask a question about it...";
        document.getElementById('chat-upload-btn').style.color = '#1762a7';
    }

    async function saveSessionQuestions(sessionParams) {
        const saveButton = document.getElementById('ai-save-all-btn');
        if (saveButton.disabled) return;

        if (!currentUserProfile || currentSessionQuestions.length === 0) {
            alert("No new questions in this session to save.");
            return;
        }

        saveButton.disabled = true;
        saveButton.innerHTML = "⏳ Saving...";

        let savedCount = 0, skippedCount = 0;

        const startNumber = await getNextQuestionNumber(sessionParams.class, sessionParams.subject, sessionParams.chapter);

        for (let i = 0; i < currentSessionQuestions.length; i++) {
    const qData = currentSessionQuestions[i];

    // If comprehensive, use fullText for duplicate check, else parsedBody
    let compareText = (qData.parsedMeta && qData.parsedMeta.includes("[Comprehensive]"))
        ? qData.fullText : qData.parsedBody;

    const snapshot = await db.collection("questions")
        .where("subject", "==", qData.subject)
        .where("chapter", "==", qData.chapter)
        .get();
    let isDuplicate = false;
    snapshot.forEach(doc => {
        const existing = doc.data();
        let existingText = (existing.metaLine && existing.metaLine.includes("[Comprehensive]")) ? existing.text : existing.body;
        if (getTextSimilarity(compareText, existingText) >= 0.9) {
            isDuplicate = true;
        }
    });
    if (isDuplicate) {
        skippedCount++;
        continue;
    }

    const meta = parseMetaLine(qData.parsedMeta);
    const currentQuestionNumber = startNumber + savedCount; // Increment based on successfully saved count

    if (qData.parsedMeta && qData.parsedMeta.includes("[Comprehensive]")) {
        // Save as a comprehensive block
        await db.collection("questions").add({
            type: "Comprehensive",
            text: qData.fullText,
            metaLine: qData.parsedMeta,
            marks: 2,
            passage: qData.passage,
            mcqs: qData.mcqs,
            questionNumber: currentQuestionNumber,
            class: qData.class,
            subject: qData.subject,
            chapter: qData.chapter,
            createdBy: currentUserProfile.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } else {
        // Normal question save (single, multiple, descriptive)
        let toSave = {
            metaLine: qData.parsedMeta,
            difficulty: meta.difficulty,
            level: meta.level,
            marks: meta.marks,
            questionNumber: currentQuestionNumber,
            class: qData.class,
            subject: qData.subject,
            chapter: qData.chapter,
            createdBy: currentUserProfile.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (sessionParams.questionType.startsWith('MCQ')) {
            toSave.question = qData.question;
            toSave.options = qData.options; // Save as array!
            toSave.answer = qData.parsedAnswer;
            toSave.mcqType = sessionParams.questionType;  // <-- ADD THIS LINE
        } else {
            toSave.text = qData.fullText;
            toSave.body = qData.parsedBody;
            toSave.answer = qData.parsedAnswer;
        }
                await db.collection("questions").add(toSave);
           }

    savedCount++;
}

        alert(`${savedCount} question(s) saved. ${skippedCount} duplicate(s) skipped.`);
        saveButton.disabled = false;
        saveButton.innerHTML = "💾 Save All";
    }

    function appendChatMessage(text, type, messagesArea) {
        let messageElement;
        if (type === 'user') {
            messageElement = document.createElement('div');
            messageElement.className = 'chat-bubble user-bubble';
            messageElement.innerHTML = `<div class="bubble-text">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`;
        } else if (type === 'system-message') {
            messageElement = document.createElement('div');
            messageElement.className = 'message system-message';
            messageElement.textContent = text;
        } else if (type === 'ai') {
            messageElement = document.createElement('div');
            messageElement.className = 'message ai-message';
            messageElement.innerHTML = `<div class="question-text-ai">${text}</div>`;
        }
        
        if (messageElement) {
            messagesArea.appendChild(messageElement);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            return messageElement;
        }
    }
    // <-- Paste here
function splitMcqOptions(body) {
    if ((body.match(/^[A-D]\)/gm) || []).length >= 3) return body;
    if (/A\).+B\).+C\).+D\)/.test(body)) {
        const m = body.match(/A\)([^B]+)B\)([^C]+)C\)([^D]+)D\)(.+)/);
        if (m) {
            return [
                "A)" + m[1].trim(),
                "B)" + m[2].trim(),
                "C)" + m[3].trim(),
                "D)" + m[4].trim()
            ].join('\n');
        } else {
            return body.replace(/([A-D]\))/g, '\n$1').replace(/^\n/, '');
        }
    }
    return body;
}
    function parseAndDisplayAiQuestions(responseText, messagesArea, sessionParams) {

       // The original logic (leave as-is for MCQ/Descriptive):
    const questionBlocks = responseText.split(/\n(?=Q\s*\d+:)/g).map(q => q.trim()).filter(q => q.match(/^Q\s*\d+:/));

       if (questionBlocks.length === 0 && responseText) {
            // fallback: show as plain text ONLY if parsing failed
            appendChatMessage(responseText, 'ai', messagesArea);
            return;
        }
        const fragment = document.createDocumentFragment();
        questionBlocks.forEach((qText) => {
            const questionData = {
                fullText: qText,
                class: sessionParams.class,
                subject: sessionParams.subject,
                chapter: sessionParams.chapter
            };

            const metaMatch = qText.match(/^(Q\s*\d+:.*)/);
            if (!metaMatch) {
                console.warn("Skipping a block that is not a valid question:", qText);
                return; 
            }

            let originalMeta = metaMatch[1];
            let difficultyLevel = "Difficulty/Level 0";
            let marks = "0 Marks";

            const partsMatch = originalMeta.match(/Q\s*\d+:\s*(.*?),\s*(.*)/i);
            if (partsMatch && partsMatch[1]) difficultyLevel = partsMatch[1].trim();
            if (partsMatch && partsMatch[2]) marks = partsMatch[2].trim();
            if (sessionParams.questionType.startsWith("MCQ")) marks = "1 Mark";

            questionData.parsedMeta = `Q${currentSessionQuestions.length + 1}: ${difficultyLevel}, ${marks} [${sessionParams.questionType}]`;
          
            let rawBody = qText.substring(originalMeta.length).trim();
            const answerRegex = /(.*)(Ans:\s*.*)/s;
            const answerMatch = rawBody.match(answerRegex);

            if (answerMatch) {
                const questionAndOptions = answerMatch[1].trim();
               const lines = questionAndOptions
                  .split('\n')
                  .map(x => x.trim())
                  .filter(x => x && x !== '<br>' && x !== '');
                questionData.question = lines[0] || '';
                questionData.options = lines.slice(1, 5).map(x => x || '');
                questionData.parsedAnswer = answerMatch[2].trim();
                questionData.parsedBody = lines.join('\n'); // removes extra blank lines
            } else {
                // Fallback (if not found, treat whole thing as question)
                questionData.question = rawBody.split('\n')[0].trim();
                questionData.options = rawBody.split('\n').slice(1, 5).map(x => x.trim());
                questionData.parsedAnswer = null;
                questionData.parsedBody = rawBody;
            }
            currentSessionQuestions.push(questionData);
            const questionEl = createQuestionElement(questionData, currentSessionQuestions.length - 1);
            fragment.appendChild(questionEl);
        });

        messagesArea.appendChild(fragment);
        if (window.MathJax) MathJax.typesetPromise([messagesArea]);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function createQuestionElement(qData, index) {
        const questionEl = document.createElement('div');
        questionEl.className = 'message ai-question-item';
        questionEl.dataset.sessionQuestionIndex = index;

        questionEl.innerHTML = `
            <div class="question-meta-ai">${qData.parsedMeta}</div>
            <div class="question-text-ai">${qData.parsedBody}</div>
            <div class="question-actions">
                <button class="q-action-btn" title="Options"><i class="fas fa-ellipsis-v"></i></button>
            </div>`;
        const actionButton = questionEl.querySelector('.q-action-btn');

        actionButton.addEventListener('click', (e) => {
            e.stopPropagation();

            const existingMenu = document.querySelector('.actions-menu');
            if (existingMenu) existingMenu.remove();

            const menu = document.createElement('div');
            menu.className = 'actions-menu';
            menu.innerHTML = `
                <button class="menu-show-answer-btn">Show Answer</button>
                <button class="menu-edit-btn">Edit</button>
                <button class="menu-delete-btn">Delete</button>`;
            
            const isAnswerShowing = questionEl.querySelector('.temp-answer');
            if (isAnswerShowing) {
                const buttonInMenu = menu.querySelector('.menu-show-answer-btn');
                buttonInMenu.textContent = 'Hide Answer';
            }

            questionEl.appendChild(menu);

            menu.querySelector('.menu-show-answer-btn').onclick = async (event) => {
                event.stopPropagation();
                const currentQuestionEl = event.target.closest('.ai-question-item');
                const existingAnswerEl = currentQuestionEl.querySelector('.temp-answer');
                const showAnswerBtn = event.target;

                if (existingAnswerEl) {
                    existingAnswerEl.remove();
                    showAnswerBtn.textContent = 'Show Answer';
                } else {
                    const questionData = currentSessionQuestions[index];
                    const answerEl = document.createElement('div');
                    answerEl.className = 'temp-answer';
                    answerEl.textContent = 'Generating answer...';
                    currentQuestionEl.appendChild(answerEl);
                    showAnswerBtn.textContent = 'Hide Answer';

                    if (questionData.parsedAnswer) {
                        answerEl.textContent = questionData.parsedAnswer;
                    } else {
                        const answerPrompt = `Based on the following question, please provide a model answer or the key points for a correct response. Keep the answer concise and clear.\n\nQuestion: "${questionData.parsedBody}"`;
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/v1/generate`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ prompt: answerPrompt })
                            });
                            const result = await response.json();
                            if (!response.ok) throw new Error(result.error || "API error");
                            answerEl.textContent = result.result;
                        } catch (err) {
                            answerEl.textContent = `Error: Could not generate answer. ${err.message}`;
                        }
                    }
                    if (window.MathJax) {
                        MathJax.typesetPromise([answerEl]);
                    }
                }
                menu.remove();
            };

            menu.querySelector('.menu-edit-btn').onclick = () => {
                showEditPopupForQuestion(index);
                menu.remove();
            };

            menu.querySelector('.menu-delete-btn').onclick = () => {
                if (confirm('Are you sure you want to delete this question?')) {
                    currentSessionQuestions.splice(index, 1);
                    rerenderAllQuestions();
                }
                menu.remove();
            };
        });
        
        return questionEl;
    }

   function rerenderAllQuestions() {
    const messagesArea = document.getElementById('chat-messages-area');
    messagesArea.querySelectorAll('.ai-question-item').forEach(item => item.remove());

    const fragment = document.createDocumentFragment();
    currentSessionQuestions.forEach((q, i) => {
        // For comprehensives, we need a different renderer
        if (q.parsedMeta && q.parsedMeta.includes("[Comprehensive]")) {
            // Renumber meta
            const metaPartsMatch = q.parsedMeta.match(/Q\s*\d+:\s*(.*)/i);
            const details = metaPartsMatch ? metaPartsMatch[1] : '';
            q.parsedMeta = `Q${i + 1}: ${details}`;
            // Build element (copy from parseAndDisplayAiQuestions)
            const blockEl = document.createElement('div');
            blockEl.className = 'message ai-question-item';
            blockEl.dataset.sessionQuestionIndex = i;

            // Build MCQ HTMLs
            const mcqHtml = q.mcqs.map((mcq, k) => {
                // Remove leading Qn: from mcq.body if present (Q1:, Q2:, etc.)
                let cleanBody = mcq.body.replace(/^Q\d+:\s*/i, '').replace(/Ans:.*/,'').trim();
                return `
                    <div class="question-text-ai" style="margin-top:8px; text-align:left;">
                        <b>Q${k+1}.</b> ${cleanBody.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
                        <div class="temp-answer" style="display:none; margin-top:3px; color:#5d4037;">${mcq.answer ? mcq.answer : ''}</div>
                    </div>
                `;
            }).join('');
            blockEl.innerHTML = `
                <div class="question-meta-ai">${q.parsedMeta}</div>
                <div class="question-text-ai" style="white-space:pre-line; margin-bottom:8px;"><b>Passage:</b> ${q.passage}</div>
                ${mcqHtml}
                <div class="question-actions">
                    <button class="q-action-btn" title="Options"><i class="fas fa-ellipsis-v"></i></button>
                </div>
            `;
            blockEl.querySelector('.q-action-btn').onclick = (e) => {
                e.stopPropagation();
                const existingMenu = document.querySelector('.actions-menu');
                if (existingMenu) existingMenu.remove();
                const menu = document.createElement('div');
                menu.className = 'actions-menu';
                menu.innerHTML = `
                    <button class="menu-show-answer-btn">Show Answer</button>
                    <button class="menu-edit-btn">Edit</button>
                    <button class="menu-delete-btn">Delete</button>`;
                blockEl.appendChild(menu);

                menu.querySelector('.menu-show-answer-btn').onclick = () => {
                    const answers = blockEl.querySelectorAll('.temp-answer');
                    const show = answers[0].style.display === 'none';
                    answers.forEach(ans => ans.style.display = show ? 'block' : 'none');
                    menu.querySelector('.menu-show-answer-btn').textContent = show ? 'Hide Answer' : 'Show Answer';
                    menu.remove();
                };
                menu.querySelector('.menu-edit-btn').onclick = () => {
                    showEditPopupForComprehensive(i);
                    menu.remove();
                };
                menu.querySelector('.menu-delete-btn').onclick = () => {
                    if (confirm('Are you sure you want to delete this comprehensive?')) {
                        currentSessionQuestions.splice(i, 1);
                        rerenderAllQuestions();
                    }
                    menu.remove();
                };
            };

            fragment.appendChild(blockEl);

        } else {
            // Normal question
            const metaPartsMatch = q.parsedMeta.match(/Q\s*\d+:\s*(.*)/i);
            const details = metaPartsMatch ? metaPartsMatch[1] : '';
            q.parsedMeta = `Q${i + 1}: ${details}`;
            const questionEl = createQuestionElement(q, i);
            fragment.appendChild(questionEl);
        }
    });
    messagesArea.appendChild(fragment);
    if (window.MathJax) MathJax.typesetPromise([messagesArea]);
}

    function parseMetaLine(metaLine) {
        const meta = { difficulty: null, level: null, marks: null };
        const diffMatch = metaLine.match(/Q\s*\d+:\s*([^,/]+)/i);
        const levelMatch = metaLine.match(/\/Level\s*(\d+)/i);
        const marksMatch = metaLine.match(/(\d+)\s*Mark(s?)/i);

        if (diffMatch) meta.difficulty = diffMatch[1].trim();
        if (levelMatch) meta.level = parseInt(levelMatch[1], 10);
        if (marksMatch) meta.marks = parseInt(marksMatch[1], 10);
        
        return meta;
    }

    async function getNextQuestionNumber(className, subjectName, chapterName) {
        const query = db.collection("questions")
            .where("class", "==", className)
            .where("subject", "==", subjectName)
            .where("chapter", "==", chapterName)
            .orderBy("questionNumber", "desc")
            .limit(1);

        const snapshot = await query.get();
        if (snapshot.empty) return 1;

        const lastQuestion = snapshot.docs[0].data();
        return (lastQuestion.questionNumber || 0) + 1;
    }

    function getTextSimilarity(a, b) {
    if (!a || !b) return 0; // If either is missing, return 0 similarity
    a = String(a).toLowerCase().replace(/\s+/g, ' ').trim();
    b = String(b).toLowerCase().replace(/\s+/g, ' ').trim();
    const aWords = new Set(a.split(' '));
    const bWords = new Set(b.split(' '));
    const common = [...aWords].filter(w => bWords.has(w));
    return common.length / Math.max(aWords.size, bWords.size);
}
   
    document.addEventListener('click', function(event) {
        document.querySelectorAll('.custom-dropdown.open').forEach(dropdown => {
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('open');
            }
        });
        const existingMenu = document.querySelector('.actions-menu');
        if (existingMenu && !existingMenu.contains(event.target) && !event.target.closest('.q-action-btn')) {
            existingMenu.remove();
        }
    });

    </script>
</body>
</html>
