<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AI Question Generator | St. Patrick's School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
      // Configure MathJax for rendering LaTeX math equations
      window.MathJax = {
        tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]], },
        svg: { fontCache: "global" },
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
      /* --- Global & Header Styles --- */
      html, body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Arial, sans-serif;
        background: #f4f8fc;
        min-height: 100vh;
        overflow-x: hidden;
      }
      .dashboard-header {
        width: 100%;
        background: #0f3d6b;
        color: #fff;
        border-bottom-left-radius: 28px;
        border-bottom-right-radius: 28px;
        min-height: 90px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        box-shadow: 0 3px 15px #0f3d6b33;
        padding: 15px 10px 18px 10px;
        box-sizing: border-box;
      }
      .header-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 1100px;
        padding: 0 10px;
        box-sizing: border-box;
      }
      .header-back-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        font-size: 1.1em;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
      }
      .header-back-btn:hover { background: rgba(255,255,255,0.25); }
      .header-back-btn .fa-solid { margin-right: 6px; }
      .school-title {
        font-size: 1.8em;
        font-weight: bold;
        text-transform: uppercase;
        text-align: center;
        flex-grow: 1;
      }
      .header-placeholder { width: 95px; } /* To balance the back button */
      .subtitle {
        font-size: 1.05em;
        color: #e0eaff;
        font-weight: 500;
        text-align: center;
        letter-spacing: 1px;
        width: 100%;
        margin-top: 5px;
      }

      /* --- Main Container & Form Styles --- */
      .review-container {
        max-width: 700px;
        margin: 25px auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 18px #0f3d6b1b;
        padding: 20px 25px 30px 25px;
        box-sizing: border-box;
      }
      .review-container h2, .review-container h3 {
        text-align: center;
        color: #0f3d6b;
        margin-top: 5px;
        margin-bottom: 25px;
      }
      .review-container form { display: flex; flex-direction: column; gap: 15px; }
      .review-container label {
        font-weight: 600;
        margin-bottom: 3px;
        color: #185496;
        font-size: 0.95em;
      }
      .review-container input[type="text"],
      .review-container button[type="submit"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1.3px solid #bcd6ef;
        font-size: 1em;
        background: #f7fafd;
        box-sizing: border-box;
        transition: border-color 0.18s, box-shadow 0.17s;
      }
      .review-container input:focus {
        border-color: #1762a7;
        box-shadow: 0 1px 8px #0f3d6b18;
        outline: none;
      }
      .review-container button[type="submit"] {
        background: linear-gradient(90deg, #1762a7, #0f3d6b);
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        padding: 12px 0;
        margin-top: 10px;
        box-shadow: 0 2px 8px #0f3d6b18;
        transition: background 0.2s, transform 0.15s;
      }
      .review-container button[type="submit"]:hover {
        background: linear-gradient(90deg, #0f3d6b, #1762a7);
        transform: translateY(-2px);
      }

      /* --- Custom Dropdown Styles --- */
      .custom-dropdown {
        position: relative;
        width: 100%;
        font-size: 1em;
        background: #f7fafd;
        border-radius: 6px;
        border: 1.3px solid #bcd6ef;
        cursor: pointer;
        min-height: 42px;
        box-sizing: border-box;
      }
      .selected-option {
        padding: 10px 12px;
        color: #12416c;
        font-weight: 500;
        user-select: none;
        display: flex;
        align-items: center;
        min-height: inherit;
      }
      .dropdown-options {
        display: none;
        position: absolute;
        top: 100%;
        left: -1px;
        right: -1px;
        background: #fff;
        border: 1.3px solid #bcd6ef;
        border-top: none;
        border-radius: 0 0 6px 6px;
        box-shadow: 0 6px 15px #0f3d6b1a;
        z-index: 100;
        max-height: 200px;
        overflow-y: auto;
      }
      .custom-dropdown.open .dropdown-options { display: block; }
      .dropdown-options div[data-value] {
        padding: 10px 15px;
        color: #12416c;
        cursor: pointer;
        border-bottom: 1px solid #e8eef5;
        transition: background 0.1s;
      }
      .dropdown-options div[data-value]:last-child { border-bottom: none; }
      .dropdown-options div[data-value]:hover { background: #e0eaff; }

      /* --- AI Chat Interface Styles --- */
      .ai-chat-header {
        padding: 12px 18px;
        background-color: #f0f2f5;
        border-bottom: 1px solid #d1d9e0;
        margin-bottom: 12px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }
      .ai-chat-header .header-info { flex-grow: 1; }
      .ai-chat-header h3 {
        margin: 0 0 6px 0;
        font-size: 1.15em;
        color: #0f3d6b;
      }
      .ai-chat-header p {
        font-size: 0.88em;
        color: #4a5c71;
        margin: 0;
      }
      .ai-chat-header .header-actions .btn-small {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 7px 12px;
        font-size: 0.85em;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
        transition: background-color 0.2s;
      }
      .ai-chat-header .header-actions .btn-small:hover { background-color: #5a6268; }
      .ai-chat-header .header-actions #ai-save-all-chat-btn { background-color: #28a745; }
      .ai-chat-header .header-actions #ai-save-all-chat-btn:hover { background-color: #218838; }

      .chat-messages-area {
        height: calc(100vh - 350px);
        min-height: 300px;
        max-height: 60vh;
        overflow-y: auto;
        padding: 10px 15px;
        border: 1px solid #e0e0e0;
        background-color: #ffffff;
      }
      .message {
        margin-bottom: 12px;
        padding: 10px 14px;
        border-radius: 10px;
        word-wrap: break-word;
        max-width: 85%;
        line-height: 1.5;
      }
      .message pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: inherit;
        margin: 0;
        font-size: 0.98em;
      }
      .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        border-radius: 10px 10px 0 10px;
      }
      .ai-message {
        background-color: #e9ecef;
        color: #343a40;
        margin-right: auto;
        border-radius: 10px 10px 10px 0;
      }
      .ai-question-item {
        border: none;
        padding: 0;
        margin-bottom: 0 !important;
        background-color: transparent;
      }
      .question-meta-ai {
        color: #c82333;
        font-weight: 600;
        font-size: 0.9em;
        margin-bottom: 6px;
        line-height: 1.4;
        display: block;
      }
      .question-text-ai {
        color: #004085;
        font-size: 0.98em;
        line-height: 1.55;
        white-space: pre-wrap;
        display: block;
      }
      .system-message {
        background-color: #f8f9fa;
        color: #6c757d;
        text-align: center;
        font-size: 0.85em;
        font-style: italic;
        padding: 8px 10px;
        max-width: 100%;
        border-radius: 5px;
      }
      .error-message {
        background-color: #f8d7da;
        color: #721c24;
      }
      .blinking-text { animation: blinker 1.3s linear infinite; }
      @keyframes blinker { 50% { opacity: 0.35; } }

      .chat-input-bar {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        background-color: #f0f2f5;
        border-top: 1px solid #d1d9e0;
        border-radius: 0 0 8px 8px;
      }
      #chat-upload-btn, #chat-send-btn {
        background: none;
        border: none;
        font-size: 1.4em;
        color: #0f3d6b;
        cursor: pointer;
        padding: 8px;
        transition: color 0.15s;
      }
      #chat-upload-btn:hover, #chat-send-btn:hover { color: #1762a7; }
      #chat-prompt-input {
        flex-grow: 1;
        padding: 10px 15px;
        border-radius: 20px;
        border: 1.3px solid #ced4da;
        font-size: 1em;
        margin: 0 10px;
        resize: none;
        max-height: 120px;
      }
      #chat-prompt-input:focus { outline: none; border-color: #0f3d6b; }

      /* --- Edit/Delete Popup & Controls Styles --- */
      .ai-question-popup {
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        padding: 8px;
        z-index: 1010;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .ai-question-popup button {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        color: #333;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        text-align: left;
        transition: background-color 0.15s;
      }
      .ai-question-popup button:hover { background-color: #e9ecef; }
      .ai-question-popup .popup-delete-btn { color: #dc3545; }
      .ai-question-popup .popup-delete-btn:hover { background-color: #f8d7da; }
      .ai-question-popup .popup-edit-btn { color: #007bff; }
      .ai-question-popup .popup-edit-btn:hover { background-color: #e7f3ff; }
      .editing-question .question-meta-ai,
      .editing-question .question-text-ai {
        outline: 1px dashed #007bff;
        padding: 5px;
        cursor: text;
      }
      .q-edit-controls {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding-top: 8px;
        margin-top: 5px;
        border-top: 1px solid #eee;
      }
      .q-edit-controls .btn-small {
        padding: 5px 10px;
        font-size: 0.85em;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid transparent;
        color: white;
      }
      .btn-save-edit { background-color: #28a745; }
      .btn-cancel-edit { background-color: #6c757d; }

      /* --- Toast Popup Styles --- */
      .toast-popup {
        visibility: hidden;
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 5px;
        padding: 16px;
        position: fixed;
        z-index: 10000;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        opacity: 0;
        transition: visibility 0s 0.5s, opacity 0.5s linear;
      }
      .toast-popup.show {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.5s linear;
      }
      .toast-popup.success { background-color: #28a745; }
      .toast-popup.error { background-color: #dc3545; }
      .toast-popup.info { background-color: #17a2b8; }
    </style>
</head>
<body>

    <header class="dashboard-header">
      <div class="header-top-row">
          <a href="dashboard.html" class="header-back-btn">
              <i class="fa-solid fa-chevron-left"></i> Dashboard
          </a>
          <h1 class="school-title">St. Patrick's School</h1>
          <div class="header-placeholder"></div>
      </div>
      <div class="subtitle">IIT & NEET FOUNDATION</div>
    </header>

    <main>
      <div id="ai-container" class="review-container">
        <p>Loading AI Generator...</p>
      </div>
    </main>
    
    <input type="file" id="image-upload-input-ai" accept="image/*" style="display:none;">

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

    <script>
    // --- START OF JAVASCRIPT ---

    // ====== 1. INITIALIZATION & CONFIG ======
    const firebaseConfig = {
      apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
      authDomain: "stpatricks-questionbank.firebaseapp.com",
      projectId: "stpatricks-questionbank",
      storageBucket: "stpatricks-questionbank.appspot.com",
      messagingSenderId: "917615322861",
      appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUserProfile = null;
    let currentSessionQuestions = []; // For the current AI generation session
    let activeQuestionEditControls = null;

    const aiGeneratorConfig = {
      classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
      subjectMappings: {
        "3rd Class": ["Telugu", "Hindi", "English 1", "Math 1", "EVS (Social/Science)"],
        "4th Class": ["Telugu", "Hindi", "English 1", "Math 1", "EVS (Social/Science)"],
        "5th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "EVS (Social/Science)"],
        "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 2", "General Science (Physics, Chemistry, Biology)", "Social"],
        "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Physics", "Chemistry", "Biology", "Social"],
        "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
      },
      questionTypes: ["MCQs", "Descriptive"],
      getSubjectsForClass: function(className) {
        return this.subjectMappings[className] || [];
      }
    };

    // ====== 2. AUTHENTICATION GUARD ======
    document.addEventListener('DOMContentLoaded', () => {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // User is signed in. Fetch their profile.
          const userDoc = await db.collection("users").doc(user.uid).get();
          if (userDoc.exists) {
            currentUserProfile = { uid: user.uid, ...userDoc.data() };
          } else {
            // Fallback profile if Firestore doc doesn't exist
            currentUserProfile = { uid: user.uid, email: user.email, displayName: user.displayName, role: 'teacher' };
          }
          // Load the initial UI for the generator
          loadAiQuestionGeneratorForm();
        } else {
          // No user is signed in. Redirect to login page.
          console.log("No user found, redirecting to login.");
          window.location.href = 'login.html';
        }
      });
    });

    // ====== 3. UI RENDERING & EVENT HANDLERS ======

    // --- Renders the initial setup form ---
    function loadAiQuestionGeneratorForm() {
      const container = document.getElementById('ai-container');
      const classesHTML = aiGeneratorConfig.classes.map(c => `<div data-value="${c}">${c}</div>`).join('');
      const initialSubjects = aiGeneratorConfig.getSubjectsForClass(aiGeneratorConfig.classes[0]);
      const subjectsHTML = initialSubjects.map(s => `<div data-value="${s}">${s}</div>`).join('');
      const qTypesHTML = aiGeneratorConfig.questionTypes.map(qt => `<div data-value="${qt}">${qt}</div>`).join('');

      container.innerHTML = `
        <h2>AI Question Generator - Setup</h2>
        <form id="ai-setup-form">
          <label for="class-ai">Class:</label>
          <div id="class-dropdown-ai" class="custom-dropdown">
            <input type="hidden" id="class-value-ai" value="${aiGeneratorConfig.classes[0]}">
            <div class="selected-option">${aiGeneratorConfig.classes[0]}</div>
            <div class="dropdown-options">${classesHTML}</div>
          </div>
          <label for="subject-ai">Subject:</label>
          <div id="subject-dropdown-ai" class="custom-dropdown">
            <input type="hidden" id="subject-value-ai" value="${initialSubjects[0] || ''}">
            <div class="selected-option">${initialSubjects[0] || 'Select Subject'}</div>
            <div class="dropdown-options">${subjectsHTML}</div>
          </div>
          <label for="qtype-ai">Question Type:</label>
          <div id="qtype-dropdown-ai" class="custom-dropdown">
            <input type="hidden" id="qtype-value-ai" value="${aiGeneratorConfig.questionTypes[0]}">
            <div class="selected-option">${aiGeneratorConfig.questionTypes[0]}</div>
            <div class="dropdown-options">${qTypesHTML}</div>
          </div>
          <label for="chapter-input-ai">Chapter:</label>
          <input type="text" id="chapter-input-ai" placeholder="e.g., Kinematics" required>
          <button type="submit">Continue</button>
        </form>`;

      // Initialize dropdowns and their inter-dependencies
      setupCustomDropdown('class-dropdown-ai', 'class-value-ai', (selectedClass) => {
        const subjectDropdown = document.getElementById('subject-dropdown-ai');
        const subjectOptions = subjectDropdown.querySelector('.dropdown-options');
        const subjectSelected = subjectDropdown.querySelector('.selected-option');
        const subjectInput = document.getElementById('subject-value-ai');
        
        const newSubjects = aiGeneratorConfig.getSubjectsForClass(selectedClass);
        subjectOptions.innerHTML = newSubjects.map(s => `<div data-value="${s}">${s}</div>`).join('');
        
        if (newSubjects.length > 0) {
          subjectSelected.textContent = newSubjects[0];
          subjectInput.value = newSubjects[0];
        } else {
          subjectSelected.textContent = 'No Subjects';
          subjectInput.value = '';
        }
        // Re-attach listeners to new options
        optionsContainerListener(subjectOptions, subjectSelected, subjectInput, subjectDropdown, null);
      });
      setupCustomDropdown('subject-dropdown-ai', 'subject-value-ai');
      setupCustomDropdown('qtype-dropdown-ai', 'qtype-value-ai');

      document.getElementById("ai-setup-form").onsubmit = (e) => {
        e.preventDefault();
        const sessionParams = {
          class: document.getElementById('class-value-ai').value,
          subject: document.getElementById('subject-value-ai').value,
          questionType: document.getElementById('qtype-value-ai').value,
          chapter: document.getElementById('chapter-input-ai').value.trim(),
        };
        if (!sessionParams.chapter || !sessionParams.subject) {
          showToast("Please select a subject and enter a chapter.", 'error');
          return;
        }
        loadAiChatInterface(sessionParams);
      };
    }

    // --- Renders the chat interface ---
    function loadAiChatInterface(sessionParams) {
        const container = document.getElementById('ai-container');
        currentSessionQuestions = []; // Reset session

        container.innerHTML = `
            <div class="ai-chat-header">
                <div class="header-info">
                    <h3>Generating: ${sessionParams.questionType}</h3>
                    <p><strong>Class:</strong> ${sessionParams.class} | <strong>Subject:</strong> ${sessionParams.subject} | <strong>Chapter:</strong> ${sessionParams.chapter}</p>
                </div>
                <div class="header-actions">
                    <button id="ai-back-to-setup-btn" class="btn-small">Change Setup</button>
                    <button id="ai-save-all-chat-btn" class="btn-small">Save All</button>
                </div>
            </div>
            <div id="chat-messages-area" class="chat-messages-area">
                <div class="message system-message">Enter your prompt below or upload an image to extract text.</div>
            </div>
            <div id="chat-input-bar" class="chat-input-bar">
                <button id="chat-upload-btn" title="Upload Image"><i class="fas fa-plus"></i></button>
                <textarea id="chat-prompt-input" placeholder="e.g., Generate 5 MCQs on Newton's Laws" rows="1"></textarea>
                <button id="chat-send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
            </div>`;

        // Attach all event listeners for the chat interface
        document.getElementById('ai-back-to-setup-btn').onclick = loadAiQuestionGeneratorForm;
        document.getElementById('ai-save-all-chat-btn').onclick = () => saveSessionQuestions(sessionParams);
        
        const chatPromptInput = document.getElementById('chat-prompt-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const imageUploadInput = document.getElementById('image-upload-input-ai');

        document.getElementById('chat-upload-btn').onclick = () => imageUploadInput.click();
        imageUploadInput.onchange = (e) => handleImageUpload(e, sessionParams);

        chatSendBtn.onclick = () => handleSendPrompt(sessionParams);
        chatPromptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatSendBtn.click();
            }
        });

        document.getElementById('chat-messages-area').addEventListener('click', (event) => {
          const clickedQuestionItem = event.target.closest('.ai-question-item');
          if (event.target.closest('.q-edit-controls') || event.target.closest('.ai-question-popup')) return;

          const existingPopup = document.getElementById('ai-question-editor-popup');
          if (existingPopup) existingPopup.remove();

          if (clickedQuestionItem) {
              const questionIndex = parseInt(clickedQuestionItem.dataset.sessionQuestionIndex, 10);
              showEditDeletePopup(clickedQuestionItem, questionIndex, sessionParams);
          }
        });
    }

    // ====== 4. CORE FUNCTIONALITY ======

    // --- Handles sending a text prompt to the server ---
    async function handleSendPrompt(sessionParams) {
        const chatPromptInput = document.getElementById('chat-prompt-input');
        const userPrompt = chatPromptInput.value.trim();
        if (!userPrompt) return;
        
        const messagesArea = document.getElementById('chat-messages-area');
        appendChatMessage(userPrompt, 'user', messagesArea);
        chatPromptInput.value = '';
        toggleChatInput(true); // Disable input

        const fullPromptForAI = `Based on the following setup: Class: ${sessionParams.class}, Subject: ${sessionParams.subject}, Chapter: ${sessionParams.chapter}, Question Type: ${sessionParams.questionType}. User request: "${userPrompt}". Generate the questions. Format each question EXACTLY like this:
Q <number>: <DifficultyName>/Level <LevelNumber>, <MarksValue> Marks
The question text itself starts on the very next line.
Provide ONLY the questions. DO NOT include answers.`;
        
        appendChatMessage("Generating questions...", 'system blink', messagesArea);

        try {
            const response = await fetch("/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: fullPromptForAI })
            });
            const result = await response.json();

            document.querySelector('.blinking-text')?.remove();

            if (!response.ok || result.error) throw new Error(result.error || "Failed to get a valid response.");
            
            parseAndDisplayAiQuestions(result.result, messagesArea, sessionParams);

        } catch (err) {
            document.querySelector('.blinking-text')?.remove();
            appendChatMessage(`Error: ${err.message}`, 'error', messagesArea);
        } finally {
            toggleChatInput(false); // Re-enable input
        }
    }

    // --- Handles image upload for OCR ---
    async function handleImageUpload(event, sessionParams) {
        const file = event.target.files[0];
        if (!file) return;

        const messagesArea = document.getElementById('chat-messages-area');
        appendChatMessage(`Processing image: ${file.name}...`, 'system', messagesArea);
        toggleChatInput(true);

        const formData = new FormData();
        formData.append('imageFile', file);

        try {
            const response = await fetch("/api/extract-from-image", { method: 'POST', body: formData });
            const result = await response.json();
            if (!response.ok || result.error) throw new Error(result.error || "Image processing failed.");
            
            appendChatMessage(`Text extracted from ${file.name}:`, 'system', messagesArea);
            parseAndDisplayAiQuestions(result.result, messagesArea, sessionParams);

        } catch (err) {
            appendChatMessage(`Image Error: ${err.message}`, 'error', messagesArea);
        } finally {
            toggleChatInput(false);
            event.target.value = null; // Reset file input
        }
    }
    
    // --- Parses and displays questions from AI/OCR response ---
    function parseAndDisplayAiQuestions(responseText, messagesArea, sessionParams) {
        const questionBlocks = responseText.split(/\n(?=Q\s*\d+:)/g).map(q => q.trim()).filter(Boolean);

        if (questionBlocks.length === 0 && responseText.trim() !== "") {
            appendChatMessage(responseText, 'ai-raw', messagesArea); // Display as raw text if format is wrong
            return;
        }

        questionBlocks.forEach(qText => {
            const questionId = `q-session-${Date.now()}-${currentSessionQuestions.length}`;
            const metaRegex = /^(Q\s*\d+:.*,\s*\d+\s*Marks)\s*([\s\S]*)/im;
            const match = qText.match(metaRegex);
            
            const questionData = {
                id: questionId,
                fullText: qText,
                class: sessionParams.class,
                subject: sessionParams.subject,
                chapter: sessionParams.chapter,
                parsedMeta: match ? match[1].trim() : "Meta: (Could not parse)",
                parsedBody: match ? match[2].trim() : qText
            };
            currentSessionQuestions.push(questionData);
        });

        displayAllSessionQuestions(messagesArea);
    }

    // --- Renders all questions currently in the session ---
    function displayAllSessionQuestions(messagesArea) {
        messagesArea.querySelectorAll('.ai-question-item').forEach(item => item.remove());
        
        currentSessionQuestions.forEach((qData, index) => {
            const questionElement = renderAiQuestionToChat(qData, index);
            messagesArea.appendChild(questionElement);
        });

        if (window.MathJax) {
            MathJax.typesetPromise([messagesArea]).catch(err => console.error("MathJax error:", err));
        }
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    // --- Creates an HTML element for a single question ---
    function renderAiQuestionToChat(questionData, index) {
        const container = document.createElement('div');
        container.className = 'message ai-message ai-question-item';
        container.dataset.sessionQuestionIndex = index;
        container.innerHTML = `
            <div class="question-meta-ai">${questionData.parsedMeta}</div>
            <div class="question-text-ai">${questionData.parsedBody}</div>`;
        return container;
    }

    // --- Saves all questions from the current session to Firestore ---
    async function saveSessionQuestions(sessionParams) {
        if (!currentUserProfile) { return showToast("Please log in again.", 'error'); }
        if (currentSessionQuestions.length === 0) { return showToast("No questions to save.", 'info'); }

        const saveButton = document.getElementById('ai-save-all-chat-btn');
        saveButton.disabled = true;
        saveButton.textContent = "Saving...";
        
        let savedCount = 0;
        let skippedCount = 0;
        const userId = currentUserProfile.uid;

        for (const qData of currentSessionQuestions) {
            const { class: qClass, subject, chapter, parsedBody, parsedMeta, fullText } = qData;
            
            // Duplicate check
            const snapshot = await db.collection("questions")
                .where("body", "==", parsedBody)
                .where("class", "==", qClass)
                .where("subject", "==", subject)
                .where("chapter", "==", chapter)
                .where("createdBy", "==", userId)
                .get();

            if (!snapshot.empty) {
                skippedCount++;
                continue;
            }
            
            // Extract details from meta line
            const meta = parseMetaLine(parsedMeta);

            await db.collection("questions").add({
                text: fullText,
                body: parsedBody,
                metaLine: parsedMeta,
                difficulty: meta.difficulty,
                level: meta.level,
                marks: meta.marks,
                class: qClass,
                subject: subject,
                chapter: chapter,
                createdBy: userId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            savedCount++;
        }

        showToast(`${savedCount} question(s) saved. ${skippedCount} duplicate(s) skipped.`, 'success');
        saveButton.disabled = false;
        saveButton.textContent = "Save All";
    }

    // --- Logic for the edit/delete popup ---
    function showEditDeletePopup(targetElement, questionIndex, sessionParams) {
        const popup = document.createElement('div');
        popup.id = 'ai-question-editor-popup';
        popup.className = 'ai-question-popup';
        popup.innerHTML = `<button class="popup-edit-btn">Edit</button><button class="popup-delete-btn">Delete</button>`;
        
        popup.querySelector('.popup-edit-btn').onclick = (e) => {
            e.stopPropagation();
            enableQuestionEditMode(targetElement, questionIndex, sessionParams);
            popup.remove();
        };
        
        popup.querySelector('.popup-delete-btn').onclick = (e) => {
            e.stopPropagation();
            if (confirm("Delete this question from the session?")) {
                currentSessionQuestions.splice(questionIndex, 1);
                displayAllSessionQuestions(document.getElementById('chat-messages-area'));
            }
            popup.remove();
        };

        document.body.appendChild(popup);
        positionPopup(popup, targetElement);
    }
    
    // --- Enables content-editable mode for a question ---
    function enableQuestionEditMode(questionElement, questionIndex, sessionParams) {
        questionElement.classList.add('editing-question');
        const metaDiv = questionElement.querySelector('.question-meta-ai');
        const bodyDiv = questionElement.querySelector('.question-text-ai');
        
        metaDiv.contentEditable = true;
        bodyDiv.contentEditable = true;
        metaDiv.focus();

        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'q-edit-controls';
        controlsDiv.innerHTML = `
            <button class="btn-small btn-save-edit">Save Edit</button>
            <button class="btn-small btn-cancel-edit">Cancel</button>`;
        
        controlsDiv.querySelector('.btn-save-edit').onclick = (e) => {
            e.stopPropagation();
            disableQuestionEditMode(questionElement, questionIndex, sessionParams, true);
        };
        controlsDiv.querySelector('.btn-cancel-edit').onclick = (e) => {
            e.stopPropagation();
            disableQuestionEditMode(questionElement, questionIndex, sessionParams, false);
        };

        questionElement.appendChild(controlsDiv);
    }

    // --- Disables content-editable mode and saves or reverts changes ---
    function disableQuestionEditMode(questionElement, questionIndex, sessionParams, saveChanges) {
        const metaDiv = questionElement.querySelector('.question-meta-ai');
        const bodyDiv = questionElement.querySelector('.question-text-ai');
        
        if (saveChanges) {
            const questionData = currentSessionQuestions[questionIndex];
            questionData.parsedMeta = metaDiv.innerText.trim();
            questionData.parsedBody = bodyDiv.innerText.trim();
            questionData.fullText = `${questionData.parsedMeta}\n${questionData.parsedBody}`;
        }
        
        metaDiv.contentEditable = false;
        bodyDiv.contentEditable = false;
        questionElement.classList.remove('editing-question');
        questionElement.querySelector('.q-edit-controls')?.remove();

        // Re-render to show final state without editable styles
        displayAllSessionQuestions(document.getElementById('chat-messages-area'));
    }

    // ====== 5. UTILITY & HELPER FUNCTIONS ======

    // --- Toggles the disabled state of chat inputs ---
    function toggleChatInput(disabled) {
        document.getElementById('chat-prompt-input').disabled = disabled;
        document.getElementById('chat-send-btn').disabled = disabled;
        document.getElementById('chat-upload-btn').disabled = disabled;
    }
    
    // --- Parses a meta line string into an object ---
    function parseMetaLine(metaLine) {
        const meta = { difficulty: null, level: null, marks: null };
        const diffMatch = metaLine.match(/Q\s*\d+:\s*([^,/]+)/i);
        const levelMatch = metaLine.match(/\/Level\s*(\d+)/i);
        const marksMatch = metaLine.match(/,\s*(\d+)\s*Marks/i);
        
        if (diffMatch) meta.difficulty = diffMatch[1].trim();
        if (levelMatch) meta.level = parseInt(levelMatch[1], 10);
        if (marksMatch) meta.marks = parseInt(marksMatch[1], 10);
        
        return meta;
    }

    // --- Shows a toast notification ---
    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `toast-popup show ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, duration);
    }

    // --- Positions a popup element relative to a target element ---
    function positionPopup(popup, target) {
        const rect = target.getBoundingClientRect();
        popup.style.top = `${window.scrollY + rect.top + (rect.height / 2) - (popup.offsetHeight / 2)}px`;
        popup.style.left = `${window.scrollX + rect.left + rect.width + 10}px`;

        if (popup.offsetLeft + popup.offsetWidth > window.innerWidth) {
            popup.style.left = `${window.scrollX + rect.left - popup.offsetWidth - 10}px`;
        }
    }
    
    // --- Custom Dropdown Widget Logic ---
    function setupCustomDropdown(dropdownId, inputId, callback) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const selected = dropdown.querySelector('.selected-option');
        const options = dropdown.querySelector('.dropdown-options');
        const input = document.getElementById(inputId);
        
        selected.onclick = () => dropdown.classList.toggle('open');
        optionsContainerListener(options, selected, input, dropdown, callback);
        
        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });
    }

    function optionsContainerListener(options, selected, input, dropdown, callback) {
        options.querySelectorAll('div[data-value]').forEach(option => {
            option.onclick = () => {
                selected.textContent = option.textContent;
                input.value = option.dataset.value;
                dropdown.classList.remove('open');
                if (callback) callback(input.value);
            };
        });
    }

    // --- END OF JAVASCRIPT ---
    </script>

</body>
</html>