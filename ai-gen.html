<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AI Question Generator | St. Patrick's School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
      window.MathJax = { tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] }, svg: { fontCache: "global" } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
      :root {
        --header-height: 90px;
        --chat-bar-height: 65px;
      }
      html {
        height: -webkit-fill-available;
      }
      body {
        margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif;
        background-color: #f4f8fc;
        height: 100vh;
        height: -webkit-fill-available;
        overflow: hidden;
      }
      body::after {
        content: "St. Patrick's\A IIT & NEET FOUNDATION";
        white-space: pre; position: fixed; top: 50%; left: 50%;
        transform: translate(-50%, -50%); font-size: 5vw; font-weight: bold;
        color: rgba(15, 61, 107, 0.04); z-index: -1; text-align: center;
        pointer-events: none; line-height: 1.2;
      }
      .page-wrapper {
        display: flex; flex-direction: column; height: 100%;
      }
      
      #main-header {
        background: linear-gradient(90deg, #1762a7, #0f3d6b);
        color: #fff; border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
        min-height: var(--header-height); display: flex; flex-direction: column;
        align-items: center; justify-content: center; padding: 15px 10px 18px 10px;
        box-sizing: border-box; flex-shrink: 0;
      }
      #main-header .school-title { font-size: 1.8em; font-weight: bold; }
      #main-header .subtitle { font-size: 1.05em; color: #e0eaff; margin-top: 5px; }

      main {
        flex-grow: 1; overflow-y: auto;
        display: flex; flex-direction: column;
      }
      
      .review-container {
        width: 100%; max-width: 800px; margin: auto; background: #fff;
        border-radius: 16px; box-shadow: 0 4px 18px rgba(0, 27, 68, 0.1);
        display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;
        margin-top: 20px; margin-bottom: 20px;
      }
      .setup-form-container { padding: 25px 30px; }
      .setup-form-container h2 { text-align: center; color: #0f3d6b; margin-top: 0; margin-bottom: 20px; }
      .setup-form-container .form-group { margin-bottom: 15px; }
      .setup-form-container label { font-weight: 600; margin-bottom: 5px; color: #185496; display: block; }
      .setup-form-container input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1.3px solid #bcd6ef; font-size: 1em; background: #f7fafd; box-sizing: border-box; }
      .setup-form-container button[type="submit"] { background: linear-gradient(90deg, #1762a7, #0f3d6b); color: #fff; font-weight: bold; cursor: pointer; padding: 12px 0; margin-top: 15px; width: 100%; border-radius: 8px; border: none; font-size: 1.05em; }

      .custom-dropdown { position: relative; }
      .selected-option { padding: 10px 12px; color: #12416c; background: #f7fafd; border-radius: 6px; border: 1.3px solid #bcd6ef; cursor: pointer; }
      .dropdown-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1.3px solid #bcd6ef; border-top: none; border-radius: 0 0 6px 6px; box-shadow: 0 6px 15px rgba(0, 27, 68, 0.1); z-index: 1000; max-height: 200px; overflow-y: auto; }
      .custom-dropdown.open .dropdown-options { display: block; }
      .dropdown-options div[data-value] { padding: 10px 15px; cursor: pointer; }
      .dropdown-options div[data-value]:hover { background: #e0eaff; }

      .chat-ui-bar {
        background: linear-gradient(90deg, #1762a7, #0f3d6b);
        color: white; flex-shrink: 0; padding: 12px 15px;
        display: flex; align-items: center; box-sizing: border-box;
      }
      .ai-chat-header {
        justify-content: space-between; min-height: var(--header-height);
        flex-direction: column; align-items: flex-start;
        justify-content: center; gap: 5px;
      }
      .chat-header-line { width: 100%; }
      .chat-header-line.buttons { margin-top: 8px; display: flex; gap: 10px; }
      .ai-chat-header p { margin: 0; font-size: 0.9em; line-height: 1.4; font-weight: 500;}
      .header-actions .btn-small { background-color: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 14px; font-size: 0.9em; border-radius: 5px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
      .header-actions .btn-small:hover { background-color: rgba(255,255,255,0.3); }
      #ai-save-all-btn { background-color: #28a745; }
      
      .chat-input-bar { gap: 10px; }
      #chat-prompt-input {
        flex-grow: 1; padding: 12px 18px; border-radius: 25px;
        border: none; font-size: 16px; resize: none; line-height: 1.4;
        background: #fff; color: #333; max-height: 120px; min-height: 22px;
      }
      #chat-upload-btn {
        background: none; border: none; font-size: 1.5em; color: white;
        cursor: pointer; padding: 5px; order: 2;
      }
      
      .ai-chat-container { display: flex; flex-direction: column; height: 100%; }
      .chat-messages-area { flex-grow: 1; overflow-y: auto; padding: 15px; }

     .chat-messages-area {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;           /* This line is NEW */
    flex-direction: column;  /* This line is NEW */
}

.message { 
    margin-bottom: 12px; 
    padding: 10px 14px; 
    border-radius: 12px; 
    max-width: 85%; 
    word-wrap: break-word; 
    line-height: 1.5; 
}
.user-message { 
    background-color: #dcf8c6; 
    margin-left: auto; 
    color: #333; 
    align-self: flex-end;    /* This line is NEW */
}
.ai-message { 
    background-color: #fff; 
    margin-right: auto; 
    color: #333; 
    box-shadow: 0 1px 1px rgba(0,0,0,0.05); 
    align-self: flex-start;  /* This line is NEW */
}
      .system-message { background-color: #e9edef; color: #54656f; text-align: center; font-size: 0.85em; max-width: 100%; border-radius: 5px; }
      .question-meta-ai { color: #c82333; font-weight: 600; font-size: 0.9em; margin-bottom: 6px; }
      .question-text-ai { color: #004085; font-size: 0.98em; }

      .selection-popup {
        position: absolute; background: #333; color: white; border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 5px;
        z-index: 1010; display: flex; gap: 5px;
      }
      .selection-popup button { background: none; border: none; color: white; padding: 8px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
      .selection-popup button:hover { background-color: #555; }
        /* --- New styles for Modern Chat Input --- */
.chat-input-container {
    position: relative;
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 25px;
    padding: 8px 15px;
    flex-grow: 1;
}

#chat-prompt-input {
    border: none;
    outline: none;
    background: transparent;
    padding-right: 70px; /* Make space for the buttons */
}

.input-buttons {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
}

#chat-upload-btn, #chat-send-btn {
    background: none;
    border: none;
    color: #54656f;
    font-size: 1.4em; /* Slightly larger icons */
    cursor: pointer;
    padding: 5px;
}

#chat-send-btn {
    color: #1762a7; /* Make the send button blue */
}
        #scroll-to-bottom {
  position: fixed;
  bottom: 85px;
  right: 20px;
  z-index: 100;
  background-color: #0f3d6b;
  color: white;
  border: none;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  font-size: 1.2em;
  cursor: pointer;
  display: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
}
    /* ===== Edit Popup Modal ===== */
.edit-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2000;
  background: #ffffff;
  border: 1.5px solid #ccc;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  padding: 20px 25px;
  max-width: 90%;
  width: 600px;
  font-family: 'Segoe UI', sans-serif;
}
.edit-popup h3 {
  margin-top: 0;
  font-size: 1.3em;
  color: #0f3d6b;
}
.edit-popup label {
  display: block;
  margin-bottom: 6px;
  font-weight: bold;
  color: #185496;
}
.edit-popup input,
.edit-popup textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 14px;
  font-size: 1em;
  border: 1.3px solid #bcd6ef;
  border-radius: 6px;
  background-color: #f7fafd;
}
.edit-popup .popup-buttons {
  text-align: right;
}
.edit-popup .popup-buttons button {
  padding: 8px 14px;
  margin-left: 10px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  font-size: 0.95em;
}
.edit-popup #edit-cancel {
  background: #ccc;
  color: #333;
}
.edit-popup #edit-save {
  background: #0f3d6b;
  color: white;
}
    .chat-bubble {
  max-width: 80%;
  margin: 10px;
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 0.95em;
  line-height: 1.4em;
  display: inline-block;
  clear: both;
  position: relative;
  word-wrap: break-word;
}
.user-bubble {
  background-color: #d1eaff;
  color: #003865;
  float: right;
  text-align: right;
}
.ai-bubble {
  background-color: #f1f1f1;
  color: #222;
  float: left;
  text-align: left;
}
.bubble-text {
  white-space: pre-wrap;
}
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header id="main-header">
          <h1 class="school-title">St. Patrick's School</h1>
          <div class="subtitle">IIT & NEET FOUNDATION</div>
        </header>
        <main>
          <div id="ai-container" class="review-container">
            <div class="setup-form-container">
                <h2>AI Question Generator</h2>
                <p>Loading...</p>
            </div>
          </div>
        </main>
    </div>

    <input type="file" id="file-upload-input" accept="image/*,application/pdf,.doc,.docx" capture="environment" style="display:none;">

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

    <script>
    // --- FULL JAVASCRIPT ---

    const API_BASE_URL = 'https://question-bank-lqsu.onrender.com';
    const firebaseConfig = {
      apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
      authDomain: "stpatricks-questionbank.firebaseapp.com",
      projectId: "stpatricks-questionbank",
      storageBucket: "stpatricks-questionbank.appspot.com",
      messagingSenderId: "917615322861",
      appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore(); let stagedFile = null;
    let currentUserProfile = null;
    let currentSessionQuestions = [];
    const aiGeneratorConfig = {
      classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
      subjectMappings: {
        "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
      },
      questionTypes: ["MCQs", "Descriptive"],
      getSubjectsForClass: function(className) { return this.subjectMappings[className] || []; }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUserProfile = { uid: user.uid, email: user.email, displayName: user.displayName };
          const state = history.state || {};
          if (state.page === 'chat') {
            loadAiChatInterface(state.sessionParams);
          } else {
            loadAiQuestionGeneratorForm();
          }
        } else {
          window.location.href = 'login.html';
        }
      });
      window.addEventListener('popstate', (event) => {
        const state = event.state || {};
        if (state.page === 'chat') {
            loadAiChatInterface(state.sessionParams);
        } else {
            loadAiQuestionGeneratorForm();
        }
      });
    });
    
    function loadAiQuestionGeneratorForm() {
      document.getElementById('main-header').style.display = 'flex';
      const container = document.getElementById('ai-container');
      container.innerHTML = `<div class="setup-form-container"></div>`;
      const formContainer = container.querySelector('.setup-form-container');
      const classesHTML = aiGeneratorConfig.classes.map(c => `<div data-value="${c}">${c}</div>`).join('');
      const initialSubjects = aiGeneratorConfig.getSubjectsForClass(aiGeneratorConfig.classes[0]);
      const subjectsHTML = initialSubjects.map(s => `<div data-value="${s}">${s}</div>`).join('');
      const qTypesHTML = aiGeneratorConfig.questionTypes.map(qt => `<div data-value="${qt}">${qt}</div>`).join('');
      
      formContainer.innerHTML = `
        <h2>AI Question Generator</h2>
        <form id="ai-setup-form">
            <div class="form-group"><label>Class:</label><div id="class-dropdown-ai" class="custom-dropdown"><input type="hidden" id="class-value-ai" value="${aiGeneratorConfig.classes[0]}"><div class="selected-option">${aiGeneratorConfig.classes[0]}</div><div class="dropdown-options">${classesHTML}</div></div></div>
            <div class="form-group"><label>Subject:</label><div id="subject-dropdown-ai" class="custom-dropdown"><input type="hidden" id="subject-value-ai" value="${initialSubjects[0] || ''}"><div class="selected-option">${initialSubjects[0] || 'Select Subject'}</div><div class="dropdown-options">${subjectsHTML}</div></div></div>
            <div class="form-group"><label>Question Type:</label><div id="qtype-dropdown-ai" class="custom-dropdown"><input type="hidden" id="qtype-value-ai" value="${aiGeneratorConfig.questionTypes[0]}"><div class="selected-option">${aiGeneratorConfig.questionTypes[0]}</div><div class="dropdown-options">${qTypesHTML}</div></div></div>
            <div class="form-group"><label>Chapter:</label><input type="text" id="chapter-input-ai" placeholder="e.g., Kinematics" required></div>
            <button type="submit">Start Generating</button>
        </form>`;
      setupCustomDropdownsForForm();
      document.getElementById("ai-setup-form").onsubmit = (e) => {
        e.preventDefault();
        const sessionParams = {
          class: document.getElementById('class-value-ai').value,
          subject: document.getElementById('subject-value-ai').value,
          questionType: document.getElementById('qtype-value-ai').value,
          chapter: document.getElementById('chapter-input-ai').value.trim(),
        };
        if (!sessionParams.chapter || !sessionParams.subject) return;
        history.pushState({ page: 'chat', sessionParams: sessionParams }, 'Chat', '#chat');
        loadAiChatInterface(sessionParams);
      };
    }
    
    function loadAiChatInterface(sessionParams) {
        document.getElementById('main-header').style.display = 'none';
        const container = document.getElementById('ai-container');
        currentSessionQuestions = [];
       container.innerHTML = `
  <div class="ai-chat-container">
    <div class="ai-chat-header chat-ui-bar">
      <div class="chat-header-line">
        <p><b>Class:</b> ${sessionParams.class} / <b>Subject:</b> ${sessionParams.subject}</p>
      </div>
      <div class="chat-header-line">
        <p><b>Chapter:</b> ${sessionParams.chapter}</p>
      </div>
      <div class="chat-header-line buttons">
        <div class="header-actions">
          <button id="ai-change-setup-btn" class="btn-small">Change Setup</button>
          <button id="ai-save-all-btn" class="btn-small">Save All</button>
        </div>
      </div>
    </div>

    <div id="chat-messages-area" class="chat-messages-area"></div>
    <!-- Show file name when attached -->
    <div id="file-preview-box" style="
      display: none;
      padding: 6px 16px;
      background: white;
      color: #333;
      font-size: 0.9em;
      font-family: 'Segoe UI', sans-serif;
      border-bottom: 1px solid #ddd;
    ">
  <span style="color: #1762a7;">📄</span>
  <span id="file-preview-name" style="font-weight: 600; color: #333;"></span>
</div>
   <button id="remove-file-btn" style="
    background: none;
    border: none;
    color: #c82333;
    font-size: 1.1em;
    cursor: pointer;
    margin-left: 10px;
  " title="Remove File">❌</button>
    <div id="chat-input-bar" class="chat-ui-bar">
      <div class="chat-input-container">
        <textarea id="chat-prompt-input" placeholder="e.g., Generate HOTS questions from Algebra..." rows="1"></textarea>
        <div class="input-buttons">
          <button id="chat-upload-btn" title="Attach File"><i class="fas fa-paperclip"></i></button>
          <button id="chat-send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>

    <button id="scroll-to-bottom" title="Scroll to Bottom">⬇️</button>
  </div>`;
        document.getElementById('ai-change-setup-btn').onclick = () => history.back();
        document.getElementById('ai-save-all-btn').onclick = () => saveSessionQuestions(sessionParams);
        const chatPromptInput = document.getElementById('chat-prompt-input');
        const fileUploadInput = document.getElementById('file-upload-input');
        const sendBtn = document.getElementById('chat-send-btn');
        document.getElementById('chat-upload-btn').onclick = () => fileUploadInput.click();
        fileUploadInput.onchange = (e) => handleFileUpload(e, sessionParams);
      sendBtn.onclick = () => handleSendPrompt(sessionParams);
    chatPromptInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendPrompt(sessionParams);
        }
    });
   
    // --- Auto-resize Textarea ---
    chatPromptInput.addEventListener('input', () => {
        chatPromptInput.style.height = 'auto'; // Reset height
        let scrollHeight = chatPromptInput.scrollHeight;
        const maxHeight = 120; // Matches the max-height in your CSS
        if (scrollHeight > maxHeight) {
            chatPromptInput.style.height = maxHeight + 'px';
            chatPromptInput.style.overflowY = 'auto';
        } else {
            chatPromptInput.style.height = scrollHeight + 'px';
            chatPromptInput.style.overflowY = 'hidden';
        }
    });
   document.addEventListener('selectionchange', handleSelectionChange);
}
    function setupCustomDropdownsForForm() {
        setupCustomDropdown('class-dropdown-ai', 'class-value-ai', (selectedClass) => {
            const subjectDropdown = document.getElementById('subject-dropdown-ai');
            const subjectOptions = subjectDropdown.querySelector('.dropdown-options');
            const subjectSelected = subjectDropdown.querySelector('.selected-option');
            const subjectInput = document.getElementById('subject-value-ai');
            const newSubjects = aiGeneratorConfig.getSubjectsForClass(selectedClass);
            subjectOptions.innerHTML = newSubjects.map(s => `<div data-value="${s}">${s}</div>`).join('');
            subjectSelected.textContent = newSubjects[0] || 'Select Subject';
            subjectInput.value = newSubjects[0] || '';
            // Re-initialize the listeners for the newly created subject options
            optionsContainerListener(subjectOptions, subjectSelected, subjectInput, subjectDropdown, null);
        });
        setupCustomDropdown('subject-dropdown-ai', 'subject-value-ai');
        setupCustomDropdown('qtype-dropdown-ai', 'qtype-value-ai');
    }

    function setupCustomDropdown(dropdownId, inputId, callback) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const selected = dropdown.querySelector('.selected-option');
        const options = dropdown.querySelector('.dropdown-options');
        const input = document.getElementById(inputId);
        selected.onclick = (e) => { e.stopPropagation(); toggleDropdown(dropdownId); };
        optionsContainerListener(options, selected, input, dropdown, callback);
    }
        function optionsContainerListener(options, selected, input, dropdown, callback) {
        options.querySelectorAll('div[data-value]').forEach(option => {
            option.onclick = () => {
                selected.textContent = option.textContent;
                input.value = option.dataset.value;
                dropdown.classList.remove('open');
                if (callback) callback(input.value);
            };
        });
    }
    function toggleDropdown(dropdownId) {
        const currentDropdown = document.getElementById(dropdownId);
        if(!currentDropdown) return;
        const currentlyOpen = currentDropdown.classList.contains('open');
        // Close all other dropdowns first
        document.querySelectorAll('.custom-dropdown.open').forEach(d => {
            if (d.id !== dropdownId) d.classList.remove('open');
        });
        // Then toggle the one that was clicked
        if(!currentlyOpen) currentDropdown.classList.add('open');
    }
async function handleSendPrompt(sessionParams) {
    const chatPromptInput = document.getElementById('chat-prompt-input');
    const userPrompt = chatPromptInput.value.trim();
    const messagesArea = document.getElementById('chat-messages-area');
    const scrollBtn = document.getElementById('scroll-to-bottom');

messagesArea.addEventListener('scroll', () => {
  const atBottom = messagesArea.scrollHeight - messagesArea.scrollTop <= messagesArea.clientHeight + 50;
  scrollBtn.style.display = atBottom ? 'none' : 'block';
});

scrollBtn.onclick = () => {
  messagesArea.scrollTop = messagesArea.scrollHeight;
};

    if (!userPrompt && !stagedFile) return;
    appendChatMessage(text, 'user', messagesArea);
    chatPromptInput.value = '';
        const loadingMessage = appendChatMessage('Generating...', 'system-message');
    // We add a flag to know if we sent a file
    const didSendFile = stagedFile !== null;
    try {
        let result;
        if (stagedFile) {
            // If a file is staged, send it
            const formData = new FormData();
            formData.append('imageFile', stagedFile);
            formData.append('prompt', userPrompt);
            const response = await fetch(`${API_BASE_URL}/api/v1/extract-from-image`, {
                method: 'POST',
                body: formData
            });
            result = await response.json();
            if (!response.ok) throw new Error(result.error || "File processing failed.");

        } else {
            // If no file, send a normal text prompt
            const fullPromptForAI = `Class: ${sessionParams.class}, Subject: ${sessionParams.subject}, Chapter: ${sessionParams.chapter}, Question Type: ${sessionParams.questionType}. User request: "${userPrompt}". Format each question strictly as: Q <num>: <Difficulty>/Level <Lvl>, <Marks> Marks\nThen the question text. Provide ONLY the questions.`;
            const response = await fetch(`${API_BASE_URL}/api/v1/generate`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: fullPromptForAI })
            });
            result = await response.json();
            if (!response.ok) throw new Error(result.error || "API error");
        }
        parseAndDisplayAiQuestions(result.result, messagesArea, sessionParams);

    } catch (err) {
       appendChatMessage(`Error: ${err.message}`, 'system-message');
    } finally {
        loadingMessage.remove(); 
        if (didSendFile) {
            stagedFile = null; 
            document.getElementById('chat-upload-btn').style.color = '#54656f'; // and reset the icon color
        }
    }
}
function handleFileUpload(event, sessionParams) {
    const file = event.target.files[0];
    if (!file) return;

    stagedFile = file; 
    document.getElementById('file-preview-box').style.display = 'block';
    document.getElementById('file-preview-name').textContent = file.name;
    document.getElementById('chat-prompt-input').placeholder = "You can describe the file or continue typing...";
    document.getElementById('chat-upload-btn').style.color = '#1762a7';
}
}
  async function saveSessionQuestions(sessionParams) {
        if (!currentUserProfile || currentSessionQuestions.length === 0) {
            alert("No new questions in this session to save.");
            return;
        }
        const saveButton = document.getElementById('ai-save-all-btn');
        saveButton.disabled = true;
        saveButton.textContent = "Saving...";
        let savedCount = 0, skippedCount = 0;
        for (const qData of currentSessionQuestions) {
            const snapshot = await db.collection("questions").where("body", "==", qData.parsedBody).where("class", "==", qData.class).where("subject", "==", qData.subject).where("chapter", "==", qData.chapter).where("createdBy", "==", currentUserProfile.uid).get();
            if (!snapshot.empty) {
                skippedCount++;
                continue;
            }
            const meta = parseMetaLine(qData.parsedMeta);
            await db.collection("questions").add({
                text: qData.fullText, body: qData.parsedBody, metaLine: qData.parsedMeta,
                difficulty: meta.difficulty, level: meta.level, marks: meta.marks,
                class: qData.class, subject: qData.subject, chapter: qData.chapter,
                createdBy: currentUserProfile.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            savedCount++;
        }
        alert(`${savedCount} question(s) saved. ${skippedCount} duplicate(s) skipped.`);
        saveButton.disabled = false;
        saveButton.textContent = "Save All";
    }

    function handleSelectionChange() {
        const selection = window.getSelection();
        const popup = document.getElementById('selection-popup');
       const targetElement = selection.anchorNode ? selection.anchorNode.parentElement.closest('.ai-message') : null;
        if (!selection || selection.isCollapsed || !targetElement) {
            if (popup) popup.remove();
            return;
        }
        if (document.getElementById('selection-popup')) return;
        const questionIndex = parseInt(targetElement.dataset.sessionQuestionIndex, 10);
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        const newPopup = document.createElement('div');
        newPopup.id = 'selection-popup';
        newPopup.className = 'selection-popup';
        newPopup.innerHTML = `<button id="popup-copy">Copy</button><button id="popup-edit">Edit</button><button id="popup-delete">Delete</button>`;
        document.body.appendChild(newPopup);
        newPopup.style.top = `${window.scrollY + rect.top - newPopup.offsetHeight - 8}px`;
        newPopup.style.left = `${window.scrollX + rect.left + (rect.width / 2) - (newPopup.offsetWidth / 2)}px`;
        newPopup.querySelector('#popup-copy').onclick = () => {
            navigator.clipboard.writeText(selection.toString());
            newPopup.remove();
        };
        newPopup.querySelector('#popup-edit').onclick = () => {
  const oldText = targetElement.querySelector('.question-text-ai').innerText;
  const oldMeta = targetElement.querySelector('.question-meta-ai').innerText;

  const editor = document.createElement('div');
 editor.className = 'edit-popup';
  editor.style.top = '50%';
  editor.style.left = '50%';
  editor.style.transform = 'translate(-50%, -50%)';
  editor.style.zIndex = 2000;
  editor.style.background = '#fff';
  editor.style.border = '1px solid #ccc';
  editor.style.borderRadius = '10px';
  editor.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
  editor.style.padding = '20px';
  editor.style.maxWidth = '90%';
  editor.style.width = '600px';

  editor.innerHTML = `
    <h3>Edit Question</h3>
    <label style="font-weight: bold;">Meta Line:</label>
    <input type="text" id="edit-meta" value="${oldMeta}" style="width:100%; padding:8px; margin-bottom:12px; font-size:1em;" />
    <label style="font-weight: bold;">Question Body:</label>
    <textarea id="edit-body" rows="6" style="width:100%; padding:8px; font-size:1em;">${oldText}</textarea>
    <div style="text-align: right; margin-top: 15px;">
      <button id="edit-cancel" style="margin-right:10px;">Cancel</button>
      <button id="edit-save">Save</button>
    </div>
  `;

  document.body.appendChild(editor);
  popup.remove(); // remove selection popup

  document.getElementById('edit-cancel').onclick = () => editor.remove();

  document.getElementById('edit-save').onclick = () => {
    const newMeta = document.getElementById('edit-meta').value.trim();
    const newBody = document.getElementById('edit-body').value.trim();

    currentSessionQuestions[questionIndex].parsedMeta = newMeta;
    currentSessionQuestions[questionIndex].parsedBody = newBody;
    currentSessionQuestions[questionIndex].fullText = `${newMeta} ${newBody}`;

    const messagesArea = document.getElementById('chat-messages-area');
    messagesArea.querySelectorAll('.ai-question-item').forEach(item => item.remove());
    const fragment = document.createDocumentFragment();
currentSessionQuestions.forEach((q, i) => {
  const message = document.createElement('div');
  message.className = 'message ai-message ai-question-item';
  message.dataset.sessionQuestionIndex = i;
  message.innerHTML = `
    <div class="question-meta-ai">${q.parsedMeta}</div>
    <div class="question-text-ai">${q.parsedBody}</div>
  `;
  fragment.appendChild(message);
});
messagesArea.appendChild(fragment);
editor.remove();
  };
};
        newPopup.querySelector('#popup-delete').onclick = () => {
            if (confirm('Are you sure you want to delete this question from the session?')) {
                currentSessionQuestions.splice(questionIndex, 1);
                const messagesArea = document.getElementById('chat-messages-area');
                messagesArea.querySelectorAll('.ai-question-item').forEach(item => item.remove());
                const fragment = document.createDocumentFragment();
currentSessionQuestions.forEach((q, i) => {
  const message = document.createElement('div');
  message.className = 'message ai-message ai-question-item';
  message.dataset.sessionQuestionIndex = i;
  message.innerHTML = `
    <div class="question-meta-ai">${q.parsedMeta}</div>
    <div class="question-text-ai">${q.parsedBody}</div>
  `;
  fragment.appendChild(message);
});
messagesArea.appendChild(fragment);
          }
            newPopup.remove();
        };
    }
    
    function appendChatMessage(text, type, messagesArea) {
      const messageDiv = document.createElement('div');
      let className = `message ${type.includes('is-loading') ? 'system-message is-loading' : type + '-message'}`;
      messageDiv.className = className;
      messageDiv.textContent = text;
      const userMessage = document.createElement('div');
        userMessage.className = 'chat-bubble user-bubble';
        userMessage.innerHTML = `<div class="bubble-text">${userPrompt}</div>`;
        messagesArea.appendChild(userMessage);

      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function parseAndDisplayAiQuestions(responseText, messagesArea, sessionParams) {
        const questionBlocks = responseText.split(/\n(?=Q\s*\d+:)/g).map(q => q.trim()).filter(Boolean);
        if (questionBlocks.length === 0 && responseText) { appendChatMessage(responseText, 'ai', messagesArea); return; }
        const fragment = document.createDocumentFragment();
        questionBlocks.forEach(qText => {
            const questionData = { fullText: qText, class: sessionParams.class, subject: sessionParams.subject, chapter: sessionParams.chapter };
            const metaMatch = qText.match(/^(Q\s*\d+:.*,\s*\d+\s*Marks)/);
            questionData.parsedMeta = metaMatch ? metaMatch[1] : 'Q: Details missing';
            questionData.parsedBody = metaMatch ? qText.substring(metaMatch[1].length).trim() : qText;
            currentSessionQuestions.push(questionData);
            const questionEl = createQuestionElement(questionData, currentSessionQuestions.length - 1);
            fragment.appendChild(questionEl);
        });
        messagesArea.appendChild(fragment);
        if (window.MathJax) MathJax.typesetPromise([messagesArea]);
    }

    function createQuestionElement(qData, index) {
        const questionEl = document.createElement('div');
        questionEl.className = 'message ai-message ai-question-item';
        questionEl.dataset.sessionQuestionIndex = index;
        questionEl.innerHTML = `<div class="question-meta-ai">${qData.parsedMeta}</div><div class="question-text-ai">${qData.parsedBody}</div>`;
        return questionEl;
    }
    
    function parseMetaLine(metaLine) {
        const meta = { difficulty: null, level: null, marks: null };
        const diffMatch = metaLine.match(/Q\s*\d+:\s*([^,/]+)/i);
        const levelMatch = metaLine.match(/\/Level\s*(\d+)/i);
        const marksMatch = metaLine.match(/,\s*(\d+)\s*Marks/i);
        if (diffMatch) meta.difficulty = diffMatch[1].trim();
        if (levelMatch) meta.level = parseInt(levelMatch[1], 10);
        if (marksMatch) meta.marks = parseInt(marksMatch[1], 10);
        return meta;
    }

    </script>
</body>
</html>
