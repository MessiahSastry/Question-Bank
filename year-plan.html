<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Year Plan & Syllabus PDF | St. Patrick's School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      margin: 0; padding: 0;
      background: #f4f8fc;
      font-family: 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
    }
    .header-bar {
      background: #0f3d6b;
      color: #fff;
      padding: 18px 0 12px 0;
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
      text-align: center;
      font-size: 1.28em;
      font-weight: 700;
      letter-spacing: 1px;
      box-shadow: 0 2px 12px #0f3d6b22;
    }
    .section-container {
      max-width: 480px;
      margin: 24px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 20px #0f3d6b18;
      padding: 22px 16px 28px 16px;
    }
    h2 {
      margin: 0 0 14px 0;
      color: #155394;
      font-size: 1.18em;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .fa-calendar, .fa-download {
      color: #1762a7;
    }
    label {
      font-weight: 600;
      color: #19599e;
      margin-bottom: 7px;
      display: block;
      font-size: 0.97em;
      letter-spacing: 0.1px;
    }
    .custom-dropdown {
      position: relative;
      margin-bottom: 16px;
    }
    .selected-option {
      padding: 11px 13px;
      color: #12416c;
      background: #f7fafd;
      border-radius: 8px;
      border: 1.6px solid #bcd6ef;
      cursor: pointer;
      font-size: 1.05em;
      transition: border-color 0.18s;
      min-height: 21px;
      user-select: none;
    }
    .selected-option:after {
      content: "\f078";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      float: right;
      color: #1461a9b8;
      margin-left: 8px;
      font-size: 0.92em;
      pointer-events: none;
    }
    .dropdown-options {
      display: none;
      position: absolute;
      top: 100%; left: 0; right: 0;
      background: #fff;
      border: 1.6px solid #bcd6ef;
      border-top: none;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 7px 18px #0f3d6b11;
      z-index: 1000;
      max-height: 220px;
      overflow-y: auto;
      animation: dropdownIn 0.15s;
    }
    @keyframes dropdownIn {
      from { opacity: 0; transform: translateY(-7px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .custom-dropdown.open .dropdown-options {
      display: block;
    }
    .dropdown-options div[data-value] {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 1.04em;
      color: #1159a8;
      background: #fff;
      transition: background 0.13s;
    }
    .dropdown-options div[data-value]:hover,
    .dropdown-options div[data-value].selected {
      background: #e0eaff;
    }
    textarea {
      width: 100%;
      min-height: 68px;
      font-size: 1.04em;
      border-radius: 8px;
      border: 1.5px solid #bcd6ef;
      padding: 10px 13px;
      background: #f7fafd;
      margin-bottom: 18px;
      resize: vertical;
      color: #12416c;
      text-transform: uppercase;
    }
    .main-btn {
      width: 100%;
      padding: 13px 0;
      font-size: 1.09em;
      background: #0f3d6b;
      color: #fff;
      border: none;
      border-radius: 9px;
      font-weight: bold;
      margin-bottom: 7px;
      cursor: pointer;
      transition: background 0.13s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 9px;
      box-shadow: 0 2px 10px #0f3d6b16;
    }
    .main-btn.green {
      background: #16aa47;
    }
    .main-btn:active {
      background: #0d3153;
    }
    .main-btn.green:active {
      background: #108a35;
    }
    hr {
      border: none;
      border-top: 1.2px solid #e4eaf3;
      margin: 30px 0 23px 0;
    }
    @media (max-width: 560px) {
      .section-container { margin: 12px 3px; }
    }
  </style>
</head>
<body>
  <div class="header-bar">Year Plan Entry</div>
  <div class="section-container">
    <h2><i class="fa-solid fa-calendar"></i> Year Plan Entry</h2>
    <!-- Academic Year -->
    <label>Academic Year</label>
    <div id="year-dropdown" class="custom-dropdown">
      <input type="hidden" id="year-value" value="">
      <div class="selected-option">Loading...</div>
      <div class="dropdown-options"></div>
    </div>
    <!-- Class -->
    <label>Class</label>
    <div id="class-dropdown" class="custom-dropdown">
      <input type="hidden" id="class-value" value="3rd Class">
      <div class="selected-option"></div>
      <div class="dropdown-options"></div>
    </div>
    <!-- Exam Name -->
    <label>Exam Name</label>
    <div id="exam-dropdown" class="custom-dropdown">
      <input type="hidden" id="exam-value" value="Formative Assessment 1">
      <div class="selected-option">Formative Assessment 1</div>
      <div class="dropdown-options"></div>
    </div>
    <label>Subject</label>
      <div id="subject-dropdown" class="custom-dropdown">
        <input type="hidden" id="subject-value" value="">
        <div class="selected-option">Select Subject</div>
        <div class="dropdown-options"></div>
      </div>
     <!-- Syllabus / Portions -->
    <label>Syllabus/Portions for Exam</label>
    <textarea id="syllabus" placeholder="ENTER SYLLABUS OR PORTIONS FOR THIS EXAM..." style="text-transform:uppercase"></textarea>
    <button class="main-btn" id="save-btn"><i class="fa-solid fa-floppy-disk"></i>Save Year Plan</button>
  </div>
  <hr>
  <div class="section-container">
    <h2><i class="fa-solid fa-download"></i> Download Exam Syllabus PDF</h2>
    <!-- Academic Year -->
    <label>Academic Year</label>
    <div id="pdf-year-dropdown" class="custom-dropdown">
      <input type="hidden" id="pdf-year-value" value="">
      <div class="selected-option">Loading...</div>
      <div class="dropdown-options"></div>
    </div>
    <!-- Class -->
    <label>Class</label>
    <div id="pdf-class-dropdown" class="custom-dropdown">
      <input type="hidden" id="pdf-class-value" value="3rd Class">
      <div class="selected-option">3rd Class</div>
      <div class="dropdown-options"></div>
    </div>
    <!-- Exam Name -->
    <label>Exam Name</label>
    <div id="pdf-exam-dropdown" class="custom-dropdown">
      <input type="hidden" id="pdf-exam-value" value="Formative Assessment 1">
      <div class="selected-option">Formative Assessment 1</div>
      <div class="dropdown-options"></div>
    </div>
    <!-- Subject -->
     <button class="main-btn green" id="download-btn">
      <i class="fa-solid fa-file-pdf"></i> Download Exam Syllabus PDF
    </button>
  </div>

  <!-- Firebase (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // ====== Your Data Mapping ======
    const aiGeneratorConfig = {
      classes: [
        "3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"
      ],
      subjectMappings: {
        "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
        "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"],
        "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 1 IIT", "Math 2", "Math 2 IIT", "Physics", "Physics IIT & NEET", "Chemistry", "Chemistry IIT & NEET", "Biology", "Biology NEET", "Social"]
      },
      exams: [
        "Formative Assessment 1", "Formative Assessment 2", "Summative Assessment 1", "Formative Assessment 3", "Formative Assessment 4", "Revision Test 1", "Revision Test 2", "Revision Test 3"
      ]
    };

    // ====== Firebase Config ======
    const firebaseConfig = {
      apiKey: "AIzaSyAszVhWXUUOYLQ7VimKmPKf1yEu_CI9RCE",
      authDomain: "stpatricks-questionbank.firebaseapp.com",
      projectId: "stpatricks-questionbank",
      storageBucket: "stpatricks-questionbank.appspot.com",
      messagingSenderId: "917615322861",
      appId: "1:917615322861:web:c6c890aa2184dd395b8ee4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ====== Helper: Setup Custom Dropdown ======
    function setupDropdown(containerId, options, initialValue, onChange) {
      const dropdown = document.getElementById(containerId);
      const selected = dropdown.querySelector('.selected-option');
      const input = dropdown.querySelector('input[type=hidden]');
      const optionsBox = dropdown.querySelector('.dropdown-options');
      optionsBox.innerHTML = '';
      options.forEach(opt => {
        const d = document.createElement('div');
        d.setAttribute('data-value', opt);
        d.innerText = opt;
        if (opt === initialValue) d.classList.add('selected');
        optionsBox.appendChild(d);
      });
      // Set initial value
      input.value = initialValue;
      selected.innerText = initialValue;
      // Click logic
      selected.onclick = e => {
        e.stopPropagation();
        document.querySelectorAll('.custom-dropdown.open').forEach(dd => { if (dd!==dropdown) dd.classList.remove('open'); });
        dropdown.classList.toggle('open');
      };
      optionsBox.querySelectorAll('div[data-value]').forEach(optDiv => {
        optDiv.onclick = () => {
          input.value = optDiv.getAttribute('data-value');
          selected.innerText = optDiv.innerText;
          optionsBox.querySelectorAll('div[data-value]').forEach(div=>div.classList.remove('selected'));
          optDiv.classList.add('selected');
          dropdown.classList.remove('open');
          if (onChange) onChange(optDiv.getAttribute('data-value'));
        };
      });
    }
    // Close dropdown on click outside
    document.addEventListener('click', function(event) {
      document.querySelectorAll('.custom-dropdown.open').forEach(dropdown => {
        if (!dropdown.contains(event.target)) dropdown.classList.remove('open');
      });
    });

    // ====== Syllabus Textarea to UPPERCASE ======
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('syllabus').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    });

    // ====== Init Page (after Firestore loads) ======
    async function initPage() {
      // Load academic years from Firestore
      let years = [];
      try {
        const snap = await db.collection('years').orderBy('name', 'desc').get();
        years = snap.docs.map(doc => doc.data().name);
      } catch (e) {
        years = ["2025-26", "2024-25", "2023-24"]; // fallback
      }

      // --- YEAR PLAN SECTION ---
      setupDropdown('year-dropdown', years, years[0]);
      setupDropdown('class-dropdown', aiGeneratorConfig.classes, aiGeneratorConfig.classes[0], onYearPlanClassChange);
      setupDropdown('exam-dropdown', aiGeneratorConfig.exams, aiGeneratorConfig.exams[0]);
      // subject
      function onYearPlanClassChange(selClass) {
        const subjects = aiGeneratorConfig.subjectMappings[selClass];
        setupDropdown('subject-dropdown', subjects, subjects[0]);
      }
      onYearPlanClassChange(aiGeneratorConfig.classes[0]);

      // --- PDF DOWNLOAD SECTION ---
      setupDropdown('pdf-year-dropdown', years, years[0]);
      setupDropdown('pdf-class-dropdown', aiGeneratorConfig.classes, aiGeneratorConfig.classes[0]);
      setupDropdown('pdf-exam-dropdown', aiGeneratorConfig.exams, aiGeneratorConfig.exams[0]);
     } 
      // ====== DOMContentLoaded Startup ======
    document.addEventListener('DOMContentLoaded', function() {
      initPage();
    });
    // ====== Save Year Plan ======
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('save-btn').onclick = async function () {
    const year = document.getElementById('year-value').value;
    const className = document.getElementById('class-value').value;
    const examName = document.getElementById('exam-value').value;
    const subject = document.getElementById('subject-value').value;
    const syllabus = document.getElementById('syllabus').value.trim();

    if (!year || !className || !examName || !subject || !syllabus) {
      alert("Please fill all fields before saving.");
      return;
    }

    // Save to Firestore
    try {
      await db.collection("year_plan").add({
        year, class: className, exam: examName, subject, syllabus,
        created: new Date()
      });
      // Show success message
      showSavedMessage("Saved!");
      // Reset fields
      document.getElementById('syllabus').value = "";
    } catch (e) {
      alert("Error saving. Try again.");
    }
  };

  // Message function
  window.showSavedMessage = function(msg) {
    let m = document.createElement('div');
    m.innerText = msg;
    m.style.cssText = "position:fixed;top:22px;left:50%;transform:translateX(-50%);background:#16aa47;color:#fff;font-weight:700;padding:13px 26px;border-radius:10px;font-size:1.12em;z-index:2000;box-shadow:0 6px 32px #0002;transition:opacity 0.2s;";
    document.body.appendChild(m);
    setTimeout(()=>{m.style.opacity='0';}, 950);
    setTimeout(()=>{m.remove();}, 1450);
  };
});
    document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('download-btn').onclick = async function () {
  const year = document.getElementById('pdf-year-value').value;
  const className = document.getElementById('pdf-class-value').value;
  const exam = document.getElementById('pdf-exam-value').value;

  // Fetch ALL subjects for this class/year/exam
  const snap = await db.collection('year_plan')
    .where('year', '==', year)
    .where('class', '==', className)
    .where('exam', '==', exam)
    .get();

  if (snap.empty) {
    alert('No syllabus found for this selection.');
    return;
  }

  // Prepare data
  const data = [];
  snap.forEach(doc => {
    const d = doc.data();
    data.push({subject: d.subject, syllabus: d.syllabus});
  });

  // ======= jsPDF Part =======
    // ======= jsPDF Part =======
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let pageWidth = doc.internal.pageSize.getWidth();
  let y = 18;

  // 1. School Name (centered, big)
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('St. Patrick\'s School', pageWidth / 2, y, { align: 'center' });
  y += 9;

  // 2. Subheading (center, normal)
  doc.setFontSize(14);
  doc.setFont(undefined, 'normal');
  doc.text('IIT & NEET Foundation', pageWidth / 2, y, { align: 'center' });
  y += 8;

  // 3. Exam Name (center, normal)
  doc.setFontSize(13);
  doc.setFont(undefined, 'bold');
  doc.text(`${exam}`, pageWidth / 2, y, { align: 'center' });
  y += 11;

  // 4. Class & Year (left)
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  doc.text(`Class: ${className}`, 12, y);
  y += 7;
  doc.text(`Year: ${year}`, 12, y);
  y += 9;

  data.forEach(d => {
    doc.setFont(undefined, 'bold');
    doc.text(`${d.subject}:`, 10, y); y += 7;
    doc.setFont(undefined, 'normal');
    let lines = doc.splitTextToSize(d.syllabus, 180);
    doc.text(lines, 16, y);
    y += lines.length * 7 + 2;
    if (y > 270) { doc.addPage(); y = 14; }
  });

  doc.save(`${className}_${exam}_syllabus.pdf`);
};
});
  </script>
</body>
</html>
