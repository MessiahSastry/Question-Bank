<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  window.MathJax = { tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] }, svg: { fontCache: "global" } };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <meta charset="UTF-8" />
  <title>Exam Review | St. Patrick's School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body { margin:0; padding:0; font-family:'Segoe UI', Arial, sans-serif; background:#f4f8fc;}
    .page-wrapper { min-height:100vh; }
    #main-header {
      background: linear-gradient(90deg,#1762a7,#0f3d6b);
      color:#fff; border-bottom-left-radius:28px; border-bottom-right-radius:28px;
      padding:24px 10px 18px 10px; display:flex; flex-direction:column; align-items:center;
      position: sticky; top: 0; z-index: 10;
    }
    #main-header .school-title { font-size:2.2em; font-weight:bold; margin:0;}
    #main-header .subtitle { font-size:1.12em; color:#e0eaff; margin-top:4px;}
    main { display:flex; flex-direction:column; align-items:center; padding:18px 8px 40px 8px;}
    .review-container {
      width:100%; max-width:600px; margin:0 auto; background:#fff; border-radius:22px;
      box-shadow:0 4px 16px rgba(0,27,68,0.13); padding:32px 20px 28px 20px;
    }
    .review-container h2 { text-align:center; color:#11385d; margin:0 0 30px 0; font-size:2em; font-weight:800;}
    .section-block { margin-bottom: 36px; }
    .section-header {
      font-size:1.2em; font-weight:700; color:#0f3d6b; margin:28px 0 10px 0; 
      display:flex; align-items:center; justify-content:center; gap:8px;
      cursor:pointer; border-bottom:1.3px solid #bcd6ef; padding-bottom:5px;
      background:#f7fafd; text-align:center;
    }
    .section-flex-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      background: #eaf4fd;
      border-left: 5px solid #1762a7;
      border-radius: 7px;
      padding: 10px 18px 10px 16px;
      box-shadow: 0 2px 8px #c8e3f533;
      font-size: 1.06em;
    }
    .section-instructions {
      color: #1762a7;
      background: none;
      border: none;
      outline: none;
      font-size: 1.07em;
      font-weight: 500;
      min-height: 24px;
      margin: 0;
      padding: 0;
      flex: 1 1 auto;
      text-align: left;
      resize: none;
    }
    .marks-total-box {
      font-weight: bold;
      color: #185496;
      margin-left: 18px;
      min-width: 85px;
      text-align: right;
      flex: 0 0 auto;
    }
    .section-header[contenteditable],
    .section-instructions[contenteditable] {
      outline: 2px solid #1762a7;
    }
    .edit-icon { color:#888; margin-left:4px; cursor:pointer; }
    .question-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
      background: #f7fafd;
      padding: 13px 13px 10px 13px;
      border-radius: 9px;
      border: 1.1px solid #bcd6ef;
      font-size: 1.07em;
      box-sizing: border-box;
      min-height: 38px;
    }
    .question-number { font-weight:700; color:#185496; margin-right:8px; }
    .question-text[contenteditable] { background:#f3f7fe; border-radius:6px; outline:2px solid #0f3d6b30;}
    .marks-box[contenteditable] {
      background: #f3f7fe;
      outline: 2px solid #bcd6ef;
      border-radius: 6px;
      padding: 2px 10px;
      min-width: 28px;
      text-align: center;
      font-weight: bold;
      color: #12416c;
    }
    .marks-label {
      margin-left: 4px;
      color: #1762a7;
      font-size: 0.98em;
      opacity: 0.82;
    }
    .save-btn, .preview-btn {
      width: 100%;
      background:#1762a7; color:#fff; border:none; border-radius:7px; padding:12px 0; font-size:1.08em; font-weight:600;
      cursor:pointer; box-shadow:0 2px 7px #bcd6ef1a; margin:0;
      transition: background 0.18s;
      display: flex; justify-content: center; align-items: center; gap: 10px;
    }
    .save-btn:hover, .preview-btn:hover { background:#12416c; }
    .preview-btn {
      background: #12416c;
      margin-top: 14px;
    }
    .preview-btn:hover {
      background: #13ad59;
    }
    .edit-indicator { color:#e67600; font-size:0.93em; margin-left:8px; }
    .section-header[contenteditable] { background:#f3f7fe; }
    @media (max-width:700px){ .review-container{max-width:98vw; padding:12px 4vw 14px 4vw;} }
    @media (max-width:480px){ #main-header .school-title{font-size:1.35em;} .review-container h2{font-size:1.25em;} }
  </style>
</head>
<body>
<div class="page-wrapper">
  <header id="main-header">
    <div class="school-title">St. Patrick's School</div>
    <div class="subtitle">IIT & NEET FOUNDATION</div>
  </header>
  <main>
    <div class="review-container">
      <h2>Review & Edit Exam Paper</h2>
      <div id="exam-review-area"></div>
      <div style="display: flex; flex-direction: column; align-items: center; gap: 14px; margin-top: 24px; width: 100%;">
         <button class="save-btn" id="randomize-numbers-btn" style="background:#f08035;">
        <i class="fas fa-random"></i> Randomize Numbers in Problems
        </button>
        <button class="save-btn" id="save-review-btn">
          <i class="fas fa-save"></i> Save Changes
        </button>
        <button class="preview-btn" id="preview-btn">
          <i class="fas fa-eye"></i> Preview Question Paper
        </button>
      </div>
    </div>
  </main>
</div>
<script>
  function getExamPaper() {
    try {
      return JSON.parse(sessionStorage.getItem("examPaper") || "null");
    } catch {
      return null;
    }
  }
  function setExamPaper(paper) {
    sessionStorage.setItem("examPaper", JSON.stringify(paper));
  }

  function renderExam() {
    const paper = getExamPaper();
    const area = document.getElementById('exam-review-area');
    if (!paper) {
      area.innerHTML = `<div style="color:#b00;padding:16px;font-size:1.11em;">No exam paper found!<br>Please go back and generate one first.</div>`;
      document.getElementById("save-review-btn").disabled = true;
      document.getElementById("preview-btn").disabled = true;
      return;
    }

    let html = '';
    (paper.subjects || []).forEach((subjectBlock, subjIdx) => {
      if (paper.instructions) {
  html += `<div class="paper-global-instructions" style="color:#12416c;font-size:1.1em; font-weight:600; background:#f7fafd; padding:10px 18px; border-radius:9px; margin-bottom:22px; text-align:center;">
    ${paper.instructions}
  </div>`;
}
      html += `<h3 style="color:#0f3d6b; margin:22px 0 8px 0;">Subject: ${subjectBlock.subject}</h3>`;
      (subjectBlock.sections || []).forEach((section, sIdx) => {
        // Section Header (centered)
       html += `
  <div class="section-block" style="margin-bottom: 18px;">
    <!-- Centered Section Header -->
    <div class="section-header"
        style="text-align:center; justify-content: center;"
        contenteditable="true"
        spellcheck="true"
        data-subject="${subjIdx}"
        data-section="${sIdx}">
      ${section.label || 'Section'}${section.mcqType ? ` (${section.mcqType.toUpperCase()})` : ""}
      <i class="fas fa-pen edit-icon"></i>
    </div>
    <!-- Instructions and Total in one row -->
    <div class="section-flex-row" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0; padding:7px 18px 7px 18px;">
  <div style="font-weight: 600; color: #1762a7; font-size: 1.08em; text-align:left;">
    ${
      section.type === "all"
        ? `Answer all ${section.numQuestions} questions`
        : section.type === "any"
          ? `Answer any ${section.attemptAny || section.numQuestions} questions`
          : section.type === "internal"
            ? `Answer all ${section.numPairs} pairs`
            : ""
    }
  </div>
  <div style="font-weight: 600; color: #1762a7; font-size: 1.08em; text-align:right; min-width:95px;">
    Total: ${
      section.type === "all"
        ? (section.numQuestions * section.marksPerQuestion)
        : section.type === "any"
          ? ((section.attemptAny || section.numQuestions) * section.marksPerQuestion)
          : section.type === "internal"
            ? (section.numPairs * section.marksPerQuestion)
            : ""
    } Marks
  </div>
</div>
`;
        (section.questions || []).forEach((q, qIdx) => {
          html += `<div class="question-row" data-subject="${subjIdx}" data-section="${sIdx}" data-question="${qIdx}">
            <span class="question-number">${q.number ? q.number : (qIdx+1)}.</span>
            <span class="question-text">${q.text}</span>
            <span class="marks-box" contenteditable="true">${q.marks || section.marksPerQuestion || ''}</span>
            <span class="marks-label">Marks</span>
          </div>`;
        });
        html += `</div>`;
      });
    });
    area.innerHTML = html;
    MathJax.typesetPromise();

    // Inline editing indicators for all [contenteditable]
    area.querySelectorAll('[contenteditable]').forEach(el => {
      el.addEventListener('input', function() {
        this.classList.add('edited');
        // Remove existing edit-indicator
        const parent = this.parentNode;
        const existing = parent.querySelector('.edit-indicator');
        if (existing) existing.remove();
        // Add new one
        const ind = document.createElement('span');
        ind.className = 'edit-indicator';
        ind.textContent = 'Edited';
        parent.appendChild(ind);
      });
      el.addEventListener('blur', function() {
        this.classList.remove('edited');
        if (this.parentNode && this.parentNode.querySelector('.edit-indicator')) {
          setTimeout(() => {
            if (this.parentNode) {
              const indicator = this.parentNode.querySelector('.edit-indicator');
              if (indicator) indicator.remove();
            }
          }, 600);
        }
      });
    });
  }

  function saveEdits() {
    const paper = getExamPaper();
    if (!paper) return;
    // Section names
    document.querySelectorAll('.section-header').forEach(sec => {
      const subjIdx = +sec.dataset.subject, secIdx = +sec.dataset.section;
      paper.subjects[subjIdx].sections[secIdx].label = sec.textContent.replace(/<[^>]+>/g,'').replace(/Edited$/,'').trim();
    });
    // Instructions (editable flex row)
    document.querySelectorAll('.section-instructions').forEach(ins => {
      const subjIdx = +ins.dataset.subject, secIdx = +ins.dataset.section;
      paper.subjects[subjIdx].sections[secIdx].instructions = ins.innerText.trim();
    });
    // Questions/marks
    document.querySelectorAll('.question-row').forEach(qr => {
      const subjIdx = +qr.dataset.subject, secIdx = +qr.dataset.section, qIdx = +qr.dataset.question;
      paper.subjects[subjIdx].sections[secIdx].questions[qIdx].marks = qr.querySelector('.marks-box').innerText.trim();
    });
    setExamPaper(paper);
    alert('Changes saved!');
  }

  document.getElementById('save-review-btn').onclick = saveEdits;
  window.onload = renderExam;
  document.getElementById('preview-btn').onclick = function() {
    saveEdits();
    const paper = getExamPaper();
    if (paper) {
      sessionStorage.setItem('finalExamData', JSON.stringify(paper));
      window.location.href = 'exam-preview.html';
    } else {
      alert('No exam paper found!');
    }
  };
 // --- Add this code at the end of your <script> ---
document.getElementById('randomize-numbers-btn').onclick = async function() {
  saveEdits();
  const paper = getExamPaper();
  if (!paper) {
    alert('No exam paper found!');
    return;
  }
  let allQuestions = [];
  paper.subjects.forEach((subjectBlock, subjIdx) => {
    (subjectBlock.sections || []).forEach((section, sIdx) => {
      (section.questions || []).forEach((q, qIdx) => {
        const isProbSubject = ["math", "math 1", "math 2", "physics", "chemistry"].some(
          s => subjectBlock.subject.toLowerCase().includes(s)
        );
        if (!isProbSubject) return;
        const hasNumber = /\d/.test(q.text);
        if (!hasNumber) return;
        allQuestions.push({
          subjIdx, sIdx, qIdx,
          subject: subjectBlock.subject,
          sectionLabel: section.label,
          question: q.text,
          options: q.options || [],
        });
      });
    });
  });
  if (allQuestions.length === 0) {
    alert("No numerical problem-solving questions found in Math/Physics/Chemistry.");
    return;
  }
  const prompt = `
For each question below, if it is a numerical/problem-solving question, change all numbers in the question and all options to new reasonable values, without changing the concept or difficulty. Make sure the correct answer and distractors match the new numbers. Do not change anything for theory or conceptual questions.

Input:
${allQuestions.map((q, idx) => 
`Q${idx+1} (Subject: ${q.subject}, Section: ${q.sectionLabel}):
${q.question}
${q.options && q.options.length ? q.options.map((o,i)=>String.fromCharCode(65+i)+') '+o).join('\n') : ''}`
).join('\n\n')}

Return ONLY the updated questions in the same order and format as above.`;

  const btn = document.getElementById('randomize-numbers-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Randomizing...';
  let aiResult;
  try {
    const response = await fetch('https://question-bank-lqsu.onrender.com/api/v1/generate', {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    const data = await response.json();
    if (!response.ok || !data.result) throw new Error(data.error || "AI Error");
    aiResult = data.result;
  } catch (e) {
    alert("AI error: " + e.message);
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-random"></i> Randomize Numbers in Problems';
    return;
  }
  const qBlocks = aiResult.split(/\nQ\d+ \(Subject:/).map((q, i) => (i === 0 && q.startsWith("Q")) ? q : "Q"+(i)+(q ? "\n"+q : "")).filter(q=>q.trim());
  if (qBlocks.length !== allQuestions.length) {
    alert("Number of returned questions from AI does not match. Please check AI output.");
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-random"></i> Randomize Numbers in Problems';
    return;
  }
  if (!confirm("AI has generated new numbers for all problem-solving questions. Apply these changes?")) {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-random"></i> Randomize Numbers in Problems';
    return;
  }
  for (let i = 0; i < allQuestions.length; i++) {
    const { subjIdx, sIdx, qIdx } = allQuestions[i];
    const lines = qBlocks[i].split('\n').filter(x=>x.trim());
    if (/^Q\d+ \(Subject:/i.test(lines[0])) lines.shift();
    const questionText = lines[0];
    let options = [];
    for (let j=1;j<lines.length;j++) {
      const m = lines[j].match(/^[A-D]\)\s*(.+)$/);
      if (m) options.push(m[1]);
    }
    paper.subjects[subjIdx].sections[sIdx].questions[qIdx].text = questionText;
    if (options.length) paper.subjects[subjIdx].sections[sIdx].questions[qIdx].options = options;
  }
  setExamPaper(paper);
  renderExam();
  alert("Numbers in all numerical problems have been randomized!");
  btn.disabled = false;
  btn.innerHTML = '<i class="fas fa-random"></i> Randomize Numbers in Problems';
};
// --- END ---
</script>
</body>
</html>
