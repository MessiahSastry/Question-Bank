<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload & Brand | St. Patrick's School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    :root {
      --primary-blue: #0f3d6b;
      --secondary-blue: #1762a7;
      --light-blue-bg: #f4f8fc;
      --border-color: #bcd6ef;
      --text-dark: #12416c;
      --text-light: #54656f;
    }
    html { height: -webkit-fill-available; }
    body {
      margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif;
      background-color: #f4f8fc;
      min-height: 100vh;
      height: -webkit-fill-available;
    }
    .page-wrapper {
      display: flex; flex-direction: column; min-height: 100vh;
    }
    #main-header {
      background: linear-gradient(90deg, #1762a7, #0f3d6b);
      color: #fff;
      border-bottom-left-radius: 28px; border-bottom-right-radius: 28px;
      min-height: 84px; display: flex; flex-direction: column;
      align-items: center; justify-content: center; padding: 15px 10px 18px 10px;
      box-sizing: border-box; flex-shrink: 0;
      position: sticky; top: 0; z-index: 10;
    }
    #main-header .school-title { font-size: 1.8em; font-weight: bold; margin: 0;}
    #main-header .subtitle { font-size: 1.05em; color: #e0eaff; margin-top: 5px; }
    main {
      flex: 1 1 0%;
      min-height: 0;
      overflow-y: auto;
      padding: 22px;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    .form-container {
      width: 100%;
      max-width: 430px;
      margin: 0 auto 22px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 18px rgba(0, 27, 68, 0.11);
      padding: 28px 18px 24px 18px;
      flex-shrink: 0;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    .form-group { margin-bottom: 17px; }
    .form-group label {
      font-weight: 600;
      color: #185496;
      display: block;
      margin-bottom: 7px;
      font-size: 1em;
    }
    .form-group input[type="text"],
    .form-group input[type="file"],
    .form-group input[type="date"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1.3px solid #bcd6ef;
      font-size: 1em;
      background: #f7fafd;
      box-sizing: border-box;
      height: 42px;
    }
    .form-group input[type="file"] { padding: 7px 4px; height: auto; background: none; }
    .submit-btn {
      background: linear-gradient(90deg, #1762a7, #0f3d6b);
      color: #fff; font-weight: bold; cursor: pointer; padding: 13px 0;
      margin-top: 18px; width: 100%; border-radius: 8px; border: none; font-size: 1.09em;
      box-shadow: 0 2px 10px #0f3d6b0a;
    }
    .submit-btn:active { transform: scale(0.98);}
    #downloadLink {
      display: none; margin-top:18px; color: #0f3d6b;
      text-decoration: underline; font-weight:bold; text-align: center;
    }
    @media (max-width: 600px) {
      main { padding-top: 14px; }
      .form-container { padding: 15px 5vw 18px 5vw; border-radius: 12px; }
    }
    .custom-dropdown {
      position: relative;
      border: 1.3px solid #bcd6ef;
      border-radius: 6px;
      background: #f7fafd;
      font-size: 1em;
      color: #12416c;
      height: 42px;
      cursor: pointer;
      padding: 10px 12px;
    }
    .custom-dropdown .dropdown-options {
      display: none;
      position: absolute;
      top: 100%; left: 0; right: 0;
      background: white;
      border: 1px solid #bcd6ef;
      border-top: none;
      z-index: 100;
      max-height: 180px;
      overflow-y: auto;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 6px 15px rgba(0, 27, 68, 0.1);
    }
    .custom-dropdown.open .dropdown-options {
      display: block;
    }
    .dropdown-options div[data-value] {
      padding: 10px;
    }
    .dropdown-options div[data-value]:hover {
      background: #e0eaff;
    }
    @keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
  <div class="page-wrapper">
    <header id="main-header">
      <h1 class="school-title">St. Patrick's School</h1>
      <div class="subtitle">IIT & NEET FOUNDATION</div>
    </header>
    <main>
      <div class="form-container">
        <h2>Upload & Brand Question Paper</h2>
        <div class="form-group">
          <label>Question Paper PDF (from Examin8):</label>
          <input type="file" id="pdfFile" accept="application/pdf">
        </div>
        <div class="form-group">
          <label>Exam Name:</label>
          <input type="text" id="examName">
        </div>
        <div class="form-group">
          <label>Class:</label>
          <div id="class-dropdown" class="custom-dropdown"></div>
        </div>
        <div class="form-group">
          <label>Subject:</label>
          <div id="subject-dropdown" class="custom-dropdown"></div>
        </div>
        <div class="form-group">
          <label>Date (YYYY-MM-DD):</label>
          <input type="text" id="date" placeholder="DD-MM-YYYY" readonly>
        </div>
        <div class="form-group">
          <label>Time (minutes):</label>
          <input type="text" id="time">
        </div>
        <div class="form-group">
          <label>Max Marks:</label>
          <input type="text" id="maxMarks">
        </div>
        <button class="submit-btn" id="processBtn">Add Header & Download</button>
        <a id="downloadLink">Download Branded PDF</a>
      </div>
    </main>
  </div>

<script>
  window.PDFLib = PDFLib;
const config = {
  classes: ["3rd Class", "4th Class", "5th Class", "6th Class", "7th Class", "8th Class", "9th Class", "10th Class"],
  subjectMappings: {
    "3rd Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
    "4th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
    "5th Class": ["Telugu", "Hindi", "English", "Math", "Science", "Social"],
    "6th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 2", "Physics", "Chemistry", "Biology", "Social"],
    "7th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 2", "Physics", "Chemistry", "Biology", "Social"],
    "8th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 2", "Physics", "Chemistry", "Biology", "Social"],
    "9th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 2", "Physics", "Chemistry", "Biology", "Social"],
    "10th Class": ["Telugu", "Hindi", "English 1", "English 2", "Math 1", "Math 2", "Physics", "Chemistry", "Biology", "Social"]
  }
};
function createDropdown(containerId, options, placeholder) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const optionsHTML = options.map(opt => `<div data-value="${opt}">${opt}</div>`).join('');
  container.innerHTML = `<div class="selected-option">${placeholder}</div><div class="dropdown-options">${optionsHTML}</div>`;
  container.dataset.value = '';
  container.addEventListener('click', (e) => {
    e.stopPropagation();
    document.querySelectorAll('.custom-dropdown.open').forEach(d => { if (d !== container) d.classList.remove('open'); });
    container.classList.toggle('open');
    if (e.target.dataset.value) {
      container.querySelector('.selected-option').textContent = e.target.dataset.value;
      container.dataset.value = e.target.dataset.value;
      container.classList.remove('open');
      container.dispatchEvent(new Event('change', { bubbles: true }));
    }
  });
}
function formatDate(dateStr) {
  if (!dateStr) return '';
  const [d, m, y] = dateStr.split('-');
  return `${d}/${m}/${y}`;
}

let sheetPerPage = 1; // Default, will be set by popup

document.getElementById('processBtn').onclick = function () {
  document.getElementById('sheet-popup').style.display = 'flex';
};

window.selectSheetOption = function(opt) {
  sheetPerPage = opt;
  document.getElementById('sheet-popup').style.display = 'none';
  processBranding();
};

async function processBranding() {
  const showSpinner = () => document.getElementById('spinner-overlay').style.display = "flex";
  const hideSpinner = () => document.getElementById('spinner-overlay').style.display = "none";
  showSpinner();
  try {
    const pdfFile = document.getElementById('pdfFile').files[0];
    if (!pdfFile) { hideSpinner(); return alert("Please select a PDF to brand!"); }

    const pdfBytes = await pdfFile.arrayBuffer();
    // Open the original PDF
    const origPdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
    const firstPage = origPdfDoc.getPage(0);

    // Add header to original first page (in-place branding, like your code)
    // -- your branding logic here (drawRectangle, drawText, drawImage, etc.) --
    // (Omitted for brevity â€“ you can keep your header-drawing code for branding the page)

    // Now export this single branded page as an image
    const brandedPdfBytes = await origPdfDoc.save();
    const brandedPdfDoc = await PDFLib.PDFDocument.load(brandedPdfBytes);
    const [brandedPage] = await brandedPdfDoc.copyPages(brandedPdfDoc, [0]);

    // New output PDF with A4 landscape page
    const outPdfDoc = await PDFLib.PDFDocument.create();
    const a4Width = 841.89, a4Height = 595.28; // A4 landscape

    const outPage = outPdfDoc.addPage([a4Width, a4Height]);
    const [origWidth, origHeight] = brandedPage.getSize();
    const gap = 20;
    const halfWidth = (a4Width - gap) / 2;
    const scale = Math.min(halfWidth / origWidth, a4Height / origHeight);

    // Left copy
    outPage.drawPage(brandedPage, { x: 0, y: 0, xScale: scale, yScale: scale });
    // Right copy
    outPage.drawPage(brandedPage, { x: halfWidth + gap, y: 0, xScale: scale, yScale: scale });

    const newPdfBytes = await outPdfDoc.save();
    const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'QuestionPaper_DuplicateSideBySide.pdf';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.open(url, '_blank');
  } catch (e) {
    alert("Error while branding PDF: " + (e.message || e));
  }
  hideSpinner();
}

flatpickr("#date", {
  dateFormat: "d-m-Y",
  allowInput: false,      // disables typing, popup only
  defaultDate: "today"
});
createDropdown('class-dropdown', config.classes, 'Select Class');
createDropdown('subject-dropdown', [], 'Select Subject');
document.getElementById('class-dropdown').addEventListener('change', () => {
  const selectedClass = document.getElementById('class-dropdown').dataset.value;
  const subjects = config.subjectMappings[selectedClass] || [];
  createDropdown('subject-dropdown', subjects, 'Select Subject');
});
</script>
<div id="spinner-overlay" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.80);align-items:center;justify-content:center;">
  <div style="display:flex;flex-direction:column;align-items:center;gap:16px;">
    <div class="spinner" style="width:52px;height:52px;border:6px solid #1762a7;border-top:6px solid #bcd6ef;border-radius:50%;animation:spin 1s linear infinite;"></div>
    <div style="font-size:1.1em;color:#1762a7;font-weight:600;">Branding PDF, please wait...</div>
  </div>
</div>
  <!-- Sheet Selection Popup -->
<div id="sheet-popup" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.30); z-index:10001; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:14px; box-shadow:0 4px 20px #12416c33; padding:28px 24px 20px 24px; min-width:260px; display:flex; flex-direction:column; align-items:center;">
    <div style="font-size:1.13em; font-weight:600; color:#0f3d6b; margin-bottom:20px;">How many sheets per page?</div>
    <button class="submit-btn" style="margin-bottom:15px; width:180px;" onclick="selectSheetOption(1)">One sheet per page</button>
    <button class="submit-btn" style="width:180px; background:#185496;" onclick="selectSheetOption(2)">Two sheets per page</button>
  </div>
</div>
</body>
</html>
