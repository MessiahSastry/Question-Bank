<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Print Preview | St. Patrick's School</title>
  <meta name="viewport" content="width=900, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script>
    window.MathJax = {
      tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] },
      svg: { fontCache: "global" }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <style>
    body {
      background: #f4f8fc;
      margin: 0;
      padding: 0;
      font-family: 'Times New Roman', Times, serif;
    }
    #page-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      min-height: 100vh;
      padding-bottom: 36px;
    }
    .print-preview {
      background: white;
      width: 210mm;
      min-height: 297mm;
      max-width: 99vw;
      box-shadow: 0 4px 36px #a5b7d7a1;
      border-radius: 13px;
      margin: 34px 0 30px 0;
      padding: 0;
      overflow: hidden;
      position: relative;
    }
    .a4-page {
      width: 210mm;
      min-height: 297mm;
      padding: 28mm 20mm 18mm 20mm;
      box-sizing: border-box;
      background: #fff;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      position: relative;
    }
    .heading-row {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      margin-top: 0;
      margin-bottom: 0;
    }
    .school-logo {
      height: 88px;
      width: auto;
      margin: 0 16px 0 16px;
    }
    .school-headings {
      flex: 1;
      text-align: center;
      min-width: 0;
    }
    .school-title {
      font-size: 2.1em;
      font-weight: bold;
      letter-spacing: 0.03em;
      margin: 0 0 0 0;
      font-family: 'Times New Roman', Times, serif;
      text-transform: capitalize;
    }
    .subtitle {
      font-size: 1.19em;
      font-weight: 500;
      color: #0f3d6b;
      margin-top: 4px;
      margin-bottom: 2px;
      letter-spacing: 0.04em;
    }
    .exam-title {
      font-size: 1.13em;
      font-weight: bold;
      margin: 7px 0 0 0;
    }
    .details-rect {
      margin: 20px 0 26px 0;
      border: 2px solid #bdd7f6;
      border-radius: 18px;
      padding: 13px 18px 13px 18px;
      width: 100%;
      display: flex;
      flex-direction: column;
      background: #fafdff;
      box-sizing: border-box;
      max-width: 100%;
    }
    .rect-row {
      display: flex;
      align-items: center;
      width: 100%;
      justify-content: space-between;
      font-size: 1.13em;
      margin-bottom: 4px;
    }
    .rect-row .rect-label {
      font-weight: bold;
      margin-right: 6px;
    }
    .rect-row .rect-subject {
      flex: 1 1 0;
      text-align: center;
      font-size: 1.32em;
      font-weight: bold;
      letter-spacing: 0.03em;
    }
    .rect-row:last-child { margin-bottom: 0; }
    .section-block {
      margin-bottom: 24px;
    }
    .section-header-instruct {
      font-weight: bold;
      font-size: 1.12em;
      color: #1762a7;
      margin-bottom: 18px;
      margin-top: 18px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .question-list {
      margin-left: 0;
      padding-left: 0;
      list-style-position: inside;
    }
    .question-item {
      margin-bottom: 17px;
      padding-bottom: 3px;
      font-size: 1.11em;
      color: #1d1d1d;
      break-inside: avoid;
      line-height: 1.6;
      white-space: pre-line;
    }
    .mcq-options-row {
      display: flex;
      gap: 36px;
      margin-top: 6px;
      margin-bottom: 0;
    }
    .mcq-options-two-row {
      display: flex;
      flex-direction: column;
      margin-top: 6px;
      margin-bottom: 0;
      gap: 2px;
    }
    .mcq-options-line {
      display: flex;
      gap: 36px;
    }
    .mcq-options-col {
      display: flex;
      flex-direction: column;
      margin-top: 6px;
      gap: 2px;
      margin-bottom: 0;
    }
    .mcq-option { white-space: pre-line; }
    .question-img {
      display: block;
      margin: 12px 0 4px 0;
      max-width: 320px;
      max-height: 140px;
      border: 1px solid #eee;
      border-radius: 5px;
    }
    .footer-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.96em;
      color: #415980;
      margin-top: 22px;
      margin-bottom: 24px;
    }
    .toolbar {
      width: 210mm;
      max-width: 99vw;
      display: flex;
      justify-content: center;
      gap: 32px;
      margin: 24px auto 12px auto;
      position: relative;
      z-index: 11;
    }
    .toolbar button {
      background: #1463ad;
      color: #fff;
      border: none;
      padding: 13px 38px;
      border-radius: 9px;
      font-weight: bold;
      font-size: 1.09em;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(0,61,107,0.05);
      transition: background .16s, transform .1s;
      display: flex;
      align-items: center;
      gap: 9px;
    }
    .toolbar button:hover { background: #0f3d6b; }
    @media print {
      body, html { background: #fff; }
      .toolbar { display: none !important; }
      #page-container { padding: 0; }
      .print-preview, .a4-page {
        width: 210mm !important; min-height: 297mm !important; box-shadow: none !important; border-radius: 0 !important; margin: 0 !important;
      }
      .footer-row { position: absolute !important; }
    }
  </style>
</head>
<body>
  <div id="page-container">
    <div id="print-preview" class="print-preview"></div>
    <div class="toolbar">
      <button id="download-pdf"><i class="fas fa-file-pdf"></i> Download PDF</button>
      <button id="download-word"><i class="fas fa-file-word"></i> Download Word</button>
      <button onclick="window.print()"><i class="fas fa-print"></i> Print</button>
    </div>
  </div>
  <script>
    // -- Change to your actual logo files --
    const schoolLogo1 = 'schoollogo1.png';
    const schoolLogo2 = 'schoollogo2.png';

    // Demo fallback (for local preview)
    let exam = JSON.parse(sessionStorage.getItem('finalExamData') || '{}');
    if (!exam.sections) {
      exam = {
        examName: "Formative Assessment 1",
        subject: "SCIENCE",
        class: "10th Class",
        time: "90",
        date: "2025-06-11",
        maxMarks: "40",
        sections: [
          {
            name: "Section A",
            instructions: "Answer all the questions (8 x 1 = 8 Marks)",
            questions: [
              { text: "What is 2 + 2? A) 2 B) 3 C) 4 D) 5", image: null },
              { text: "Which of the following are even numbers? A) 2 B) 4 C) 7 D) 9", image: null },
              { text: "Which of the following best describes osmosis? A) The movement of water molecules through a semipermeable membrane from a region of low solute concentration to a region of high solute concentration B) The process by which plants make food using sunlight C) The movement of oxygen from the air into the bloodstream D) The process by which cells divide to form new cells", image: null }
            ]
          }
        ]
      }
    }

    // Helper to remove question metadata (like "Q9: Easy/Level 1, 1 Mark.")
    function cleanQuestionText(text) {
      // Remove Qx: ... style prefix
      return text.replace(/^Q\d+:\s*[^.]*\.\s*/, '').trim();
    }

    // Helper to detect MCQ and format options
    function renderMCQOptions(questionText) {
      // Detect options like "A) ... B) ... C) ... D) ..."
      const mcqMatch = questionText.match(/^(.*?)(?:\s*)A\)(.*)B\)(.*)C\)(.*)D\)(.*)$/s);
      if (!mcqMatch) return null; // Not an MCQ

      // Extract question and options
      const question = mcqMatch[1].trim().replace(/\s+$/, '');
      const options = [
        mcqMatch[2] ? mcqMatch[2].trim() : "",
        mcqMatch[3] ? mcqMatch[3].trim() : "",
        mcqMatch[4] ? mcqMatch[4].trim() : "",
        mcqMatch[5] ? mcqMatch[5].trim() : ""
      ];

      // Prepare option strings
      const optLabels = ['A', 'B', 'C', 'D'];
      const optionStrs = options.map((opt, i) => `${optLabels[i]}) ${opt}`);

      // Try single line
      const singleLineStr = optionStrs.join('    ');
      // For measuring, create a dummy span
      const dummy = document.createElement('span');
      dummy.style.visibility = 'hidden';
      dummy.style.position = 'absolute';
      dummy.style.fontFamily = "'Times New Roman', Times, serif";
      dummy.style.fontSize = '1.11em';
      dummy.innerText = singleLineStr;
      document.body.appendChild(dummy);
      const fitsSingleLine = dummy.offsetWidth < 540; // approx A4 printable width in px
      document.body.removeChild(dummy);

      if (fitsSingleLine) {
        // All options in one row
        return {
          question,
          html: `<div class="mcq-options-row">${optionStrs.map(opt => `<div class="mcq-option">${opt}</div>`).join('')}</div>`
        }
      }
      // Try two lines (2 per line)
      const firstRow = optionStrs.slice(0,2).join('    ');
      const secondRow = optionStrs.slice(2,4).join('    ');
      // Dummy spans for each line
      const dummy1 = document.createElement('span');
      dummy1.style.visibility = 'hidden';
      dummy1.style.position = 'absolute';
      dummy1.style.fontFamily = "'Times New Roman', Times, serif";
      dummy1.style.fontSize = '1.11em';
      dummy1.innerText = firstRow;
      document.body.appendChild(dummy1);
      const fitsTwoPerLine = dummy1.offsetWidth < 540;
      document.body.removeChild(dummy1);

      if (fitsTwoPerLine) {
        return {
          question,
          html: `
          <div class="mcq-options-two-row">
            <div class="mcq-options-line">${optionStrs.slice(0,2).map(opt => `<div class="mcq-option">${opt}</div>`).join('')}</div>
            <div class="mcq-options-line">${optionStrs.slice(2,4).map(opt => `<div class="mcq-option">${opt}</div>`).join('')}</div>
          </div>
          `
        }
      }
      // Otherwise, one per line
      return {
        question,
        html: `<div class="mcq-options-col">${optionStrs.map(opt => `<div class="mcq-option">${opt}</div>`).join('')}</div>`
      }
    }

    function renderPrintPreview() {
      const container = document.getElementById('print-preview');
      container.innerHTML = '';
      let page = document.createElement('div');
      page.className = 'a4-page';

      // Heading row
      page.innerHTML += `
        <div class="heading-row">
          <img src="${schoolLogo1}" class="school-logo" alt="School Logo" onerror="this.style.display='none';">
          <div class="school-headings">
            <div class="school-title">St. Patrick’s School</div>
            <div class="subtitle">IIT & NEET FOUNDATION</div>
            <div class="exam-title">${exam.examName || ''}</div>
          </div>
          <img src="${schoolLogo2}" class="school-logo" alt="School Logo" onerror="this.style.display='none';">
        </div>
        <div class="details-rect">
          <div class="rect-row">
            <span class="rect-label">Class: ${exam.class || ''}</span>
            <span class="rect-subject">${(exam.subject || '').toUpperCase()}</span>
            <span class="rect-label">Date: ${exam.date || ''}</span>
          </div>
          <div class="rect-row">
            <span class="rect-label">Time: ${exam.time || ''} min</span>
            <span style="flex:1;"></span>
            <span class="rect-label">Max Marks: ${exam.maxMarks || ''}</span>
          </div>
        </div>
      `;

      // Sections and questions
      let qNum = 1;
      for (const section of (exam.sections || [])) {
        // Section header and instructions on single line
        let sectionHeader = '';
        if (section.name && section.name !== "undefined") sectionHeader += section.name;
        if (section.instructions && section.instructions !== "undefined") sectionHeader += (sectionHeader ? ': ' : '') + section.instructions;
        if (sectionHeader) {
          page.innerHTML += `<div class="section-header-instruct">${sectionHeader}</div>`;
        }
        // Questions
        if (section.questions) {
          page.innerHTML += `<ol class="question-list" type="1" start="${qNum}">` +
            section.questions.map(q => {
              // Remove metadata, handle MCQ formatting
              const cleanText = cleanQuestionText(q.text);
              const mcqObj = renderMCQOptions(cleanText);
              if (mcqObj) {
                // MCQ: question, then options as per rule
                return `<li class="question-item">
                  <span class="question-text">${mcqObj.question}</span>
                  ${mcqObj.html}
                  ${q.image ? `<img class="question-img" src="${q.image}" alt="Question Image" />` : ''}
                </li>`;
              } else {
                // Not MCQ: Just show as-is (text will wrap naturally)
                return `<li class="question-item">
                  <span class="question-text">${cleanText}</span>
                  ${q.image ? `<img class="question-img" src="${q.image}" alt="Question Image" />` : ''}
                </li>`;
              }
            }).join('') +
            `</ol>`;
          qNum += section.questions.length;
        }
      }

      // Footer
      page.innerHTML += `
        <div class="footer-row">
          <div>St. Patrick’s School – a school for IIT & NEET Foundation</div>
        </div>
      `;

      container.appendChild(page);

      // MathJax render
      if (window.MathJax) MathJax.typesetPromise();
    }

    renderPrintPreview();

    // PDF Export
    document.getElementById('download-pdf').onclick = function () {
      import('jspdf').then(jsPDF => {
        const doc = new jsPDF.jsPDF({ unit: "mm", format: "a4" });
        doc.html(document.querySelector('.a4-page'), {
          callback: function (pdf) {
            pdf.save(`${(exam.examName || 'Exam')}_StPatricks.pdf`);
          },
          x: 0, y: 0, width: 210, windowWidth: 900
        });
      });
    };

    // Word Export
    document.getElementById('download-word').onclick = function () {
      alert('Word export coming soon. For now, use Print > Save as Word/PDF.');
    };
  </script>
</body>
</html>
