<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Print Preview | St. Patrick's School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.1/docx.min.js"></script>
  <script>
    window.MathJax = {
      tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] },
      svg: { fontCache: "global" }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <style>
    body {
      background: #f4f8fc;
      margin: 0;
      padding: 0;
      font-family: 'Times New Roman', Times, serif;
    }
    #page-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      min-height: 100vh;
      padding-bottom: 36px;
    }
    .print-preview {
      background: white;
      min-height: 297mm;
      border-radius: 13px;
      padding: 0;
      overflow-x: auto;
      position: relative;
      width: 100vw;
      max-width: 100vw;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .question-container {
      display: flex;
      align-items: flex-start;
      margin-bottom: 12px; /* Default, overridden by JS */
    }
    .question-number {
      min-width: 28px;
      padding-right: 4px;
    }
    .question-body {
      flex: 1;
    }
    .a4-page {
      width: 210mm;
      min-height: 297mm;
      margin: 0 auto;
      padding: 2.1cm 1.5cm 1.5cm 1.5cm; /* Default, overridden by JS */
      box-sizing: border-box;
      background: #fff;
      transition: width 0.25s, padding 0.25s;
    }

    /* General responsive adjustments */
    @media (max-width: 800px) {
      .a4-page {
        width: 100vw !important;
        min-width: 100vw !important;
        max-width: 100vw !important;
        margin: 0 !important;
        padding: 3vw 2vw !important; /* Adjust padding for smaller screens */
        min-height: unset !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        background: #fff !important;
        display: block !important;
      }
      .print-preview {
        min-height: unset !important;
        border-radius: 0 !important;
        width: 100vw !important;
        max-width: 100vw !important;
        padding: 0 !important;
      }
      #page-container {
        max-width: 100vw !important;
        width: 100vw !important;
        margin: 0 !important;
        padding: 0 !important;
        border-radius: 0 !important;
        align-items: stretch !important;
      }
    }

    @media print {
      #floating-settings-btn {
        display: none !important;
      }
      body, html {
        background: #fff !important;
        /* Force minimum width on print for layout consistency */
        min-width: 210mm; /* A4 width */
      }
      .toolbar {
        display: none !important;
      }
      #page-container {
        padding: 0 !important;
        margin: 0 !important;
      }

      .a4-page {
        width: 100% !important;
        min-height: auto !important; /* Let content define height */
        box-shadow: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
        box-sizing: border-box !important;
        page-break-after: always; /* Ensure each .a4-page starts a new print page */
        /* Padding is set by JS variable or inline style for dynamic control */
      }

      /* Spacer at end of the page to ensure content doesn't get cut off */
      .print-footer-spacer {
        height: 3cm; /* Creates 3cm of empty space */
      }

      /* Footer for print - positioned relative to page flow, no page-break-after */
      .footer-row {
        position: relative !important; /* Changed from static */
        left: 0;
        bottom: 0;
        width: 100%;
        text-align: center;
        background: #fff;
        font-size: 0.9em;
        z-index: 99;
        padding: 5mm 0 5mm 0;
        box-sizing: border-box;
        border-top: 1px solid #ddd; /* Lighter border for print */
        /* Removed page-break-after: always; here */
      }

      /* Make the question gap and page margin print-consistent */
      .question-container {
        margin-bottom: var(--question-gap, 12px) !important;
      }
      .a4-page {
        padding: var(--page-margin, 1.5cm) !important;
      }

      /* Minor print adjustments for internal elements */
      .question-item div,
      .question-item span,
      .question-item {
        margin-top: 0;
        margin-bottom: 0;
      }
      /* Ensure MathJax containers behave correctly in print */
      mjx-container {
        display: inline-block !important;
        min-width: 40px !important;
        min-height: 24px !important;
        vertical-align: middle !important;
        overflow: visible !important; /* Ensure equations aren't cut off */
      }
    }

    /* Corrected Global Layout Rules - apply to all sizes unless overridden */
    .heading-row,
    .details-rect,
    .section-header,
    .section-block,
    .footer-row,
    .question-container {
      width: 100%; /* Changed to 100% and removed !important unless truly needed */
      margin-left: 0;
      margin-right: 0;
      box-sizing: border-box;
    }

    /* Toolbar Styles */
    .toolbar {
      width: 210mm;
      max-width: 99vw;
      display: flex;
      justify-content: center;
      gap: 32px;
      margin: 24px auto 12px auto;
      position: relative;
      z-index: 11;
    }
    .toolbar button {
      background: #1463ad;
      color: #fff;
      border: none;
      padding: 16px 50px;
      border-radius: 9px;
      font-weight: bold;
      font-size: 1.2em;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(0,61,107,0.05);
      transition: background .16s, transform .1s;
      display: flex;
      align-items: center;
      gap: 9px;
    }
    .toolbar button:hover { background: #0f3d6b; }

    /* Settings Button Styles */
    .floating-settings-btn {
      position: fixed;
      bottom: 32px;
      right: 32px;
      z-index: 9999;
      background: linear-gradient(90deg, #1762a7, #0f3d6b);
      color: #fff;
      border: none;
      border-radius: 50%;
      box-shadow: 0 4px 18px rgba(15,61,107,0.16);
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      cursor: pointer;
      transition: background 0.15s;
    }
    @media (max-width: 700px) {
      .floating-settings-btn {
        width: 72px !important;
        height: 72px !important;
        font-size: 2.5em !important;
        right: 18px !important;
        bottom: 18px !important;
        box-shadow: 0 6px 22px rgba(15,61,107,0.25) !important;
      }
    }

    /* Settings Popup Modal Styles */
    .settings-popup-modal {
      display: none; /* Controlled by JS */
      position: fixed;
      bottom: 100px;
      right: 36px;
      z-index: 10000;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(23,56,104,0.26); /* Updated shadow for consistency */
      padding: 32px 24px 22px 24px;
      min-width: 260px;
      border: 2px solid #1463ad;
      flex-direction: column;
      align-items: flex-start;
    }
    .settings-popup-modal .title {
      font-weight: 700;
      color: #12416c;
      font-size: 1.2em;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
    }
    .settings-popup-modal .title i {
      margin-right: 8px;
      color: #1463ad;
    }
    .settings-popup-modal .setting-row {
      margin-bottom: 18px;
    }
    .settings-popup-modal .setting-row label {
      font-weight: 600;
      color: #185496;
      font-size: 1em;
      display: block;
      margin-bottom: 5px;
    }
    .settings-popup-modal .setting-row .slider-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings-popup-modal .setting-row input[type="range"] {
      width: 100%;
    }
    .settings-popup-modal .close-btn {
      position: absolute;
      top: 10px;
      right: 18px;
      background: none;
      border: none;
      color: #185496;
      font-size: 1.5em;
      cursor: pointer;
    }
    .rect-row .rect-label {
      font-weight: bold;
      margin-right: 6px;
    }
    .rect-row .rect-subject {
      flex: 1 1 0;
      text-align: center;
      font-size: 1.32em;
      font-weight: bold;
      letter-spacing: 0.03em;
    }
    .options-block {
      margin-left: 0;
      margin-top: 0;
      margin-bottom: 2px;
    }
    .options-block > div { /* For individual option lines */
        margin-bottom: 2px;
        margin-left: 2px;
    }
    .options-grid { /* For A,B,C,D layout */
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 32px;
        margin-bottom: 2px;
        margin-left: 2px;
        width: 100%;
    }
    .options-flex-wrap { /* For A,B,C,D on one line, wrapping */
        display: flex;
        gap: 32px;
        flex-wrap: wrap;
        margin-bottom: 3px;
        margin-left: 2px;
    }
    .option-item {
        min-width: 70px;
        display: inline-block;
    }
    .question-text {
        font-size: 1.15em;
    }
    .question-img-block {
        margin-top: 10px;
        text-align: center;
    }
    .question-img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
    }

  </style>
</head>
<body>
    <div id="page-container">
        <div id="print-preview" class="print-preview"></div>
        <div class="toolbar">
            <button onclick="window.print()"><i class="fas fa-print"></i> Print</button>
            </div>
    </div>

    <button id="floating-settings-btn" class="floating-settings-btn" title="Settings">
        <i class="fas fa-cog"></i>
    </button>

    <div id="settings-popup-modal" class="settings-popup-modal">
        <div class="title">
            <i class="fas fa-sliders-h"></i>Print Settings
        </div>
        <div class="setting-row">
            <label for="gap-slider">Gap between questions</label>
            <div class="slider-group">
                <input id="gap-slider" type="range" min="4" max="36" value="12">
                <span id="gap-slider-value">12px</span>
            </div>
        </div>
        <div class="setting-row" style="margin-bottom:22px;">
            <label for="margin-slider">Page margin (cm)</label>
            <div class="slider-group">
                <input id="margin-slider" type="range" min="0.5" max="2.5" value="1.5" step="0.1">
                <span id="margin-slider-value">1.5cm</span>
            </div>
        </div>
        <button id="close-settings-popup" class="close-btn" title="Close">×</button>
    </div>

<script>
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${day}-${month}-${year}`;
    }

    let exam = JSON.parse(sessionStorage.getItem('finalExamData') || '{}');

    // Demo fallback (for local preview) - Using a more structured 'options' array
    if (!exam.sections || exam.sections.length === 0) {
        exam = {
            examName: "Formative Assessment 1",
            subject: "SCIENCE",
            class: "10th Class",
            time: "90",
            date: "2025-06-11",
            maxMarks: "40",
            sections: [
                {
                    name: "Section A",
                    instructions: "Answer any 3 questions. (3 × 4 = 12 Marks)",
                    questions: [
                        {
                            question: "What is the order of the matrix \\( B = \\begin{bmatrix} 7 & 8 & 9 \\\\ 4 & 5 & 6 \\end{bmatrix} \\)?",
                            image: null,
                            options: ["A) $2 \\times 3$", "B) $3 \\times 2$", "C) $2 \\times 2$", "D) $3 \\times 3$"]
                        },
                        {
                            question: "If a square matrix \\( G \\) has all its off-diagonal elements zero, what kind of matrix is \\( G \\)?",
                            image: null,
                            options: ["A) Identity matrix", "B) Diagonal matrix", "C) Null matrix", "D) Scalar matrix"]
                        },
                        {
                            question: "For the matrix \\( A = \\begin{bmatrix} x & 2 \\\\ 3 & 4 \\end{bmatrix} \\), if \\( A \\) is the identity matrix, then \\( x \\) is:",
                            image: null,
                            options: ["A) 1", "B) 0", "C) 2", "D) 3"]
                        },
                        { question: "Define osmosis.", image: null, options: [] } // Non-MCQ question
                    ]
                },
                {
                    name: "Section B",
                    instructions: "Answer any 2 questions. (2 × 5 = 10 Marks)",
                    questions: [
                        { question: "Explain the process of photosynthesis with a balanced chemical equation.", image: null, options: [] },
                        { question: "Differentiate between acids and bases.", image: null, options: [] }
                    ]
                }
            ]
        };
    }

    // This function tries to intelligently wrap certain mathematical patterns with $...$ for MathJax.
    // It's still prone to false positives with plain text, but more targeted.
    function autoLatexSimple(text) {
        // Avoid wrapping if it already contains MathJax delimiters
        if (text.includes('$') || text.includes('\\(') || text.includes('\\[') || text.includes('mjx-container')) {
            return text;
        }

        // Wrap isolated variables or simple numbers with exponents
        text = text.replace(/\b([a-zA-Z][\d_]*)(\^\d+)?\b/g, (match, p1, p2) => {
            return `$${p1}${p2 || ''}$`;
        });

        // Wrap simple fractions like 1/2 or a/b
        text = text.replace(/(\b\d+\/\d+\b)|(\b[a-zA-Z]\/[a-zA-Z]\b)/g, (match) => {
            return `$\\frac{${match.replace('/', '{')}}{}}$`;
        });
        
        // Wrap basic arithmetic expressions (e.g., A + B = C)
        // More specific to avoid wrapping common English sentences
        text = text.replace(/([a-zA-Z0-9]+)\s*([+\-*/=<>])\s*([a-zA-Z0-9]+)/g, (match, p1, op, p2) => {
            // Only wrap if it looks like a simple equation/expression
            if (p1.length < 10 && p2.length < 10) { // Arbitrary length check to avoid wrapping long words
                return `$${match}$`;
            }
            return match;
        });

        return text;
    }


    function renderPrintPreview() {
        const container = document.getElementById('print-preview');
        container.innerHTML = '';
        const page = document.createElement('div');
        page.className = 'a4-page';

        page.innerHTML = `
            <div class="heading-row">
                <img src="schoollogo1.png" class="school-logo" alt="School Logo" onerror="this.style.display='none';">
                <div class="school-headings">
                    <div class="school-title">St. Patrick’s School</div>
                    <div class="subtitle">IIT & NEET FOUNDATION</div>
                    <div class="exam-title">${exam.examName || ''}</div>
                </div>
                <img src="schoollogo2.png" class="school-logo" alt="School Logo" onerror="this.style.display='none';">
            </div>
            <div class="details-rect">
                <div class="rect-row">
                    <span class="rect-label">Class: ${exam.class || ''}</span>
                    <span class="rect-subject">${(exam.subject || '').toUpperCase()}</span>
                    <span class="rect-label">Date: ${formatDate(exam.date) || ''}</span>
                </div>
                <div class="rect-row">
                    <span class="rect-label">Time: ${exam.time ? exam.time + ' min' : ''}</span>
                    <span style="flex:1;"></span>
                    <span class="rect-label">Max Marks: ${exam.maxMarks || ''}</span>
                </div>
            </div>
        `;

        let contentHTML = '';
        let qNum = 1;

        for (const section of (exam.sections || [])) {
            if (section.name || section.instructions) {
                contentHTML += `<div class="section-header">${section.name || ''}${(section.instructions ? ': ' + section.instructions : '')}</div>`;
            }

            if (section.questions && section.questions.length > 0) {
                const questionsHTML = section.questions.map((q) => {
                    const currentQNum = qNum++;
                    let optionsHTML = "";

                    // Prioritize q.options array if available and has 4 elements
                    const hasStructuredOptions = Array.isArray(q.options) && q.options.length === 4;

                    if (hasStructuredOptions) {
                        const containsMath = q.options.some(opt =>
                            opt.includes('$') || opt.includes('\\(') || opt.includes('\\[')
                        );

                        if (containsMath) {
                            optionsHTML = `<div class="options-flex-wrap">
                                ${q.options.map(opt => `<span class="option-item">${opt.trim()}</span>`).join('')}
                            </div>`;
                        } else {
                            // Test if A and B fit on one line, and C and D fit on one line
                            let dummy = document.createElement('span');
                            dummy.style.cssText = 'visibility:hidden;position:absolute;white-space:nowrap;padding:0;margin:0;border:none;font-family:Times New Roman,Times,serif;font-size:1.11em;';
                            
                            // Check if all four fit on one line
                            dummy.innerText = q.options.join('    ');
                            document.body.appendChild(dummy);
                            const fitsFour = dummy.offsetWidth < 440; // Adjusted max width for 4 options
                            document.body.removeChild(dummy);

                            // Check if A+B fits and C+D fits on separate lines
                            dummy.innerText = q.options[0] + "    " + q.options[1];
                            document.body.appendChild(dummy);
                            const abFits = dummy.offsetWidth < 400; // Max width for two options
                            document.body.removeChild(dummy);

                            dummy.innerText = q.options[2] + "    " + q.options[3];
                            document.body.appendChild(dummy);
                            const cdFits = dummy.offsetWidth < 400;
                            document.body.removeChild(dummy);

                            if (fitsFour) {
                                optionsHTML = `<div class="options-flex-wrap">
                                    ${q.options.map(opt => `<span class="option-item">${opt.trim()}</span>`).join('')}
                                </div>`;
                            } else if (abFits && cdFits) {
                                optionsHTML = `
                                <div class="options-grid">
                                    <span class="option-item">${q.options[0]}</span>
                                    <span class="option-item">${q.options[1]}</span>
                                    <span class="option-item">${q.options[2]}</span>
                                    <span class="option-item">${q.options[3]}</span>
                                </div>
                                `;
                            } else {
                                // Default to one option per line
                                optionsHTML = q.options.map(opt =>
                                    `<div class="option-item">${opt.trim().replace(/\n/g, '<br>')}</div>`
                                ).join('');
                            }
                        }
                    } else if (Array.isArray(q.options) && q.options.length > 0) {
                        // Handle cases with fewer than 4 structured options
                        optionsHTML = q.options.map(opt =>
                            `<div class="option-item">${opt.trim().replace(/\n/g, '<br>')}</div>`
                        ).join('');
                    } else {
                        // Fallback to old text parsing if no structured options,
                        // but autoLatexAll should be handled carefully.
                        // Ideally, `q.options` would always be an array.
                        let tempText = q.question || q.text || '';
                        let lines = tempText.split(/<br\s*\/?>|<\/div>|<div[^>]*>/gi)
                                          .map(s => s.replace(/ /g, ' ').trim())
                                          .filter(Boolean);
                        
                        let detectedOptions = [];
                        let questionMainText = '';

                        // Simple regex to detect A), B), C), D) patterns
                        const optionRegex = /^[A-D][).]?\s*(.*)/;
                        let foundOptionsSection = false;

                        for(let i = 0; i < lines.length; i++) {
                            const line = lines[i];
                            const match = line.match(optionRegex);
                            if (match) {
                                detectedOptions.push(autoLatexSimple(line)); // Apply autoLatex to options
                                foundOptionsSection = true;
                            } else if (!foundOptionsSection) {
                                questionMainText += autoLatexSimple(line) + (line ? '<br>' : '');
                            }
                        }
                        
                        // If 4 options detected from text, treat as MCQ
                        if (detectedOptions.length === 4) {
                            q.question = questionMainText.trim(); // Update question text
                            q.options = detectedOptions; // Store detected options
                            // Rerender with the structured options logic
                            return `<div class="question-container">
                                        <div class="question-number">${currentQNum}.</div>
                                        <div class="question-body">
                                            <div class="question-text">${q.question}</div>
                                            ${q.image ? `<div class="question-img-block"><img class="question-img" src="${q.image}" alt="Question Image" /></div>` : ''}
                                            <div class="options-block">
                                                <div class="options-flex-wrap">
                                                    ${q.options.map(opt => `<span class="option-item">${opt.trim()}</span>`).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>`;
                        } else {
                            // If not 4 detected options, just render the whole text
                            q.question = autoLatexSimple(tempText);
                        }
                    }

                    const imageHTML = q.image ? `<div class="question-img-block"><img class="question-img" src="${q.image}" alt="Question Image" /></div>` : '';
                    return `
                        <div class="question-container">
                            <div class="question-number">${currentQNum}.</div>
                            <div class="question-body">
                                <div class="question-text">${q.question || ''}</div>
                                ${imageHTML}
                                <div class="options-block">${optionsHTML}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                contentHTML += questionsHTML;
            }
        }

        page.innerHTML += contentHTML;
        page.innerHTML += `<div class="print-footer-spacer"></div>`;
        container.appendChild(page);

        // Ensure MathJax typesets after content is in DOM
        if (window.MathJax && typeof window.MathJax.typesetPromise === "function") {
            // One call should be sufficient. Removed the nested setTimeout.
            window.MathJax.typesetPromise([container]);
        }
    }

    // MathJax to Image Conversion (kept for reference, not actively called for print)
    async function renderMathJaxToImages(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (!container) return;

        if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
            await window.MathJax.typesetPromise([container]);
        }

        const mathElements = container.querySelectorAll('mjx-container');
        for (const el of mathElements) {
            // Check if html2canvas is available
            if (typeof html2canvas === 'function') {
                const canvas = await html2canvas(el, { backgroundColor: null, logging: false });
                const dataUrl = canvas.toDataURL('image/png');
                const img = document.createElement('img');
                img.src = dataUrl;
                img.style.verticalAlign = 'middle';
                img.style.display = 'inline-block';
                img.style.maxHeight = '32px'; // Keep consistent sizing
                img.style.minWidth = '40px'; // Prevent collapse
                img.style.minHeight = '24px';
                el.parentNode.replaceChild(img, el);
            } else {
                console.warn('html2canvas library not found. MathJax will not be converted to images.');
            }
        }
    }

    // Render on page load
    renderPrintPreview();

    // Show/hide the settings popup
    document.getElementById('floating-settings-btn').onclick = function() {
        document.getElementById('settings-popup-modal').style.display = 'flex';
    };
    document.getElementById('close-settings-popup').onclick = function() {
        document.getElementById('settings-popup-modal').style.display = 'none';
    };

    // GAP & MARGIN SLIDER LOGIC
    const gapSlider = document.getElementById('gap-slider');
    const gapValue = document.getElementById('gap-slider-value');
    const marginSlider = document.getElementById('margin-slider');
    const marginValue = document.getElementById('margin-slider-value');

    function updateGap() {
        const px = gapSlider.value;
        gapValue.textContent = px + "px";
        document.documentElement.style.setProperty('--question-gap', px + 'px');
        // Apply directly for immediate visual feedback (for non-print)
        document.querySelectorAll('.question-container').forEach(div => {
            div.style.marginBottom = px + "px";
        });
    }

    function updateMargin() {
        const cm = marginSlider.value;
        marginValue.textContent = cm + "cm";
        document.documentElement.style.setProperty('--page-margin', cm + 'cm');
        // Apply directly for immediate visual feedback (for non-print)
        document.querySelectorAll('.a4-page').forEach(page => {
            page.style.padding = `${cm}cm`;
        });
    }

    // Listen for changes
    gapSlider.addEventListener('input', updateGap);
    marginSlider.addEventListener('input', updateMargin);

    // Set initial values after DOM loaded
    window.addEventListener('DOMContentLoaded', () => {
        updateGap();
        updateMargin();
    });
</script>
</body>
</html>
